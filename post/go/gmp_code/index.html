<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>从源码分析 GMP 调度原理 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="本身涉及到的 go 代码 都是基于 go 1.23.0 版本
传统 OS 线程
线程是 CPU 的最小调度单位，CPU 通过不断切换线程来实现多任务的并发。这会引发一些问题（对于用户角度）：

线程的创建和销毁等是昂贵的，因为要不断在用户空间和内核空间切换。
线程的调度是由操作系统负责的，用户无法控制。而操作 …"><meta name=keywords content="[Go Golang Linux Docker Kubernetes DevOps Cloud Native Open Source Daemon365]"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/go/gmp_code/"><meta property="og:title" content="从源码分析 GMP 调度原理 - Daemon365"><meta property="og:description" content="本身涉及到的 go 代码 都是基于 go 1.23.0 版本
传统 OS 线程
线程是 CPU 的最小调度单位，CPU 通过不断切换线程来实现多任务的并发。这会引发一些问题（对于用户角度）：

线程的创建和销毁等是昂贵的，因为要不断在用户空间和内核空间切换。
线程的调度是由操作系统负责的，用户无法控制。而操作 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2024-12-07T14:23:31+08:00"><meta property="article:modified_time" content="2024-12-07T14:23:31+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="go"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/go/gmp_code/"><meta name=twitter:title content="从源码分析 GMP 调度原理 - Daemon365"><meta name=twitter:description content="本身涉及到的 go 代码 都是基于 go 1.23.0 版本
传统 OS 线程
线程是 CPU 的最小调度单位，CPU 通过不断切换线程来实现多任务的并发。这会引发一些问题（对于用户角度）：

线程的创建和销毁等是昂贵的，因为要不断在用户空间和内核空间切换。
线程的调度是由操作系统负责的，用户无法控制。而操作 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/go/gmp_code/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"从源码分析 GMP 调度原理","description":"\u003cp\u003e\u003cstrong\u003e本身涉及到的 go 代码 都是基于 go 1.23.0 版本\u003c\/strong\u003e\u003c\/p\u003e\n\u003ch2 id=\u0022传统-os-线程\u0022\u003e传统 OS 线程\u003c\/h2\u003e\n\u003cp\u003e线程是 CPU 的最小调度单位，CPU 通过不断切换线程来实现多任务的并发。这会引发一些问题（对于用户角度）：\u003c\/p\u003e\n\u003col\u003e\n\u003cli\u003e线程的创建和销毁等是昂贵的，因为要不断在用户空间和内核空间切换。\u003c\/li\u003e\n\u003cli\u003e线程的调度是由操作系统负责的，用户无法控制。而操作 …\u003c\/li\u003e\u003c\/ol\u003e","datePublished":"2024-12-07T14:23:31\u002b08:00","dateModified":"2024-12-07T14:23:31\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/go\/gmp_code\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
Archives</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
Search</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>从源码分析 GMP 调度原理</h1><div class=post-meta><time datetime=2024-12-07><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2024-12-07
</time><a href=/categories/go class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
go
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
15 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
3162 words</span></div></header><div class=post-body><p><strong>本身涉及到的 go 代码 都是基于 go 1.23.0 版本</strong></p><h2 id=传统-os-线程>传统 OS 线程</h2><p>线程是 CPU 的最小调度单位，CPU 通过不断切换线程来实现多任务的并发。这会引发一些问题（对于用户角度）：</p><ol><li>线程的创建和销毁等是昂贵的，因为要不断在用户空间和内核空间切换。</li><li>线程的调度是由操作系统负责的，用户无法控制。而操作系统又可能不知道线程已经 IO 阻塞，导致线程被调度，浪费 CPU 资源。</li><li>线程的栈是很大的，最新版 linux 默认是 8M，会引起内存浪费。</li><li>&mldr;&mldr;</li></ol><p>所以，最简单的办法就是复用线程，go 中使用的是 M:N 模型，即 M 个 OS 线程对应 N 个 任务。</p><h2 id=gmp-模型>GMP 模型</h2><ol><li>G</li></ol><p>goroutine, 一个 goroutine 代表一个任务。它有自己的栈空间，默认是 2K，栈空间可以动态增长。方式就是把旧的栈空间复制到新的栈空间，然后释放旧的栈空间。它的栈是在 heap （对于 OS） 上分配的。</p><ol start=2><li>M</li></ol><p>machine, 一个 M 代表一个 OS 线程。</p><ol start=3><li>P</li></ol><p>processor, 一个 P 代表一个逻辑处理器，它维护了一个 goroutine 队列。P 会把 goroutine 分配给 M，M 会执行 goroutine。默认的大小为 CPU 核心数。</p><p><img src=/images/gmp.png alt></p><h2 id=数据结构>数据结构</h2><h3 id=g>G</h3><p>结构体在 <code>src/runtime/runtime2.go</code> 中定义，主要介绍一些重要的字段：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>g</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// goroutine 的栈 两个地址，分别是栈的起始地址和结束地址</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>stack</span>       <span style=color:#75af00>stack</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 绑定的m</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>m</span>         <span style=color:#f92672>*</span><span style=color:#75af00>m</span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// goroutine 被调度走保存的中间状态</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>sched</span>     <span style=color:#75af00>gobuf</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// goroutine 的状态</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>atomicstatus</span> <span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Uint32</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>gobuf</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sp</span>   <span style=color:#00a8c8>uintptr</span> <span style=color:#75715e>// stack pointer 栈指针</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pc</span>   <span style=color:#00a8c8>uintptr</span> <span style=color:#75715e>// program counter 程序要从哪里开始执行</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>g</span>    <span style=color:#75af00>guintptr</span> <span style=color:#75715e>// goroutine 的 指针</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctxt</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span> <span style=color:#75715e>// 保存的上下文</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ret</span>  <span style=color:#00a8c8>uintptr</span> <span style=color:#75715e>// 返回地址</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lr</span>   <span style=color:#00a8c8>uintptr</span> <span style=color:#75715e>// link register</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>bp</span>   <span style=color:#00a8c8>uintptr</span> <span style=color:#75715e>// base pointer 栈的基地址</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=goroutine-状态>goroutine 状态</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// defined constants</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 未初始化</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gidle</span> <span style=color:#111>=</span> <span style=color:#00a8c8>iota</span> <span style=color:#75715e>// 0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 准备好了 可以被 P 调度</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Grunnable</span> <span style=color:#75715e>// 1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 正在执行中</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Grunning</span> <span style=color:#75715e>// 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 正在执行系统调用</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gsyscall</span> <span style=color:#75715e>// 3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 正在等待 例如 channel network 等</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gwaiting</span> <span style=color:#75715e>// 4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 没有被使用 为了兼容性</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gmoribund_unused</span> <span style=color:#75715e>// 5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 未使用的 goroutine </span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 1. 可能初始化了但是没有被使用 </span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 2. 因为会复用未扩栈的 goroutine 所以也可能上次使用完了 还没继续使用</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gdead</span> <span style=color:#75715e>// 6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 没有被使用 为了兼容性</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Genqueue_unused</span> <span style=color:#75715e>// 7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 栈扩容中</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gcopystack</span> <span style=color:#75715e>// 8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 被抢占了 等待到 _Gwaiting </span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gpreempted</span> <span style=color:#75715e>// 9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 用于 GC 扫描</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gscan</span>          <span style=color:#111>=</span> <span style=color:#ae81ff>0x1000</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gscanrunnable</span>  <span style=color:#111>=</span> <span style=color:#75af00>_Gscan</span> <span style=color:#f92672>+</span> <span style=color:#75af00>_Grunnable</span>  <span style=color:#75715e>// 0x1001</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gscanrunning</span>   <span style=color:#111>=</span> <span style=color:#75af00>_Gscan</span> <span style=color:#f92672>+</span> <span style=color:#75af00>_Grunning</span>   <span style=color:#75715e>// 0x1002</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gscansyscall</span>   <span style=color:#111>=</span> <span style=color:#75af00>_Gscan</span> <span style=color:#f92672>+</span> <span style=color:#75af00>_Gsyscall</span>   <span style=color:#75715e>// 0x1003</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gscanwaiting</span>   <span style=color:#111>=</span> <span style=color:#75af00>_Gscan</span> <span style=color:#f92672>+</span> <span style=color:#75af00>_Gwaiting</span>   <span style=color:#75715e>// 0x1004</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Gscanpreempted</span> <span style=color:#111>=</span> <span style=color:#75af00>_Gscan</span> <span style=color:#f92672>+</span> <span style=color:#75af00>_Gpreempted</span> <span style=color:#75715e>// 0x1009</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span></code></pre></div><h4 id=g-的创建>G 的创建</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>malg</span><span style=color:#111>(</span><span style=color:#75af00>stacksize</span> <span style=color:#00a8c8>int32</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>newg</span> <span style=color:#f92672>:=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>g</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 分配 runtime 栈</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>stacksize</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stacksize</span> <span style=color:#111>=</span> <span style=color:#75af00>round2</span><span style=color:#111>(</span><span style=color:#75af00>stackSystem</span> <span style=color:#f92672>+</span> <span style=color:#75af00>stacksize</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>newg</span><span style=color:#111>.</span><span style=color:#75af00>stack</span> <span style=color:#111>=</span> <span style=color:#75af00>stackalloc</span><span style=color:#111>(</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#75af00>stacksize</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>newg</span><span style=color:#111>.</span><span style=color:#75af00>stackguard0</span> <span style=color:#111>=</span> <span style=color:#75af00>newg</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>.</span><span style=color:#75af00>lo</span> <span style=color:#f92672>+</span> <span style=color:#75af00>stackGuard</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>newg</span><span style=color:#111>.</span><span style=color:#75af00>stackguard1</span> <span style=color:#111>=</span> <span style=color:#111>^</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#00a8c8>uintptr</span><span style=color:#111>)(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>newg</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>.</span><span style=color:#75af00>lo</span><span style=color:#111>))</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>newg</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>状态流转:</p><p><img src=/images/gmp_g_status.png alt></p><ol><li>如果 groutine 还未初始化，那么状态是 <code>_Gidle</code></li><li>初始化完毕是 <code>_Gdead</code></li><li>当被调用 go func() 时，状态变为 <code>_Grunnable</code></li><li>当被调度到 M 上执行时，状态变为 <code>_Grunning</code></li><li>执行完毕后，状态变为 <code>_Gdead</code></li><li>如果 goroutine 阻塞，状态变为 <code>_Gwaiting</code> 等待阻塞完毕 状态再变为 <code>_Grunnable</code> 等待调度</li><li>如果 goroutine 被抢占 （gc 要 STW 时），状态变为 <code>_Gpreempted</code> 等待变成 <code>_Gwaiting</code></li><li>如果发生系统调用，状态变为 <code>_Gsyscall</code> 如果很快完成（10ms） 状态会变为 <code>_Grunning</code> 继续执行 否则会变为 <code>_Grunnable</code> 等待调度</li><li>如果发生栈扩容，状态变为 <code>_Gcopystack</code> 等待栈扩容完毕 状态变为 <code>_Grunning</code> 等待调度</li></ol><h3 id=m>M</h3><p>结构体在 <code>src/runtime/runtime2.go</code> 中定义，主要介绍一些重要的字段：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>m</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>g0</span>      <span style=color:#f92672>*</span><span style=color:#75af00>g</span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 寄存器上下文</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>morebuf</span> <span style=color:#75af00>gobuf</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// tls 是线程本地存储 用于存储 M 相关的线程本地数据 包括当前 G 的引用等重要信息</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>tls</span>           <span style=color:#111>[</span><span style=color:#75af00>tlsSlots</span><span style=color:#111>]</span><span style=color:#00a8c8>uintptr</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 现在正在执行的 goroutine</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>curg</span>          <span style=color:#f92672>*</span><span style=color:#75af00>g</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 1. 正常执行： p 有效</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 2. 系统调用前： p -&gt; oldp</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 3. 系统调用中： p == nil</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 4. 系统调用返回： 尝试重新获取 oldp</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span>             <span style=color:#75af00>puintptr</span> 
</span></span><span style=display:flex><span>	<span style=color:#75af00>nextp</span>         <span style=color:#75af00>puintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>oldp</span>          <span style=color:#75af00>puintptr</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=m-的创建>M 的创建</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>newm</span><span style=color:#111>(</span><span style=color:#75af00>fn</span> <span style=color:#00a8c8>func</span><span style=color:#111>(),</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>id</span> <span style=color:#00a8c8>int64</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 禁止被抢占</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>acquirem</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 分配 M 结构体 并添加列表中</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>allocm</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#75af00>fn</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置 nextP m 会尽量与之绑定</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>nextp</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>sigmask</span> <span style=color:#111>=</span> <span style=color:#75af00>initSigmask</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建 M</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>newm1</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 释放 m 的锁定状态</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>allocm</span><span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>fn</span> <span style=color:#00a8c8>func</span><span style=color:#111>(),</span> <span style=color:#75af00>id</span> <span style=color:#00a8c8>int64</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>m</span> <span style=color:#111>{</span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ... 加锁解锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果当前 M 没有绑定 P，临时借用传入的 P</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>acquirep</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>)</span> <span style=color:#75715e>// temporarily borrow p for mallocs in this function</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 处理空闲的 M </span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>freem</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建 M</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span> <span style=color:#f92672>:=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>mstartfn</span> <span style=color:#111>=</span> <span style=color:#75af00>fn</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mcommoninit</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 对于 cgo 或者特定的操作系统 使用系统分配的栈 否则使用 go runtime 的栈</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>iscgo</span> <span style=color:#f92672>||</span> <span style=color:#75af00>mStackIsSystemAllocated</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span> <span style=color:#111>=</span> <span style=color:#75af00>malg</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span> <span style=color:#111>=</span> <span style=color:#75af00>malg</span><span style=color:#111>(</span><span style=color:#ae81ff>16384</span> <span style=color:#f92672>*</span> <span style=color:#75af00>sys</span><span style=color:#111>.</span><span style=color:#75af00>StackGuardMultiplier</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span><span style=color:#111>.</span><span style=color:#75af00>m</span> <span style=color:#111>=</span> <span style=color:#75af00>mp</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清理临时借用的 P</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>==</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>releasep</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>mp</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// newm1 -&gt; newosproc </span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>newosproc</span><span style=color:#111>(</span><span style=color:#75af00>mp</span> <span style=color:#f92672>*</span><span style=color:#75af00>m</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 栈顶指针</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>stk</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>.</span><span style=color:#75af00>hi</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 信号屏蔽</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>oset</span> <span style=color:#75af00>sigset</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sigprocmask</span><span style=color:#111>(</span><span style=color:#75af00>_SIG_SETMASK</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>sigset_all</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>oset</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 重试的系统调用</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ret</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>retryOnEAGAIN</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#00a8c8>int32</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建新线程 是汇编代码 可以找去看看</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>r</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>clone</span><span style=color:#111>(</span><span style=color:#75af00>cloneFlags</span><span style=color:#111>,</span> <span style=color:#75af00>stk</span><span style=color:#111>,</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span><span style=color:#111>),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>abi</span><span style=color:#111>.</span><span style=color:#75af00>FuncPCABI0</span><span style=color:#111>(</span><span style=color:#75af00>mstart</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>r</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#f92672>-</span><span style=color:#75af00>r</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 恢复信号</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sigprocmask</span><span style=color:#111>(</span><span style=color:#75af00>_SIG_SETMASK</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>oset</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// mstart 启动 M 是一个汇编代码</span>
</span></span><span style=display:flex><span><span style=color:#75af00>TEXT</span> <span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>mstart</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span><span style=color:#75af00>NOSPLIT</span><span style=color:#111>|</span><span style=color:#75af00>TOPFRAME</span><span style=color:#111>|</span><span style=color:#75af00>NOFRAME</span><span style=color:#111>,</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>CALL</span>	<span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>mstart0</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span> <span style=color:#75715e>// 调用 mstart0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>RET</span> <span style=color:#75715e>// not reached</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// mstart0 -&gt; mstart1</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>mstart1</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>g0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>throw</span><span style=color:#111>(</span><span style=color:#d88200>&#34;bad runtime·mstart&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 保存调度信息</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>g</span> <span style=color:#111>=</span> <span style=color:#75af00>guintptr</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>pc</span> <span style=color:#111>=</span> <span style=color:#75af00>getcallerpc</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>sp</span> <span style=color:#111>=</span> <span style=color:#75af00>getcallersp</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 初始化</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>asminit</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>minit</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 主线程初始一些东西</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span> <span style=color:#f92672>==</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>m0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mstartm0</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 调度</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>schedule</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 初始化信号 之后抢占那块会介绍</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 只有主线程需要初始化的原因是 其他线程是 clone 而来 而且包括了 _CLONE_SIGHAND 会继承这些</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>mstartm0</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>initsig</span><span style=color:#111>(</span><span style=color:#00a8c8>false</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>g0： 一个特殊的 g 用于执行调度任务</p><p><img src=/images/gmp_g0.png alt></p><p>流程大概为用户态的 g -> g0 调度 -> 用户的其他 g</p><h3 id=p>P</h3><p>结构体在 <code>src/runtime/runtime2.go</code> 中定义，主要介绍一些重要的字段：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>p</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// p 的状态</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>status</span>      <span style=color:#00a8c8>uint32</span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 分配内存使用 每个p 都有的目的是少加锁</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>mcache</span>      <span style=color:#f92672>*</span><span style=color:#75af00>mcache</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 定长的 queue 用于存储 goroutine</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>runqhead</span> <span style=color:#00a8c8>uint32</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>runqtail</span> <span style=color:#00a8c8>uint32</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>runq</span>     <span style=color:#111>[</span><span style=color:#ae81ff>256</span><span style=color:#111>]</span><span style=color:#75af00>guintptr</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//  下个运行的 goroutine 主要用来快速调度 比如从 chan 读取数据，把 g 放到 runnext 中 当完成读取时 直接从 runnext 中取出来执行</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>runnext</span> <span style=color:#75af00>guintptr</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>状态：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 空闲</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Pidle</span> <span style=color:#111>=</span> <span style=color:#00a8c8>iota</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 正在运行中</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Prunning</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 正在执行系统调用</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Psyscall</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// GC 停止</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Pgcstop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 死亡状态</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_Pdead</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span></code></pre></div><h4 id=p的创建>P的创建</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 程序启动</span>
</span></span><span style=display:flex><span><span style=color:#75af00>TEXT</span> <span style=color:#75af00>main</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span><span style=color:#75af00>NOSPLIT</span><span style=color:#111>,</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>JMP</span>	<span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>rt0_go</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>TEXT</span> <span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>rt0_go</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span><span style=color:#75af00>NOSPLIT</span><span style=color:#111>|</span><span style=color:#75af00>NOFRAME</span><span style=color:#111>|</span><span style=color:#75af00>TOPFRAME</span><span style=color:#111>,</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#75af00>CALL</span>	<span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>schedinit</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>schedinit</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>procresize</span><span style=color:#111>(</span><span style=color:#75af00>procs</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>throw</span><span style=color:#111>(</span><span style=color:#d88200>&#34;unknown runnable goroutine during bootstrap&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// nprocs 是 process 数 默认是 cpu 个数</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>procresize</span><span style=color:#111>(</span><span style=color:#75af00>nprocs</span> <span style=color:#00a8c8>int32</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 扩容 allp 加入未初始化的 P</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>nprocs</span> <span style=color:#111>&gt;</span> <span style=color:#111>int32</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>allp</span><span style=color:#111>))</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 。。。</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 初始化所有新建的 P</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>old</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>nprocs</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>allp</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span> <span style=color:#111>=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>init</span><span style=color:#111>(</span><span style=color:#75af00>i</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>atomicstorep</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>allp</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 处理 p 的状态</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>id</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>nprocs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// continue to use the current P</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>status</span> <span style=color:#111>=</span> <span style=color:#75af00>_Prunning</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>mcache</span><span style=color:#111>.</span><span style=color:#75af00>prepareForSweep</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// g.m.p is now set, so we no longer need mcache0 for bootstrapping.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mcache0</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清理多余的 P</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>nprocs</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>old</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>allp</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>destroy</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// can&#39;t free P itself because it can be referenced by an M in syscall</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 裁剪 allp 切片</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>int32</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>allp</span><span style=color:#111>))</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>nprocs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>allpLock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>allp</span> <span style=color:#111>=</span> <span style=color:#75af00>allp</span><span style=color:#111>[:</span><span style=color:#75af00>nprocs</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>idlepMask</span> <span style=color:#111>=</span> <span style=color:#75af00>idlepMask</span><span style=color:#111>[:</span><span style=color:#75af00>maskWords</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>timerpMask</span> <span style=color:#111>=</span> <span style=color:#75af00>timerpMask</span><span style=color:#111>[:</span><span style=color:#75af00>maskWords</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>allpLock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 重新分配 P</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>runnablePs</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>nprocs</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>--</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>allp</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#75af00>pp</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>status</span> <span style=color:#111>=</span> <span style=color:#75af00>_Pidle</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>runqempty</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pidleput</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#75af00>now</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>mget</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>link</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>runnablePs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>runnablePs</span> <span style=color:#111>=</span> <span style=color:#75af00>pp</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>stealOrder</span><span style=color:#111>.</span><span style=color:#75af00>reset</span><span style=color:#111>(</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#75af00>nprocs</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>int32p</span> <span style=color:#f92672>*</span><span style=color:#00a8c8>int32</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>gomaxprocs</span> <span style=color:#75715e>// make compiler check that gomaxprocs is an int32</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Store</span><span style=color:#111>((</span><span style=color:#f92672>*</span><span style=color:#00a8c8>uint32</span><span style=color:#111>)(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>int32p</span><span style=color:#111>)),</span> <span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#75af00>nprocs</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>old</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>nprocs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Notify the limiter that the amount of procs has changed.</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcCPULimiter</span><span style=color:#111>.</span><span style=color:#75af00>resetCapacity</span><span style=color:#111>(</span><span style=color:#75af00>now</span><span style=color:#111>,</span> <span style=color:#75af00>nprocs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>runnablePs</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>)</span> <span style=color:#75af00>init</span><span style=color:#111>(</span><span style=color:#75af00>id</span> <span style=color:#00a8c8>int32</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 分配 cache</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mcache</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>id</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>mcache0</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>throw</span><span style=color:#111>(</span><span style=color:#d88200>&#34;missing mcache?&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Use the bootstrap mcache0. Only one P will get</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// mcache0: the one with ID 0.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mcache</span> <span style=color:#111>=</span> <span style=color:#75af00>mcache0</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mcache</span> <span style=color:#111>=</span> <span style=color:#75af00>allocmcache</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>)</span> <span style=color:#75af00>destroy</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 枷锁 确保 stw</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>assertLockHeld</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>assertWorldStopped</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将本地队列中的 goroutine 移到全局队列</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runqhead</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runqtail</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runqtail</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runq</span><span style=color:#111>[</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runqtail</span><span style=color:#f92672>%</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runq</span><span style=color:#111>))].</span><span style=color:#75af00>ptr</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>globrunqputhead</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runnext</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>globrunqputhead</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runnext</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runnext</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清理 span</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mspancache</span><span style=color:#111>.</span><span style=color:#75af00>len</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Safe to call since the world is stopped.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>spanalloc</span><span style=color:#111>.</span><span style=color:#75af00>free</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mspancache</span><span style=color:#111>.</span><span style=color:#75af00>buf</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]))</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mspancache</span><span style=color:#111>.</span><span style=color:#75af00>len</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>pcache</span><span style=color:#111>.</span><span style=color:#75af00>flush</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>pages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 释放 mcache</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>freemcache</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mcache</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mcache</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=全局队列>全局队列</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>schedt</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lock</span> <span style=color:#75af00>mutex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// m 相关配置</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>midle</span>        <span style=color:#75af00>muintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// p 相关配置 </span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pidle</span>        <span style=color:#75af00>puintptr</span> <span style=color:#75715e>// idle p&#39;s</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// g 队列</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>runq</span>     <span style=color:#75af00>gQueue</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>runqsize</span> <span style=color:#00a8c8>int32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// G 对象池</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gFree</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span>    <span style=color:#75af00>mutex</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stack</span>   <span style=color:#75af00>gList</span> <span style=color:#75715e>// Gs with stacks</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>noStack</span> <span style=color:#75af00>gList</span> <span style=color:#75715e>// Gs without stacks</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>n</span>       <span style=color:#00a8c8>int32</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>P 的空闲列表： M 获取 P 的时候拿到
M 的空闲列表： 线程的创建于销毁代价是很大的 为了复用性</p><h2 id=调度>调度</h2><p>go 有三种进行到调度的方式：</p><ol><li>用户 goroutine 主动执行 runtime.Gosched() 会把当前 goroutine 放到队列中等待调度</li><li>用户 goroutine 阻塞，例如 channel 读写，网络 IO 等 会主动调用修改自己状态并切换到 g0 执行调度任务</li><li>go runtime 中有个 OS 线程 （名称是 sysmon） 检测到 goroutine 超时（上次执行到现在超过 10ms）那就会给线程发信号 使其切换到 g0 执行调度任务</li></ol><p><em><strong>为什么 sysmon 使用物理线程而不是 goroutine 呢？</strong></em></p><p>因为所有 p 上正在执行的 g 都阻塞住了 比如 <code>for {}</code> 那么其他的 g 永远无法执行了包括负责检测的 sysmon</p><h3 id=主动调度>主动调度</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Gosched</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>checkTimeouts</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mcall</span><span style=color:#111>(</span><span style=color:#75af00>gosched_m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=阻塞调度>阻塞调度</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gopark</span><span style=color:#111>(</span><span style=color:#75af00>unlockf</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span><span style=color:#111>,</span> <span style=color:#75af00>lock</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>,</span> <span style=color:#75af00>reason</span> <span style=color:#75af00>waitReason</span><span style=color:#111>,</span> <span style=color:#75af00>traceReason</span> <span style=color:#75af00>traceBlockReason</span><span style=color:#111>,</span> <span style=color:#75af00>traceskip</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>reason</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>waitReasonSleep</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>checkTimeouts</span><span style=color:#111>()</span> <span style=color:#75715e>// timeouts may expire while two goroutines keep the scheduler busy</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>acquirem</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>curg</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>status</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>readgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>status</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>_Grunning</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>status</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>_Gscanrunning</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>throw</span><span style=color:#111>(</span><span style=color:#d88200>&#34;gopark: bad g status&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>waitlock</span> <span style=color:#111>=</span> <span style=color:#75af00>lock</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>waitunlockf</span> <span style=color:#111>=</span> <span style=color:#75af00>unlockf</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>waitreason</span> <span style=color:#111>=</span> <span style=color:#75af00>reason</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>waitTraceBlockReason</span> <span style=color:#111>=</span> <span style=color:#75af00>traceReason</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>waitTraceSkip</span> <span style=color:#111>=</span> <span style=color:#75af00>traceskip</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// can&#39;t do anything that might move the G between Ms here.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mcall</span><span style=color:#111>(</span><span style=color:#75af00>park_m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=抢占调度>抢占调度</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// m 在 start 的时候会注册一些信号处理函数</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>initsig</span><span style=color:#111>(</span><span style=color:#75af00>preinit</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>);</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>_NSIG</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>setsig</span><span style=color:#111>(</span><span style=color:#75af00>i</span><span style=color:#111>,</span> <span style=color:#75af00>abi</span><span style=color:#111>.</span><span style=color:#75af00>FuncPCABIInternal</span><span style=color:#111>(</span><span style=color:#75af00>sighandler</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// sighandler -&gt; doSigPreempt -&gt; asyncPreempt （去汇编代码里找） -&gt; asyncPreempt2 </span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>asyncPreempt2</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>asyncSafePoint</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>preemptStop</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mcall</span><span style=color:#111>(</span><span style=color:#75af00>preemptPark</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mcall</span><span style=color:#111>(</span><span style=color:#75af00>gopreempt_m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>asyncSafePoint</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// sysmon 发信号 </span>
</span></span><span style=display:flex><span><span style=color:#75715e>// sysmon -&gt; retake -&gt; preemptone -&gt; preemptM</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>preemptM</span><span style=color:#111>(</span><span style=color:#75af00>mp</span> <span style=color:#f92672>*</span><span style=color:#75af00>m</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>signalPending</span><span style=color:#111>.</span><span style=color:#75af00>CompareAndSwap</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>signalM</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>,</span> <span style=color:#75af00>sigPreempt</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>signalM</span><span style=color:#111>(</span><span style=color:#75af00>mp</span> <span style=color:#f92672>*</span><span style=color:#75af00>m</span><span style=color:#111>,</span> <span style=color:#75af00>sig</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>tgkill</span><span style=color:#111>(</span><span style=color:#75af00>getpid</span><span style=color:#111>(),</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>procid</span><span style=color:#111>),</span> <span style=color:#75af00>sig</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 代码在在汇编里 就是对线程发送信号 系统调用</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>tgkill</span><span style=color:#111>(</span><span style=color:#75af00>tgid</span><span style=color:#111>,</span> <span style=color:#75af00>tid</span><span style=color:#111>,</span> <span style=color:#75af00>sig</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span>
</span></span></code></pre></div><h3 id=调度代码>调度代码</h3><p>可以看到调度代码都是通过 mcall 调用的，mcall 会切换到 g0 执行调度任务 如果参数的函数不太一样 但是都是处理一些状态信息等，最好都会执行到 schedule 函数。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>schedule</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 核心代码就是选一个 g 去执行</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span><span style=color:#111>,</span> <span style=color:#75af00>tryWakeP</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>findRunnable</span><span style=color:#111>()</span> <span style=color:#75715e>// blocks until work is available</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>execute</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>findRunnable：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>findRunnable</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>gp</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span><span style=color:#111>,</span> <span style=color:#75af00>tryWakeP</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Try to schedule a GC worker.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gcBlackenEnabled</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>tnow</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>gcController</span><span style=color:#111>.</span><span style=color:#75af00>findRunnableGCWorker</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#75af00>now</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>now</span> <span style=color:#111>=</span> <span style=color:#75af00>tnow</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>schedtick</span><span style=color:#f92672>%</span><span style=color:#ae81ff>61</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>runqsize</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>globrunqget</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// local runq</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>runqget</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>);</span> <span style=color:#75af00>gp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// global runq</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>runqsize</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>globrunqget</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>netpollinited</span><span style=color:#111>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>netpollAnyWaiters</span><span style=color:#111>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lastpoll</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>list</span><span style=color:#111>,</span> <span style=color:#75af00>delta</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>netpoll</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>);</span> <span style=color:#111>!</span><span style=color:#75af00>list</span><span style=color:#111>.</span><span style=color:#75af00>empty</span><span style=color:#111>()</span> <span style=color:#111>{</span> <span style=color:#75715e>// non-blocking</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>list</span><span style=color:#111>.</span><span style=color:#75af00>pop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>injectglist</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>list</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>netpollAdjustWaiters</span><span style=color:#111>(</span><span style=color:#75af00>delta</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>trace</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>traceAcquire</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Gwaiting</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunnable</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>trace</span><span style=color:#111>.</span><span style=color:#75af00>ok</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>trace</span><span style=color:#111>.</span><span style=color:#75af00>GoUnpark</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>traceRelease</span><span style=color:#111>(</span><span style=color:#75af00>trace</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Spinning Ms: steal work from other Ps.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// Limit the number of spinning Ms to half the number of busy Ps.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This is necessary to prevent excessive CPU consumption when</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// GOMAXPROCS&gt;&gt;1 but the program parallelism is low.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>spinning</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>nmspinning</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>gomaxprocs</span><span style=color:#f92672>-</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>npidle</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>spinning</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>becomeSpinning</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span><span style=color:#111>,</span> <span style=color:#75af00>tnow</span><span style=color:#111>,</span> <span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>newWork</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>stealWork</span><span style=color:#111>(</span><span style=color:#75af00>now</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Successfully stole.</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>newWork</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// There may be new timer or GC work; restart to</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// discover.</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>goto</span> <span style=color:#75af00>top</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>now</span> <span style=color:#111>=</span> <span style=color:#75af00>tnow</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>w</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>(</span><span style=color:#75af00>pollUntil</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#75af00>w</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>pollUntil</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Earlier timer to wait for.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pollUntil</span> <span style=color:#111>=</span> <span style=color:#75af00>w</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>简化了一下代码还是很多 价绍一些这个功能吧</p><ol><li>优先执行 GC worker</li><li>每 61 次 从全局队列中获取一个 g 去执行 作用是 防止所有 p 的本地队列谁都非常多 导致全局队列的 g 饿死</li><li>从本地队列中获取一个 g 去执行 有限使用 runnext</li><li>从全局队列中获取一个 g 去执行 并 load 一些到本地队列</li><li>如果有网络 IO 准备好了 就从网络 IO 中获取一个 g 去执行 （go 中网络 epoll_wait 正常情况下使用的非阻塞模式）</li><li>从其他的 p 中偷取 g 去执行 （cas 保证数据安全）</li></ol><p>execute：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>execute</span><span style=color:#111>(</span><span style=color:#75af00>gp</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#75af00>inheritTime</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 修改状态</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunnable</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 执行</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gogo</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>sched</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>我的 arch 是 amd64 所以代码在 <code>src/runtime/asm_amd64.s</code> 中</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>TEXT</span> <span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>gogo</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span> <span style=color:#75af00>NOSPLIT</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>buf</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>(</span><span style=color:#75af00>FP</span><span style=color:#111>),</span> <span style=color:#75af00>BX</span>	  <span style=color:#75715e>// 将 gobuf 指针加载到 BX 寄存器</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>gobuf_g</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>),</span> <span style=color:#75af00>DX</span>  <span style=color:#75715e>// 将 gobuf 中保存的 g 指针加载到 DX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#ae81ff>0</span><span style=color:#111>(</span><span style=color:#75af00>DX</span><span style=color:#111>),</span> <span style=color:#75af00>CX</span>	  <span style=color:#75715e>// 检查 g 不为 nil</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>JMP</span>	<span style=color:#75af00>gogo</span><span style=color:#111>&lt;&gt;(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>TEXT</span> <span style=color:#75af00>gogo</span><span style=color:#111>&lt;&gt;(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span> <span style=color:#75af00>NOSPLIT</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>get_tls</span><span style=color:#111>(</span><span style=color:#75af00>CX</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>DX</span><span style=color:#111>,</span> <span style=color:#75af00>g</span><span style=color:#111>(</span><span style=color:#75af00>CX</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>DX</span><span style=color:#111>,</span> <span style=color:#75af00>R14</span>		<span style=color:#75715e>// set the g register</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 恢复寄存器状态 （sp ret bp ctxt） 执行 </span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>gobuf_sp</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>),</span> <span style=color:#75af00>SP</span>	<span style=color:#75715e>// restore SP</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>gobuf_ret</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>),</span> <span style=color:#75af00>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>gobuf_ctxt</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>),</span> <span style=color:#75af00>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>gobuf_bp</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>),</span> <span style=color:#75af00>BP</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 加载之后 清空 go 的 gobuf 结构体 为了给 gc 节省压力</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>gobuf_sp</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>)</span>	
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>gobuf_ret</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>gobuf_ctxt</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>gobuf_bp</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 跳转到保存的 PC （程序执行到哪了） 去执行</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>gobuf_pc</span><span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>),</span> <span style=color:#75af00>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>JMP</span>	<span style=color:#75af00>BX</span>
</span></span></code></pre></div><h3 id=syscall>syscall</h3><p>我的 arch 是 and64 操作系统是 linux 所以代码在 <code>src/runtime/asm_linux_amd64.s</code> 中</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>SyscallNoError</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span><span style=color:#75af00>NOSPLIT</span><span style=color:#111>,</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>CALL</span>	<span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>entersyscall</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>a1</span><span style=color:#f92672>+</span><span style=color:#ae81ff>8</span><span style=color:#111>(</span><span style=color:#75af00>FP</span><span style=color:#111>),</span> <span style=color:#75af00>DI</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>a2</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>FP</span><span style=color:#111>),</span> <span style=color:#75af00>SI</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>a3</span><span style=color:#f92672>+</span><span style=color:#ae81ff>24</span><span style=color:#111>(</span><span style=color:#75af00>FP</span><span style=color:#111>),</span> <span style=color:#75af00>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>R10</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>R8</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>R9</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>trap</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>(</span><span style=color:#75af00>FP</span><span style=color:#111>),</span> <span style=color:#75af00>AX</span>	<span style=color:#75715e>// syscall entry</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>SYSCALL</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>AX</span><span style=color:#111>,</span> <span style=color:#75af00>r1</span><span style=color:#f92672>+</span><span style=color:#ae81ff>32</span><span style=color:#111>(</span><span style=color:#75af00>FP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>DX</span><span style=color:#111>,</span> <span style=color:#75af00>r2</span><span style=color:#f92672>+</span><span style=color:#ae81ff>40</span><span style=color:#111>(</span><span style=color:#75af00>FP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>CALL</span>	<span style=color:#75af00>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>exitsyscall</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>RET</span>
</span></span></code></pre></div><p>系统调用前执行这个函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>entersyscall</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getcallerfp</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>reentersyscall</span><span style=color:#111>(</span><span style=color:#75af00>getcallerpc</span><span style=color:#111>(),</span> <span style=color:#75af00>getcallersp</span><span style=color:#111>(),</span> <span style=color:#75af00>fp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>reentersyscall</span><span style=color:#111>(</span><span style=color:#75af00>pc</span><span style=color:#111>,</span> <span style=color:#75af00>sp</span><span style=color:#111>,</span> <span style=color:#75af00>bp</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 保存寄存器信息</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>save</span><span style=color:#111>(</span><span style=color:#75af00>pc</span><span style=color:#111>,</span> <span style=color:#75af00>sp</span><span style=color:#111>,</span> <span style=color:#75af00>bp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>syscallsp</span> <span style=color:#111>=</span> <span style=color:#75af00>sp</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>syscallpc</span> <span style=color:#111>=</span> <span style=color:#75af00>pc</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>syscallbp</span> <span style=color:#111>=</span> <span style=color:#75af00>bp</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 修改 g 状态</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>,</span> <span style=color:#75af00>_Gsyscall</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>sysmonwait</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#75af00>entersyscall_sysmon</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>save</span><span style=color:#111>(</span><span style=color:#75af00>pc</span><span style=color:#111>,</span> <span style=color:#75af00>sp</span><span style=color:#111>,</span> <span style=color:#75af00>bp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>runSafePointFn</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// runSafePointFn may stack split if run on this stack</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#75af00>runSafePointFn</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>save</span><span style=color:#111>(</span><span style=color:#75af00>pc</span><span style=color:#111>,</span> <span style=color:#75af00>sp</span><span style=color:#111>,</span> <span style=color:#75af00>bp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>syscalltick</span> <span style=color:#111>=</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>syscalltick</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 解绑 P 和 M 并设置 oldP 为当前 P 等待系统调用之后重新绑定</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>m</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>oldp</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 修改 P 的状态为 syscall</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Store</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>status</span><span style=color:#111>,</span> <span style=color:#75af00>_Psyscall</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>gcwaiting</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#75af00>entersyscall_gcwait</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>save</span><span style=color:#111>(</span><span style=color:#75af00>pc</span><span style=color:#111>,</span> <span style=color:#75af00>sp</span><span style=color:#111>,</span> <span style=color:#75af00>bp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>locks</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>系统调用后执行这个函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>exitsyscall</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果之前保存的oldp不为空 那么重新绑定</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>exitsyscallfast</span><span style=color:#111>(</span><span style=color:#75af00>oldp</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 设置状态为 runnable 并重新执行</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Gsyscall</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>disable</span><span style=color:#111>.</span><span style=color:#75af00>user</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>schedEnabled</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Scheduling of this goroutine is disabled.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Gosched</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 切换到 g0 执行 exitsyscall0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mcall</span><span style=color:#111>(</span><span style=color:#75af00>exitsyscall0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>exitsyscall0</span><span style=color:#111>(</span><span style=color:#75af00>gp</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 修改 g 状态到 _Grunnable 让重新可调度</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Gsyscall</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunnable</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 删除 gm 的绑定</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>dropg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 找个空闲的 p （状态为 _Gidle） 与 M 绑定</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>schedEnabled</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#111>=</span> <span style=color:#75af00>pidleget</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>locked</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果绑定失败了 直接把 g 放到全局队列中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>globrunqput</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>locked</span> <span style=color:#111>=</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>lockedm</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>sysmonwait</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果 sysmon 在等待 那么唤醒它</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>sysmonwait</span><span style=color:#111>.</span><span style=color:#75af00>Store</span><span style=color:#111>(</span><span style=color:#00a8c8>false</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>notewakeup</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>sysmonnote</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果找到 p 了 那么就去执行</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>acquirep</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>execute</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>)</span> <span style=color:#75715e>// Never returns.</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>locked</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Wait until another thread schedules gp and so m again.</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>		// N.B. lockedm must be this M, as this g was running on this M</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// before entersyscall.</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stoplockedm</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>execute</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>)</span> <span style=color:#75715e>// Never returns.</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 如果没有 P 给我这个 M 绑定的话 那么把 M 休眠并加入到 schedlink 队列中  做复用</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>stopm</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 直到有新的 g 被调度到这个 M 上</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>schedule</span><span style=color:#111>()</span> <span style=color:#75715e>// Never returns.</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=goroutine-切换通用寄存器问题>goroutine 切换通用寄存器问题</h2><p>我们知道 goroutine 中的 gobuf 中只保存了 sp pc bp 等寄存器信息，但是 goroutine 切换的时候还有其他通用寄存器，如果中间丢失会引起结果不一致。那么 go 中是怎么保存的呢？</p><p>goroutine 切换大体有两种情况</p><ol><li>在编译阶段知道 goroutine 可能交出控制权 比如 读写 channel 等待网络 系统调用等</li><li>goroutine 被抢占了 GC 超时等</li></ol><p>对于第一种方式，在编译阶段知道后续会使用哪个寄存器和知道在哪里可能会交出控制权，就会在后续保存这些寄存器。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>test</span><span style=color:#111>(</span><span style=color:#75af00>a</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>c</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>int</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>d</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>a</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>d</span> <span style=color:#f92672>+</span> <span style=color:#75af00>b</span> <span style=color:#f92672>+</span> <span style=color:#75af00>c</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// go tool compile -S main.go 的汇编代码</span>
</span></span><span style=display:flex><span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test</span> <span style=color:#75af00>STEXT</span> <span style=color:#75af00>size</span><span style=color:#111>=</span><span style=color:#ae81ff>105</span> <span style=color:#75af00>args</span><span style=color:#111>=</span><span style=color:#ae81ff>0x18</span> <span style=color:#75af00>locals</span><span style=color:#111>=</span><span style=color:#ae81ff>0x20</span> <span style=color:#75af00>funcid</span><span style=color:#111>=</span><span style=color:#ae81ff>0x0</span> <span style=color:#75af00>align</span><span style=color:#111>=</span><span style=color:#ae81ff>0x0</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>TEXT</span>	<span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span> <span style=color:#75af00>ABIInternal</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>32</span><span style=color:#f92672>-</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 栈检查</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>CMPQ</span>	<span style=color:#75af00>SP</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>R14</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0004</span> <span style=color:#ae81ff>00004</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0004</span> <span style=color:#ae81ff>00004</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>JLS</span>	<span style=color:#ae81ff>68</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0006</span> <span style=color:#ae81ff>00006</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0006</span> <span style=color:#ae81ff>00006</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>PUSHQ</span>	<span style=color:#75af00>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0007</span> <span style=color:#ae81ff>00007</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>SP</span><span style=color:#111>,</span> <span style=color:#75af00>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x000a</span> <span style=color:#ae81ff>00010</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>SUBQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>24</span><span style=color:#111>,</span> <span style=color:#75af00>SP</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 调试使用的</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x000e</span> <span style=color:#ae81ff>00014</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>gclocals</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>wgcWObbY2HYnK2SU</span><span style=color:#f92672>/</span><span style=color:#75af00>U22lA</span><span style=color:#f92672>==</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x000e</span> <span style=color:#ae81ff>00014</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#75af00>gclocals</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>J5F</span><span style=color:#f92672>+</span><span style=color:#ae81ff>7</span><span style=color:#75af00>Qw7O7ve2QcWC7DpeQ</span><span style=color:#f92672>==</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x000e</span> <span style=color:#ae81ff>00014</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>.</span><span style=color:#75af00>arginfo1</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x000e</span> <span style=color:#ae81ff>00014</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>6</span><span style=color:#111>,</span> <span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>.</span><span style=color:#75af00>argliveinfo</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x000e</span> <span style=color:#ae81ff>00014</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 把 BX CX 保存到栈中</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x000e</span> <span style=color:#ae81ff>00014</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>BX</span><span style=color:#111>,</span> <span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>b</span><span style=color:#f92672>+</span><span style=color:#ae81ff>48</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0013</span> <span style=color:#ae81ff>0001</span><span style=color:#ae81ff>9</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>CX</span><span style=color:#111>,</span> <span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>c</span><span style=color:#f92672>+</span><span style=color:#ae81ff>56</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0018</span> <span style=color:#ae81ff>00024</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 初始化临时变量 并 chanrecv1 接受 chan 数据</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0018</span> <span style=color:#ae81ff>00024</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>main</span><span style=color:#111>..</span><span style=color:#75af00>autotmp_5</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0021</span> <span style=color:#ae81ff>00033</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>	<span style=color:#75af00>LEAQ</span>	<span style=color:#75af00>main</span><span style=color:#111>..</span><span style=color:#75af00>autotmp_5</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0026</span> <span style=color:#ae81ff>0003</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0026</span> <span style=color:#ae81ff>0003</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>	<span style=color:#75af00>CALL</span>	<span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>chanrecv1</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 恢复接受 chan 之前入栈的寄存器 </span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x002b</span> <span style=color:#ae81ff>00043</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>b</span><span style=color:#f92672>+</span><span style=color:#ae81ff>48</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>CX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0030</span> <span style=color:#ae81ff>0004</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>ADDQ</span>	<span style=color:#75af00>main</span><span style=color:#111>..</span><span style=color:#75af00>autotmp_5</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>CX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0035</span> <span style=color:#ae81ff>00053</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>c</span><span style=color:#f92672>+</span><span style=color:#ae81ff>56</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x003a</span> <span style=color:#ae81ff>0005</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>LEAQ</span>	<span style=color:#111>(</span><span style=color:#75af00>DX</span><span style=color:#111>)(</span><span style=color:#75af00>CX</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span><span style=color:#111>),</span> <span style=color:#75af00>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x003e</span> <span style=color:#ae81ff>00062</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>ADDQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>24</span><span style=color:#111>,</span> <span style=color:#75af00>SP</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0042</span> <span style=color:#ae81ff>00066</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>POPQ</span>	<span style=color:#75af00>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0043</span> <span style=color:#ae81ff>00067</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>RET</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0044</span> <span style=color:#ae81ff>0006</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>	<span style=color:#75af00>NOP</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 处理扩容栈相关的代码</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0044</span> <span style=color:#ae81ff>0006</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0044</span> <span style=color:#ae81ff>0006</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0044</span> <span style=color:#ae81ff>0006</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>AX</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0049</span> <span style=color:#ae81ff>00073</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>BX</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x004e</span> <span style=color:#ae81ff>0007</span><span style=color:#ae81ff>8</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#75af00>CX</span><span style=color:#111>,</span> <span style=color:#ae81ff>24</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0053</span> <span style=color:#ae81ff>000</span><span style=color:#ae81ff>83</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>CALL</span>	<span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>morestack_noctxt</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0058</span> <span style=color:#ae81ff>000</span><span style=color:#ae81ff>88</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0058</span> <span style=color:#ae81ff>000</span><span style=color:#ae81ff>88</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#ae81ff>8</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x005d</span> <span style=color:#ae81ff>000</span><span style=color:#ae81ff>93</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0062</span> <span style=color:#ae81ff>000</span><span style=color:#ae81ff>98</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>MOVQ</span>	<span style=color:#ae81ff>24</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>CX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0067</span> <span style=color:#ae81ff>00103</span> <span style=color:#111>(.</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span>	<span style=color:#75af00>JMP</span>	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>test2</span><span style=color:#111>(</span><span style=color:#75af00>a</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>c</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>int</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>a</span> <span style=color:#f92672>+</span> <span style=color:#75af00>b</span> <span style=color:#f92672>+</span> <span style=color:#75af00>c</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test2</span> <span style=color:#75af00>STEXT</span> <span style=color:#75af00>nosplit</span> <span style=color:#75af00>size</span><span style=color:#111>=</span><span style=color:#ae81ff>9</span> <span style=color:#75af00>args</span><span style=color:#111>=</span><span style=color:#ae81ff>0x18</span> <span style=color:#75af00>locals</span><span style=color:#111>=</span><span style=color:#ae81ff>0x0</span> <span style=color:#75af00>funcid</span><span style=color:#111>=</span><span style=color:#ae81ff>0x0</span> <span style=color:#75af00>align</span><span style=color:#111>=</span><span style=color:#ae81ff>0x0</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>	<span style=color:#75af00>TEXT</span>	<span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test2</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span> <span style=color:#75af00>NOSPLIT</span><span style=color:#111>|</span><span style=color:#75af00>NOFRAME</span><span style=color:#111>|</span><span style=color:#75af00>ABIInternal</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>gclocals</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>g2BeySu</span><span style=color:#f92672>+</span><span style=color:#75af00>wFnoycgXfElmcg</span><span style=color:#f92672>==</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#75af00>gclocals</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>g2BeySu</span><span style=color:#f92672>+</span><span style=color:#75af00>wFnoycgXfElmcg</span><span style=color:#f92672>==</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test2</span><span style=color:#111>.</span><span style=color:#75af00>arginfo1</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>	<span style=color:#75af00>FUNCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>6</span><span style=color:#111>,</span> <span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#75af00>test2</span><span style=color:#111>.</span><span style=color:#75af00>argliveinfo</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>	<span style=color:#75af00>PCDATA</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0000</span> <span style=color:#ae81ff>00000</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>9</span><span style=color:#111>)</span>	<span style=color:#75af00>LEAQ</span>	<span style=color:#111>(</span><span style=color:#75af00>BX</span><span style=color:#111>)(</span><span style=color:#75af00>AX</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span><span style=color:#111>),</span> <span style=color:#75af00>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0004</span> <span style=color:#ae81ff>00004</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>9</span><span style=color:#111>)</span>	<span style=color:#75af00>LEAQ</span>	<span style=color:#111>(</span><span style=color:#75af00>CX</span><span style=color:#111>)(</span><span style=color:#75af00>DX</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span><span style=color:#111>),</span> <span style=color:#75af00>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x0008</span> <span style=color:#ae81ff>0000</span><span style=color:#ae81ff>8</span> <span style=color:#111>(</span><span style=color:#f92672>/</span><span style=color:#75af00>home</span><span style=color:#f92672>/</span><span style=color:#75af00>zhy</span><span style=color:#f92672>/</span><span style=color:#75af00>code</span><span style=color:#f92672>/</span><span style=color:#75af00>test1</span><span style=color:#f92672>/</span><span style=color:#75af00>main</span><span style=color:#111>.</span><span style=color:#00a8c8>go</span><span style=color:#111>:</span><span style=color:#ae81ff>9</span><span style=color:#111>)</span>	<span style=color:#75af00>RET</span>
</span></span></code></pre></div><p><em><strong>从上方可以看到 test2 函数没有保存 BX CX 寄存器，因为编译器知道这个函数不会交出控制权，所以不需要保存这些寄存器。如果调用函数不做参数入栈的话，只用寄存器的话性能会更好。</strong></em></p><p>那如果是抢占呢，编译阶段肯定是不知道会在哪被抢占的，是怎么恢复要使用的寄存器呢？</p><p>处理信号的逻辑：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>doSigPreempt</span><span style=color:#111>(</span><span style=color:#75af00>gp</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#75af00>ctxt</span> <span style=color:#f92672>*</span><span style=color:#75af00>sigctxt</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Check if this G wants to be preempted and is safe to</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// preempt.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>wantAsyncPreempt</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>ok</span><span style=color:#111>,</span> <span style=color:#75af00>newpc</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>isAsyncSafePoint</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>ctxt</span><span style=color:#111>.</span><span style=color:#75af00>sigpc</span><span style=color:#111>(),</span> <span style=color:#75af00>ctxt</span><span style=color:#111>.</span><span style=color:#75af00>sigsp</span><span style=color:#111>(),</span> <span style=color:#75af00>ctxt</span><span style=color:#111>.</span><span style=color:#75af00>siglr</span><span style=color:#111>());</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Adjust the PC and inject a call to asyncPreempt.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ctxt</span><span style=color:#111>.</span><span style=color:#75af00>pushCall</span><span style=color:#111>(</span><span style=color:#75af00>abi</span><span style=color:#111>.</span><span style=color:#75af00>FuncPCABI0</span><span style=color:#111>(</span><span style=color:#75af00>asyncPreempt</span><span style=color:#111>),</span> <span style=color:#75af00>newpc</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>代码在 <code>src/runtime/preempt_amd64.go</code> 中</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>asyncPreempt</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span><span style=color:#75af00>NOSPLIT</span><span style=color:#111>|</span><span style=color:#75af00>NOFRAME</span><span style=color:#111>,</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PUSHQ</span> <span style=color:#75af00>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>SP</span><span style=color:#111>,</span> <span style=color:#75af00>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Save flags before clobbering them</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PUSHFQ</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// obj doesn&#39;t understand ADD/SUB on SP, but does understand ADJSP</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ADJSP</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>368</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// But vet doesn&#39;t know ADJSP, so suppress vet stack checking</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>NOP</span> <span style=color:#75af00>SP</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>AX</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>CX</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>DX</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>BX</span><span style=color:#111>,</span> <span style=color:#ae81ff>24</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>SI</span><span style=color:#111>,</span> <span style=color:#ae81ff>32</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>DI</span><span style=color:#111>,</span> <span style=color:#ae81ff>40</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R8</span><span style=color:#111>,</span> <span style=color:#ae81ff>48</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R9</span><span style=color:#111>,</span> <span style=color:#ae81ff>56</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R10</span><span style=color:#111>,</span> <span style=color:#ae81ff>64</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R11</span><span style=color:#111>,</span> <span style=color:#ae81ff>72</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R12</span><span style=color:#111>,</span> <span style=color:#ae81ff>80</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R13</span><span style=color:#111>,</span> <span style=color:#ae81ff>88</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R14</span><span style=color:#111>,</span> <span style=color:#ae81ff>96</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#75af00>R15</span><span style=color:#111>,</span> <span style=color:#ae81ff>104</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#75af00>ifdef</span> <span style=color:#75af00>GOOS_darwin</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#75af00>ifndef</span> <span style=color:#75af00>hasAVX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>CMPB</span> <span style=color:#75af00>internal</span><span style=color:#960050;background-color:#1e0010>∕</span><span style=color:#75af00>cpu</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>X86</span><span style=color:#f92672>+</span><span style=color:#75af00>const_offsetX86HasAVX</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>),</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>JE</span> <span style=color:#ae81ff>2</span><span style=color:#111>(</span><span style=color:#75af00>PC</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#75af00>endif</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VZEROUPPER</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#75af00>endif</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X0</span><span style=color:#111>,</span> <span style=color:#ae81ff>112</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X1</span><span style=color:#111>,</span> <span style=color:#ae81ff>128</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X2</span><span style=color:#111>,</span> <span style=color:#ae81ff>144</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X3</span><span style=color:#111>,</span> <span style=color:#ae81ff>160</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X4</span><span style=color:#111>,</span> <span style=color:#ae81ff>176</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X5</span><span style=color:#111>,</span> <span style=color:#ae81ff>192</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X6</span><span style=color:#111>,</span> <span style=color:#ae81ff>208</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X7</span><span style=color:#111>,</span> <span style=color:#ae81ff>224</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X8</span><span style=color:#111>,</span> <span style=color:#ae81ff>240</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X9</span><span style=color:#111>,</span> <span style=color:#ae81ff>256</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X10</span><span style=color:#111>,</span> <span style=color:#ae81ff>272</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X11</span><span style=color:#111>,</span> <span style=color:#ae81ff>288</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X12</span><span style=color:#111>,</span> <span style=color:#ae81ff>304</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X13</span><span style=color:#111>,</span> <span style=color:#ae81ff>320</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X14</span><span style=color:#111>,</span> <span style=color:#ae81ff>336</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#75af00>X15</span><span style=color:#111>,</span> <span style=color:#ae81ff>352</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>CALL</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#75af00>asyncPreempt2</span><span style=color:#111>(</span><span style=color:#75af00>SB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>352</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X15</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>336</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X14</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>320</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X13</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>304</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X12</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>288</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X11</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>272</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X10</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>256</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X9</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>240</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X8</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>224</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X7</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>208</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X6</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>192</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X5</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>176</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X4</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>160</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X3</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>144</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X2</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>128</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X1</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVUPS</span> <span style=color:#ae81ff>112</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>X0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>104</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R15</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>96</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R14</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>88</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R13</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>80</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R12</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>72</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R11</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>64</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R10</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>56</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R9</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>48</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>R8</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>40</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>DI</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>32</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>SI</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>24</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>16</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>8</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>CX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MOVQ</span> <span style=color:#ae81ff>0</span><span style=color:#111>(</span><span style=color:#75af00>SP</span><span style=color:#111>),</span> <span style=color:#75af00>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ADJSP</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>-</span><span style=color:#ae81ff>368</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>POPFQ</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>POPQ</span> <span style=color:#75af00>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>RET</span>
</span></span></code></pre></div><p>这段汇编代码很简单，把各种寄存器保存到栈中，然后调用 asyncPreempt2 函数，这个函数会恢复这些寋存器。然后把 BP 弹回去，最后 RET 返回。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>asyncPreempt2</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>asyncSafePoint</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>preemptStop</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mcall</span><span style=color:#111>(</span><span style=color:#75af00>preemptPark</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mcall</span><span style=color:#111>(</span><span style=color:#75af00>gopreempt_m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>asyncSafePoint</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>这个代码就是开始交给 g0 去执行调度任务，当 goroutine 回来可以继续执行的时候，会执行恢复寄存器的代码。</p><p><img src=/images/gmp_preempt.png alt></p><h2 id=g0-和-sysmon-stack>G0 和 sysmon stack</h2><p>G0 和 sysmon 使用的是 OS 栈还是 runtime 自己维护的栈呢？</p><p>我们看下代码：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// sysmon</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>haveSysmon</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>newm</span><span style=color:#111>(</span><span style=color:#75af00>sysmon</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// newm -&gt; allocm</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>allocm</span><span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>fn</span> <span style=color:#00a8c8>func</span><span style=color:#111>(),</span> <span style=color:#75af00>id</span> <span style=color:#00a8c8>int64</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>m</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ... </span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>iscgo</span> <span style=color:#f92672>||</span> <span style=color:#75af00>mStackIsSystemAllocated</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span> <span style=color:#111>=</span> <span style=color:#75af00>malg</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span> <span style=color:#111>=</span> <span style=color:#75af00>malg</span><span style=color:#111>(</span><span style=color:#ae81ff>16384</span> <span style=color:#f92672>*</span> <span style=color:#75af00>sys</span><span style=color:#111>.</span><span style=color:#75af00>StackGuardMultiplier</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>可以看到，sysmon 或者普通的线程都是在 allocm 中创建的栈 上边介绍过了，<code>malg(-1)</code> 是 OS stack，<code>malg(16384 * sys.StackGuardMultiplier)</code> 是 runtime 自己维护的 16K 栈。</p><p>首先 sysmon 和 G0 都一定不是 CGO，根据操作系统来判断是不是 OS stack，linux 是 runtime 自己维护的栈。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>mStackIsSystemAllocated</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>switch</span> <span style=color:#75af00>GOOS</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#d88200>&#34;aix&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;darwin&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;plan9&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;illumos&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;ios&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;solaris&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;windows&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#d88200>&#34;openbsd&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>GOARCH</span> <span style=color:#f92672>!=</span> <span style=color:#d88200>&#34;mips64&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> 从源码分析 GMP 调度原理</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/go/gmp_code/>https://daemon365.dev/post/go/gmp_code/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/cloud/keepalived_haproxy/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>kube-apiserver 高可用，keepalived + haproxy</span></div></a><a href=/post/go/go_memory_code/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>go 内存管理</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#传统-os-线程>传统 OS 线程</a></li><li><a href=#gmp-模型>GMP 模型</a></li><li><a href=#数据结构>数据结构</a><ul><li><a href=#g>G</a><ul><li><a href=#goroutine-状态>goroutine 状态</a></li><li><a href=#g-的创建>G 的创建</a></li></ul></li><li><a href=#m>M</a><ul><li><a href=#m-的创建>M 的创建</a></li></ul></li><li><a href=#p>P</a><ul><li><a href=#p的创建>P的创建</a></li></ul></li><li><a href=#全局队列>全局队列</a></li></ul></li><li><a href=#调度>调度</a><ul><li><a href=#主动调度>主动调度</a></li><li><a href=#阻塞调度>阻塞调度</a></li><li><a href=#抢占调度>抢占调度</a></li><li><a href=#调度代码>调度代码</a></li><li><a href=#syscall>syscall</a></li></ul></li><li><a href=#goroutine-切换通用寄存器问题>goroutine 切换通用寄存器问题</a></li><li><a href=#g0-和-sysmon-stack>G0 和 sysmon stack</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2025 daemon365</p><p class=powered-by>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a></p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder="Search articles..." autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>Enter 2 or more characters to start searching</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>