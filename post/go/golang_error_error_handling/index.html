<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>golang error错误处理 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="error定义
数据结构
go语言error是一普通的值，实现方式为简单一个接口。
// The error built-in interface type is the conventional interface for
// representing an error condition, with …"><meta name=keywords content="go"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/go/golang_error_error_handling/"><meta property="og:title" content="golang error错误处理 - Daemon365"><meta property="og:description" content="error定义
数据结构
go语言error是一普通的值，实现方式为简单一个接口。
// The error built-in interface type is the conventional interface for
// representing an error condition, with …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2019-06-20T00:00:00+08:00"><meta property="article:modified_time" content="2019-06-20T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="go"><meta property="article:tag" content="go"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/go/golang_error_error_handling/"><meta name=twitter:title content="golang error错误处理 - Daemon365"><meta name=twitter:description content="error定义
数据结构
go语言error是一普通的值，实现方式为简单一个接口。
// The error built-in interface type is the conventional interface for
// representing an error condition, with …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/go/golang_error_error_handling/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golang error错误处理","description":"\u003ch2 id=\u0022error定义\u0022\u003eerror定义\u003c\/h2\u003e\n\u003ch3 id=\u0022数据结构\u0022\u003e数据结构\u003c\/h3\u003e\n\u003cp\u003ego语言error是一普通的值，实现方式为简单一个接口。\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-go\u0022 data-lang=\u0022go\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ The error built-in interface type is the conventional interface for\u003c\/span\u003e\n\u003c\/span\u003e\u003c\/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\/\/ representing an error condition, with …\u003c\/span\u003e\u003c\/span\u003e\u003c\/span\u003e\u003c\/span\u003e\u003c\/span\u003e\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e","datePublished":"2019-06-20T00:00:00\u002b08:00","dateModified":"2019-06-20T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/go\/golang_error_error_handling\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
首页</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
关于</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
归档</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
分类</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
标签</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
搜索</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>golang error错误处理</h1><div class=post-meta><time datetime=2019-06-20><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2019-06-20
</time><a href=/categories/go class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
go
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
8 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
1643 words</span></div><div class=post-tags><a href=/tags/go class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
go</a></div></header><div class=post-body><h2 id=error定义>error定义</h2><h3 id=数据结构>数据结构</h3><p>go语言error是一普通的值，实现方式为简单一个接口。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// The error built-in interface type is the conventional interface for</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// representing an error condition, with the nil value representing no error.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#00a8c8>error</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Error</span><span style=color:#111>()</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>创建error</p><p>使用<code>errors.New()</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// New returns an error that formats as the given text.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Each call to New returns a distinct error value even if the text is identical.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#75af00>text</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>errorString</span><span style=color:#111>{</span><span style=color:#75af00>text</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// errorString is a trivial implementation of error.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>errorString</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>e</span> <span style=color:#f92672>*</span><span style=color:#75af00>errorString</span><span style=color:#111>)</span> <span style=color:#75af00>Error</span><span style=color:#111>()</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>返回的是errorString结构体 实现了error接口的Error()方法</p><p>使用<code>fmt.Errorf（）</code>创建</p><p>创建方式为把字符串拼接起来，然后调用errors.New().</p><h3 id=基础库中的自定义的error>基础库中的自定义的error</h3><p>bufio中的错误：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>ErrTooLong</span>         <span style=color:#111>=</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;bufio.Scanner: token too long&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ErrNegativeAdvance</span> <span style=color:#111>=</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;bufio.Scanner: SplitFunc returns negative advance count&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ErrAdvanceTooFar</span>   <span style=color:#111>=</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;bufio.Scanner: SplitFunc returns advance count beyond input&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ErrBadReadCount</span>    <span style=color:#111>=</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;bufio.Scanner: Read returned impossible count&#34;</span><span style=color:#111>)</span>
</span></span></code></pre></div><h2 id=error的比较>error的比较</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>errorString</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>errorString</span><span style=color:#111>{</span><span style=color:#75af00>s</span><span style=color:#111>:</span> <span style=color:#75af00>s</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>e</span> <span style=color:#f92672>*</span><span style=color:#75af00>errorString</span><span style=color:#111>)</span> <span style=color:#75af00>Error</span><span style=color:#111>()</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>error1</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>error2</span> <span style=color:#f92672>:=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>error1</span> <span style=color:#f92672>==</span> <span style=color:#75af00>error2</span><span style=color:#111>)</span> <span style=color:#75715e>// false</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 比较结构体</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>errorString</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>errorString</span><span style=color:#111>{</span><span style=color:#75af00>s</span><span style=color:#111>:</span> <span style=color:#75af00>s</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>e</span> <span style=color:#f92672>*</span><span style=color:#75af00>errorString</span><span style=color:#111>)</span> <span style=color:#75af00>Error</span><span style=color:#111>()</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>error1</span> <span style=color:#f92672>:=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>error1</span> <span style=color:#f92672>==</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>))</span> <span style=color:#75715e>// false</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>errorString</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>errorString</span><span style=color:#111>{</span><span style=color:#75af00>s</span><span style=color:#111>:</span> <span style=color:#75af00>s</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>e</span> <span style=color:#75af00>errorString</span><span style=color:#111>)</span> <span style=color:#75af00>Error</span><span style=color:#111>()</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>error1</span> <span style=color:#f92672>:=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>error1</span> <span style=color:#f92672>==</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>))</span> <span style=color:#75715e>// true</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p><strong>error对比为对比对比实现interface的结构体类型 和结构体本身</strong></p><h2 id=error-or-exception>Error or Exception</h2><h3 id=处理错误的演进>处理错误的演进</h3><ol><li>C</li></ol><ul><li>单返回值，一般通过传递指针作为入参，返回值为 int 表示成功还是失败。</li></ul><ol start=2><li>C++</li></ol><ul><li>引入了 exception，但是无法知道被调用方会抛出什么异常。</li></ul><ol start=3><li>Java</li></ol><ul><li>引入了 checked exception，方法的所有者必须申明，调用者必须处理。在启动时抛出大量的异常是司空见惯的事情，并在它们的调用堆栈中尽职地记录下来。Java 异常不再是异常，而是变得司空见惯了。它们从良性到灾难性都有使用，异常的严重性由函数的调用者来区分</li></ul><ol start=4><li>go</li></ol><ul><li><p>Go 的处理异常逻辑是不引入 exception，支持多参数返回，所以你很容易的在函数签名中带上实现了 error interface 的对象，交由调用者来判定。</p></li><li><p>如果一个函数返回了 value, error，你不能对这个 value 做任何假设，必须先判定 error。唯一可以忽略 error 的是，如果你连 value 也不关心。</p></li><li><p>Go 中有 panic 的机制，如果你认为和其他语言的 exception 一样，那你就错了。当我们抛出异常的时候，相当于你把 exception 扔给了调用者来处理。比如，你在 C++ 中，把 string 转为 int，如果转换失败，会抛出异常。或者在 java 中转换 string 为 date 失败时，会抛出异常。</p></li><li><p>Go panic 意味着 fatal error(就是挂了)。不能假设调用者来解决 panic，意味着代码不能继续运行。</p></li><li><p>使用多个返回值和一个简单的约定，Go 解决了让程序员知道什么时候出了问题，并为真正的异常情况保留了 panic。</p></li></ul><h3 id=代码对比>代码对比</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Positive</span><span style=color:#111>(</span><span style=color:#75af00>x</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>x</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#75af00>x</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>Positive</span><span style=color:#111>(</span><span style=color:#75af00>x</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;正数&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;负数&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#75715e>// 负数</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>  <span style=color:#75715e>// 正数 bug</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>  <span style=color:#75715e>// 正数</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Positive</span><span style=color:#111>(</span><span style=color:#75af00>x</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>bool</span><span style=color:#111>,</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>x</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>x</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#75af00>x</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Positive</span><span style=color:#111>(</span><span style=color:#75af00>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;零&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;正数&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;负数&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#75715e>// 负数</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>  <span style=color:#75715e>// 零</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>  <span style=color:#75715e>// 正数</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Positive</span><span style=color:#111>(</span><span style=color:#75af00>x</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>bool</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>x</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;为零&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>x</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#75af00>x</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Positive</span><span style=color:#111>(</span><span style=color:#75af00>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;正数&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;负数&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#75715e>// 负数</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>  <span style=color:#75715e>// 为零</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Check</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>  <span style=color:#75715e>// 正数</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=error使用>error使用</h3><p>对于真正意外的情况，那些表示不可恢复的程序错误，例如索引越界、不可恢复的环境问题、栈溢出，我们才使用 panic。对于其他的错误情况，我们应该是期望使用 error 来进行判定。</p><ul><li><p>简单。</p></li><li><p>考虑失败，而不是成功。</p></li><li><p>没有隐藏的控制流。</p></li><li><p>完全交给你来控制 error。</p></li><li><p>Error are values。</p></li></ul><h2 id=sentinel-error>Sentinel Error</h2><p>预定义的特定错误，我们叫为 sentinel error，这个名字来源于计算机编程中使用一个特定值来表示不可能进行进一步处理的做法。所以对于 Go，我们使用特定的值来表示错误。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#75af00>ErrSomething</span> <span style=color:#111>{</span> <span style=color:#960050;background-color:#1e0010>…</span> <span style=color:#111>}</span>
</span></span></code></pre></div><p>类似的 <code>io.EOF</code>，更底层的 <code>syscall.ENOENT</code>。</p><p>使用 sentinel 值是最不灵活的错误处理策略，因为调用方必须使用 == 将结果与预先声明的值进行比较。当您想要提供更多的上下文时，这就出现了一个问题，因为返回一个不同的错误将破坏相等性检查。</p><p>甚至是一些有意义的 fmt.Errorf 携带一些上下文，也会破坏调用者的 == ，调用者将被迫查看 error.Error() 方法的输出，以查看它是否与特定的字符串匹配。</p><ul><li>不依赖检查 error.Error 的输出。</li></ul><p>不应该依赖检测 error.Error 的输出，Error 方法存在于 error 接口主要用于方便程序员使用，但不是程序(编写测试可能会依赖这个返回)。这个输出的字符串用于记录日志、输出到 stdout 等。</p><ul><li>Sentinel errors 成为你 API 公共部分。</li></ul><p>如果您的公共函数或方法返回一个特定值的错误，那么该值必须是公共的，当然要有文档记录，这会增加 API 的表面积。</p><p>如果 API 定义了一个返回特定错误的 interface，则该接口的所有实现都将被限制为仅返回该错误，即使它们可以提供更具描述性的错误。</p><p>比如 io.Reader。像 io.Copy 这类函数需要 reader 的实现者比如返回 io.EOF 来告诉调用者没有更多数据了，但这又不是错误。</p><ul><li>Sentinel errors 在两个包之间创建了依赖。</li></ul><p>sentinel errors 最糟糕的问题是它们在两个包之间创建了源代码依赖关系。例如，检查错误是否等于 io.EOF，您的代码必须导入 io 包。这个特定的例子听起来并不那么糟糕，因为它非常常见，但是想象一下，当项目中的许多包导出错误值时，存在耦合，项目中的其他包必须导入这些错误值才能检查特定的错误条件(in the form of an import loop)。</p><ul><li>结论: 尽可能避免 sentinel errors。</li></ul><p>我的建议是避免在编写的代码中使用 sentinel errors。在标准库中有一些使用它们的情况，但这不是一个您应该模仿的模式。</p><h2 id=错误类型>错误类型</h2><p>Error type 是实现了 error 接口的自定义类型。例如 MyError 类型记录了文件和行号以展示发生了什么。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Myerror</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>line</span> <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>file</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>s</span>    <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>e</span> <span style=color:#f92672>*</span><span style=color:#75af00>Myerror</span><span style=color:#111>)</span> <span style=color:#75af00>Error</span><span style=color:#111>()</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>file</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>line</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>Myerror</span><span style=color:#111>{</span><span style=color:#75af00>line</span><span style=color:#111>:</span> <span style=color:#75af00>line</span><span style=color:#111>,</span> <span style=color:#75af00>file</span><span style=color:#111>:</span> <span style=color:#75af00>file</span><span style=color:#111>,</span> <span style=color:#75af00>s</span><span style=color:#111>:</span> <span style=color:#75af00>s</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>因为 MyError 是一个 type，调用者可以使用断言转换成这个类型，来获取更多的上下文信息。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#d88200>&#34;main.go&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>23</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;test error&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>switch</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>err</span><span style=color:#111>.(</span><span style=color:#00a8c8>type</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>case</span> <span style=color:#00a8c8>nil</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;err is nil&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>case</span> <span style=color:#f92672>*</span><span style=color:#75af00>Myerror</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;type is *Myerror err line :&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>line</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>default</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;None of them&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 结果:type is *Myerror err line : 23</span>
</span></span></code></pre></div><p>与错误值相比，错误类型的一大改进是它们能够包装底层错误以提供更多上下文。</p><p>一个不错的例子就是 os.PathError 他提供了底层执行了什么操作、那个路径出了什么问题。</p><p>调用者要使用类型断言和类型 switch，就要让自定义的 error 变为 public。这种模型会导致和调用者产生强耦合，从而导致 API 变得脆弱。</p><p>结论是尽量避免使用 error types，虽然错误类型比 sentinel errors 更好，因为它们可以捕获关于出错的更多上下文，但是 error types 共享 error values 许多相同的问题。</p><p>因此，我的建议是避免错误类型，或者至少避免将它们作为公共 API 的一部分。</p><h3 id=非透明的error>非透明的error</h3><p>在我看来，这是最灵活的错误处理策略，因为它要求代码和调用者之间的耦合最少。</p><p>我将这种风格称为不透明错误处理，因为虽然您知道发生了错误，但您没有能力看到错误的内部。作为调用者，关于操作的结果，您所知道的就是它起作用了，或者没有起作用(成功还是失败)。</p><p>这就是不透明错误处理的全部功能–只需返回错误而不假设其内容</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#d88200>&#34;os&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>test</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>f</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;filename.txt&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// use f </span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>为行为而不是类型断言错误 在少数情况下，这种二分错误处理方法是不够的。例如，与进程外的世界进行交互(如网络活动)，需要调用方调查错误的性质，以确定重试该操作是否合理。在这种情况下，我们可以断言错误实现了特定的行为，而不是断言错误是特定的类型或值。考虑这个例子：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 封装内部</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>temporary</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Temporary</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>IsTemporary</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>te</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>err</span><span style=color:#111>.(</span><span style=color:#75af00>temporary</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>te</span><span style=color:#111>.</span><span style=color:#75af00>Temporary</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// net包的error</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Error</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Timeout</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span>   <span style=color:#75715e>// Is the error a timeout?</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Temporary</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span> <span style=color:#75715e>// Is the error temporary?</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 错误处理</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>nerr</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>err</span><span style=color:#111>.(</span><span style=color:#75af00>net</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>);</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>nerr</span><span style=color:#111>.</span><span style=color:#75af00>Temporary</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 处理</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=handling-error>Handling Error</h2><p>无错误的正常流程代码，将成为一条直线，而不是缩进的代码。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>f</span><span style=color:#111>,</span><span style=color:#75af00>err</span>  <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;file&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 处理错误</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 逻辑</span>
</span></span><span style=display:flex><span><span style=color:#75af00>f</span><span style=color:#111>,</span><span style=color:#75af00>err</span>  <span style=color:#111>=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;file2&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 处理错误</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 逻辑</span>
</span></span></code></pre></div><p>通过消除错误消除错误处理</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 改进前</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>AutoRusquest</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>Anto</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>  
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 改进后</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>AutoRusquest</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>Anto</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>AutoRusquest</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// log </span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 统计行数</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Countlines</span><span style=color:#111>(</span><span style=color:#75af00>r</span> <span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>Reader</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>br</span>    <span style=color:#111>=</span> <span style=color:#75af00>bufio</span><span style=color:#111>.</span><span style=color:#75af00>NewReader</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lines</span> <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>err</span>   <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span>    <span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>br</span><span style=color:#111>.</span><span style=color:#75af00>ReadString</span><span style=color:#111>(</span><span style=color:#d88200>&#39;\n&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lines</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>EOF</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>lines</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 改进后</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Countlines</span><span style=color:#111>(</span><span style=color:#75af00>r</span> <span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>Reader</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>sr</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bufio</span><span style=color:#111>.</span><span style=color:#75af00>NewScanner</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>lines</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>sr</span><span style=color:#111>.</span><span style=color:#75af00>Scan</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lines</span> <span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>lines</span><span style=color:#111>,</span><span style=color:#75af00>sr</span><span style=color:#111>.</span><span style=color:#75af00>Err</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=wrap-errors>Wrap errors</h2><h3 id=传统error的问题>传统error的问题</h3><p>还记得之前我们 auth 的代码吧，如果 Auto 返回错误，则 Aut0Request 会将错误返回给调用方，调用者可能也会这样做，依此类推。在程序的顶部，程序的主体将把错误打印到屏幕或日志文件中，打印出来的只是：没有这样的文件或目录。</p><p>没有生成错误的 file:line 信息。没有导致错误的调用堆栈的堆栈跟踪。这段代码的作者将被迫进行长时间的代码分割，以发现是哪个代码路径触发了文件未找到错误。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>AutoRusquest</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>Anto</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;auto failed:%v&#34;</span><span style=color:#111>,</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>  
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>但是正如我们前面看到的，这种模式与 sentinel errors 或 type assertions 的使用不兼容，因为将错误值转换为字符串，将其与另一个字符串合并，然后将其转换回 fmt.Errorf 破坏了原始错误，导致等值判定失败。</p><p>你应该只处理一次错误。处理错误意味着检查错误值，并做出单个决策。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>WriteAll</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>Writer</span><span style=color:#111>,</span> <span style=color:#75af00>buf</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>buf</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>我们经常发现类似的代码，在错误处理中，带了两个任务: 记录日志并且再次返回错误。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>WriteAll</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>Writer</span><span style=color:#111>,</span> <span style=color:#75af00>buf</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>buf</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Panicln</span><span style=color:#111>(</span><span style=color:#d88200>&#34;write buf failed:&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>在这个例子中，如果在 w.Write 过程中发生了一个错误，那么一行代码将被写入日志文件中，记录错误发生的文件和行，并且错误也会返回给调用者，调用者可能会记录并返回它，一直返回到程序的顶部。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>WriteConfig</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#f92672>*</span><span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>Writer</span><span style=color:#111>,</span><span style=color:#75af00>config</span> <span style=color:#f92672>*</span><span style=color:#75af00>Config</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>buf</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>conf</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;could not marshal config: %V&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Writeall</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>buf</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;could not write config: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Writeconfig</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>conf</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>unable to write: io.EOF
</span></span></span><span style=display:flex><span><span style=color:#75715e>could not write config: io.EOF
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><p>Go 中的错误处理契约规定，在出现错误的情况下，不能对其他返回值的内容做出任何假设。由于 JSON 序列化失败，buf 的内容是未知的，可能它不包含任何内容，但更糟糕的是，它可能包含一个半写的 JSON 片段。</p><p>由于程序员在检查并记录错误后忘记 return，损坏的缓冲区将被传递给 WriteAll，这可能会成功，因此配置文件将被错误地写入。但是，该函数返回的结果是正确的。</p><h3 id=栈处理错误>栈处理错误</h3><p>日志记录与错误无关且对调试没有帮助的信息应被视为噪音，应予以质疑。记录的原因是因为某些东西失败了，而日志包含了答案。</p><ul><li><p>错误要被日志记录。</p></li><li><p>应用程序处理错误，保证100%完整性。</p></li><li><p>之后不再报告当前错误。</p></li></ul><p>包:github.com/pkg/errors</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Readconfig</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Exit</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Readfile</span><span style=color:#111>(</span><span style=color:#75af00>path</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>([]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>f</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#75af00>path</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Wrap</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;open failed&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>defer</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>buf</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ioutil</span><span style=color:#111>.</span><span style=color:#75af00>ReadAll</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Wrap</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;read failed&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>buf</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Readconfig</span><span style=color:#111>()</span> <span style=color:#111>([]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>home</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Getenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;HOME&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>config</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Readfile</span><span style=color:#111>(</span><span style=color:#75af00>filepath</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#75af00>home</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;settings.xml&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>config</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>WithMessage</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;could not read config&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>could not read config: open failed: open /Users/zhaohaiyu/settings.xml: no such file or directory
</span></span></span><span style=display:flex><span><span style=color:#75715e>exit status 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Readconfig</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;original error: %T -&gt; %v\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Cause</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>),</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Cause</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;stack trace: \n%+v\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Exit</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>original error: *os.PathError -&gt; open /Users/zhaohaiyu/settings.xml: no such file or directory
</span></span></span><span style=display:flex><span><span style=color:#75715e>stack trace: 
</span></span></span><span style=display:flex><span><span style=color:#75715e>open /Users/zhaohaiyu/settings.xml: no such file or directory
</span></span></span><span style=display:flex><span><span style=color:#75715e>open failed
</span></span></span><span style=display:flex><span><span style=color:#75715e>main.Readfile
</span></span></span><span style=display:flex><span><span style=color:#75715e>        /Users/zhaohaiyu/code/test/main.go:35
</span></span></span><span style=display:flex><span><span style=color:#75715e>main.Readconfig
</span></span></span><span style=display:flex><span><span style=color:#75715e>        /Users/zhaohaiyu/code/test/main.go:51
</span></span></span><span style=display:flex><span><span style=color:#75715e>main.main
</span></span></span><span style=display:flex><span><span style=color:#75715e>        /Users/zhaohaiyu/code/test/main.go:22
</span></span></span><span style=display:flex><span><span style=color:#75715e>runtime.main
</span></span></span><span style=display:flex><span><span style=color:#75715e>        /usr/local/Cellar/go/1.15.3/libexec/src/runtime/proc.go:204
</span></span></span><span style=display:flex><span><span style=color:#75715e>runtime.goexit
</span></span></span><span style=display:flex><span><span style=color:#75715e>        /usr/local/Cellar/go/1.15.3/libexec/src/runtime/asm_amd64.s:1374
</span></span></span><span style=display:flex><span><span style=color:#75715e>could not read config
</span></span></span><span style=display:flex><span><span style=color:#75715e>exit status 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><p>通过使用 pkg/errors 包，您可以向错误值添加上下文，这种方式既可以由人也可以由机器检查。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Wrap</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;read failed&#34;</span><span style=color:#111>)</span>
</span></span></code></pre></div><h3 id=wrap-errors使用>wrap errors使用</h3><ol><li>在你的应用代码中，使用 errors.New 或者 errros.Errorf 返回错误。</li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>parseargs</span><span style=color:#111>(</span><span style=color:#75af00>args</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>args</span><span style=color:#111>)</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>3</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;not enough arguments, expected at Least&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=2><li>如果调用其他的函数，通常简单的直接返回。</li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=3><li>如果和其他库进行协作，考虑使用 errors.Wrap 或者 errors.Wrapf 保存堆栈信息。同样适用于和标准库协作的时候。</li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>f</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#75af00>file</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Wrapf</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;open %s failed&#34;</span><span style=color:#111>,</span><span style=color:#75af00>file</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=4><li><p>直接返回错误，而不是每个错误产生的地方到处打日志。</p></li><li><p>在程序的顶部或者是工作的 goroutine 顶部(请求入口)，使用 %+v 把堆栈详情记录。</p></li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>Run</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;FATAL:%+v\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Exit</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=6><li>使用 errors.Cause 获取 root error，再进行和 sentinel error 判定。</li></ol><h3 id=总结>总结:</h3><ul><li><p>Packages that are reusable across many projects only return root error values.（选择 wrap error 是只有 applications 可以选择应用的策略。具有最高可重用性的包只能返回根错误值。此机制与 Go 标准库中使用的相同(kit 库的 sql.ErrNoRows)。）</p></li><li><p>If the error is not going to be handled, wrap and return up the call stack.（这是关于函数/方法调用返回的每个错误的基本问题。如果函数/方法不打算处理错误，那么用足够的上下文 wrap errors 并将其返回到调用堆栈中。例如，额外的上下文可以是使用的输入参数或失败的查询语句。确定您记录的上下文是足够多还是太多的一个好方法是检查日志并验证它们在开发期间是否为您工作。）</p></li><li><p>Once an error is handled, it is not allowed to be passed up the call stack any longer.（ 一旦确定函数/方法将处理错误，错误就不再是错误。如果函数/方法仍然需要发出返回，则它不能返回错误值。它应该只返回零(比如降级处理中，你返回了降级数据，然后需要 return nil)。）</p></li></ul><h2 id=go113-error>Go1.13 error</h2><p>1
函数在调用栈中添加信息向上传递错误，例如对错误发生时发生的情况的简要描述。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;decompress %v:%v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>name</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>使用创建新错误 fmt.Errorf 丢弃原始错误中除文本外的所有内容。正如我们在上面的QueryError 中看到的那样，我们有时可能需要定义一个包含底层错误的新错误类型，并将其保存以供代码检查。这里是 QueryError：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>QueryError</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Query</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Err</span>   <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>程序可以查看 QueryError \p值以根据底层错误做出决策。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>e</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>err</span><span style=color:#111>.(</span><span style=color:#f92672>*</span><span style=color:#75af00>Queryerror</span><span style=color:#111>);</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>Err</span> <span style=color:#f92672>==</span> <span style=color:#75af00>ErrPermission</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//query failed because of a permission problem</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>go1.13为 errors 和 fmt 标准库包引入了新特性，以简化处理包含其他错误的错误。其中最重要的是: 包含另一个错误的 error 可以实现返回底层错误的 Unwrap 方法。如果 e1.Unwrap() 返回 e2，那么我们说 e1 包装 e2，您可以展开 e1 以获得 e2。</p><p>按照此约定，我们可以为上面的 QueryError 类型指定一个 Unwrap 方法，该方法返回其包含的错误:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>e</span> <span style=color:#f92672>*</span><span style=color:#75af00>Queryerror</span><span style=color:#111>)</span> <span style=color:#75af00>Unwrap</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span> <span style=color:#00a8c8>return</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>Err</span> <span style=color:#111>}</span>
</span></span></code></pre></div><p>go1.13 errors 包包含两个用于检查错误的新函数：Is 和 As。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Similar to:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// if err = Errnotfound {...}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Is</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#75af00>Errnotfound</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// something wasnt found</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Similar to</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// if e, ok := err.(*Queryerror); ok {...}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>e</span> <span style=color:#f92672>*</span><span style=color:#75af00>Queryerror</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Note: *Queryerror is the type of the error</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>errorsAs</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>e</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// err is a *Queryerror, and e is set to the errors value</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=wrapping-errors-with-w>Wrapping errors with %w</h3><p>如前所述，使用 fmt.Errorf 向错误添加附加信息。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;decompress %v:%v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>name</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>在 Go 1.13中 fmt.Errorf 支持新的 %w 谓词。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;decompress %v:%w&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>name</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>用 %w 包装错误可用于 errors.Is 以及 errors.As</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;access denied: % W&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>Errpermission</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Is</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#75af00>Errpermission</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=go2介绍>Go2介绍</h2><p><a href=https://go.googlesource.com/proposal/+/master/design/29934-error-values.md>https://go.googlesource.com/proposal/+/master/design/29934-error-values.md</a></p><h2 id=原文地址>原文地址</h2><ul><li><a href=https://www.zhaohaiyu.com/post/go/go-error/>https://www.zhaohaiyu.com/post/go/go-error/</a></li></ul><h2 id=参考文章>参考文章</h2><ul><li><a href=https://u.geekbang.org/subject/go>https://u.geekbang.org/subject/go</a></li><li><a href=https://lailin.xyz/post/go-training-03.html>https://lailin.xyz/post/go-training-03.html</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> golang error错误处理</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/go/golang_error_error_handling/>https://daemon365.dev/post/go/golang_error_error_handling/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/go/golang_fmt_package/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>golang fmt包</span></div></a><a href=/post/go/golang_time_package/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>golang time包</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#error定义>error定义</a><ul><li><a href=#数据结构>数据结构</a></li><li><a href=#基础库中的自定义的error>基础库中的自定义的error</a></li></ul></li><li><a href=#error的比较>error的比较</a></li><li><a href=#error-or-exception>Error or Exception</a><ul><li><a href=#处理错误的演进>处理错误的演进</a></li><li><a href=#代码对比>代码对比</a></li><li><a href=#error使用>error使用</a></li></ul></li><li><a href=#sentinel-error>Sentinel Error</a></li><li><a href=#错误类型>错误类型</a><ul><li><a href=#非透明的error>非透明的error</a></li></ul></li><li><a href=#handling-error>Handling Error</a></li><li><a href=#wrap-errors>Wrap errors</a><ul><li><a href=#传统error的问题>传统error的问题</a></li><li><a href=#栈处理错误>栈处理错误</a></li><li><a href=#wrap-errors使用>wrap errors使用</a></li><li><a href=#总结>总结:</a></li></ul></li><li><a href=#go113-error>Go1.13 error</a><ul><li><a href=#wrapping-errors-with-w>Wrapping errors with %w</a></li></ul></li><li><a href=#go2介绍>Go2介绍</a></li><li><a href=#原文地址>原文地址</a></li><li><a href=#参考文章>参考文章</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2026 daemon365</p><p class=powered-by>由 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 和 <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a> 驱动</p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder=搜索文章... autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>输入 2 个或更多字符开始搜索</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>