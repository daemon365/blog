<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>grpc服务发现与负载均衡 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="前言
   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。
负载均衡 && 服务发现
基础
   负载均衡 ，顾名思义，是通过某种手段将流量 …"><meta name=keywords content="grpc,go"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/"><meta property="og:title" content="grpc服务发现与负载均衡 - Daemon365"><meta property="og:description" content="前言
   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。
负载均衡 && 服务发现
基础
   负载均衡 ，顾名思义，是通过某种手段将流量 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2020-12-20T00:00:00+08:00"><meta property="article:modified_time" content="2020-12-20T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="microservice"><meta property="article:tag" content="grpc"><meta property="article:tag" content="go"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/"><meta name=twitter:title content="grpc服务发现与负载均衡 - Daemon365"><meta name=twitter:description content="前言
   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。
负载均衡 && 服务发现
基础
   负载均衡 ，顾名思义，是通过某种手段将流量 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"grpc服务发现与负载均衡","description":"\u003ch2 id=\u0022前言\u0022\u003e前言\u003c\/h2\u003e\n\u003cp\u003e   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。\u003c\/p\u003e\n\u003ch2 id=\u0022负载均衡--服务发现\u0022\u003e负载均衡 \u0026amp;\u0026amp; 服务发现\u003c\/h2\u003e\n\u003ch4 id=\u0022基础\u0022\u003e基础\u003c\/h4\u003e\n\u003cp\u003e   负载均衡 ，顾名思义，是通过某种手段将流量 …\u003c\/p\u003e","datePublished":"2020-12-20T00:00:00\u002b08:00","dateModified":"2020-12-20T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/microservice\/grpc_service_discovery_and_load_balancing\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
Archives</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
Search</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>grpc服务发现与负载均衡</h1><div class=post-meta><time datetime=2020-12-20><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2020-12-20
</time><a href=/categories/microservice class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
microservice
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
7 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
1310 words</span></div><div class=post-tags><a href=/tags/grpc class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
grpc
</a><a href=/tags/go class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
go</a></div></header><div class=post-body><h2 id=前言>前言</h2><p>   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。</p><h2 id=负载均衡--服务发现>负载均衡 && 服务发现</h2><h4 id=基础>基础</h4><p>   负载均衡 ，顾名思义，是通过某种手段将流量 / 请求分配到不通的服务器上去，保证后台的每个服务收到的请求都尽可能保持平衡
   服务发现 ，就是指客户端按照某种约定的方式主动去（注册中心）寻找服务，然后再连接相应的服务
   关于负载均衡的构建与实现，可以看下这几篇文章：</p><ul><li><a href=https://segmentfault.com/a/1190000008672912>gRPC 服务发现 & 负载均衡</a></li><li><a href=https://grpc.io/blog/loadbalancing/>gRPC Load Balancing</a></li><li><a href=https://github.com/grpc/grpc/blob/master/doc/load-balancing.md>Load Balancing in gRPC</a></li></ul><h4 id=服务发现概念>服务发现概念</h4><p>   我们说的服务发现，一般理解为客户端如何发现 (并连接到) 服务，这里一般包含三个组件：</p><ol><li>服务消费者：一般指客户端（可以是简单的 TCP-Client 或者是 RPC-Client ）</li><li>服务提供者：一般指服务提供方，如传统服务，微服务等</li><li>服务注册中心：用来存储（Key-Value）服务提供者的服务，一般以 DNS/HTTP/RPC 等方式对外暴露接口</li></ol><h4 id=负载均衡概念>负载均衡概念</h4><p>我们把 LB 看作一个组件，根据组件位置的不同，大致上分为三种：</p><h4 id=集中式-lbproxy-model>集中式 LB（Proxy Model）</h4><p>   独立的 LB, 可以是硬件实现，如 F5，或者是 nginx 这种内置 Proxy-pass 或者 upstream 功能的网关，亦或是 LVS/HAPROXY，之前也使用 <a href=http://core.dpdk.org/doc/quick-start/>DPDK</a> 开发过类似的专用网关。</p><p><img src=/images/600380fe-75ab-44af-9615-c41dd981f499.png alt></p><h4 id=进程内-lbbalancing-aware-client>进程内 LB（Balancing-aware Client）</h4><p>   进程内 LB（集成到客户端），此方案将 LB 的功能集成到服务消费方进程里，也被称为软负载或者客户端负载方案。服务提供方启动时，首先将服务地址注册到服务注册表，同时定期报心跳到服务注册表以表明服务的存活状态，相当于健康检查，服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询，同时缓存并定期刷新目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。LB 和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。</p><p><img src=/images/484f3293-3b5e-4606-ade5-7b69ac18f7fb.png alt></p><h4 id=独立-lb-进程external-load-balancing-service>独立 LB 进程（External Load Balancing Service）</h4><p>   该方案是针对上一种方案的不足而提出的一种折中方案，原理和第二种方案基本类似。不同之处是将 LB 和服务发现功能从进程内移出来，变成主机上的一个独立进程。主机上的一个或者多个服务要访问目标服务时，他们都通过同一主机上的独立 LB 进程做服务发现和负载均衡。该方案也是一种分布式方案没有单点问题，一个 LB 进程挂了只影响该主机上的服务调用方，服务调用方和 LB 之间是进程内调用性能好，同时该方案还简化了服务调用方，不需要为不同语言开发客户库，LB 的升级不需要服务调用方改代码。 公司的 L5 是这种方式，每台机器上都安装了 L5 的 agent，供其他服务调用。该方案主要问题：部署较复杂，环节多，出错调试排查问题不方便。</p><p><img src=/images/be553bb2-7a9a-4539-93db-02cd4a2d1ee2.png alt></p><h3 id=grpc-内置的方案>gRPC 内置的方案</h3><p>  gRPC 的内置方案如下图所示：</p><p><img src=/images/4bc0b344-b882-415c-9972-75ad14e35d51.png alt></p><p>gRPC 在官网文档中提供了实现 LB 的思路，并在不同语言的 gRPC 代码 API 中已提供了命名解析和负载均衡接口供扩展。默认提供了 DNS-resolver 的实现，接口相当规范，实现起来也不复杂，只需要实现服务注册（Registry）和服务监听 + 解析（Watcher+Resolver）的逻辑就行了，这里简单介绍其基本实现过程：</p><ol><li>构建注册中心，这里注册中心一般要求具备分布式一致性（满足 CAP 定理的 AP 或 CP）的高可用的组件集群，如 Zookeeper、Consul、Etcd 等</li><li>构建 gRPC 服务端的注册逻辑，服务启动后定时向注册中心注册自身的关键信息（一般开启新的 groutine 来完成），至少包含 IP 和端口，其他可选信息，如自身的负载信息（CPU 和 Memory）、当前实时连接数等，这些辅助信息有助于帮助系统更好的执行 LB 算法</li><li>gRPC 客户端向注册中心发出服务解析请求，注册中心将请求中关联的所有服务的信息返回给 gRPC 客户端，客户端与所有在线的服务建立起 HTTP2 长连接</li><li>gRPC 客户端发起 RPC 调用，根据 LB 均衡器中实现的负载均衡策略（gRPC 中默认提供的算法是 RoundRobin），选择其中一 HTTP2 长连接进行通信，即 LB 策略决定哪个子通道 - 即哪个 gRPC 服务器将接收请求</li></ol><h2 id=grpc-负载均衡的运行机制>gRPC 负载均衡的运行机制</h2><p>gRPC 提供了负载均衡实现的用户侧接口，我们可以非常方便的定制化业务的负载均衡策略，为了理解 gRPC 的负载均衡的实现机制，后续博客中我会分析下 <code>gRPC</code> 实现负载均衡的代码。</p><p><img src=/images/c0b8b2f7-eee6-4a7b-8785-331d276a19fd.png alt></p><ol><li>Resolver<ul><li>解析器，用于从注册中心实时获取当前服务端的列表，同步发送给 Balancer</li></ul></li><li>Balancer<ul><li>平衡器，一是接收从 Resolver 发送的服务端列表，建立并维护（长）连接状态；二是每次当 Client 发起 Rpc 调用时，按照一定算法从连接池中选择一个连接进行 Rpc 调用</li></ul></li><li>Register<ul><li>注册，用于服务端初始化和在线时，将自己信息上报到注册中心，主要信息有 Ip，端口等</li></ul></li></ol><h2 id=负载均衡的算法及实现>负载均衡的算法及实现</h2><p>在实践中，如何选取负载均衡策略是一个很有趣的话题，例如 Nginx 的 <code>upstream</code> 机制中就有很多经典的 LB 策略，如带权重的轮询 <a href=https://github.com/nginx/nginx/blob/master/src/http/ngx_http_upstream_round_robin.c>Weight-RoundRobin</a>，一般常用的负载均衡方法有如下几种：</p><ol><li>RoundRobin（轮询）</li><li>Weight-RoundRobin（加权轮询）<ul><li>不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。给配置高、负载低的机器配置更高的权重，而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。</li></ul></li><li>Random（随机）</li><li>Weight-Random（加权随机）<ul><li>通过系统的随机算法，根据后端服务器的列表随机选取其中的一台服务器进行访问</li></ul></li><li>源地址哈希法<ul><li>源地址哈希的思想是根据获取客户端的 IP 地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号。采用源地址哈希法进行负载均衡，同一 IP 地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问</li></ul></li><li>最小连接数法<ul><li>最小连接数算法比较灵活和智能，由于后端服务器的配置不尽相同，对于请求的处理有快有慢，它是根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器</li></ul></li><li>一致性哈希算法<ul><li>常见的是 <code>Ketama</code> 算法，该算法是用来解决 <code>cache</code> 失效导致的缓存穿透的问题的，当然也可以适用于 gRPC 长连接的场景</li></ul></li></ol><h2 id=grpc-服务治理的优势>gRPC 服务治理的优势</h2><p>   在现网环境中，后端服务就是采用了 gRPC 与 Etcd 的服务治理方案，总结下有这么几个优点；</p><ul><li>采用了 gRPC 实现负载均衡策略，模块之间通信采用长连接方式，避免每次 RPC 调用时新建连接的开销，充分发挥 <code>HTTP2</code> 的优势</li><li>扩容和缩容都及其方便，例如扩容，只要部署上服务，运行后，服务成功注册到 Etcd 便大功告成</li><li>灵活的自定义的 LB 算法，使得后端压力更为均衡</li><li>客户端加入重试逻辑，使得网络抖动情况下，可以通过重试连接上另外一台服务</li></ul><h2 id=resolver-暴露的三个接口>Resolver 暴露的三个接口</h2><p>前文说过，gRPC 内置的服务治理功能，对开发者暴露了服务发现的 <code>interface{}</code>，<code>resolver.Builder</code> 和 <code>resolver.ClientConn</code> 和 <code>resolver.Resolver</code>，<a href=https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go>相关代码</a>。开发者在实例化这三个接口之后，就可以实现从指定的 scheme 中获取服务列表，通知 balancer 并与这些服务端建立 RPC 长连接。</p><ol><li>resolver.Builder</li><li>resolver.ClientConn</li><li>resolver.Resolver</li></ol><ul><li>resolver.Builder <code>Builder</code> 用于 gRPC 内部创建 <code>Resolver</code> 接口的实现，但注意内部声明的 <code>Build()</code> 方法将接口 <code>ClientConn</code> 作为参数传入了，在前文的分析中，我们了解到 <code>ClientConn</code><a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459>结库</a> 是非常重要的结构，其成员 <code>conns map[*addrConn]struct{}</code> 中维护了所有从注册中心获取到的服务端列表。</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Builder creates a resolver that will be used to watch name resolution updates.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Builder</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Build creates a new resolver for the given target.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// gRPC dial calls Build synchronously, and fails if the returned error is</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// not nil.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>Build</span><span style=color:#111>(</span><span style=color:#75af00>target</span> <span style=color:#75af00>Target</span><span style=color:#111>,</span> <span style=color:#75af00>cc</span> <span style=color:#75af00>ClientConn</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span> <span style=color:#75af00>BuildOption</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>Resolver</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Scheme returns the scheme supported by this resolver.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>Scheme</span><span style=color:#111>()</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ul><li><a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459>resolver.ClientConn</a> <code>ClientConn</code> 接口中，<code>UpdateState</code> 方法需要传入 <code>State</code> 结构，<code>NewAddress</code> 方法需要传入 <code>Address</code> 结构，看代码可以发现其中包含了 <code>Addresses []Address // Resolved addresses for the target</code>，可以看出是需要将服务发现得到的 <code>Address</code> 对象列表告诉 <code>ClientConn</code> 的对象。</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// ClientConn contains the callbacks for resolver to notify any updates</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// to the gRPC ClientConn.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This interface is to be implemented by gRPC. Users should not need a</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// brand new implementation of this interface. For the situations like</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// testing, the new implementation should embed this interface. This allows</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// gRPC to add new methods to this interface.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>ClientConn</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UpdateState updates the state of the ClientConn appropriately.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>UpdateState</span><span style=color:#111>(</span><span style=color:#75af00>State</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NewAddress is called by resolver to notify ClientConn a new list</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// of resolved addresses.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The address list should be the complete list of resolved addresses.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Deprecated: Use UpdateState instead.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>NewAddress</span><span style=color:#111>(</span><span style=color:#75af00>addresses</span> <span style=color:#111>[]</span><span style=color:#75af00>Address</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NewServiceConfig is called by resolver to notify ClientConn a new</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// service config. The service config should be provided as a json string.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Deprecated: Use UpdateState instead.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>NewServiceConfig</span><span style=color:#111>(</span><span style=color:#75af00>serviceConfig</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ul><li>resolver.Resolver <code>Resolver</code> 提供了 <code>ResolveNow</code> 用于被 gRPC 尝试重新进行服务发现</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Resolver watches for the updates on the specified target.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Updates include address updates and service config updates.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Resolver</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ResolveNow will be called by gRPC to try to resolve the target name</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// It could be called multiple times concurrently.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ResolveNow</span><span style=color:#111>(</span><span style=color:#75af00>ResolveNowOption</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Close closes the resolver.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=梳理-resolver-过程>梳理 Resolver 过程</h2><p>通过这三个接口，再次梳理下 gRPC 的服务发现实现逻辑</p><ol><li>通过 <code>Builder.Build()</code> 进行 <code>Reslover</code> 的创建，在 <code>Build()</code> 的过程中将服务发现的地址信息丢给 <code>ClientConn</code> 用于内部连接创建（通过 <code>ClientConn.UpdateState()</code> 实现）等逻辑；</li><li>当 <code>client</code> 在 <code>Dial</code> 时会根据 <code>target</code> 解析的 <code>scheme</code> 获取对应的 <code>Builder</code>，<a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L242>代码位置</a></li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>DialContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>target</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span> <span style=color:#f92672>...</span><span style=color:#75af00>DialOption</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>conn</span> <span style=color:#f92672>*</span><span style=color:#75af00>ClientConn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Determine the resolver to use.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span> <span style=color:#111>=</span> <span style=color:#75af00>parseTarget</span><span style=color:#111>(</span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>target</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>grpclog</span><span style=color:#111>.</span><span style=color:#75af00>Infof</span><span style=color:#111>(</span><span style=color:#d88200>&#34;parsed scheme: %q&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span><span style=color:#111>.</span><span style=color:#75af00>Scheme</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>resolverBuilder</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>getResolver</span><span style=color:#111>(</span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span><span style=color:#111>.</span><span style=color:#75af00>Scheme</span><span style=color:#111>)</span>		<span style=color:#75715e>// 通过 scheme(名字) 获取对应的 resolver</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>resolverBuilder</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If resolver builder is still nil, the parsed target&#39;s scheme is</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// not registered. Fallback to default resolver and set Endpoint to</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the original target.</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>grpclog</span><span style=color:#111>.</span><span style=color:#75af00>Infof</span><span style=color:#111>(</span><span style=color:#d88200>&#34;scheme %q not registered, fallback to default scheme&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span><span style=color:#111>.</span><span style=color:#75af00>Scheme</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span> <span style=color:#111>=</span> <span style=color:#75af00>resolver</span><span style=color:#111>.</span><span style=color:#75af00>Target</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>Scheme</span><span style=color:#111>:</span>   <span style=color:#75af00>resolver</span><span style=color:#111>.</span><span style=color:#75af00>GetDefaultScheme</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>Endpoint</span><span style=color:#111>:</span> <span style=color:#75af00>target</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>resolverBuilder</span> <span style=color:#111>=</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>getResolver</span><span style=color:#111>(</span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span><span style=color:#111>.</span><span style=color:#75af00>Scheme</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>resolverBuilder</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;could not get resolver for default scheme: %q&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span><span style=color:#111>.</span><span style=color:#75af00>Scheme</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Build the resolver.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>rWrapper</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>newCCResolverWrapper</span><span style=color:#111>(</span><span style=color:#75af00>cc</span><span style=color:#111>,</span> <span style=color:#75af00>resolverBuilder</span><span style=color:#111>)</span>		<span style=color:#75715e>// 通过 gRPC 提供的 Wrapper，应用我们实现的 resolver 逻辑</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to build resolver: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>resolverWrapper</span> <span style=color:#111>=</span> <span style=color:#75af00>rWrapper</span>
</span></span><span style=display:flex><span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=3><li>当 <code>Dial</code> 成功会创建出结构体 <code>ClientConn</code> 的对象 <a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L447>官方代码位置</a>(注意不是上面的 <code>ClientConn</code> 接口)，可以看到结构体 <code>ClientConn</code> 内的成员 <code>resolverWrapper</code> 又实现了接口 <code>ClientConn</code> 的方法 <a href=https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go>官方代码位置</a></li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>DialContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>target</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span> <span style=color:#f92672>...</span><span style=color:#75af00>DialOption</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>conn</span> <span style=color:#f92672>*</span><span style=color:#75af00>ClientConn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 初始化 CC</span>
</span></span><span style=display:flex><span><span style=color:#75af00>cc</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>ClientConn</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>target</span><span style=color:#111>:</span>            <span style=color:#75af00>target</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>csMgr</span><span style=color:#111>:</span>             <span style=color:#f92672>&amp;</span><span style=color:#75af00>connectivityStateManager</span><span style=color:#111>{},</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>conns</span><span style=color:#111>:</span>             <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#f92672>*</span><span style=color:#75af00>addrConn</span><span style=color:#111>]</span><span style=color:#00a8c8>struct</span><span style=color:#111>{}),</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>dopts</span><span style=color:#111>:</span>             <span style=color:#75af00>defaultDialOptions</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>blockingpicker</span><span style=color:#111>:</span>    <span style=color:#75af00>newPickerWrapper</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>czData</span><span style=color:#111>:</span>            <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>channelzData</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>firstResolveEvent</span><span style=color:#111>:</span> <span style=color:#75af00>grpcsync</span><span style=color:#111>.</span><span style=color:#75af00>NewEvent</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#75af00>cc</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=4><li>当 <code>resolverWrapper</code> 被初始化时就会调用 <code>Build</code> 方法 <a href=https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L89>官方代码位置</a>，其中参数为接口 <code>ClientConn</code> 传入的是 <code>ccResolverWrapper</code></li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// newCCResolverWrapper uses the resolver.Builder to build a Resolver and</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// returns a ccResolverWrapper object which wraps the newly built resolver.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>newCCResolverWrapper</span><span style=color:#111>(</span><span style=color:#75af00>cc</span> <span style=color:#f92672>*</span><span style=color:#75af00>ClientConn</span><span style=color:#111>,</span> <span style=color:#75af00>rb</span> <span style=color:#75af00>resolver</span><span style=color:#111>.</span><span style=color:#75af00>Builder</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>ccResolverWrapper</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ccr</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>ccResolverWrapper</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cc</span><span style=color:#111>:</span>   <span style=color:#75af00>cc</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>done</span><span style=color:#111>:</span> <span style=color:#75af00>grpcsync</span><span style=color:#111>.</span><span style=color:#75af00>NewEvent</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>credsClone</span> <span style=color:#75af00>credentials</span><span style=color:#111>.</span><span style=color:#75af00>TransportCredentials</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>creds</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>dopts</span><span style=color:#111>.</span><span style=color:#75af00>copts</span><span style=color:#111>.</span><span style=color:#75af00>TransportCredentials</span><span style=color:#111>;</span> <span style=color:#75af00>creds</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>credsClone</span> <span style=color:#111>=</span> <span style=color:#75af00>creds</span><span style=color:#111>.</span><span style=color:#75af00>Clone</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>rbo</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>resolver</span><span style=color:#111>.</span><span style=color:#75af00>BuildOptions</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>DisableServiceConfig</span><span style=color:#111>:</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>dopts</span><span style=color:#111>.</span><span style=color:#75af00>disableServiceConfig</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>DialCreds</span><span style=color:#111>:</span>            <span style=color:#75af00>credsClone</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>CredsBundle</span><span style=color:#111>:</span>          <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>dopts</span><span style=color:#111>.</span><span style=color:#75af00>copts</span><span style=color:#111>.</span><span style=color:#75af00>CredsBundle</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>Dialer</span><span style=color:#111>:</span>               <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>dopts</span><span style=color:#111>.</span><span style=color:#75af00>copts</span><span style=color:#111>.</span><span style=color:#75af00>Dialer</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// We need to hold the lock here while we assign to the ccr.resolver field</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// to guard against a data race caused by the following code path,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// rb.Build--&gt;ccr.ReportError--&gt;ccr.poll--&gt;ccr.resolveNow, would end up</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// accessing ccr.resolver which is being assigned here.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ccr</span><span style=color:#111>.</span><span style=color:#75af00>resolverMu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>defer</span> <span style=color:#75af00>ccr</span><span style=color:#111>.</span><span style=color:#75af00>resolverMu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ccr</span><span style=color:#111>.</span><span style=color:#75af00>resolver</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>rb</span><span style=color:#111>.</span><span style=color:#75af00>Build</span><span style=color:#111>(</span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>parsedTarget</span><span style=color:#111>,</span> <span style=color:#75af00>ccr</span><span style=color:#111>,</span> <span style=color:#75af00>rbo</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#75af00>ccr</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=5><li>当用户基于 <code>Builder</code> 的实现进行 <code>UpdateState</code> 调用时，则会触发结构体 <code>ClientConn</code> 的 <code>updateResolverState</code> 方法 <a href=https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L109>官方代码位置</a>，<code>updateResolverState</code> 则会对传入的 <code>Address</code> 进行初始化等逻辑 <a href=https://github.com/grpc/grpc-go/blob/master/clientconn.go#L553>官方代码位置</a></li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>cc</span> <span style=color:#f92672>*</span><span style=color:#75af00>ClientConn</span><span style=color:#111>)</span> <span style=color:#75af00>updateResolverState</span><span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#75af00>resolver</span><span style=color:#111>.</span><span style=color:#75af00>State</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>defer</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>firstResolveEvent</span><span style=color:#111>.</span><span style=color:#75af00>Fire</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Check if the ClientConn is already closed. Some fields (e.g.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// balancerWrapper) are set to nil when closing the ClientConn, and could</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// cause nil pointer panic if we don&#39;t have this check.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>conns</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// May need to apply the initial service config in case the resolver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// doesn&#39;t support service configs, or doesn&#39;t provide a service config</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// with the new addresses.</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>maybeApplyDefaultServiceConfig</span><span style=color:#111>(</span><span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>balancerWrapper</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>balancerWrapper</span><span style=color:#111>.</span><span style=color:#75af00>resolverError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// No addresses are valid with err set; return early.</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>balancer</span><span style=color:#111>.</span><span style=color:#75af00>ErrBadResolverState</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>ret</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>dopts</span><span style=color:#111>.</span><span style=color:#75af00>disableServiceConfig</span> <span style=color:#f92672>||</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>ServiceConfig</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>maybeApplyDefaultServiceConfig</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO: do we need to apply a failing LB policy if there is no</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// default, per the error handling design?</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>sc</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>ServiceConfig</span><span style=color:#111>.</span><span style=color:#75af00>Config</span><span style=color:#111>.(</span><span style=color:#f92672>*</span><span style=color:#75af00>ServiceConfig</span><span style=color:#111>);</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>ServiceConfig</span><span style=color:#111>.</span><span style=color:#75af00>Err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>applyServiceConfigAndBalancer</span><span style=color:#111>(</span><span style=color:#75af00>sc</span><span style=color:#111>,</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ret</span> <span style=color:#111>=</span> <span style=color:#75af00>balancer</span><span style=color:#111>.</span><span style=color:#75af00>ErrBadResolverState</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>balancerWrapper</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>var</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>ServiceConfig</span><span style=color:#111>.</span><span style=color:#75af00>Err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>status</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#75af00>codes</span><span style=color:#111>.</span><span style=color:#75af00>Unavailable</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;error parsing service config: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>ServiceConfig</span><span style=color:#111>.</span><span style=color:#75af00>Err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>status</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#75af00>codes</span><span style=color:#111>.</span><span style=color:#75af00>Unavailable</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;illegal service config type: %T&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>ServiceConfig</span><span style=color:#111>.</span><span style=color:#75af00>Config</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>blockingpicker</span><span style=color:#111>.</span><span style=color:#75af00>updatePicker</span><span style=color:#111>(</span><span style=color:#75af00>base</span><span style=color:#111>.</span><span style=color:#75af00>NewErrPicker</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>csMgr</span><span style=color:#111>.</span><span style=color:#75af00>updateState</span><span style=color:#111>(</span><span style=color:#75af00>connectivity</span><span style=color:#111>.</span><span style=color:#75af00>TransientFailure</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>ret</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>balCfg</span> <span style=color:#75af00>serviceconfig</span><span style=color:#111>.</span><span style=color:#75af00>LoadBalancingConfig</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>dopts</span><span style=color:#111>.</span><span style=color:#75af00>balancerBuilder</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>sc</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>sc</span><span style=color:#111>.</span><span style=color:#75af00>lbConfig</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>balCfg</span> <span style=color:#111>=</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>sc</span><span style=color:#111>.</span><span style=color:#75af00>lbConfig</span><span style=color:#111>.</span><span style=color:#75af00>cfg</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>cbn</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>curBalancerName</span>
</span></span><span style=display:flex><span><span style=color:#75af00>bw</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>balancerWrapper</span>
</span></span><span style=display:flex><span><span style=color:#75af00>cc</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>cbn</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>grpclbName</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Filter any grpclb addresses since we don&#39;t have the grpclb balancer.</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>);</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Type</span> <span style=color:#f92672>==</span> <span style=color:#75af00>resolver</span><span style=color:#111>.</span><span style=color:#75af00>GRPCLB</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>copy</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>:],</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>:])</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>[:</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Addresses</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>uccsErr</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bw</span><span style=color:#111>.</span><span style=color:#75af00>updateClientConnState</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>balancer</span><span style=color:#111>.</span><span style=color:#75af00>ClientConnState</span><span style=color:#111>{</span><span style=color:#75af00>ResolverState</span><span style=color:#111>:</span> <span style=color:#75af00>s</span><span style=color:#111>,</span> <span style=color:#75af00>BalancerConfig</span><span style=color:#111>:</span> <span style=color:#75af00>balCfg</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>ret</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ret</span> <span style=color:#111>=</span> <span style=color:#75af00>uccsErr</span> <span style=color:#75715e>// prefer ErrBadResolver state since any other error is</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// currently meaningless to the caller.</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#75af00>ret</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol start=6><li>至此整个服务发现过程就结束了。从中也可以看出 gRPC 官方提供的三个接口还是很灵活的，但也正因为灵活要实现稍微麻烦一些，而 <code>Address</code><a href=https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go#L79>官方代码位置</a> 如果直接被业务拿来用于服务节点信息的描述结构则显得有些过于简单。</li></ol><p>所以 <code>warden</code> 包装了 gRPC 的整个服务发现实现逻辑，代码分别位于 <code>pkg/naming/naming.go</code> 和 <code>warden/resolver/resolver.go</code>，其中：</p><ul><li><code>naming.go</code> 内定义了用于描述业务实例的 <code>Instance</code> 结构、用于服务注册的 <code>Registry</code> 接口、用于服务发现的 <code>Resolver</code> 接口</li><li><code>resolver.go</code> 内实现了 gRPC 官方的 <code>resolver.Builder</code> 和 <code>resolver.Resolver</code> 接口，但也暴露了 <code>naming.go</code> 内的 <code>naming.Builder</code> 和 <code>naming.Resolver</code> 接口</li></ul><h2 id=文章转自>文章转自：</h2><ul><li><a href=https://pandaychen.github.io/2019/07/11/GRPC-SERVICE-DISCOVERY/>基于 gRPC 的服务发现与负载均衡（基础篇） - 熊喵君的博客 | PANDAYCHEN</a></li><li><a href=https://pandaychen.github.io/2020/01/03/GRPC-RESOLVER-DEEP-ANALYSIS2-IN-KRATOS/>gRPC 应用篇之 Resolver 接口封装 - 熊喵君的博客 | PANDAYCHEN</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> grpc服务发现与负载均衡</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/>https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/microservice/grpc_basics/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>grpc基础</span></div></a><a href=/post/microservice/introduction_and_use_of_thrift/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>thrift的介绍及其使用</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#负载均衡--服务发现>负载均衡 && 服务发现</a><ul><li><ul><li><a href=#基础>基础</a></li><li><a href=#服务发现概念>服务发现概念</a></li><li><a href=#负载均衡概念>负载均衡概念</a></li><li><a href=#集中式-lbproxy-model>集中式 LB（Proxy Model）</a></li><li><a href=#进程内-lbbalancing-aware-client>进程内 LB（Balancing-aware Client）</a></li><li><a href=#独立-lb-进程external-load-balancing-service>独立 LB 进程（External Load Balancing Service）</a></li></ul></li><li><a href=#grpc-内置的方案>gRPC 内置的方案</a></li></ul></li><li><a href=#grpc-负载均衡的运行机制>gRPC 负载均衡的运行机制</a></li><li><a href=#负载均衡的算法及实现>负载均衡的算法及实现</a></li><li><a href=#grpc-服务治理的优势>gRPC 服务治理的优势</a></li><li><a href=#resolver-暴露的三个接口>Resolver 暴露的三个接口</a></li><li><a href=#梳理-resolver-过程>梳理 Resolver 过程</a></li><li><a href=#文章转自>文章转自：</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2025 daemon365</p><p class=powered-by>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a></p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder="Search articles..." autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>Enter 2 or more characters to start searching</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>