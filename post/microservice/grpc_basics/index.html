<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>grpc基础 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="RPC 框架原理
RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。

业界主流的 RPC 框架整体上分为 …"><meta name=keywords content="grpc,go"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/microservice/grpc_basics/"><meta property="og:title" content="grpc基础 - Daemon365"><meta property="og:description" content="RPC 框架原理
RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。

业界主流的 RPC 框架整体上分为 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2020-12-10T00:00:00+08:00"><meta property="article:modified_time" content="2020-12-10T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="microservice"><meta property="article:tag" content="grpc"><meta property="article:tag" content="go"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/microservice/grpc_basics/"><meta name=twitter:title content="grpc基础 - Daemon365"><meta name=twitter:description content="RPC 框架原理
RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。

业界主流的 RPC 框架整体上分为 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/microservice/grpc_basics/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"grpc基础","description":"\u003ch2 id=\u0022rpc-框架原理\u0022\u003eRPC 框架原理\u003c\/h2\u003e\n\u003cp\u003eRPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML\/Json\/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。\u003c\/p\u003e\n\u003cp\u003e\u003cimg src=\u0022\/images\/32547781-dc18-4784-b1a3-f6ade97bc87f.png\u0022 alt=\u0022\u0022\u003e\u003c\/p\u003e\n\u003cp\u003e业界主流的 RPC 框架整体上分为 …\u003c\/p\u003e","datePublished":"2020-12-10T00:00:00\u002b08:00","dateModified":"2020-12-10T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/microservice\/grpc_basics\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
首页</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
关于</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
归档</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
分类</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
标签</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
搜索</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>grpc基础</h1><div class=post-meta><time datetime=2020-12-10><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2020-12-10
</time><a href=/categories/microservice class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
microservice
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
4 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
667 words</span></div><div class=post-tags><a href=/tags/grpc class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
grpc
</a><a href=/tags/go class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
go</a></div></header><div class=post-body><h2 id=rpc-框架原理>RPC 框架原理</h2><p>RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。</p><p><img src=/images/32547781-dc18-4784-b1a3-f6ade97bc87f.png alt></p><p>业界主流的 RPC 框架整体上分为三类：</p><ul><li>支持多语言的 RPC 框架，比较成熟的有 Google 的 gRPC、facebook的Apache、Thrift；</li><li>只支持特定语言的 RPC 框架，例如新浪微博的 Motan；</li><li>支持服务治理等服务化特性的分布式服务框架，其底层内核仍然是 RPC 框架, 例如阿里的 Dubbo。</li></ul><h2 id=grpc是什么>gRPC是什么</h2><p><a href=http://www.oschina.net/p/grpc-framework>gRPC</a> 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C、Java 和 Go 语言版本，分别是：grpc, grpc-java, grpc-go. 其中 C 版本支持 C, C++, Node.js, Python, Ruby, Objective-C, PHP 和 C## 支持.</p><p>gRPC 基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。</p><h3 id=grc优点>grc优点</h3><ul><li>多语言：语言中立，支持多种语言。</li><li>轻量级、高性能：序列化支持 PB(Protocol Buffer)和 JSON，PB 是一种语言无关的高性能序列化框架。
可插拔</li><li>IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub。</li><li>移动端：基于标准的 HTTP2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。</li></ul><p><img src=/images/f011b389-3272-4f7f-be74-4eb0f6bb7b94.png alt></p><h2 id=安全>安全</h2><p>HTTP2 规范当使用 TLS 时强制使用 TLS 1.2 及以上的版本，并且在部署上对允许的密码施加一些额外的限制以避免已知的比如需要 SNI 支持的问题。并且期待 HTTP2 与专有的传输安全机制相结合，这些传输机制的规格说明不能提供有意义的建议。</p><h2 id=grpc使用>gRPC使用</h2><p>使用gRPC， 我们可以一次性的在一个.proto文件中定义服务并使用任何支持它的语言去实现客户端和服务端，反过来，它们可以应用在各种场景中，从Google的服务器到你自己的平板电脑—— gRPC帮你解决了不同语言及环境间通信的复杂性。使用protocol buffers还能获得其他好处，包括高效的序列号，简单的IDL以及容易进行接口更新。总之一句话，使用gRPC能让我们更容易编写跨语言的分布式代码。</p><ul><li>通过一个 protocol buffers 模式，定义一个简单的带有 Hello World 方法的 RPC 服务。</li><li>用你最喜欢的语言(如果可用的话)来创建一个实现了这个接口的服务端。</li><li>用你最喜欢的(或者其他你愿意的)语言来访问你的服务端。</li></ul><h2 id=什么用grpc>什么用grpc</h2><ul><li>服务而非对象、消息而非引用：促进微服务的系统间粗粒度消息交互设计理念。</li><li>负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。</li><li>流：Streaming API。</li><li>阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。</li><li>元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。</li><li>标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误。</li></ul><h3 id=healthcheck>HealthCheck</h3><p>gRPC 有一个标准的健康检测协议，在 gRPC 的所有语言实现中基本都提供了生成代码和用于设置运行状态的功能。</p><p>主动健康检查 health check，可以在服务提供者服务不稳定时，被消费者所感知，临时从负载均衡中摘除，减少错误请求。当服务提供者重新稳定后，health check 成功，重新加入到消费者的负载均衡，恢复请求。health check，同样也被用于外挂方式的容器健康检测，或者流量检测(k8s liveness & readiness)。</p><p><img src=/images/b0e2261e-65fd-4a25-92bd-faf3e2465848.png alt></p><p><img src=/images/2d6258dc-37b5-409b-a46f-b727115925af.png alt></p><h2 id=protubuf文件编写>protubuf文件编写</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>syntax</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;proto3&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>hello</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// option go_package = &#34;hello&#34;;</span>
</span></span><span style=display:flex><span><span style=color:#75af00>option</span> <span style=color:#75af00>go_package</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/hello&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The greeting service definition.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>service</span> <span style=color:#75af00>Greeter</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Sends a greeting</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>rpc</span> <span style=color:#75af00>SayHello</span> <span style=color:#111>(</span><span style=color:#75af00>HelloRequest</span><span style=color:#111>)</span> <span style=color:#75af00>returns</span> <span style=color:#111>(</span><span style=color:#75af00>HelloReply</span><span style=color:#111>)</span>  <span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The request message containing the user&#39;s name.</span>
</span></span><span style=display:flex><span><span style=color:#75af00>message</span> <span style=color:#75af00>HelloRequest</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>string</span> <span style=color:#75af00>name</span> <span style=color:#111>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The response message containing the greetings</span>
</span></span><span style=display:flex><span><span style=color:#75af00>message</span> <span style=color:#75af00>HelloReply</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>string</span> <span style=color:#75af00>message</span> <span style=color:#111>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=golang创建grpc-server>golang创建grpc server</h2><p>安装工具包:</p><ol><li>下载protoc <a href=https://www.zhaohaiyu.com/protobuf/>链接</a></li><li><code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</code></li><li><code>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></li></ol><p>执行:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>protoc --go_out<span style=color:#f92672>=</span>./  --go-grpc_out<span style=color:#f92672>=</span>./  hello.proto
</span></span></code></pre></div><ul><li>&ndash;proto_path: 指定了要去哪个目录中搜索import中导入的和要编译为.go的proto文件 (在这没有使用,需要的话可以加上)</li><li>&ndash;go_out:指定了生成的go文件的目录，我在这里把go文件放到本目录中</li><li>&ndash;go-grpc_out: 指定了生成的go grpc文件的目录，我在这里把go grpc文件放到本目录中</li><li>hello.proto， 定义了我要编译的文件是哪个文件。</li></ul><h3 id=go-server代码>go server代码</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/zhaohaiyu1996/akit/example/grpc/hello&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;net&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Server</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>hello</span><span style=color:#111>.</span><span style=color:#75af00>UnimplementedGreeterServer</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// SayHello implements helloworld.GreeterServer</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>Server</span><span style=color:#111>)</span> <span style=color:#75af00>SayHello</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>in</span> <span style=color:#f92672>*</span><span style=color:#75af00>hello</span><span style=color:#111>.</span><span style=color:#75af00>HelloRequest</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>hello</span><span style=color:#111>.</span><span style=color:#75af00>HelloReply</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>in</span><span style=color:#111>.</span><span style=color:#75af00>Name</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;error&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;123&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>in</span><span style=color:#111>.</span><span style=color:#75af00>Name</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;panic&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;grpc panic&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>hello</span><span style=color:#111>.</span><span style=color:#75af00>HelloReply</span><span style=color:#111>{</span><span style=color:#75af00>Message</span><span style=color:#111>:</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Hello %+v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>in</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>)},</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Ss</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span><span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>Server</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 监听本地的8848端口</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>Ss</span><span style=color:#111>{</span><span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>NewServer</span><span style=color:#111>()}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>hello</span><span style=color:#111>.</span><span style=color:#75af00>RegisterGreeterServer</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>Server</span><span style=color:#111>{})</span> <span style=color:#75715e>// 在gRPC服务端注册服务</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lis</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>net</span><span style=color:#111>.</span><span style=color:#75af00>Listen</span><span style=color:#111>(</span><span style=color:#d88200>&#34;tcp&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;127.0.0.1:8808&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;listen failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//reflection.Register(s.Server) //在给定的gRPC服务器上注册服务器反射服务</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Serve方法在lis上接受传入连接，为每个连接创建一个ServerTransport和server的goroutine。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 该goroutine读取gRPC请求，然后调用已注册的处理程序来响应它们。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Serve</span><span style=color:#111>(</span><span style=color:#75af00>lis</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to serve: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=golang创建grpc-client>golang创建grpc client</h2><p>执行:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>protoc --go_out<span style=color:#f92672>=</span>./  --go-grpc_out<span style=color:#f92672>=</span>./  hello.proto
</span></span></code></pre></div><h3 id=go-client代码>go client代码</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/zhaohaiyu1996/akit/example/grpc/hello&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 连接服务器</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#d88200>&#34;localhost:8808&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>WithInsecure</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;connect faild: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>hello</span><span style=color:#111>.</span><span style=color:#75af00>NewGreeterClient</span><span style=color:#111>(</span><span style=color:#75af00>conn</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 调用SayHello</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>r</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>SayHello</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Background</span><span style=color:#111>(),</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>hello</span><span style=color:#111>.</span><span style=color:#75af00>HelloRequest</span><span style=color:#111>{</span><span style=color:#75af00>Name</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;sayHello failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>结果:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SayHello: hello ---&gt; zhaohaiyu
</span></span></code></pre></div><h2 id=python创建grpc-client>python创建grpc client</h2><p>使用python客户端调用golang服务端的方法</p><p>下载依赖:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>pip</span> <span style=color:#111>install</span> <span style=color:#111>grpcio</span>
</span></span><span style=display:flex><span><span style=color:#111>pip</span> <span style=color:#111>install</span> <span style=color:#111>protobuf</span>
</span></span><span style=display:flex><span><span style=color:#111>pip</span> <span style=color:#111>install</span> <span style=color:#111>grpcio_tools</span>
</span></span></code></pre></div><p>执行:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python -m grpc_tools.protoc -I ./ --python_out<span style=color:#f92672>=</span>./ --grpc_python_out<span style=color:#f92672>=</span>./ hello.proto
</span></span></code></pre></div><h3 id=python-client代码>python client代码</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>grpc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>hello_pb2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>hello_pb2_grpc</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>run</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>with</span> <span style=color:#111>grpc</span><span style=color:#f92672>.</span><span style=color:#111>insecure_channel</span><span style=color:#111>(</span><span style=color:#d88200>&#39;localhost:8848&#39;</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>channel</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>stub</span> <span style=color:#f92672>=</span> <span style=color:#111>hello_pb2_grpc</span><span style=color:#f92672>.</span><span style=color:#111>HelloStub</span><span style=color:#111>(</span><span style=color:#111>channel</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>stub</span><span style=color:#f92672>.</span><span style=color:#111>SayHello</span><span style=color:#111>(</span><span style=color:#111>hello_pb2</span><span style=color:#f92672>.</span><span style=color:#111>HelloRequest</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;赵海宇&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>message</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>run</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>结果:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python ./main.go
</span></span><span style=display:flex><span>hello ---&gt; 赵海宇
</span></span></code></pre></div><h2 id=gprc的haeder>gprc的haeder</h2><ul><li>grpc是基于http2.0的rpc框架 -</li><li>grpc对于http头部传递数据进行了封装 metadata,单独抽象了一个包google.golang.org/grpc/metadata-</li><li>type ***p[string][]string其实就是一个map</li></ul><p>客户端发送方式一:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 创建md 并加入ctx</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>md</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>Pairs</span><span style=color:#111>(</span><span style=color:#d88200>&#34;key1&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;value1&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;key2&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;value2&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>NewOutgoingContext</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Background</span><span style=color:#111>(),</span><span style=color:#75af00>md</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从ctx中拿出md</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>md</span><span style=color:#111>,</span><span style=color:#75af00>_</span> <span style=color:#111>=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>FromOutgoingContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>newMd</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>Pairs</span><span style=color:#111>(</span><span style=color:#d88200>&#34;key3&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;value3&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctx</span> <span style=color:#111>=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>NewOutgoingContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span><span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#75af00>md</span><span style=color:#111>,</span><span style=color:#75af00>newMd</span><span style=color:#111>))</span>
</span></span></code></pre></div><p>客户端发送方式二:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Background</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ctx</span> <span style=color:#111>=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>AppendToOutgoingContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span><span style=color:#d88200>&#34;key1&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;value1&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;key2&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;value2&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ctx</span> <span style=color:#111>=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>AppendToOutgoingContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span><span style=color:#d88200>&#34;key3&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;value3&#34;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>服务端接收:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>md</span><span style=color:#111>,</span><span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>FromIncomingContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>实例:</p><ol><li>server:</li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;net&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pb</span> <span style=color:#d88200>&#34;test/demo13/server/hello&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/grpc-ecosystem/grpc-gateway/examples/clients/responsebody&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/uber/jaeger-client-go/crossdock/client&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;golang.org/x/net/context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;google.golang.org/grpc/metadata&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;google.golang.org/grpc/reflection&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>server</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>server</span><span style=color:#111>)</span> <span style=color:#75af00>SayHello</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>in</span> <span style=color:#f92672>*</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>HelloRequest</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>HelloResponse</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>md</span><span style=color:#111>,</span><span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>FromIncomingContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>md</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>HelloResponse</span><span style=color:#111>{</span><span style=color:#75af00>Message</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;hello ---&gt; &#34;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>in</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>},</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 监听本地的8848端口</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lis</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>net</span><span style=color:#111>.</span><span style=color:#75af00>Listen</span><span style=color:#111>(</span><span style=color:#d88200>&#34;tcp&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;localhost:8848&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;listen failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>NewServer</span><span style=color:#111>()</span> <span style=color:#75715e>// 创建gRPC服务器</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>RegisterHelloServer</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>server</span><span style=color:#111>{})</span> <span style=color:#75715e>// 在gRPC服务端注册服务</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>reflection</span><span style=color:#111>.</span><span style=color:#75af00>Register</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>)</span> <span style=color:#75715e>//在给定的gRPC服务器上注册服务器反射服务</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Serve方法在lis上接受传入连接，为每个连接创建一个ServerTransport和server的goroutine。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 该goroutine读取gRPC请求，然后调用已注册的处理程序来响应它们。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Serve</span><span style=color:#111>(</span><span style=color:#75af00>lis</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to serve: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol><li>client</li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pb</span> <span style=color:#d88200>&#34;test/demo13/client/hello&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;google.golang.org/grpc/metadata&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 连接服务器</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#d88200>&#34;localhost:8848&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>WithInsecure</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;faild to connect: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>NewHelloClient</span><span style=color:#111>(</span><span style=color:#75af00>conn</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 调用服务端的SayHello</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Background</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctx</span> <span style=color:#111>=</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>AppendToOutgoingContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span><span style=color:#d88200>&#34;zhyyz&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;961119&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>r</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>SayHello</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>HelloRequest</span><span style=color:#111>{</span><span style=color:#75af00>Name</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;sayHello failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;SayHello: %s \n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>Message</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> grpc基础</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/microservice/grpc_basics/>https://daemon365.dev/post/microservice/grpc_basics/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/database/sql_query_statement_execution_process/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>SQL查询语句执行流程</span></div></a><a href=/post/microservice/grpc_service_discovery_and_load_balancing/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>grpc服务发现与负载均衡</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#rpc-框架原理>RPC 框架原理</a></li><li><a href=#grpc是什么>gRPC是什么</a><ul><li><a href=#grc优点>grc优点</a></li></ul></li><li><a href=#安全>安全</a></li><li><a href=#grpc使用>gRPC使用</a></li><li><a href=#什么用grpc>什么用grpc</a><ul><li><a href=#healthcheck>HealthCheck</a></li></ul></li><li><a href=#protubuf文件编写>protubuf文件编写</a></li><li><a href=#golang创建grpc-server>golang创建grpc server</a><ul><li><a href=#go-server代码>go server代码</a></li></ul></li><li><a href=#golang创建grpc-client>golang创建grpc client</a><ul><li><a href=#go-client代码>go client代码</a></li></ul></li><li><a href=#python创建grpc-client>python创建grpc client</a><ul><li><a href=#python-client代码>python client代码</a></li></ul></li><li><a href=#gprc的haeder>gprc的haeder</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2026 daemon365</p><p class=powered-by>由 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 和 <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a> 驱动</p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder=搜索文章... autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>输入 2 个或更多字符开始搜索</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>