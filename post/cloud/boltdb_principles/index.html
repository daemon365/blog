<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.140.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.ico><meta itemprop=name content="boltdb 原理"><meta itemprop=description content="Don't let yourself stop."><meta name=description content="Don't let yourself stop."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://daemon365.dev/imgs/daemon365.png"><meta itemprop=keywords content="boltdb,etcd,golang,数据库,kubernetes,源码分析,事务"><meta property="og:type" content="article"><meta property="og:title" content="boltdb 原理"><meta property="og:description" content="Don't let yourself stop."><meta property="og:image" content="/imgs/daemon365.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://daemon365.dev/post/cloud/boltdb_principles/"><meta property="og:site_name" content="Daemon"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="daemon365"><meta property="article:published_time" content="2024-06-15 16:14:00 +0800 +0800"><meta property="article:modified_time" content="2024-06-15 16:14:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.5ec1f63635756d664e619fe2d87a11c7394f519beff240c124743433c9861792.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"boltdb_principles","permalink":"https://daemon365.dev/post/cloud/boltdb_principles/","title":"boltdb 原理","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JmAHxEAUVgyS8B1c",ck:"JmAHxEAUVgyS8B1c",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>boltdb 原理 - Daemon</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Daemon</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Don't let yourself stop.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>Commonweal</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#page>page</a><ul><li><a href=#branchpage--leafpage>BranchPage && LeafPage</a></li><li><a href=#metapage>MetaPage</a></li><li><a href=#freelistpage>FreelistPage</a></li></ul></li><li><a href=#node>Node</a><ul><li><a href=#page-to-node>page to node</a></li><li><a href=#node-to-page>node to page</a></li></ul></li><li><a href=#bucket>Bucket</a><ul><li><a href=#遍历-cursor>遍历 cursor</a><ul><li><a href=#seek>Seek</a></li></ul></li><li><a href=#创建-bucket-如果不存在>创建 bucket 如果不存在</a></li><li><a href=#插入-keyvalue>插入 key/value</a></li></ul></li><li><a href=#事务>事务</a><ul><li><a href=#begin>Begin</a></li><li><a href=#commit>Commit</a></li><li><a href=#rollback>Rollback</a></li></ul></li><li><a href=#view--update>View && Update</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=daemon365 src=/imgs/img-lazy-loading.gif data-src=/imgs/daemon365.png><p class=site-author-name itemprop=name>daemon365</p><div class=site-description itemprop=description>Don't let yourself stop.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>96</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/daemon365 title="Github → https://github.com/daemon365" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev title=https://go-kratos.dev target=_blank>kratos</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://daemon365.dev/post/cloud/boltdb_principles/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/daemon365.png"><meta itemprop=name content="daemon365"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="daemon365"><meta itemprop=description content="Don't let yourself stop."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="boltdb 原理"><meta itemprop=description content="简介

介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt"></span><header class=post-header><h1 class=post-title itemprop="name headline">boltdb 原理</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-06-15 16:14:00 +0800 +0800" itemprop="dateCreated datePublished" datetime="2024-06-15 16:14:00 +0800 +0800">2024-06-15
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cloud itemprop=url rel=index><span itemprop=name>cloud</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>9599</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>20分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/cloud/boltdb_principles/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><h2 id=简介>简介
<a class=header-anchor href=#%e7%ae%80%e4%bb%8b></a></h2><p>介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt</p><h2 id=page>page
<a class=header-anchor href=#page></a></h2><p>因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的
<a href=https://man7.org/linux/man-pages/man2/mmap.2.html title=mmap rel="noopener external nofollow noreferrer" target=_blank class=exturl>mmap
<i class="fa fa-external-link-alt"></i>
</a>来内存映射操作文件，这样可以提高效率。</p><p>在 linux 中，每个 page 的大小是 4KB。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-BASH data-lang=BASH><span style=display:flex><span>getconf PAGESIZE
</span></span><span style=display:flex><span><span style=color:#ae81ff>4096</span>
</span></span></code></pre></div><p>对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 <code>page</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Pgid</span> <span style=color:#66d9ef>uint64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Page</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>id</span>       <span style=color:#a6e22e>Pgid</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flags</span>    <span style=color:#66d9ef>uint16</span> <span style=color:#75715e>// page 类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>count</span>    <span style=color:#66d9ef>uint16</span> <span style=color:#75715e>// page 中的元素数量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>overflow</span> <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// 是否有后序页，如果有，overflow 表示后续页的数量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>BranchPageFlag</span>   = <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LeafPageFlag</span>     = <span style=color:#ae81ff>0x02</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MetaPageFlag</span>     = <span style=color:#ae81ff>0x04</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FreelistPageFlag</span> = <span style=color:#ae81ff>0x10</span> 
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p><code>Page</code> 里面有一个 <code>flags</code> 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。</p><ul><li>分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。</li><li>叶子页：叶子页用来存储 key 和 value。</li><li>元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。</li><li>空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。</li></ul><p>在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/eebaffa3-116e-40f0-95be-2dfc0ee58bd6.png alt></p><h3 id=branchpage--leafpage>BranchPage && LeafPage
<a class=header-anchor href=#branchpage--leafpage></a></h3><p>这两个分别存储 B+ tree 的分支页和叶子页。对应结构为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// branchPageElement represents a node on a branch page.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>branchPageElement</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pos</span>   <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// 真实数据对应的偏移量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ksize</span> <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// key 的大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pgid</span>  <span style=color:#a6e22e>Pgid</span> <span style=color:#75715e>// 指向 page 的 id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// leafPageElement represents a node on a leaf page.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>leafPageElement</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flags</span> <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// 是否是一个 bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pos</span>   <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// 真实数据对应的偏移量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ksize</span> <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// key 的大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>vsize</span> <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// value 的大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>对应的存储方式为:</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/c5206aef-62de-447a-880a-3024a75f4b3d.png alt></p><p>从 page 中拿取数据：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Page</span>) <span style=color:#a6e22e>LeafPageElements</span>() []<span style=color:#a6e22e>leafPageElement</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>count</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从 page 的指针 加上 page 的大小，就是第一个元素的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>UnsafeAdd</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>p</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>))
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 转换为 slice
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>elems</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Slice</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>leafPageElement</span>)(<span style=color:#a6e22e>data</span>), int(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>count</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elems</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Page</span>) <span style=color:#a6e22e>BranchPageElements</span>() []<span style=color:#a6e22e>branchPageElement</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>count</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>UnsafeAdd</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>p</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elems</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Slice</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>branchPageElement</span>)(<span style=color:#a6e22e>data</span>), int(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>count</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elems</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=metapage>MetaPage
<a class=header-anchor href=#metapage></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Meta</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>magic</span>    <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// boltdb 的魔数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>version</span>  <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// boltdb 的版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pageSize</span> <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// boltdb 的 page 大小 ，该值和操作系统默认的页大小保持一致
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>flags</span>    <span style=color:#66d9ef>uint32</span> 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>root</span>     <span style=color:#a6e22e>InBucket</span> <span style=color:#75715e>// boltdb 的根节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>freelist</span> <span style=color:#a6e22e>Pgid</span>   <span style=color:#75715e>// 空闲页的 id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pgid</span>     <span style=color:#a6e22e>Pgid</span> <span style=color:#75715e>// 当前 page 的 id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>txid</span>     <span style=color:#a6e22e>Txid</span> <span style=color:#75715e>// 当前事务的 id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>checksum</span> <span style=color:#66d9ef>uint64</span> <span style=color:#75715e>// 用作校验的校验和
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>它是如何写到 page 中的和从 page 中读取的呢？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 把 meta 写到 page 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Meta</span>) <span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Page</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 检查 root bucket 的 pgid 是否有效。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 如果 root.root 的 pgid 大于或等于 m.pgid，这是不合理的，因为这意味着它引用了一个尚未分配的 pgid。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>root</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pgid</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;root bucket pgid (%d) above high water mark (%d)&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pgid</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e>// 检查 freelist 的 pgid 是否有效。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	  <span style=color:#75715e>// 如果 freelist 的 pgid 大于或等于 m.pgid 且 freelist 不是 PgidNoFreelist，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	  <span style=color:#75715e>// 这同样表示它引用了一个尚未分配的 pgid，这是不合理的。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>freelist</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pgid</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>freelist</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>PgidNoFreelist</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;freelist pgid (%d) above high water mark (%d)&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>freelist</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pgid</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定 pageId 和 page 类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>Pgid</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>txid</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>MetaPageFlag</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 计算校验和
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>checksum</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Sum64</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Meta</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 从 page 中读取 meta
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Page</span>) <span style=color:#a6e22e>Meta</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>Meta</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>Meta</span>)(<span style=color:#a6e22e>UnsafeAdd</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>p</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>)))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 把 meta 的数据拷贝到 page 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Meta</span>) <span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>dest</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Meta</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>dest</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 计算校验和
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Meta</span>) <span style=color:#a6e22e>Sum64</span>() <span style=color:#66d9ef>uint64</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>h</span> = <span style=color:#a6e22e>fnv</span>.<span style=color:#a6e22e>New64a</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>Write</span>((<span style=color:#f92672>*</span>[<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Offsetof</span>(<span style=color:#a6e22e>Meta</span>{}.<span style=color:#a6e22e>checksum</span>)]<span style=color:#66d9ef>byte</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>m</span>))[:])
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>Sum64</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=freelistpage>FreelistPage
<a class=header-anchor href=#freelistpage></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>freelist</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 表示 freelist 的类型，可能会有不同的策略或实现。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>freelistType</span> <span style=color:#a6e22e>FreelistType</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存储所有已释放且可供分配的页面ID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ids</span> []<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录哪个事务ID分配了特定的页面ID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>allocs</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Txid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录即将被释放的页面ID及其所属的事务ID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>pending</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Txid</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>txPending</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 快速查找所有空闲和待处理页面ID的缓存。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cache</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 按连续页面大小分类的空闲页面，键是连续页面的大小，值是具有相同大小的起始页面ID的集合。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>freemaps</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>uint64</span>]<span style=color:#a6e22e>pidSet</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 正向映射，键是起始页面ID，值是其span大小。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>forwardMap</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#66d9ef>uint64</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 反向映射，键是结束页面ID，值是其span大小。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>backwardMap</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#66d9ef>uint64</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 空闲页面的计数（基于哈希图的版本）。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>freePagesCount</span> <span style=color:#66d9ef>uint64</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 分配函数，根据提供的事务ID和需求的页面数量分配页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>allocate</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>txid</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Txid</span>, <span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回当前空闲页面数量的函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>free_count</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 合并连续空闲页面的函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mergeSpans</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ids</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgids</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取所有空闲页面ID的函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>getFreePageIDs</span> <span style=color:#66d9ef>func</span>() []<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取一系列页面ID并初始化 freelist 的函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>readIDs</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pgids</span> []<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// FreelistType 定义了 freelist 后端的类型，用字符串表示不同的实现策略。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FreelistType</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 未来的开发计划：
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  1. 默认改为使用 `FreelistMapType`；
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  2. 移除 `FreelistArrayType`，不再公开 `FreelistMapType`，
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     并从 `DB` 和 `Options` 结构体中移除 `FreelistType` 字段。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#75715e>// FreelistArrayType 表示 freelist 的后端类型为数组。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这种类型可能适用于需要按顺序访问空闲页的场景。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>FreelistArrayType</span> = <span style=color:#a6e22e>FreelistType</span>(<span style=color:#e6db74>&#34;array&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// FreelistMapType 表示 freelist 的后端类型为哈希映射。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这种类型提供了更快的查找速度，适合于频繁、随机地访问空闲页的情况。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>FreelistMapType</span> = <span style=color:#a6e22e>FreelistType</span>(<span style=color:#e6db74>&#34;hashmap&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>把 freelist 写到 page 中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// write 将空闲和待处理的页面ID写入到 freelist 页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 在程序崩溃的事件中，所有待处理的ID都将变成空闲的，因此这些ID都需要被保存到磁盘上。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 	<span style=color:#75715e>// 设置页头中的页类型标识
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>FreelistPageFlag</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取需要保存的 PageID 数量。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>count</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>l</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 没有 id 需要保存，直接返回。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetCount</span>(uint16(<span style=color:#a6e22e>l</span>))
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>l</span> &lt; <span style=color:#ae81ff>0xFFFF</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果数量小于 0xFFFF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// 将 id 数量写入到页头中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetCount</span>(uint16(<span style=color:#a6e22e>l</span>))
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 计算指针头
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>UnsafeAdd</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>p</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>))
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 开辟一个 slice 用来存储 id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>ids</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Slice</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>)(<span style=color:#a6e22e>data</span>), <span style=color:#a6e22e>l</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将 id 拷贝到 page 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>copyall</span>(<span style=color:#a6e22e>ids</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果数量大于 0xFFFF ，则需要分多个 page 来保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// 先设置本页的数量为 0xFFFF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetCount</span>(<span style=color:#ae81ff>0xFFFF</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 计算指针头 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>UnsafeAdd</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>p</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ids</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Slice</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>)(<span style=color:#a6e22e>data</span>), <span style=color:#a6e22e>l</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将ID数量存储在第一个元素中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>ids</span>[<span style=color:#ae81ff>0</span>] = <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#a6e22e>l</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将剩余的 id 拷贝到 page 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>copyall</span>(<span style=color:#a6e22e>ids</span>[<span style=color:#ae81ff>1</span>:])
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// copyall 将所有空闲的ID和所有待处理的ID复制到一个排序后的列表中。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// f.count 返回目标数组 dst 需要的最小长度。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>copyall</span>(<span style=color:#a6e22e>dst</span> []<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建一个切片用于存放待处理的ID，容量预设为待处理ID的数量。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgids</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>pending_count</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 遍历所有待处理事务，并将它们的ID加入到切片 m 中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>txp</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>pending</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>m</span> = append(<span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>txp</span>.<span style=color:#a6e22e>ids</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 对切片 m 进行排序。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将已经空闲的ID和刚排序的待处理ID合并到目标切片 dst 中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Mergepgids</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>getFreePageIDs</span>(), <span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Mergepgids 将两个已排序列表 a 和 b 的并集复制到 dst 中。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果 dst 的长度不足以容纳结果，会触发 panic。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Mergepgids</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>Pgids</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查目标切片 dst 是否足够大以容纳 a 和 b 的所有元素。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>dst</span>) &lt; len(<span style=color:#a6e22e>a</span>)<span style=color:#f92672>+</span>len(<span style=color:#a6e22e>b</span>) {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;mergepgids bad len %d &lt; %d + %d&#34;</span>, len(<span style=color:#a6e22e>dst</span>), len(<span style=color:#a6e22e>a</span>), len(<span style=color:#a6e22e>b</span>)))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果其中一个列表为空，则直接将另一个列表复制到 dst 中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>a</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        copy(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>b</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        copy(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>a</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化一个切片 merged 来存储最终合并的结果。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>merged</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dst</span>[:<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确定哪个列表的起始值更小，并将其设为 lead，另一个设为 follow。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>lead</span>, <span style=color:#a6e22e>follow</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>[<span style=color:#ae81ff>0</span>] &lt; <span style=color:#a6e22e>a</span>[<span style=color:#ae81ff>0</span>] {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lead</span>, <span style=color:#a6e22e>follow</span> = <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 循环合并，直到 lead 为空。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>lead</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 合并 lead 中所有小于 follow[0] 的元素。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Search</span>(len(<span style=color:#a6e22e>lead</span>), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lead</span>[<span style=color:#a6e22e>i</span>] &gt; <span style=color:#a6e22e>follow</span>[<span style=color:#ae81ff>0</span>] })
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>merged</span> = append(<span style=color:#a6e22e>merged</span>, <span style=color:#a6e22e>lead</span>[:<span style=color:#a6e22e>n</span>]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>&gt;=</span> len(<span style=color:#a6e22e>lead</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 交换 lead 和 follow，继续合并过程。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>lead</span>, <span style=color:#a6e22e>follow</span> = <span style=color:#a6e22e>follow</span>, <span style=color:#a6e22e>lead</span>[<span style=color:#a6e22e>n</span>:]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将剩余的 follow 元素加入到 merged 中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>_</span> = append(<span style=color:#a6e22e>merged</span>, <span style=color:#a6e22e>follow</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>从 page 中读取 freelist：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// read 从 freelist 页面读取页面ID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 首先检查是否为 freelist 页面，如果不是则抛出错误。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>IsFreelistPage</span>() {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;invalid freelist page: %d, page type is %s&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Id</span>(), <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Typ</span>()))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从页面获取 freelist 页面的ID列表。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ids</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>FreelistPageIds</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果获取的ID列表为空，将 f.ids 设置为 nil，表示没有空闲页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>ids</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ids</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果ID列表不为空，则创建一个新切片并复制这些ID，以避免直接修改原始页面数据。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>idsCopy</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>, len(<span style=color:#a6e22e>ids</span>))
</span></span><span style=display:flex><span>        copy(<span style=color:#a6e22e>idsCopy</span>, <span style=color:#a6e22e>ids</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 确保复制的ID列表是排序的。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgids</span>(<span style=color:#a6e22e>idsCopy</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将排序后的ID列表读入 freelist 结构。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>readIDs</span>(<span style=color:#a6e22e>idsCopy</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// hashmapReadIDs 读取输入的 pgids 并初始化 freelist（基于哈希映射的版本）。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>hashmapReadIDs</span>(<span style=color:#a6e22e>pgids</span> []<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化 freelist。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>pgids</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重建页面缓存。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>reindex</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// reindex 基于可用和待处理的空闲列表重建自由缓存。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>reindex</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取所有空闲页面ID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ids</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>getFreePageIDs</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建一个新的缓存映射。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#66d9ef>struct</span>{}, len(<span style=color:#a6e22e>ids</span>))
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将所有空闲ID添加到缓存中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>id</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ids</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将所有待处理的空闲ID也添加到缓存中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>txp</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>pending</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pendingID</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>txp</span>.<span style=color:#a6e22e>ids</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>pendingID</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>分配页：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hashmapAllocate 根据传入的事务ID和请求的页面数量，分配页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>hashmapAllocate</span>(<span style=color:#a6e22e>txid</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Txid</span>, <span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果请求的页面数量为0，则直接返回0，表示没有分配任何页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 检查是否存在完全匹配的空闲span。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bm</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span>[uint64(<span style=color:#a6e22e>n</span>)]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>bm</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 移除这个span。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>delSpan</span>(<span style=color:#a6e22e>pid</span>, uint64(<span style=color:#a6e22e>n</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 记录这个页面ID被哪个事务分配。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>allocs</span>[<span style=color:#a6e22e>pid</span>] = <span style=color:#a6e22e>txid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 从缓存中移除已分配的页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#a6e22e>n</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>, <span style=color:#a6e22e>pid</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pid</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在映射中查找大于请求大小的更大span。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>bm</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> &lt; uint64(<span style=color:#a6e22e>n</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>bm</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 移除找到的大span。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>delSpan</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 记录页面分配。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>allocs</span>[<span style=color:#a6e22e>pid</span>] = <span style=color:#a6e22e>txid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 计算剩余的span大小，并添加回 freelist。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>remain</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>-</span> uint64(<span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>addSpan</span>(<span style=color:#a6e22e>pid</span><span style=color:#f92672>+</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#a6e22e>n</span>), <span style=color:#a6e22e>remain</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 从缓存中移除已分配的页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#a6e22e>n</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>, <span style=color:#a6e22e>pid</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pid</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// delSpan 从 freelist 中删除一个span。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>delSpan</span>(<span style=color:#a6e22e>start</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>, <span style=color:#a6e22e>size</span> <span style=color:#66d9ef>uint64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新前向和后向映射，移除对应的条目。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>forwardMap</span>, <span style=color:#a6e22e>start</span>)
</span></span><span style=display:flex><span>	delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>backwardMap</span>, <span style=color:#a6e22e>start</span><span style=color:#f92672>+</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#a6e22e>size</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从 freemaps 中移除span。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span>[<span style=color:#a6e22e>size</span>], <span style=color:#a6e22e>start</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span>[<span style=color:#a6e22e>size</span>]) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果某个大小的span已经没有其他项，从 freemaps 中完全移除这个大小。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span>, <span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新空闲页面计数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freePagesCount</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>size</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// addSpan 向 freelist 中添加一个新的span。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>addSpan</span>(<span style=color:#a6e22e>start</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>, <span style=color:#a6e22e>size</span> <span style=color:#66d9ef>uint64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新前向和后向映射。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>backwardMap</span>[<span style=color:#a6e22e>start</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>+</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>(<span style=color:#a6e22e>size</span>)] = <span style=color:#a6e22e>size</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>forwardMap</span>[<span style=color:#a6e22e>start</span>] = <span style=color:#a6e22e>size</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 确保 freemaps 中存在对应大小的映射。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span>[<span style=color:#a6e22e>size</span>]; !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span>[<span style=color:#a6e22e>size</span>] = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 添加新的span到 freemaps。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freemaps</span>[<span style=color:#a6e22e>size</span>][<span style=color:#a6e22e>start</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新空闲页面计数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>freePagesCount</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>size</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=node>Node
<a class=header-anchor href=#node></a></h2><p>page 的操作跟多都是基于磁盘设计的，在内存中使用这些数据结构并不是很方便。所以 boltdb 会把 page 的数据结构转换为 node 的数据结构，这样在内存中操作就会方便很多。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>node</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bucket</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span> <span style=color:#75715e>// bucket 的指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>isLeaf</span>     <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// 是否是叶子节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>unbalanced</span> <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// 是否平衡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>spilled</span>    <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// 是否溢出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>key</span>        []<span style=color:#66d9ef>byte</span> <span style=color:#75715e>// 该 node 的起始 key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pgid</span>       <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span> <span style=color:#75715e>// 该 node 对应的 page id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>parent</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span> <span style=color:#75715e>// 父节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>children</span>   <span style=color:#a6e22e>nodes</span> <span style=color:#75715e>// 子节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>inodes</span>     <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Inodes</span> <span style=color:#75715e>// 存储键值对的结构体数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Inode</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flags</span> <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// 用于 leaf node 是否是一个 bucket （subbucket）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pgid</span>  <span style=color:#a6e22e>Pgid</span>	<span style=color:#75715e>// 用于 branch node, 子节点的 page id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>key</span>   []<span style=color:#66d9ef>byte</span> <span style=color:#75715e>// key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>value</span> []<span style=color:#66d9ef>byte</span> <span style=color:#75715e>// value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Inodes</span> []<span style=color:#a6e22e>Inode</span>
</span></span></code></pre></div><h3 id=page-to-node>page to node
<a class=header-anchor href=#page-to-node></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span>) <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>pgid</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Id</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>isLeaf</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>IsLeafPage</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 读取 inodes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span> = <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>ReadInodeFromPage</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 保存第一个键，以便在将节点写入到父节点时能够找到这个节点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>key</span> = <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Key</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>key</span>) &gt; <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;read: zero-length node key&#34;</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>key</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ReadInodeFromPage</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Page</span>) <span style=color:#a6e22e>Inodes</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>inodes</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>Inodes</span>, int(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Count</span>()))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>isLeaf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>IsLeafPage</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; int(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Count</span>()); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>inode</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isLeaf</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 转换为 leafPageElement 结构
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>LeafPageElement</span>(uint16(<span style=color:#a6e22e>i</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Flags</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetKey</span>(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Key</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Value</span>())
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 转换为 branchPageElement 结构
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>BranchPageElement</span>(uint16(<span style=color:#a6e22e>i</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetPgid</span>(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Pgid</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetKey</span>(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Key</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Assert</span>(len(<span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>Key</span>()) &gt; <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;read: zero-length inode key&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>inodes</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=node-to-page>node to page
<a class=header-anchor href=#node-to-page></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// write writes the items onto one or more pages.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The page should have p.id (might be 0 for meta or bucket-inline page) and p.overflow set
</span></span></span><span style=display:flex><span><span style=color:#75715e>// and the rest should be zeroed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span>) <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Count</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Flags</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;node cannot be written into a not empty page&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Initialize page.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>isLeaf</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>LeafPageFlag</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>BranchPageFlag</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0xFFFF</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;inode overflow: %d (pgid=%d)&#34;</span>, len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>), <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Id</span>()))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SetCount</span>(uint16(len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stop here if there are no items to write.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Count</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将node的inodes写入page
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>WriteInodeToPage</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>, <span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// DEBUG ONLY: n.dump()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WriteInodeToPage</span>(<span style=color:#a6e22e>inodes</span> <span style=color:#a6e22e>Inodes</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Page</span>) <span style=color:#66d9ef>uint32</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 计算写入的初始偏移量。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>off</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>PageElementSize</span>()<span style=color:#f92672>*</span>uintptr(len(<span style=color:#a6e22e>inodes</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>isLeaf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>IsLeafPage</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>item</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>inodes</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Assert</span>(len(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Key</span>()) &gt; <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;write: zero-length inode key&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建一个足够大小的切片来存放键和值。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sz</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Key</span>()) <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Value</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>UnsafeByteSlice</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>p</span>), <span style=color:#a6e22e>off</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>sz</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>off</span> <span style=color:#f92672>+=</span> uintptr(<span style=color:#a6e22e>sz</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Write the page element.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isLeaf</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>LeafPageElement</span>(uint16(<span style=color:#a6e22e>i</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>SetPos</span>(uint32(uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>b</span>[<span style=color:#ae81ff>0</span>])) <span style=color:#f92672>-</span> uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>elem</span>))))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Flags</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>SetKsize</span>(uint32(len(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Key</span>())))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>SetVsize</span>(uint32(len(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Value</span>())))
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>BranchPageElement</span>(uint16(<span style=color:#a6e22e>i</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>SetPos</span>(uint32(uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>b</span>[<span style=color:#ae81ff>0</span>])) <span style=color:#f92672>-</span> uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>elem</span>))))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>SetKsize</span>(uint32(len(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Key</span>())))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>SetPgid</span>(<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Pgid</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Assert</span>(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Pgid</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Id</span>(), <span style=color:#e6db74>&#34;write: circular dependency occurred&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将键和值数据写入到页面的末尾。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> copy(<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Key</span>())
</span></span><span style=display:flex><span>		copy(<span style=color:#a6e22e>b</span>[<span style=color:#a6e22e>l</span>:], <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>Value</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> uint32(<span style=color:#a6e22e>off</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=bucket>Bucket
<a class=header-anchor href=#bucket></a></h2><p>Bucket 是 boltdb 的上层的数据结构，每个 bucket 都有一个完成的 B+ 树。将多个 page 联合起来。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Bucket</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>InBucket</span>             
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tx</span>       <span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>                    <span style=color:#75715e>// 指向关联事务的指针，将 bucket 与其事务上下文连接。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>buckets</span>  <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span>     <span style=color:#75715e>// 子 bucket 缓存；允许通过名字快速访问子 bucket。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>page</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span>           <span style=color:#75715e>// 内联页面的引用，用于直接存储少量数据或作为数据节点的入口点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rootNode</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span>                  <span style=color:#75715e>// 根页面的已实例化节点，如果 bucket 直接存储在内存中，则此节点将被激活。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>nodes</span>    <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>node</span>  <span style=color:#75715e>// 节点缓存，用于快速访问已加载的页面节点，避免重复读取磁盘。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置节点分裂时的填充阈值。默认情况下，bucket 将填充至 50%，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 但如果你知道你的写入工作负载主要是追加操作，提高这个比例可能会有用。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这个设置不会跨事务持久化，因此每个事务都必须设置它。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>FillPercent</span> <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>InBucket</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>root</span>     <span style=color:#a6e22e>Pgid</span>   <span style=color:#75715e>// bucket 根级页面的页面ID。如果 bucket 是内联的，则此值为 0。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sequence</span> <span style=color:#66d9ef>uint64</span> <span style=color:#75715e>// 单调递增的序列号，用于 NextSequence() 函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Bucket 有可能是 node，也可能是 page。查找某页面的键值对时，首先检查 Bucket.nodes 缓存是否有对应的 node，如果没有，再从 page 中查找。
Bucket.FillPercent 记录 node 的填充百分比。当 node 的已用空间超过其容量的某个百分比后，节点必须分裂，以减少在 B+ Tree 中插入键值对时触发再平衡的概率。默认值是 50%，仅当大量写入操作在尾部添加时，增大该值才有帮助。</p><p>bucket 存储方式：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/04c8dda1-ff6f-4ae5-9162-bf31819e9a9c.png alt></p><h3 id=遍历-cursor>遍历 cursor
<a class=header-anchor href=#%e9%81%8d%e5%8e%86-cursor></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Cursor</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bucket</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stack</span>  []<span style=color:#a6e22e>elemRef</span> 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>elemRef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>page</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span>        
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>cursor 分为三类，定位到某一个元素的位置、在当前位置从前往后找、在当前位置从后往前找。方法为：First、Last、Next、Prev 等。</p><h4 id=seek>Seek
<a class=header-anchor href=#seek></a></h4><p>如果该键存在，它会返回该键及其对应的值；如果键不存在，它则返回最近的后续键。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Seek 方法使用B树搜索将光标移动到给定的键并返回它。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果键不存在，则使用下一个键。如果没有更多的键，返回nil。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 返回的键和值只在事务的生命周期内有效。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>Seek</span>(<span style=color:#a6e22e>seek</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>value</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保数据库事务没有关闭
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;tx closed&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用内部的seek方法，获取键和值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>flags</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>seek</span>(<span style=color:#a6e22e>seek</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否位于页面的最后一个元素之后，如果是，则移动到下一个元素。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ref</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]; <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>index</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>count</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>flags</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>next</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果k为nil，表示未找到键，返回nil。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>k</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> uint32(<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>BucketLeafFlag</span>)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果是叶子节点，返回键和nil值。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>k</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回找到的键和值。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// seek 方法将光标移动到给定的键，并返回该键。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果键不存在，则使用下一个键。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>seek</span>(<span style=color:#a6e22e>seek</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>value</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>flags</span> <span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从根页面/节点开始，遍历到正确的页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[:<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>search</span>(<span style=color:#a6e22e>seek</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>RootPage</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是桶，则返回nil值。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>keyValue</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>search</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// search 方法递归地对给定的页面/节点进行二分搜索，直到找到给定的键。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>search</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>pgId</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>pageNode</span>(<span style=color:#a6e22e>pgId</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>IsBranchPage</span>() <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>IsLeafPage</span>() {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;invalid page type: %d: %x&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Id</span>(), <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Flags</span>()))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>elemRef</span>{<span style=color:#a6e22e>page</span>: <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>node</span>: <span style=color:#a6e22e>n</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span> = append(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果我们位于叶节点页面上，则在该页面内部继续查找特定节点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>isLeaf</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nsearch</span>(<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是节点，继续在节点内部搜索。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>searchNode</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是页面，继续在页面内部搜索。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>searchPage</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>searchNode</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>exact</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用二分搜索确定键的位置。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Search</span>(len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ret</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ret</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exact</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ret</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exact</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>index</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>index</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>index</span> = <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 递归搜索到下一页。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>search</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>index</span>].<span style=color:#a6e22e>Pgid</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>searchPage</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 对页面进行二分搜索以确定正确的范围。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>inodes</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>BranchPageElements</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>exact</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Search</span>(int(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Count</span>()), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ret</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ret</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exact</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ret</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exact</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>index</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>index</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>index</span> = <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 递归搜索到下一页。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>search</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>index</span>].<span style=color:#a6e22e>Pgid</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>nsearch</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If we have a node then search its inodes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Search</span>(len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>key</span>) <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>index</span> = <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If we have a page then search its leaf elements.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>inodes</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>LeafPageElements</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Search</span>(int(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Count</span>()), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>key</span>) <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>index</span> = <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>keyValue</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>keyValue</span>() ([]<span style=color:#66d9ef>byte</span>, []<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ref</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果索引超出范围，则返回nil。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>count</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>index</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>count</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  从node中获取键值对。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>node</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>inode</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>index</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>Value</span>(), <span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>Flags</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从 page 中获取键值对。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>LeafPageElement</span>(uint16(<span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>index</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Value</span>(), <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>Flags</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=创建-bucket-如果不存在>创建 bucket 如果不存在
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba-bucket-%e5%a6%82%e6%9e%9c%e4%b8%8d%e5%ad%98%e5%9c%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// CreateBucketIfNotExists 如果指定的存储桶不存在，则创建它，并返回一个对它的引用。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果存储桶名为空或太长，则返回错误。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 存储桶实例仅在事务的生命周期内有效。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span>) <span style=color:#a6e22e>CreateBucketIfNotExists</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>rb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果日志不是被丢弃，记录创建存储桶的尝试。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Logger</span>(); <span style=color:#a6e22e>lg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>discardLogger</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Creating bucket if not exist %q&#34;</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Creating bucket if not exist %q failed: %v&#34;</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Creating bucket if not exist %q successfully&#34;</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查数据库是否关闭，检查事务是否可写，检查键名是否为空。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrTxClosed</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>writable</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrTxNotWritable</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>key</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrBucketNameRequired</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用克隆的键而不是原始键，以避免内存泄漏。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>newKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cloneBytes</span>(<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查键是否已存在。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span>[string(<span style=color:#a6e22e>newKey</span>)]; <span style=color:#a6e22e>child</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>child</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用光标寻找正确的位置。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Cursor</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>flags</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>seek</span>(<span style=color:#a6e22e>newKey</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果找到的键相同，检查是否已有相同名字的非存储桶键。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>newKey</span>, <span style=color:#a6e22e>k</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>BucketLeafFlag</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>child</span> = <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>openBucket</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span>[string(<span style=color:#a6e22e>newKey</span>)] = <span style=color:#a6e22e>child</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>child</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrIncompatibleValue</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建空的内联存储桶。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>bucket</span> = <span style=color:#a6e22e>Bucket</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>InBucket</span>:    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>InBucket</span>{},
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rootNode</span>:    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>node</span>{<span style=color:#a6e22e>isLeaf</span>: <span style=color:#66d9ef>true</span>},
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>FillPercent</span>: <span style=color:#a6e22e>DefaultFillPercent</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>write</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在当前节点上插入键、值、标志。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>node</span>().<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>newKey</span>, <span style=color:#a6e22e>newKey</span>, <span style=color:#a6e22e>value</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>BucketLeafFlag</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果存在内联页面，取消引用它，使得存储桶被视为常规非内联存储桶。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>page</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回新创建的存储桶。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Bucket</span>(<span style=color:#a6e22e>newKey</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// node方法返回光标当前定位的节点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cursor</span>) <span style=color:#a6e22e>node</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保光标栈长度大于0，否则抛出异常。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>) &gt; <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;accessing a node with a zero-length cursor stack&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果栈顶是叶子节点，直接返回该节点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ref</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]; <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>node</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>isLeaf</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从根开始，向下遍历层级结构。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>n</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>n</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>node</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Id</span>(), <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ref</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>[:len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>stack</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(!<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>isLeaf</span>, <span style=color:#e6db74>&#34;expected branch node&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>n</span> = <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>childAt</span>(<span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>isLeaf</span>, <span style=color:#e6db74>&#34;expected leaf node&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// put方法在节点中插入键值对。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>node</span>) <span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>oldKey</span>, <span style=color:#a6e22e>newKey</span>, <span style=color:#a6e22e>value</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>pgId</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>, <span style=color:#a6e22e>flags</span> <span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查pgId是否超出限制。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pgId</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Pgid</span>() {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;pgId (%d) above high water mark (%d)&#34;</span>, <span style=color:#a6e22e>pgId</span>, <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Pgid</span>()))
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>oldKey</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#e6db74>&#34;put: zero-length old key&#34;</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>newKey</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#e6db74>&#34;put: zero-length new key&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 寻找插入的位置。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Search</span>(len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>oldKey</span>) <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果没有找到确切匹配，增加容量并移动节点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>exact</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>index</span> &lt; len(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>index</span>].<span style=color:#a6e22e>Key</span>(), <span style=color:#a6e22e>oldKey</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exact</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span> = append(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>, <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Inode</span>{})
</span></span><span style=display:flex><span>        copy(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>index</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:], <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>index</span>:])
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置inode的属性。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>inode</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>inodes</span>[<span style=color:#a6e22e>index</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>flags</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetKey</span>(<span style=color:#a6e22e>newKey</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>SetPgid</span>(<span style=color:#a6e22e>pgId</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(len(<span style=color:#a6e22e>inode</span>.<span style=color:#a6e22e>Key</span>()) &gt; <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;put: zero-length inode key&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Bucket方法通过名称检索嵌套桶。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果桶不存在，返回nil。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 返回的桶实例只在事务生命周期内有效。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span>) <span style=color:#a6e22e>Bucket</span>(<span style=color:#a6e22e>name</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果已有桶缓存，则直接返回对应桶。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span>[string(<span style=color:#a6e22e>name</span>)]; <span style=color:#a6e22e>child</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>child</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 移动光标到键位置。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Cursor</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>flags</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>seek</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果键不存在或者不是桶标志，则返回nil。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>k</span>) <span style=color:#f92672>||</span> (<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>BucketLeafFlag</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 否则创建并缓存桶。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>child</span> = <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>openBucket</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>buckets</span>[string(<span style=color:#a6e22e>name</span>)] = <span style=color:#a6e22e>child</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>child</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=插入-keyvalue>插入 key/value
<a class=header-anchor href=#%e6%8f%92%e5%85%a5-keyvalue></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Bucket</span>) <span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>value</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Logger</span>(); <span style=color:#a6e22e>lg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>discardLogger</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Putting key %q&#34;</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Putting key %q failed: %v&#34;</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Putting key %q successfully&#34;</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrTxClosed</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Writable</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrTxNotWritable</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>key</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrKeyRequired</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>key</span>) &gt; <span style=color:#a6e22e>MaxKeySize</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrKeyTooLarge</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> int64(len(<span style=color:#a6e22e>value</span>)) &gt; <span style=color:#a6e22e>MaxValueSize</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrValueTooLarge</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cloneBytes</span>(<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 移动光标到键位置。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Cursor</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>flags</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>seek</span>(<span style=color:#a6e22e>newKey</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Return an error if there is an existing key with a bucket value.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>newKey</span>, <span style=color:#a6e22e>k</span>) <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>flags</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>BucketLeafFlag</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrIncompatibleValue</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// gofail: var beforeBucketPut struct{}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>node</span>().<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>newKey</span>, <span style=color:#a6e22e>newKey</span>, <span style=color:#a6e22e>value</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=事务>事务
<a class=header-anchor href=#%e4%ba%8b%e5%8a%a1></a></h2><p>BoltDB 支持 ACID 事务，并采用了使用读写锁机制，支持多个读操作与一个写操作并发执行，让应用程序可以更简单的处理复杂操作。每个事务都有一个 txid，其中db.meta.txid 保存了最大的已提交的写事务 id。BoltDB 对写事务和读事务执行不同的 id 分配策略：</p><ol><li>读事务：txid == db.meta.txid；</li><li>写事务：txid == db.meta.txid + 1；</li><li>当写事务成功提交时，会更新了db.meta.txid为当前写事务 id。</li></ol><p>数据库初始化时会将页号为 0 和 1 的两个页面设置为meta页，每个事务会获得一个txid，并选取txid % 2的meta页做为该事务的读取对象，每次写数据后会交替更新meta页。当其中一个出现数据校验不一致时会使用另一个meta页。
BoltDB 的写操作都是在内存中进行，若事务未 commit 时出错，不会对数据库造成影响；若是在 commit 的过程中出错，BoltDB 写入文件的顺序也保证了不会造成影响：因为数据会写在新的 page 中不会覆盖原来的数据，且此时 meta中的信息不发生变化。</p><ol><li>开始一份写事务时，会拷贝一份 meta数据；</li><li>从 rootBucket 开始，遍历 B+ Tree 查找数据位置并修改；</li><li>修改操作完成后会进行事务 commit，此时会将数据写入新的 page；</li><li>最后更新meta的信息。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Tx 代表数据库上的一个只读或读写事务。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 只读事务可用于检索键值和创建光标。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 读写事务可以创建和删除桶以及创建和删除键。
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 重要：必须在使用完事务后提交或回滚事务。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 只有当没有事务在使用页面时，写入者才能回收这些页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 长时间运行的读事务可能会导致数据库迅速增长。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Tx</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>writable</span>       <span style=color:#66d9ef>bool</span>           <span style=color:#75715e>// 是否为可写事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>managed</span>        <span style=color:#66d9ef>bool</span>           <span style=color:#75715e>// 是否为管理事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>             <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>            <span style=color:#75715e>// 关联的数据库实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>meta</span>           <span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Meta</span>   <span style=color:#75715e>// 元数据指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>root</span>           <span style=color:#a6e22e>Bucket</span>         <span style=color:#75715e>// 根桶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pages</span>          <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgid</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Page</span> <span style=color:#75715e>// 页面映射
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stats</span>          <span style=color:#a6e22e>TxStats</span>        <span style=color:#75715e>// 事务统计
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>commitHandlers</span> []<span style=color:#66d9ef>func</span>()       <span style=color:#75715e>// 提交处理程序列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WriteFlag 指定写相关方法（如 WriteTo()）的标志。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Tx 使用指定的标志打开数据库文件以复制数据。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 默认情况下，此标志未设置，适合主要在内存中的工作负载。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 对于大于可用 RAM 的数据库，可以设置为 syscall.O_DIRECT 来避免淘汰页面缓存。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>WriteFlag</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=begin>Begin
<a class=header-anchor href=#begin></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Begin 开始一个新事务。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 多个只读事务可以并发使用，但一次只能使用一个写事务。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 启动多个写事务会导致调用阻塞，并序列化直到当前写事务完成。
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 事务不应该彼此依赖。在同一个goroutine中打开一个读事务和一个写事务可能会导致写入者死锁，
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 因为数据库需要定期重新映射自身以应对增长，并且在读事务打开的时候无法进行。
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果需要长时间运行的读事务（例如，快照事务），你可能想要将DB.InitialMmapSize设置为足够大的值
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 以避免写事务的潜在阻塞。
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 重要：你必须在完成后关闭只读事务，否则数据库将无法回收旧页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>Begin</span>(<span style=color:#a6e22e>writable</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Logger</span>(); <span style=color:#a6e22e>lg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>discardLogger</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Starting a new transaction [writable: %t]&#34;</span>, <span style=color:#a6e22e>writable</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Starting a new transaction [writable: %t] failed: %v&#34;</span>, <span style=color:#a6e22e>writable</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Starting a new transaction [writable: %t] successfully&#34;</span>, <span style=color:#a6e22e>writable</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>writable</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>beginRWTx</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>beginTx</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>beginRWTx</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If the database was opened with Options.ReadOnly, return an error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>readOnly</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrDatabaseReadOnly</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Obtain writer lock. This is released by the transaction when it closes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// This enforces only one writer transaction at a time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>rwlock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Once we have the writer lock then we can lock the meta pages so that
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// we can set up the transaction.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>metalock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>metalock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not open yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>opened</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>rwlock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrDatabaseNotOpen</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not correctly mapped.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>rwlock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrInvalidMapping</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create a transaction associated with the database.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Tx</span>{<span style=color:#a6e22e>writable</span>: <span style=color:#66d9ef>true</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>db</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>rwtx</span> = <span style=color:#a6e22e>t</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freePages</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// freePages 释放与已关闭的只读事务关联的任何页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>freePages</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>txsById</span>(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>txs</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>minid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Txid</span>(<span style=color:#ae81ff>0xFFFFFFFFFFFFFFFF</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>txs</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>minid</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>txs</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Txid</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>minid</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freelist</span>.<span style=color:#a6e22e>release</span>(<span style=color:#a6e22e>minid</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>txs</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freelist</span>.<span style=color:#a6e22e>releaseRange</span>(<span style=color:#a6e22e>minid</span>, <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Txid</span>()<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>minid</span> = <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Txid</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freelist</span>.<span style=color:#a6e22e>releaseRange</span>(<span style=color:#a6e22e>minid</span>, <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Txid</span>(<span style=color:#ae81ff>0xFFFFFFFFFFFFFFFF</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>beginTx</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Lock the meta pages while we initialize the transaction. We obtain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// the meta lock before the mmap lock because that&#39;s the order that the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// write transaction will obtain them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>metalock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Obtain a read-only lock on the mmap. When the mmap is remapped it will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// obtain a write lock so all transactions must finish before it can be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// remapped.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>mmaplock</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not open yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>opened</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>mmaplock</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>metalock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrDatabaseNotOpen</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not correctly mapped.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>mmaplock</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>metalock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrInvalidMapping</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create a transaction associated with the database.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Tx</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>db</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Keep track of transaction until it closes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>txs</span> = append(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>txs</span>, <span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>txs</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Unlock the meta pages.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>metalock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Update the transaction stats.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>statlock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>TxN</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>OpenTxN</span> = <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>statlock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=commit>Commit
<a class=header-anchor href=#commit></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Commit 将所有更改写入磁盘，更新元数据页，并关闭事务。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果磁盘写入发生错误，或者在只读事务上调用Commit，将返回错误。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>tx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>) <span style=color:#a6e22e>Commit</span>() (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>txId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>ID</span>()  <span style=color:#75715e>// 获取事务ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>lg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Logger</span>()  <span style=color:#75715e>// 获取日志记录器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>discardLogger</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Committing transaction %d&#34;</span>, <span style=color:#a6e22e>txId</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Committing transaction failed: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Committing transaction %d successfully&#34;</span>, <span style=color:#a6e22e>txId</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否为管理事务，不允许提交。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(!<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>managed</span>, <span style=color:#e6db74>&#34;managed tx commit not allowed&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrTxClosed</span>  <span style=color:#75715e>// 事务已关闭错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>writable</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrTxNotWritable</span>  <span style=color:#75715e>// 非写事务错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO: 使用向量化I/O写出脏页
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重新平衡删除后的节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>startTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>rebalance</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>GetRebalance</span>() &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncRebalanceTime</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opgid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Pgid</span>()  <span style=color:#75715e>// 获取旧的页面ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将数据溢出到脏页
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>startTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>spill</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;spilling data onto dirty pages failed: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>rollback</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncSpillTime</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 释放旧的根桶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>RootBucket</span>().<span style=color:#a6e22e>SetRootPage</span>(<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>RootPage</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 释放旧的自由列表，因为提交会写出一个新的自由列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Freelist</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>PgidNoFreelist</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freelist</span>.<span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Txid</span>(), <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>page</span>(<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Freelist</span>()))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>NoFreelistSync</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>commitFreelist</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;committing freelist failed: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>SetFreelist</span>(<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>PgidNoFreelist</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果高水位标记已上移，则尝试扩大数据库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Pgid</span>() &gt; <span style=color:#a6e22e>opgid</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>grow</span>(int(<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Pgid</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;growing db size failed, pgid: %d, pagesize: %d, error: %v&#34;</span>, <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Pgid</span>(), <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>rollback</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将脏页写入磁盘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>startTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>write</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;writing data failed: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>rollback</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果启用了严格模式，则执行一致性检查
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>StrictMode</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>Check</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errs</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>chkErr</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>chkErr</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>errs</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            panic(<span style=color:#e6db74>&#34;check fail: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>errs</span>, <span style=color:#e6db74>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将元数据写入磁盘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>writeMeta</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;writeMeta failed: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>rollback</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncWriteTime</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 结束事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>tx</span>.close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行提交处理程序，锁已经移除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>commitHandlers</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=rollback>Rollback
<a class=header-anchor href=#rollback></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Rollback 关闭事务并忽略所有之前的更新。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 只读事务必须回滚而不是提交。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>tx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>) <span style=color:#a6e22e>Rollback</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Assert</span>(!<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>managed</span>, <span style=color:#e6db74>&#34;managed tx rollback not allowed&#34;</span>)  <span style=color:#75715e>// 断言此事务不是管理型事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>berrors</span>.<span style=color:#a6e22e>ErrTxClosed</span>  <span style=color:#75715e>// 如果数据库已关闭，返回错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>nonPhysicalRollback</span>()  <span style=color:#75715e>// 执行非物理性回滚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// nonPhysicalRollback 在用户直接调用Rollback时被调用，在这种情况下，我们不需要从磁盘重新加载自由页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>tx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>) <span style=color:#a6e22e>nonPhysicalRollback</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>  <span style=color:#75715e>// 如果数据库已关闭，直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>writable</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freelist</span>.<span style=color:#a6e22e>rollback</span>(<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Txid</span>())  <span style=color:#75715e>// 如果事务是可写的，回滚自由列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tx</span>.close()  <span style=color:#75715e>// 关闭事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// rollback 从给定的挂起事务中移除页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>freelist</span>) <span style=color:#a6e22e>rollback</span>(<span style=color:#a6e22e>txid</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Txid</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从缓存中移除页面ID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>txp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>pending</span>[<span style=color:#a6e22e>txid</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>txp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>  <span style=color:#75715e>// 如果没有挂起的事务，直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>m</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Pgids</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>pgid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>txp</span>.<span style=color:#a6e22e>ids</span> {
</span></span><span style=display:flex><span>        delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>, <span style=color:#a6e22e>pgid</span>)  <span style=color:#75715e>// 从缓存中删除页面ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>tx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>txp</span>.<span style=color:#a6e22e>alloctx</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>  <span style=color:#75715e>// 如果未分配事务ID，继续下一个
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tx</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>txid</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果待释放页面被中断，恢复页面回分配列表。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>allocs</span>[<span style=color:#a6e22e>pgid</span>] = <span style=color:#a6e22e>tx</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果释放的页面由此事务分配，可以安全地丢弃。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>m</span> = append(<span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>pgid</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从挂起列表中移除页面，并将其标记为由txid分配的自由页面。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    delete(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>pending</span>, <span style=color:#a6e22e>txid</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>mergeSpans</span>(<span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=view--update>View && Update
<a class=header-anchor href=#view--update></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// View 在管理的只读事务上下文中执行一个函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 从函数返回的任何错误都会从View()方法返回。
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 尝试在函数内手动回滚会导致panic。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>View</span>(<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>) <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Begin</span>(<span style=color:#66d9ef>false</span>)  <span style=color:#75715e>// 开始一个只读事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>  <span style=color:#75715e>// 如果无法开始事务，返回错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保在发生panic的情况下事务能够回滚。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>rollback</span>()  <span style=color:#75715e>// 执行回滚操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 标记为管理的事务，以便内部函数不能手动回滚。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>managed</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果函数返回错误，则传递该错误。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>managed</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Rollback</span>()  <span style=color:#75715e>// 执行回滚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Rollback</span>()  <span style=color:#75715e>// 完成后回滚事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update 在读写管理事务的上下文中执行一个函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果函数没有返回错误，则提交事务。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果返回了错误，则整个事务被回滚。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 从函数返回的任何错误或从提交返回的错误都会从Update()方法返回。
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 尝试在函数内手动提交或回滚将导致panic。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>Update</span>(<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>) <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Begin</span>(<span style=color:#66d9ef>true</span>)  <span style=color:#75715e>// 开始一个读写事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>  <span style=color:#75715e>// 如果无法开始事务，返回错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保在发生panic的情况下事务能够回滚。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>db</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>rollback</span>()  <span style=color:#75715e>// 执行回滚操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 标记为管理的事务，以便内部函数不能手动提交。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>managed</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果函数返回错误，则回滚并返回错误。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>managed</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Rollback</span>()  <span style=color:#75715e>// 执行回滚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Commit</span>()  <span style=color:#75715e>// 无错误时提交事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=reference>Reference
<a class=header-anchor href=#reference></a></h2><ul><li><a href=https://wingsxdu.com/posts/database/boltdb/ title=https://wingsxdu.com/posts/database/boltdb/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://wingsxdu.com/posts/database/boltdb/
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://jaydenwen123.github.io/boltdb/ title=https://jaydenwen123.github.io/boltdb/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://jaydenwen123.github.io/boltdb/
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://youjiali1995.github.io/storage/boltdb/ title=https://youjiali1995.github.io/storage/boltdb/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://youjiali1995.github.io/storage/boltdb/
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://www.cnblogs.com/huxiao-tee/p/4660352.html title=https://www.cnblogs.com/huxiao-tee/p/4660352.html rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://www.cnblogs.com/huxiao-tee/p/4660352.html
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/boltdb>boltdb
</a><a href=/tags/etcd>etcd
</a><a href=/tags/golang>golang
</a><a href=/tags/%e6%95%b0%e6%8d%ae%e5%ba%93>数据库
</a><a href=/tags/kubernetes>kubernetes
</a><a href=/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>源码分析
</a><a href=/tags/%e4%ba%8b%e5%8a%a1>事务</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
boltdb 原理</li><li class=post-copyright-author><strong>本文作者： </strong>daemon365</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://daemon365.dev/post/cloud/boltdb_principles/ title="boltdb 原理">https://daemon365.dev/post/cloud/boltdb_principles/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/cloud/keepalived_haproxy/ rel=next title="kube-apiserver 高可用，keepalived + haproxy"><i class="fa fa-chevron-left"></i> kube-apiserver 高可用，keepalived + haproxy</a></div><div class="post-nav-prev post-nav-item"><a href=/post/cloud/etcd_watch_implementation_principle/ rel=prev title="etcd watch 实现原理">etcd watch 实现原理
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>daemon365</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.140.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://daemon365.dev/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://daemon365.dev/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"JmAHxEAUVgyS8B1c","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":false,"enable":false,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"daemon365/blog","theme":"preferred-color-scheme"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://daemon365.dev/3rd"}},"version":"4.6.3"}</script><script type=text/javascript src=/js/main.min.412b2d7d9cead6dbf9b4df1d9dcc9b5b7818e8e434f664050b4498e888bb3009.js defer></script></body></html>