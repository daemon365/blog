<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>boltdb 原理 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="简介
介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt
page
因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 …"><meta name=keywords content="boltdb,etcd,golang,数据库,kubernetes,源码分析,事务"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/cloud/boltdb_principles/"><meta property="og:title" content="boltdb 原理 - Daemon365"><meta property="og:description" content="简介
介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt
page
因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2024-06-15T16:14:00+08:00"><meta property="article:modified_time" content="2024-06-15T16:14:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="cloud"><meta property="article:tag" content="boltdb"><meta property="article:tag" content="etcd"><meta property="article:tag" content="golang"><meta property="article:tag" content="数据库"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="源码分析"><meta property="article:tag" content="事务"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/cloud/boltdb_principles/"><meta name=twitter:title content="boltdb 原理 - Daemon365"><meta name=twitter:description content="简介
介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt
page
因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/cloud/boltdb_principles/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"boltdb 原理","description":"\u003ch2 id=\u0022简介\u0022\u003e简介\u003c\/h2\u003e\n\u003cp\u003e介绍及简单使用：https:\/\/www.cnblogs.com\/daemon365\/p\/17690167.html\n源码地址：https:\/\/github.com\/etcd-io\/bbolt\u003c\/p\u003e\n\u003ch2 id=\u0022page\u0022\u003epage\u003c\/h2\u003e\n\u003cp\u003e因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 …\u003c\/p\u003e","datePublished":"2024-06-15T16:14:00\u002b08:00","dateModified":"2024-06-15T16:14:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/cloud\/boltdb_principles\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
Archives</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
Search</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>boltdb 原理</h1><div class=post-meta><time datetime=2024-06-15><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2024-06-15
</time><a href=/categories/cloud class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
cloud
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
19 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
3978 words</span></div><div class=post-tags><a href=/tags/boltdb class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
boltdb
</a><a href=/tags/etcd class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
etcd
</a><a href=/tags/golang class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
golang
</a><a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93 class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
数据库
</a><a href=/tags/kubernetes class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
kubernetes
</a><a href=/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90 class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
源码分析
</a><a href=/tags/%E4%BA%8B%E5%8A%A1 class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
事务</a></div></header><div class=post-body><h2 id=简介>简介</h2><p>介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt</p><h2 id=page>page</h2><p>因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的 <a href=https://man7.org/linux/man-pages/man2/mmap.2.html>mmap</a> 来内存映射操作文件，这样可以提高效率。</p><p>在 linux 中，每个 page 的大小是 4KB。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>getconf PAGESIZE
</span></span><span style=display:flex><span><span style=color:#ae81ff>4096</span>
</span></span></code></pre></div><p>对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 <code>page</code>。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Pgid</span> <span style=color:#00a8c8>uint64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Page</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>id</span>       <span style=color:#75af00>Pgid</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>flags</span>    <span style=color:#00a8c8>uint16</span> <span style=color:#75715e>// page 类型</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>count</span>    <span style=color:#00a8c8>uint16</span> <span style=color:#75715e>// page 中的元素数量</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>overflow</span> <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// 是否有后序页，如果有，overflow 表示后续页的数量</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>BranchPageFlag</span>   <span style=color:#111>=</span> <span style=color:#ae81ff>0x01</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LeafPageFlag</span>     <span style=color:#111>=</span> <span style=color:#ae81ff>0x02</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>MetaPageFlag</span>     <span style=color:#111>=</span> <span style=color:#ae81ff>0x04</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>FreelistPageFlag</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0x10</span> 
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span></code></pre></div><p><code>Page</code> 里面有一个 <code>flags</code> 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。</p><ul><li>分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。</li><li>叶子页：叶子页用来存储 key 和 value。</li><li>元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。</li><li>空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。</li></ul><p>在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。</p><p><img src=/images/eebaffa3-116e-40f0-95be-2dfc0ee58bd6.png alt></p><h3 id=branchpage--leafpage>BranchPage && LeafPage</h3><p>这两个分别存储 B+ tree 的分支页和叶子页。对应结构为：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// branchPageElement represents a node on a branch page.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>branchPageElement</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pos</span>   <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// 真实数据对应的偏移量</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ksize</span> <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// key 的大小</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pgid</span>  <span style=color:#75af00>Pgid</span> <span style=color:#75715e>// 指向 page 的 id</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// leafPageElement represents a node on a leaf page.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>leafPageElement</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>flags</span> <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// 是否是一个 bucket</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pos</span>   <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// 真实数据对应的偏移量</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ksize</span> <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// key 的大小</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>vsize</span> <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// value 的大小</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>对应的存储方式为:</p><p><img src=/images/c5206aef-62de-447a-880a-3024a75f4b3d.png alt></p><p>从 page 中拿取数据：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#75af00>LeafPageElements</span><span style=color:#111>()</span> <span style=color:#111>[]</span><span style=color:#75af00>leafPageElement</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>count</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从 page 的指针 加上 page 的大小，就是第一个元素的地址</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>data</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>UnsafeAdd</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Sizeof</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 转换为 slice</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>elems</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Slice</span><span style=color:#111>((</span><span style=color:#f92672>*</span><span style=color:#75af00>leafPageElement</span><span style=color:#111>)(</span><span style=color:#75af00>data</span><span style=color:#111>),</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>count</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>elems</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#75af00>BranchPageElements</span><span style=color:#111>()</span> <span style=color:#111>[]</span><span style=color:#75af00>branchPageElement</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>count</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>data</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>UnsafeAdd</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Sizeof</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>elems</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Slice</span><span style=color:#111>((</span><span style=color:#f92672>*</span><span style=color:#75af00>branchPageElement</span><span style=color:#111>)(</span><span style=color:#75af00>data</span><span style=color:#111>),</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>count</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>elems</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=metapage>MetaPage</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Meta</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>magic</span>    <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// boltdb 的魔数</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>version</span>  <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// boltdb 的版本</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pageSize</span> <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// boltdb 的 page 大小 ，该值和操作系统默认的页大小保持一致</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>flags</span>    <span style=color:#00a8c8>uint32</span> 
</span></span><span style=display:flex><span>	<span style=color:#75af00>root</span>     <span style=color:#75af00>InBucket</span> <span style=color:#75715e>// boltdb 的根节点</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>freelist</span> <span style=color:#75af00>Pgid</span>   <span style=color:#75715e>// 空闲页的 id</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pgid</span>     <span style=color:#75af00>Pgid</span> <span style=color:#75715e>// 当前 page 的 id</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>txid</span>     <span style=color:#75af00>Txid</span> <span style=color:#75715e>// 当前事务的 id</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>checksum</span> <span style=color:#00a8c8>uint64</span> <span style=color:#75715e>// 用作校验的校验和</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>它是如何写到 page 中的和从 page 中读取的呢？</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 把 meta 写到 page 中</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>m</span> <span style=color:#f92672>*</span><span style=color:#75af00>Meta</span><span style=color:#111>)</span> <span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 检查 root bucket 的 pgid 是否有效。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果 root.root 的 pgid 大于或等于 m.pgid，这是不合理的，因为这意味着它引用了一个尚未分配的 pgid。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>root</span><span style=color:#111>.</span><span style=color:#75af00>root</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>pgid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;root bucket pgid (%d) above high water mark (%d)&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>root</span><span style=color:#111>.</span><span style=color:#75af00>root</span><span style=color:#111>,</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>pgid</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e>// 检查 freelist 的 pgid 是否有效。</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e>// 如果 freelist 的 pgid 大于或等于 m.pgid 且 freelist 不是 PgidNoFreelist，</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e>// 这同样表示它引用了一个尚未分配的 pgid，这是不合理的。</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>pgid</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>PgidNoFreelist</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;freelist pgid (%d) above high water mark (%d)&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span><span style=color:#111>,</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>pgid</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定 pageId 和 page 类型</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>id</span> <span style=color:#111>=</span> <span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>txid</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetFlags</span><span style=color:#111>(</span><span style=color:#75af00>MetaPageFlag</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 计算校验和</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>checksum</span> <span style=color:#111>=</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>Sum64</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>Copy</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Meta</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 从 page 中读取 meta</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#75af00>Meta</span><span style=color:#111>()</span> <span style=color:#f92672>*</span><span style=color:#75af00>Meta</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Meta</span><span style=color:#111>)(</span><span style=color:#75af00>UnsafeAdd</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Sizeof</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 把 meta 的数据拷贝到 page 中</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>m</span> <span style=color:#f92672>*</span><span style=color:#75af00>Meta</span><span style=color:#111>)</span> <span style=color:#75af00>Copy</span><span style=color:#111>(</span><span style=color:#75af00>dest</span> <span style=color:#f92672>*</span><span style=color:#75af00>Meta</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span><span style=color:#75af00>dest</span> <span style=color:#111>=</span> <span style=color:#f92672>*</span><span style=color:#75af00>m</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 计算校验和</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>m</span> <span style=color:#f92672>*</span><span style=color:#75af00>Meta</span><span style=color:#111>)</span> <span style=color:#75af00>Sum64</span><span style=color:#111>()</span> <span style=color:#00a8c8>uint64</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>h</span> <span style=color:#111>=</span> <span style=color:#75af00>fnv</span><span style=color:#111>.</span><span style=color:#75af00>New64a</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#111>=</span> <span style=color:#75af00>h</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>((</span><span style=color:#f92672>*</span><span style=color:#111>[</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Offsetof</span><span style=color:#111>(</span><span style=color:#75af00>Meta</span><span style=color:#111>{}.</span><span style=color:#75af00>checksum</span><span style=color:#111>)]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>))[:])</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>h</span><span style=color:#111>.</span><span style=color:#75af00>Sum64</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=freelistpage>FreelistPage</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>freelist</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 表示 freelist 的类型，可能会有不同的策略或实现。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>freelistType</span> <span style=color:#75af00>FreelistType</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存储所有已释放且可供分配的页面ID。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ids</span> <span style=color:#111>[]</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录哪个事务ID分配了特定的页面ID。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>allocs</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 记录即将被释放的页面ID及其所属的事务ID。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>pending</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#75af00>txPending</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 快速查找所有空闲和待处理页面ID的缓存。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cache</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#00a8c8>struct</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 按连续页面大小分类的空闲页面，键是连续页面的大小，值是具有相同大小的起始页面ID的集合。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>freemaps</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#00a8c8>uint64</span><span style=color:#111>]</span><span style=color:#75af00>pidSet</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 正向映射，键是起始页面ID，值是其span大小。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>forwardMap</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#00a8c8>uint64</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 反向映射，键是结束页面ID，值是其span大小。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>backwardMap</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#00a8c8>uint64</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 空闲页面的计数（基于哈希图的版本）。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>freePagesCount</span> <span style=color:#00a8c8>uint64</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 分配函数，根据提供的事务ID和需求的页面数量分配页面。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>allocate</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>txid</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>,</span> <span style=color:#75af00>n</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回当前空闲页面数量的函数。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>free_count</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 合并连续空闲页面的函数。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>mergeSpans</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>ids</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgids</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取所有空闲页面ID的函数。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>getFreePageIDs</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>[]</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取一系列页面ID并初始化 freelist 的函数。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>readIDs</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>pgids</span> <span style=color:#111>[]</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// FreelistType 定义了 freelist 后端的类型，用字符串表示不同的实现策略。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>FreelistType</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 未来的开发计划：</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  1. 默认改为使用 `FreelistMapType`；</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  2. 移除 `FreelistArrayType`，不再公开 `FreelistMapType`，</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//     并从 `DB` 和 `Options` 结构体中移除 `FreelistType` 字段。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// FreelistArrayType 表示 freelist 的后端类型为数组。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 这种类型可能适用于需要按顺序访问空闲页的场景。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>FreelistArrayType</span> <span style=color:#111>=</span> <span style=color:#75af00>FreelistType</span><span style=color:#111>(</span><span style=color:#d88200>&#34;array&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// FreelistMapType 表示 freelist 的后端类型为哈希映射。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 这种类型提供了更快的查找速度，适合于频繁、随机地访问空闲页的情况。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>FreelistMapType</span> <span style=color:#111>=</span> <span style=color:#75af00>FreelistType</span><span style=color:#111>(</span><span style=color:#d88200>&#34;hashmap&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span></code></pre></div><p>把 freelist 写到 page 中：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// write 将空闲和待处理的页面ID写入到 freelist 页面。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在程序崩溃的事件中，所有待处理的ID都将变成空闲的，因此这些ID都需要被保存到磁盘上。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>write</span><span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 	<span style=color:#75715e>// 设置页头中的页类型标识</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetFlags</span><span style=color:#111>(</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>FreelistPageFlag</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取需要保存的 PageID 数量。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>l</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>count</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>l</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 没有 id 需要保存，直接返回。</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetCount</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#75af00>l</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#75af00>l</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>0xFFFF</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果数量小于 0xFFFF</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将 id 数量写入到页头中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetCount</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#75af00>l</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 计算指针头</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>data</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>UnsafeAdd</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Sizeof</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 开辟一个 slice 用来存储 id</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ids</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Slice</span><span style=color:#111>((</span><span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>)(</span><span style=color:#75af00>data</span><span style=color:#111>),</span> <span style=color:#75af00>l</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将 id 拷贝到 page 中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>copyall</span><span style=color:#111>(</span><span style=color:#75af00>ids</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果数量大于 0xFFFF ，则需要分多个 page 来保存</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 先设置本页的数量为 0xFFFF</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetCount</span><span style=color:#111>(</span><span style=color:#ae81ff>0xFFFF</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 计算指针头 </span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>data</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>UnsafeAdd</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>),</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Sizeof</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ids</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Slice</span><span style=color:#111>((</span><span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>)(</span><span style=color:#75af00>data</span><span style=color:#111>),</span> <span style=color:#75af00>l</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将ID数量存储在第一个元素中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ids</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#75af00>l</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将剩余的 id 拷贝到 page 中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>copyall</span><span style=color:#111>(</span><span style=color:#75af00>ids</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>:])</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// copyall 将所有空闲的ID和所有待处理的ID复制到一个排序后的列表中。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// f.count 返回目标数组 dst 需要的最小长度。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>copyall</span><span style=color:#111>(</span><span style=color:#75af00>dst</span> <span style=color:#111>[]</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建一个切片用于存放待处理的ID，容量预设为待处理ID的数量。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>m</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgids</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>pending_count</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 遍历所有待处理事务，并将它们的ID加入到切片 m 中。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>txp</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>pending</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>m</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>,</span> <span style=color:#75af00>txp</span><span style=color:#111>.</span><span style=color:#75af00>ids</span><span style=color:#f92672>...</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 对切片 m 进行排序。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Sort</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将已经空闲的ID和刚排序的待处理ID合并到目标切片 dst 中。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Mergepgids</span><span style=color:#111>(</span><span style=color:#75af00>dst</span><span style=color:#111>,</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>getFreePageIDs</span><span style=color:#111>(),</span> <span style=color:#75af00>m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Mergepgids 将两个已排序列表 a 和 b 的并集复制到 dst 中。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果 dst 的长度不足以容纳结果，会触发 panic。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Mergepgids</span><span style=color:#111>(</span><span style=color:#75af00>dst</span><span style=color:#111>,</span> <span style=color:#75af00>a</span><span style=color:#111>,</span> <span style=color:#75af00>b</span> <span style=color:#75af00>Pgids</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查目标切片 dst 是否足够大以容纳 a 和 b 的所有元素。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>dst</span><span style=color:#111>)</span> <span style=color:#111>&lt;</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>a</span><span style=color:#111>)</span><span style=color:#f92672>+</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;mergepgids bad len %d &lt; %d + %d&#34;</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>dst</span><span style=color:#111>),</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>a</span><span style=color:#111>),</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果其中一个列表为空，则直接将另一个列表复制到 dst 中。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>a</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>copy</span><span style=color:#111>(</span><span style=color:#75af00>dst</span><span style=color:#111>,</span> <span style=color:#75af00>b</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>copy</span><span style=color:#111>(</span><span style=color:#75af00>dst</span><span style=color:#111>,</span> <span style=color:#75af00>a</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化一个切片 merged 来存储最终合并的结果。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>merged</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>dst</span><span style=color:#111>[:</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确定哪个列表的起始值更小，并将其设为 lead，另一个设为 follow。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>lead</span><span style=color:#111>,</span> <span style=color:#75af00>follow</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>a</span><span style=color:#111>,</span> <span style=color:#75af00>b</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>a</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lead</span><span style=color:#111>,</span> <span style=color:#75af00>follow</span> <span style=color:#111>=</span> <span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>a</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 循环合并，直到 lead 为空。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>lead</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 合并 lead 中所有小于 follow[0] 的元素。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>n</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Search</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>lead</span><span style=color:#111>),</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span> <span style=color:#00a8c8>return</span> <span style=color:#75af00>lead</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>follow</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>})</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>merged</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>merged</span><span style=color:#111>,</span> <span style=color:#75af00>lead</span><span style=color:#111>[:</span><span style=color:#75af00>n</span><span style=color:#111>]</span><span style=color:#f92672>...</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>lead</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 交换 lead 和 follow，继续合并过程。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lead</span><span style=color:#111>,</span> <span style=color:#75af00>follow</span> <span style=color:#111>=</span> <span style=color:#75af00>follow</span><span style=color:#111>,</span> <span style=color:#75af00>lead</span><span style=color:#111>[</span><span style=color:#75af00>n</span><span style=color:#111>:]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将剩余的 follow 元素加入到 merged 中。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>_</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>merged</span><span style=color:#111>,</span> <span style=color:#75af00>follow</span><span style=color:#f92672>...</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>从 page 中读取 freelist：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// read 从 freelist 页面读取页面ID。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>read</span><span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 首先检查是否为 freelist 页面，如果不是则抛出错误。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>IsFreelistPage</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;invalid freelist page: %d, page type is %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Id</span><span style=color:#111>(),</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Typ</span><span style=color:#111>()))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从页面获取 freelist 页面的ID列表。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ids</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>FreelistPageIds</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果获取的ID列表为空，将 f.ids 设置为 nil，表示没有空闲页面。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>ids</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>ids</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果ID列表不为空，则创建一个新切片并复制这些ID，以避免直接修改原始页面数据。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>idsCopy</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>([]</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>ids</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>        <span style=color:#111>copy</span><span style=color:#111>(</span><span style=color:#75af00>idsCopy</span><span style=color:#111>,</span> <span style=color:#75af00>ids</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 确保复制的ID列表是排序的。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Sort</span><span style=color:#111>(</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgids</span><span style=color:#111>(</span><span style=color:#75af00>idsCopy</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将排序后的ID列表读入 freelist 结构。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>readIDs</span><span style=color:#111>(</span><span style=color:#75af00>idsCopy</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// hashmapReadIDs 读取输入的 pgids 并初始化 freelist（基于哈希映射的版本）。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>hashmapReadIDs</span><span style=color:#111>(</span><span style=color:#75af00>pgids</span> <span style=color:#111>[]</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化 freelist。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>init</span><span style=color:#111>(</span><span style=color:#75af00>pgids</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重建页面缓存。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>reindex</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// reindex 基于可用和待处理的空闲列表重建自由缓存。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>reindex</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取所有空闲页面ID。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ids</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>getFreePageIDs</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建一个新的缓存映射。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>cache</span> <span style=color:#111>=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#00a8c8>struct</span><span style=color:#111>{},</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>ids</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将所有空闲ID添加到缓存中。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>id</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>ids</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>cache</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}{}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将所有待处理的空闲ID也添加到缓存中。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>txp</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>pending</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>pendingID</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>txp</span><span style=color:#111>.</span><span style=color:#75af00>ids</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>cache</span><span style=color:#111>[</span><span style=color:#75af00>pendingID</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}{}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>分配页：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hashmapAllocate 根据传入的事务ID和请求的页面数量，分配页面。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>hashmapAllocate</span><span style=color:#111>(</span><span style=color:#75af00>txid</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>,</span> <span style=color:#75af00>n</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果请求的页面数量为0，则直接返回0，表示没有分配任何页面。</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 检查是否存在完全匹配的空闲span。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>bm</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span><span style=color:#111>[</span><span style=color:#111>uint64</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>)];</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>pid</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>bm</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 移除这个span。</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>delSpan</span><span style=color:#111>(</span><span style=color:#75af00>pid</span><span style=color:#111>,</span> <span style=color:#111>uint64</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 记录这个页面ID被哪个事务分配。</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>allocs</span><span style=color:#111>[</span><span style=color:#75af00>pid</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>txid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 从缓存中移除已分配的页面。</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>);</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>);</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>cache</span><span style=color:#111>,</span> <span style=color:#75af00>pid</span><span style=color:#f92672>+</span><span style=color:#75af00>i</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>pid</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在映射中查找大于请求大小的更大span。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>size</span><span style=color:#111>,</span> <span style=color:#75af00>bm</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>size</span> <span style=color:#111>&lt;</span> <span style=color:#111>uint64</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>pid</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>bm</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 移除找到的大span。</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>delSpan</span><span style=color:#111>(</span><span style=color:#75af00>pid</span><span style=color:#111>,</span> <span style=color:#75af00>size</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 记录页面分配。</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>allocs</span><span style=color:#111>[</span><span style=color:#75af00>pid</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>txid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 计算剩余的span大小，并添加回 freelist。</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>remain</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>size</span> <span style=color:#f92672>-</span> <span style=color:#111>uint64</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>addSpan</span><span style=color:#111>(</span><span style=color:#75af00>pid</span><span style=color:#f92672>+</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>),</span> <span style=color:#75af00>remain</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 从缓存中移除已分配的页面。</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>);</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>);</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>cache</span><span style=color:#111>,</span> <span style=color:#75af00>pid</span><span style=color:#f92672>+</span><span style=color:#75af00>i</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>pid</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// delSpan 从 freelist 中删除一个span。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>delSpan</span><span style=color:#111>(</span><span style=color:#75af00>start</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>,</span> <span style=color:#75af00>size</span> <span style=color:#00a8c8>uint64</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新前向和后向映射，移除对应的条目。</span>
</span></span><span style=display:flex><span>	<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>forwardMap</span><span style=color:#111>,</span> <span style=color:#75af00>start</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>backwardMap</span><span style=color:#111>,</span> <span style=color:#75af00>start</span><span style=color:#f92672>+</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#75af00>size</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从 freemaps 中移除span。</span>
</span></span><span style=display:flex><span>	<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span><span style=color:#111>[</span><span style=color:#75af00>size</span><span style=color:#111>],</span> <span style=color:#75af00>start</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span><span style=color:#111>[</span><span style=color:#75af00>size</span><span style=color:#111>])</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果某个大小的span已经没有其他项，从 freemaps 中完全移除这个大小。</span>
</span></span><span style=display:flex><span>		<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span><span style=color:#111>,</span> <span style=color:#75af00>size</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新空闲页面计数。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freePagesCount</span> <span style=color:#f92672>-=</span> <span style=color:#75af00>size</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// addSpan 向 freelist 中添加一个新的span。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>addSpan</span><span style=color:#111>(</span><span style=color:#75af00>start</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>,</span> <span style=color:#75af00>size</span> <span style=color:#00a8c8>uint64</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新前向和后向映射。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>backwardMap</span><span style=color:#111>[</span><span style=color:#75af00>start</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>+</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(</span><span style=color:#75af00>size</span><span style=color:#111>)]</span> <span style=color:#111>=</span> <span style=color:#75af00>size</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>forwardMap</span><span style=color:#111>[</span><span style=color:#75af00>start</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>size</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 确保 freemaps 中存在对应大小的映射。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span><span style=color:#111>[</span><span style=color:#75af00>size</span><span style=color:#111>];</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span><span style=color:#111>[</span><span style=color:#75af00>size</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#00a8c8>struct</span><span style=color:#111>{})</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 添加新的span到 freemaps。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freemaps</span><span style=color:#111>[</span><span style=color:#75af00>size</span><span style=color:#111>][</span><span style=color:#75af00>start</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}{}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新空闲页面计数。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>freePagesCount</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>size</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=node>Node</h2><p>page 的操作跟多都是基于磁盘设计的，在内存中使用这些数据结构并不是很方便。所以 boltdb 会把 page 的数据结构转换为 node 的数据结构，这样在内存中操作就会方便很多。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>node</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>bucket</span>     <span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span> <span style=color:#75715e>// bucket 的指针</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>isLeaf</span>     <span style=color:#00a8c8>bool</span> <span style=color:#75715e>// 是否是叶子节点</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>unbalanced</span> <span style=color:#00a8c8>bool</span> <span style=color:#75715e>// 是否平衡</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>spilled</span>    <span style=color:#00a8c8>bool</span> <span style=color:#75715e>// 是否溢出</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>key</span>        <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span> <span style=color:#75715e>// 该 node 的起始 key</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pgid</span>       <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span> <span style=color:#75715e>// 该 node 对应的 page id</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>parent</span>     <span style=color:#f92672>*</span><span style=color:#75af00>node</span> <span style=color:#75715e>// 父节点</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>children</span>   <span style=color:#75af00>nodes</span> <span style=color:#75715e>// 子节点</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>inodes</span>     <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Inodes</span> <span style=color:#75715e>// 存储键值对的结构体数组</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Inode</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>flags</span> <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// 用于 leaf node 是否是一个 bucket （subbucket）</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pgid</span>  <span style=color:#75af00>Pgid</span>	<span style=color:#75715e>// 用于 branch node, 子节点的 page id</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>key</span>   <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span> <span style=color:#75715e>// key</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>value</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span> <span style=color:#75715e>// value</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Inodes</span> <span style=color:#111>[]</span><span style=color:#75af00>Inode</span>
</span></span></code></pre></div><h3 id=page-to-node>page to node</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>n</span> <span style=color:#f92672>*</span><span style=color:#75af00>node</span><span style=color:#111>)</span> <span style=color:#75af00>read</span><span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>pgid</span> <span style=color:#111>=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Id</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>isLeaf</span> <span style=color:#111>=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>IsLeafPage</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 读取 inodes</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span> <span style=color:#111>=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>ReadInodeFromPage</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 保存第一个键，以便在将节点写入到父节点时能够找到这个节点。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>key</span> <span style=color:#111>=</span> <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>Key</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>key</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;read: zero-length node key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>key</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>ReadInodeFromPage</span><span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#75af00>Inodes</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>inodes</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#75af00>Inodes</span><span style=color:#111>,</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Count</span><span style=color:#111>()))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>isLeaf</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>IsLeafPage</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Count</span><span style=color:#111>());</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>inode</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>isLeaf</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 转换为 leafPageElement 结构</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>LeafPageElement</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#75af00>i</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetFlags</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Flags</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetKey</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetValue</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 转换为 branchPageElement 结构</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>BranchPageElement</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#75af00>i</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetPgid</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetKey</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;read: zero-length inode key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>inodes</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=node-to-page>node to page</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// write writes the items onto one or more pages.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The page should have p.id (might be 0 for meta or bucket-inline page) and p.overflow set</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// and the rest should be zeroed.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>n</span> <span style=color:#f92672>*</span><span style=color:#75af00>node</span><span style=color:#111>)</span> <span style=color:#75af00>write</span><span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Count</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Flags</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;node cannot be written into a not empty page&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Initialize page.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>isLeaf</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetFlags</span><span style=color:#111>(</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>LeafPageFlag</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetFlags</span><span style=color:#111>(</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>BranchPageFlag</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>)</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0xFFFF</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;inode overflow: %d (pgid=%d)&#34;</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>),</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Id</span><span style=color:#111>()))</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>SetCount</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stop here if there are no items to write.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Count</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将node的inodes写入page</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>WriteInodeToPage</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>,</span> <span style=color:#75af00>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// DEBUG ONLY: n.dump()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>WriteInodeToPage</span><span style=color:#111>(</span><span style=color:#75af00>inodes</span> <span style=color:#75af00>Inodes</span><span style=color:#111>,</span> <span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#00a8c8>uint32</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 计算写入的初始偏移量。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>off</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Sizeof</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>)</span> <span style=color:#f92672>+</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>PageElementSize</span><span style=color:#111>()</span><span style=color:#f92672>*</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>inodes</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>isLeaf</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>IsLeafPage</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span><span style=color:#111>,</span> <span style=color:#75af00>item</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>inodes</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;write: zero-length inode key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建一个足够大小的切片来存放键和值。</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sz</span> <span style=color:#f92672>:=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())</span> <span style=color:#f92672>+</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>UnsafeByteSlice</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>),</span> <span style=color:#75af00>off</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>sz</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>off</span> <span style=color:#f92672>+=</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>sz</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Write the page element.</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>isLeaf</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>LeafPageElement</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#75af00>i</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>SetPos</span><span style=color:#111>(</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>b</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]))</span> <span style=color:#f92672>-</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>))))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>SetFlags</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Flags</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>SetKsize</span><span style=color:#111>(</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>SetVsize</span><span style=color:#111>(</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>())))</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>BranchPageElement</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#75af00>i</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>SetPos</span><span style=color:#111>(</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>b</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]))</span> <span style=color:#f92672>-</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>))))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>SetKsize</span><span style=color:#111>(</span><span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>SetPgid</span><span style=color:#111>(</span><span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>()</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Id</span><span style=color:#111>(),</span> <span style=color:#d88200>&#34;write: circular dependency occurred&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将键和值数据写入到页面的末尾。</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>l</span> <span style=color:#f92672>:=</span> <span style=color:#111>copy</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#111>copy</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>[</span><span style=color:#75af00>l</span><span style=color:#111>:],</span> <span style=color:#75af00>item</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#75af00>off</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=bucket>Bucket</h2><p>Bucket 是 boltdb 的上层的数据结构，每个 bucket 都有一个完成的 B+ 树。将多个 page 联合起来。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Bucket</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>InBucket</span>             
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span>       <span style=color:#f92672>*</span><span style=color:#75af00>Tx</span>                    <span style=color:#75715e>// 指向关联事务的指针，将 bucket 与其事务上下文连接。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>buckets</span>  <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#00a8c8>string</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span>     <span style=color:#75715e>// 子 bucket 缓存；允许通过名字快速访问子 bucket。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>page</span>     <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span>           <span style=color:#75715e>// 内联页面的引用，用于直接存储少量数据或作为数据节点的入口点。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>rootNode</span> <span style=color:#f92672>*</span><span style=color:#75af00>node</span>                  <span style=color:#75715e>// 根页面的已实例化节点，如果 bucket 直接存储在内存中，则此节点将被激活。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>nodes</span>    <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#75af00>node</span>  <span style=color:#75715e>// 节点缓存，用于快速访问已加载的页面节点，避免重复读取磁盘。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置节点分裂时的填充阈值。默认情况下，bucket 将填充至 50%，</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 但如果你知道你的写入工作负载主要是追加操作，提高这个比例可能会有用。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>    // 这个设置不会跨事务持久化，因此每个事务都必须设置它。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>FillPercent</span> <span style=color:#00a8c8>float64</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>InBucket</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>root</span>     <span style=color:#75af00>Pgid</span>   <span style=color:#75715e>// bucket 根级页面的页面ID。如果 bucket 是内联的，则此值为 0。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>sequence</span> <span style=color:#00a8c8>uint64</span> <span style=color:#75715e>// 单调递增的序列号，用于 NextSequence() 函数。</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>Bucket 有可能是 node，也可能是 page。查找某页面的键值对时，首先检查 Bucket.nodes 缓存是否有对应的 node，如果没有，再从 page 中查找。
Bucket.FillPercent 记录 node 的填充百分比。当 node 的已用空间超过其容量的某个百分比后，节点必须分裂，以减少在 B+ Tree 中插入键值对时触发再平衡的概率。默认值是 50%，仅当大量写入操作在尾部添加时，增大该值才有帮助。</p><p>bucket 存储方式：</p><p><img src=/images/04c8dda1-ff6f-4ae5-9162-bf31819e9a9c.png alt></p><h3 id=遍历-cursor>遍历 cursor</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Cursor</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>bucket</span> <span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span>  
</span></span><span style=display:flex><span>    <span style=color:#75af00>stack</span>  <span style=color:#111>[]</span><span style=color:#75af00>elemRef</span> 
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>elemRef</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>page</span>  <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>node</span>  <span style=color:#f92672>*</span><span style=color:#75af00>node</span>        
</span></span><span style=display:flex><span>    <span style=color:#75af00>index</span> <span style=color:#00a8c8>int</span>    
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>cursor 分为三类，定位到某一个元素的位置、在当前位置从前往后找、在当前位置从后往前找。方法为：First、Last、Next、Prev 等。</p><h4 id=seek>Seek</h4><p>如果该键存在，它会返回该键及其对应的值；如果键不存在，它则返回最近的后续键。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Seek 方法使用B树搜索将光标移动到给定的键并返回它。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果键不存在，则使用下一个键。如果没有更多的键，返回nil。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 返回的键和值只在事务的生命周期内有效。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>Seek</span><span style=color:#111>(</span><span style=color:#75af00>seek</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>value</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保数据库事务没有关闭</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>bucket</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;tx closed&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调用内部的seek方法，获取键和值</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>seek</span><span style=color:#111>(</span><span style=color:#75af00>seek</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否位于页面的最后一个元素之后，如果是，则移动到下一个元素。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>ref</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>index</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>count</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>next</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果k为nil，表示未找到键，返回nil。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>k</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#111>uint32</span><span style=color:#111>(</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>BucketLeafFlag</span><span style=color:#111>))</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果是叶子节点，返回键和nil值。</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回找到的键和值。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// seek 方法将光标移动到给定的键，并返回该键。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果键不存在，则使用下一个键。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>seek</span><span style=color:#111>(</span><span style=color:#75af00>seek</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>value</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#00a8c8>uint32</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从根页面/节点开始，遍历到正确的页面。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[:</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>search</span><span style=color:#111>(</span><span style=color:#75af00>seek</span><span style=color:#111>,</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>bucket</span><span style=color:#111>.</span><span style=color:#75af00>RootPage</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是桶，则返回nil值。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>keyValue</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>search</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// search 方法递归地对给定的页面/节点进行二分搜索，直到找到给定的键。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>search</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>pgId</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>n</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>bucket</span><span style=color:#111>.</span><span style=color:#75af00>pageNode</span><span style=color:#111>(</span><span style=color:#75af00>pgId</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>p</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>IsBranchPage</span><span style=color:#111>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>IsLeafPage</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;invalid page type: %d: %x&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Id</span><span style=color:#111>(),</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Flags</span><span style=color:#111>()))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>e</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>elemRef</span><span style=color:#111>{</span><span style=color:#75af00>page</span><span style=color:#111>:</span> <span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>node</span><span style=color:#111>:</span> <span style=color:#75af00>n</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>,</span> <span style=color:#75af00>e</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果我们位于叶节点页面上，则在该页面内部继续查找特定节点。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>isLeaf</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>nsearch</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是节点，继续在节点内部搜索。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>searchNode</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>n</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是页面，继续在页面内部搜索。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>searchPage</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>searchNode</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>n</span> <span style=color:#f92672>*</span><span style=color:#75af00>node</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>exact</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用二分搜索确定键的位置。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>index</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Search</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>),</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ret</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Compare</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>ret</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>exact</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>ret</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>exact</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>index</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>index</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>].</span><span style=color:#75af00>index</span> <span style=color:#111>=</span> <span style=color:#75af00>index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 递归搜索到下一页。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>search</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>index</span><span style=color:#111>].</span><span style=color:#75af00>Pgid</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>searchPage</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 对页面进行二分搜索以确定正确的范围。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>inodes</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>BranchPageElements</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>exact</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>index</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Search</span><span style=color:#111>(</span><span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Count</span><span style=color:#111>()),</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ret</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Compare</span><span style=color:#111>(</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>ret</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>exact</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>ret</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>exact</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>index</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>index</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>].</span><span style=color:#75af00>index</span> <span style=color:#111>=</span> <span style=color:#75af00>index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 递归搜索到下一页。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>search</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>index</span><span style=color:#111>].</span><span style=color:#75af00>Pgid</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>nsearch</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>e</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>n</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>page</span><span style=color:#111>,</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>node</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If we have a node then search its inodes.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>index</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Search</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>),</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Compare</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>key</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>index</span> <span style=color:#111>=</span> <span style=color:#75af00>index</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If we have a page then search its leaf elements.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>inodes</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>LeafPageElements</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>index</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Search</span><span style=color:#111>(</span><span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Count</span><span style=color:#111>()),</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Compare</span><span style=color:#111>(</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>key</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>index</span> <span style=color:#111>=</span> <span style=color:#75af00>index</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>keyValue</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>keyValue</span><span style=color:#111>()</span> <span style=color:#111>([]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#00a8c8>uint32</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ref</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果索引超出范围，则返回nil。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>count</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>index</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>count</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  从node中获取键值对。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>node</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>inode</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>index</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>(),</span> <span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>Flags</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从 page 中获取键值对。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>elem</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>LeafPageElement</span><span style=color:#111>(</span><span style=color:#111>uint16</span><span style=color:#111>(</span><span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>index</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>(),</span> <span style=color:#75af00>elem</span><span style=color:#111>.</span><span style=color:#75af00>Flags</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=创建-bucket-如果不存在>创建 bucket 如果不存在</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// CreateBucketIfNotExists 如果指定的存储桶不存在，则创建它，并返回一个对它的引用。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果存储桶名为空或太长，则返回错误。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 存储桶实例仅在事务的生命周期内有效。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>b</span> <span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>)</span> <span style=color:#75af00>CreateBucketIfNotExists</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>rb</span> <span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果日志不是被丢弃，记录创建存储桶的尝试。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Logger</span><span style=color:#111>();</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>discardLogger</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Creating bucket if not exist %q&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Creating bucket if not exist %q failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Creating bucket if not exist %q successfully&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查数据库是否关闭，检查事务是否可写，检查键名是否为空。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrTxClosed</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>writable</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrTxNotWritable</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrBucketNameRequired</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用克隆的键而不是原始键，以避免内存泄漏。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>newKey</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>cloneBytes</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查键是否已存在。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>child</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span><span style=color:#111>[</span><span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>)];</span> <span style=color:#75af00>child</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>child</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用光标寻找正确的位置。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Cursor</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>seek</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果找到的键相同，检查是否已有相同名字的非存储桶键。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Equal</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>BucketLeafFlag</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>var</span> <span style=color:#75af00>child</span> <span style=color:#111>=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>openBucket</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span><span style=color:#111>[</span><span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>)]</span> <span style=color:#111>=</span> <span style=color:#75af00>child</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>child</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrIncompatibleValue</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建空的内联存储桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>bucket</span> <span style=color:#111>=</span> <span style=color:#75af00>Bucket</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>InBucket</span><span style=color:#111>:</span>    <span style=color:#f92672>&amp;</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>InBucket</span><span style=color:#111>{},</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>rootNode</span><span style=color:#111>:</span>    <span style=color:#f92672>&amp;</span><span style=color:#75af00>node</span><span style=color:#111>{</span><span style=color:#75af00>isLeaf</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>},</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>FillPercent</span><span style=color:#111>:</span> <span style=color:#75af00>DefaultFillPercent</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>value</span> <span style=color:#111>=</span> <span style=color:#75af00>bucket</span><span style=color:#111>.</span><span style=color:#75af00>write</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在当前节点上插入键、值、标志。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>node</span><span style=color:#111>().</span><span style=color:#75af00>put</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>,</span> <span style=color:#75af00>newKey</span><span style=color:#111>,</span> <span style=color:#75af00>value</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>BucketLeafFlag</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果存在内联页面，取消引用它，使得存储桶被视为常规非内联存储桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>page</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回新创建的存储桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>),</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// node方法返回光标当前定位的节点。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Cursor</span><span style=color:#111>)</span> <span style=color:#75af00>node</span><span style=color:#111>()</span> <span style=color:#f92672>*</span><span style=color:#75af00>node</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保光标栈长度大于0，否则抛出异常。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;accessing a node with a zero-length cursor stack&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果栈顶是叶子节点，直接返回该节点。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>ref</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>node</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>isLeaf</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>node</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从根开始，向下遍历层级结构。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>n</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>node</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>n</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>bucket</span><span style=color:#111>.</span><span style=color:#75af00>node</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>Id</span><span style=color:#111>(),</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>ref</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>[:</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>stack</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(!</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>isLeaf</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;expected branch node&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>n</span> <span style=color:#111>=</span> <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>childAt</span><span style=color:#111>(</span><span style=color:#75af00>ref</span><span style=color:#111>.</span><span style=color:#75af00>index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>isLeaf</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;expected leaf node&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>n</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// put方法在节点中插入键值对。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>n</span> <span style=color:#f92672>*</span><span style=color:#75af00>node</span><span style=color:#111>)</span> <span style=color:#75af00>put</span><span style=color:#111>(</span><span style=color:#75af00>oldKey</span><span style=color:#111>,</span> <span style=color:#75af00>newKey</span><span style=color:#111>,</span> <span style=color:#75af00>value</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>pgId</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#00a8c8>uint32</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查pgId是否超出限制。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>pgId</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>bucket</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;pgId (%d) above high water mark (%d)&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>pgId</span><span style=color:#111>,</span> <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>bucket</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>()))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>oldKey</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;put: zero-length old key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;put: zero-length new key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 寻找插入的位置。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>index</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Search</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>),</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span> <span style=color:#00a8c8>return</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Compare</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>oldKey</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果没有找到确切匹配，增加容量并移动节点。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>exact</span> <span style=color:#f92672>:=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>index</span> <span style=color:#111>&lt;</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Equal</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>index</span><span style=color:#111>].</span><span style=color:#75af00>Key</span><span style=color:#111>(),</span> <span style=color:#75af00>oldKey</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>exact</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>,</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Inode</span><span style=color:#111>{})</span>
</span></span><span style=display:flex><span>        <span style=color:#111>copy</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>index</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>:],</span> <span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>index</span><span style=color:#111>:])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置inode的属性。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>inode</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>n</span><span style=color:#111>.</span><span style=color:#75af00>inodes</span><span style=color:#111>[</span><span style=color:#75af00>index</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetFlags</span><span style=color:#111>(</span><span style=color:#75af00>flags</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetKey</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetValue</span><span style=color:#111>(</span><span style=color:#75af00>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>SetPgid</span><span style=color:#111>(</span><span style=color:#75af00>pgId</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>inode</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>())</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;put: zero-length inode key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Bucket方法通过名称检索嵌套桶。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果桶不存在，返回nil。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 返回的桶实例只在事务生命周期内有效。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>b</span> <span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>)</span> <span style=color:#75af00>Bucket</span><span style=color:#111>(</span><span style=color:#75af00>name</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果已有桶缓存，则直接返回对应桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>child</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span><span style=color:#111>[</span><span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>name</span><span style=color:#111>)];</span> <span style=color:#75af00>child</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>child</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 移动光标到键位置。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Cursor</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>seek</span><span style=color:#111>(</span><span style=color:#75af00>name</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果键不存在或者不是桶标志，则返回nil。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Equal</span><span style=color:#111>(</span><span style=color:#75af00>name</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>)</span> <span style=color:#f92672>||</span> <span style=color:#111>(</span><span style=color:#75af00>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>BucketLeafFlag</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 否则创建并缓存桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>child</span> <span style=color:#111>=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>openBucket</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>buckets</span><span style=color:#111>[</span><span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>name</span><span style=color:#111>)]</span> <span style=color:#111>=</span> <span style=color:#75af00>child</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>child</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=插入-keyvalue>插入 key/value</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>b</span> <span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>)</span> <span style=color:#75af00>Put</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>value</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Logger</span><span style=color:#111>();</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>discardLogger</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Putting key %q&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Putting key %q failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Putting key %q successfully&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrTxClosed</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Writable</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrTxNotWritable</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrKeyRequired</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>MaxKeySize</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrKeyTooLarge</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>int64</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>value</span><span style=color:#111>))</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>MaxValueSize</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrValueTooLarge</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>newKey</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>cloneBytes</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 移动光标到键位置。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Cursor</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>seek</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Return an error if there is an existing key with a bucket value.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Equal</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>(</span><span style=color:#75af00>flags</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>BucketLeafFlag</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>ErrIncompatibleValue</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// gofail: var beforeBucketPut struct{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>node</span><span style=color:#111>().</span><span style=color:#75af00>put</span><span style=color:#111>(</span><span style=color:#75af00>newKey</span><span style=color:#111>,</span> <span style=color:#75af00>newKey</span><span style=color:#111>,</span> <span style=color:#75af00>value</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=事务>事务</h2><p>BoltDB 支持 ACID 事务，并采用了使用读写锁机制，支持多个读操作与一个写操作并发执行，让应用程序可以更简单的处理复杂操作。每个事务都有一个 txid，其中db.meta.txid 保存了最大的已提交的写事务 id。BoltDB 对写事务和读事务执行不同的 id 分配策略：</p><ol><li>读事务：txid == db.meta.txid；</li><li>写事务：txid == db.meta.txid + 1；</li><li>当写事务成功提交时，会更新了db.meta.txid为当前写事务 id。</li></ol><p>数据库初始化时会将页号为 0 和 1 的两个页面设置为meta页，每个事务会获得一个txid，并选取txid % 2的meta页做为该事务的读取对象，每次写数据后会交替更新meta页。当其中一个出现数据校验不一致时会使用另一个meta页。
BoltDB 的写操作都是在内存中进行，若事务未 commit 时出错，不会对数据库造成影响；若是在 commit 的过程中出错，BoltDB 写入文件的顺序也保证了不会造成影响：因为数据会写在新的 page 中不会覆盖原来的数据，且此时 meta中的信息不发生变化。</p><ol><li>开始一份写事务时，会拷贝一份 meta数据；</li><li>从 rootBucket 开始，遍历 B+ Tree 查找数据位置并修改；</li><li>修改操作完成后会进行事务 commit，此时会将数据写入新的 page；</li><li>最后更新meta的信息。</li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Tx 代表数据库上的一个只读或读写事务。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 只读事务可用于检索键值和创建光标。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 读写事务可以创建和删除桶以及创建和删除键。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 重要：必须在使用完事务后提交或回滚事务。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 只有当没有事务在使用页面时，写入者才能回收这些页面。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 长时间运行的读事务可能会导致数据库迅速增长。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Tx</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>writable</span>       <span style=color:#00a8c8>bool</span>           <span style=color:#75715e>// 是否为可写事务</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>managed</span>        <span style=color:#00a8c8>bool</span>           <span style=color:#75715e>// 是否为管理事务</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span>             <span style=color:#f92672>*</span><span style=color:#75af00>DB</span>            <span style=color:#75715e>// 关联的数据库实例</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>meta</span>           <span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Meta</span>   <span style=color:#75715e>// 元数据指针</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>root</span>           <span style=color:#75af00>Bucket</span>         <span style=color:#75715e>// 根桶</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pages</span>          <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Page</span> <span style=color:#75715e>// 页面映射</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>stats</span>          <span style=color:#75af00>TxStats</span>        <span style=color:#75715e>// 事务统计</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>commitHandlers</span> <span style=color:#111>[]</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span>       <span style=color:#75715e>// 提交处理程序列表</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WriteFlag 指定写相关方法（如 WriteTo()）的标志。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Tx 使用指定的标志打开数据库文件以复制数据。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 默认情况下，此标志未设置，适合主要在内存中的工作负载。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 对于大于可用 RAM 的数据库，可以设置为 syscall.O_DIRECT 来避免淘汰页面缓存。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>WriteFlag</span> <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=begin>Begin</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Begin 开始一个新事务。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 多个只读事务可以并发使用，但一次只能使用一个写事务。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 启动多个写事务会导致调用阻塞，并序列化直到当前写事务完成。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 事务不应该彼此依赖。在同一个goroutine中打开一个读事务和一个写事务可能会导致写入者死锁，</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 因为数据库需要定期重新映射自身以应对增长，并且在读事务打开的时候无法进行。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果需要长时间运行的读事务（例如，快照事务），你可能想要将DB.InitialMmapSize设置为足够大的值</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 以避免写事务的潜在阻塞。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 重要：你必须在完成后关闭只读事务，否则数据库将无法回收旧页面。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>db</span> <span style=color:#f92672>*</span><span style=color:#75af00>DB</span><span style=color:#111>)</span> <span style=color:#75af00>Begin</span><span style=color:#111>(</span><span style=color:#75af00>writable</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>t</span> <span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Logger</span><span style=color:#111>();</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>discardLogger</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Starting a new transaction [writable: %t]&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>writable</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Starting a new transaction [writable: %t] failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>writable</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Starting a new transaction [writable: %t] successfully&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>writable</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>writable</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>beginRWTx</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>beginTx</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>db</span> <span style=color:#f92672>*</span><span style=color:#75af00>DB</span><span style=color:#111>)</span> <span style=color:#75af00>beginRWTx</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If the database was opened with Options.ReadOnly, return an error.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>readOnly</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrDatabaseReadOnly</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Obtain writer lock. This is released by the transaction when it closes.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This enforces only one writer transaction at a time.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>rwlock</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Once we have the writer lock then we can lock the meta pages so that</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// we can set up the transaction.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>metalock</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>metalock</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not open yet.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>opened</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>rwlock</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrDatabaseNotOpen</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not correctly mapped.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>data</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>rwlock</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrInvalidMapping</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create a transaction associated with the database.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>t</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>Tx</span><span style=color:#111>{</span><span style=color:#75af00>writable</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>init</span><span style=color:#111>(</span><span style=color:#75af00>db</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>rwtx</span> <span style=color:#111>=</span> <span style=color:#75af00>t</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>freePages</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// freePages 释放与已关闭的只读事务关联的任何页面。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>db</span> <span style=color:#f92672>*</span><span style=color:#75af00>DB</span><span style=color:#111>)</span> <span style=color:#75af00>freePages</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sort</span><span style=color:#111>.</span><span style=color:#75af00>Sort</span><span style=color:#111>(</span><span style=color:#75af00>txsById</span><span style=color:#111>(</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>txs</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>minid</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>(</span><span style=color:#ae81ff>0xFFFFFFFFFFFFFFFF</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>txs</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>minid</span> <span style=color:#111>=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>txs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>minid</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span><span style=color:#111>.</span><span style=color:#75af00>release</span><span style=color:#111>(</span><span style=color:#75af00>minid</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>t</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>txs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span><span style=color:#111>.</span><span style=color:#75af00>releaseRange</span><span style=color:#111>(</span><span style=color:#75af00>minid</span><span style=color:#111>,</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>()</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>minid</span> <span style=color:#111>=</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>()</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span><span style=color:#111>.</span><span style=color:#75af00>releaseRange</span><span style=color:#111>(</span><span style=color:#75af00>minid</span><span style=color:#111>,</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>(</span><span style=color:#ae81ff>0xFFFFFFFFFFFFFFFF</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>db</span> <span style=color:#f92672>*</span><span style=color:#75af00>DB</span><span style=color:#111>)</span> <span style=color:#75af00>beginTx</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Lock the meta pages while we initialize the transaction. We obtain</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the meta lock before the mmap lock because that&#39;s the order that the</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// write transaction will obtain them.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>metalock</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Obtain a read-only lock on the mmap. When the mmap is remapped it will</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// obtain a write lock so all transactions must finish before it can be</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// remapped.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>mmaplock</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not open yet.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>opened</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>mmaplock</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>metalock</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrDatabaseNotOpen</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit if the database is not correctly mapped.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>data</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>mmaplock</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>metalock</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrInvalidMapping</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create a transaction associated with the database.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>t</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>Tx</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>init</span><span style=color:#111>(</span><span style=color:#75af00>db</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Keep track of transaction until it closes.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>txs</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>txs</span><span style=color:#111>,</span> <span style=color:#75af00>t</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>n</span> <span style=color:#f92672>:=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>txs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Unlock the meta pages.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>metalock</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Update the transaction stats.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>statlock</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>stats</span><span style=color:#111>.</span><span style=color:#75af00>TxN</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>stats</span><span style=color:#111>.</span><span style=color:#75af00>OpenTxN</span> <span style=color:#111>=</span> <span style=color:#75af00>n</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>statlock</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=commit>Commit</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Commit 将所有更改写入磁盘，更新元数据页，并关闭事务。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果磁盘写入发生错误，或者在只读事务上调用Commit，将返回错误。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#75af00>Commit</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>txId</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>ID</span><span style=color:#111>()</span>  <span style=color:#75715e>// 获取事务ID</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>lg</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Logger</span><span style=color:#111>()</span>  <span style=color:#75715e>// 获取日志记录器</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>discardLogger</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Committing transaction %d&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>txId</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Committing transaction failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debugf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Committing transaction %d successfully&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>txId</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否为管理事务，不允许提交。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(!</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>managed</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;managed tx commit not allowed&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrTxClosed</span>  <span style=color:#75715e>// 事务已关闭错误</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>writable</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrTxNotWritable</span>  <span style=color:#75715e>// 非写事务错误</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO: 使用向量化I/O写出脏页</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重新平衡删除后的节点</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>startTime</span> <span style=color:#111>=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Now</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>root</span><span style=color:#111>.</span><span style=color:#75af00>rebalance</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>stats</span><span style=color:#111>.</span><span style=color:#75af00>GetRebalance</span><span style=color:#111>()</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>stats</span><span style=color:#111>.</span><span style=color:#75af00>IncRebalanceTime</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Since</span><span style=color:#111>(</span><span style=color:#75af00>startTime</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>opgid</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>()</span>  <span style=color:#75715e>// 获取旧的页面ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将数据溢出到脏页</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>startTime</span> <span style=color:#111>=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Now</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>root</span><span style=color:#111>.</span><span style=color:#75af00>spill</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;spilling data onto dirty pages failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>rollback</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>stats</span><span style=color:#111>.</span><span style=color:#75af00>IncSpillTime</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Since</span><span style=color:#111>(</span><span style=color:#75af00>startTime</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 释放旧的根桶</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>RootBucket</span><span style=color:#111>().</span><span style=color:#75af00>SetRootPage</span><span style=color:#111>(</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>root</span><span style=color:#111>.</span><span style=color:#75af00>RootPage</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 释放旧的自由列表，因为提交会写出一个新的自由列表</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Freelist</span><span style=color:#111>()</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>PgidNoFreelist</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span><span style=color:#111>.</span><span style=color:#75af00>free</span><span style=color:#111>(</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>(),</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>page</span><span style=color:#111>(</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Freelist</span><span style=color:#111>()))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>NoFreelistSync</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>commitFreelist</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;committing freelist failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>SetFreelist</span><span style=color:#111>(</span><span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>PgidNoFreelist</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果高水位标记已上移，则尝试扩大数据库</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>()</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>opgid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>grow</span><span style=color:#111>(</span><span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>()</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#f92672>*</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>pageSize</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;growing db size failed, pgid: %d, pagesize: %d, error: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Pgid</span><span style=color:#111>(),</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>pageSize</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>rollback</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将脏页写入磁盘</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>startTime</span> <span style=color:#111>=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Now</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>write</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;writing data failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>rollback</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果启用了严格模式，则执行一致性检查</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>StrictMode</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Check</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>errs</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>chkErr</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>ch</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>errs</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>errs</span><span style=color:#111>,</span> <span style=color:#75af00>chkErr</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>errs</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;check fail: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>strings</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#75af00>errs</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;\n&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将元数据写入磁盘</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>writeMeta</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;writeMeta failed: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>rollback</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>stats</span><span style=color:#111>.</span><span style=color:#75af00>IncWriteTime</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Since</span><span style=color:#111>(</span><span style=color:#75af00>startTime</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 结束事务</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#111>close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行提交处理程序，锁已经移除</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>fn</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>commitHandlers</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fn</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=rollback>Rollback</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Rollback 关闭事务并忽略所有之前的更新。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 只读事务必须回滚而不是提交。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#75af00>Rollback</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(!</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>managed</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;managed tx rollback not allowed&#34;</span><span style=color:#111>)</span>  <span style=color:#75715e>// 断言此事务不是管理型事务</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>berrors</span><span style=color:#111>.</span><span style=color:#75af00>ErrTxClosed</span>  <span style=color:#75715e>// 如果数据库已关闭，返回错误</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>nonPhysicalRollback</span><span style=color:#111>()</span>  <span style=color:#75715e>// 执行非物理性回滚</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// nonPhysicalRollback 在用户直接调用Rollback时被调用，在这种情况下，我们不需要从磁盘重新加载自由页面。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#75af00>nonPhysicalRollback</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>  <span style=color:#75715e>// 如果数据库已关闭，直接返回</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>writable</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>freelist</span><span style=color:#111>.</span><span style=color:#75af00>rollback</span><span style=color:#111>(</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>meta</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>())</span>  <span style=color:#75715e>// 如果事务是可写的，回滚自由列表</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#111>close</span><span style=color:#111>()</span>  <span style=color:#75715e>// 关闭事务</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// rollback 从给定的挂起事务中移除页面。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>f</span> <span style=color:#f92672>*</span><span style=color:#75af00>freelist</span><span style=color:#111>)</span> <span style=color:#75af00>rollback</span><span style=color:#111>(</span><span style=color:#75af00>txid</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Txid</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从缓存中移除页面ID。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>txp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>pending</span><span style=color:#111>[</span><span style=color:#75af00>txid</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>txp</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>  <span style=color:#75715e>// 如果没有挂起的事务，直接返回</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>m</span> <span style=color:#75af00>common</span><span style=color:#111>.</span><span style=color:#75af00>Pgids</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span><span style=color:#111>,</span> <span style=color:#75af00>pgid</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>txp</span><span style=color:#111>.</span><span style=color:#75af00>ids</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>cache</span><span style=color:#111>,</span> <span style=color:#75af00>pgid</span><span style=color:#111>)</span>  <span style=color:#75715e>// 从缓存中删除页面ID</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>tx</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>txp</span><span style=color:#111>.</span><span style=color:#75af00>alloctx</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>continue</span>  <span style=color:#75715e>// 如果未分配事务ID，继续下一个</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>tx</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>txid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果待释放页面被中断，恢复页面回分配列表。</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>allocs</span><span style=color:#111>[</span><span style=color:#75af00>pgid</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>tx</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果释放的页面由此事务分配，可以安全地丢弃。</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>m</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>,</span> <span style=color:#75af00>pgid</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从挂起列表中移除页面，并将其标记为由txid分配的自由页面。</span>
</span></span><span style=display:flex><span>    <span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>pending</span><span style=color:#111>,</span> <span style=color:#75af00>txid</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>mergeSpans</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=view--update>View && Update</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// View 在管理的只读事务上下文中执行一个函数。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 从函数返回的任何错误都会从View()方法返回。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 尝试在函数内手动回滚会导致panic。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>db</span> <span style=color:#f92672>*</span><span style=color:#75af00>DB</span><span style=color:#111>)</span> <span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#75af00>fn</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Begin</span><span style=color:#111>(</span><span style=color:#00a8c8>false</span><span style=color:#111>)</span>  <span style=color:#75715e>// 开始一个只读事务</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>  <span style=color:#75715e>// 如果无法开始事务，返回错误</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>rollback</span><span style=color:#111>()</span>  <span style=color:#75715e>// 执行回滚操作</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 标记为管理的事务，以便内部函数不能手动回滚。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>managed</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果函数返回错误，则传递该错误。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>fn</span><span style=color:#111>(</span><span style=color:#75af00>t</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>managed</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>_</span> <span style=color:#111>=</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>Rollback</span><span style=color:#111>()</span>  <span style=color:#75715e>// 执行回滚</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>Rollback</span><span style=color:#111>()</span>  <span style=color:#75715e>// 完成后回滚事务</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update 在读写管理事务的上下文中执行一个函数。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果函数没有返回错误，则提交事务。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果返回了错误，则整个事务被回滚。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 从函数返回的任何错误或从提交返回的错误都会从Update()方法返回。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 尝试在函数内手动提交或回滚将导致panic。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>db</span> <span style=color:#f92672>*</span><span style=color:#75af00>DB</span><span style=color:#111>)</span> <span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#75af00>fn</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Begin</span><span style=color:#111>(</span><span style=color:#00a8c8>true</span><span style=color:#111>)</span>  <span style=color:#75715e>// 开始一个读写事务</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>  <span style=color:#75715e>// 如果无法开始事务，返回错误</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>db</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>rollback</span><span style=color:#111>()</span>  <span style=color:#75715e>// 执行回滚操作</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 标记为管理的事务，以便内部函数不能手动提交。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>managed</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果函数返回错误，则回滚并返回错误。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>fn</span><span style=color:#111>(</span><span style=color:#75af00>t</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>managed</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>_</span> <span style=color:#111>=</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>Rollback</span><span style=color:#111>()</span>  <span style=color:#75715e>// 执行回滚</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>Commit</span><span style=color:#111>()</span>  <span style=color:#75715e>// 无错误时提交事务</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://wingsxdu.com/posts/database/boltdb/>https://wingsxdu.com/posts/database/boltdb/</a></li><li><a href=https://jaydenwen123.github.io/boltdb/>https://jaydenwen123.github.io/boltdb/</a></li><li><a href=https://youjiali1995.github.io/storage/boltdb/>https://youjiali1995.github.io/storage/boltdb/</a></li><li><a href=https://www.cnblogs.com/huxiao-tee/p/4660352.html>https://www.cnblogs.com/huxiao-tee/p/4660352.html</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> boltdb 原理</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/cloud/boltdb_principles/>https://daemon365.dev/post/cloud/boltdb_principles/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/cloud/etcd_watch_implementation_principle/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>etcd watch 实现原理</span></div></a><a href=/post/cloud/keepalived_haproxy/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>kube-apiserver 高可用，keepalived + haproxy</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#page>page</a><ul><li><a href=#branchpage--leafpage>BranchPage && LeafPage</a></li><li><a href=#metapage>MetaPage</a></li><li><a href=#freelistpage>FreelistPage</a></li></ul></li><li><a href=#node>Node</a><ul><li><a href=#page-to-node>page to node</a></li><li><a href=#node-to-page>node to page</a></li></ul></li><li><a href=#bucket>Bucket</a><ul><li><a href=#遍历-cursor>遍历 cursor</a><ul><li><a href=#seek>Seek</a></li></ul></li><li><a href=#创建-bucket-如果不存在>创建 bucket 如果不存在</a></li><li><a href=#插入-keyvalue>插入 key/value</a></li></ul></li><li><a href=#事务>事务</a><ul><li><a href=#begin>Begin</a></li><li><a href=#commit>Commit</a></li><li><a href=#rollback>Rollback</a></li></ul></li><li><a href=#view--update>View && Update</a></li><li><a href=#reference>Reference</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2025 daemon365</p><p class=powered-by>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a></p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder="Search articles..." autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>Enter 2 or more characters to start searching</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>