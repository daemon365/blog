<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.139.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.ico><meta itemprop=name content="kubelet 原理分析"><meta itemprop=description content="Don't let yourself stop."><meta name=description content="Don't let yourself stop."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://daemon365.dev/imgs/daemon365.png"><meta itemprop=keywords content="kubelet,kubernetes,源码分析,golang"><meta property="og:type" content="article"><meta property="og:title" content="kubelet 原理分析"><meta property="og:description" content="Don't let yourself stop."><meta property="og:image" content="/imgs/daemon365.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/"><meta property="og:site_name" content="Daemon"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="daemon365"><meta property="article:published_time" content="2024-05-01 12:40:00 +0800 +0800"><meta property="article:modified_time" content="2024-05-01 12:40:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.5ec1f63635756d664e619fe2d87a11c7394f519beff240c124743433c9861792.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"analysis_of_kubelet_principles","permalink":"https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/","title":"kubelet 原理分析","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JmAHxEAUVgyS8B1c",ck:"JmAHxEAUVgyS8B1c",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>kubelet 原理分析 - Daemon</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Daemon</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Don't let yourself stop.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>Commonweal</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#reference>Reference</a></li><li><a href=#kubelet-简介>kubelet 简介</a></li><li><a href=#kubelet-架构>kubelet 架构</a></li><li><a href=#流程>流程</a><ul><li><a href=#bootstrap>Bootstrap</a></li><li><a href=#run>Run</a></li><li><a href=#syncloop>syncLoop</a><ul><li><a href=#syncloopiteration>syncLoopIteration</a></li></ul></li><li><a href=#handle-synchandler>handle (SyncHandler)</a></li></ul></li><li><a href=#podconfig>podconfig</a><ul><li><a href=#kube-apiserver>kube-apiserver</a></li><li><a href=#file>file</a></li><li><a href=#http>http</a></li></ul></li><li><a href=#pleg>PLEG</a><ul><li><a href=#genericpleg>GenericPLEG</a></li><li><a href=#eventpleg>EventPLEG</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=daemon365 src=/imgs/img-lazy-loading.gif data-src=/imgs/daemon365.png><p class=site-author-name itemprop=name>daemon365</p><div class=site-description itemprop=description>Don't let yourself stop.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>94</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/daemon365 title="Github → https://github.com/daemon365" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev title=https://go-kratos.dev target=_blank>kratos</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/daemon365.png"><meta itemprop=name content="daemon365"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="daemon365"><meta itemprop=description content="Don't let yourself stop."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="kubelet 原理分析"><meta itemprop=description content="Reference




    https://atbug.com/kubelet-source-code-analysis/
    
    
    


kubelet 简介

kubernetes 分为控制面和数据面，kubelet 就是数据面最主要的组件，在每个节点上启动，主要负责容器的创建、启停、监控、日志收集等工作。它是一个在每个集群节点上运行的代理，负责确保节点上的容器根据PodSpec（Pod定义文件）正确运行。"></span><header class=post-header><h1 class=post-title itemprop="name headline">kubelet 原理分析</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-05-01 12:40:00 +0800 +0800" itemprop="dateCreated datePublished" datetime="2024-05-01 12:40:00 +0800 +0800">2024-05-01
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cloud itemprop=url rel=index><span itemprop=name>cloud</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>8901</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>18分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/cloud/analysis_of_kubelet_principles/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><h2 id=reference>Reference
<a class=header-anchor href=#reference></a></h2><ul><li><a href=https://atbug.com/kubelet-source-code-analysis/ title=https://atbug.com/kubelet-source-code-analysis/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://atbug.com/kubelet-source-code-analysis/
<i class="fa fa-external-link-alt"></i></a></li></ul><h2 id=kubelet-简介>kubelet 简介
<a class=header-anchor href=#kubelet-%e7%ae%80%e4%bb%8b></a></h2><p>kubernetes 分为控制面和数据面，kubelet 就是数据面最主要的组件，在每个节点上启动，主要负责容器的创建、启停、监控、日志收集等工作。它是一个在每个集群节点上运行的代理，负责确保节点上的容器根据PodSpec（Pod定义文件）正确运行。</p><p>Kubelet执行以下几项重要功能：</p><ul><li>Pod生命周期管理：Kubelet根据从API服务器接收到的PodSpecs创建、启动、终止容器。它负责启动Pod中的容器，并确保它们按预期运行。</li><li>节点状态监控：Kubelet定期监控节点和容器的状态，并将状态报告回集群的控制平面。这使得集群中的其他组件能够做出相应的调度决策。</li><li>资源管理：Kubelet负责管理分配给每个Pod的资源。这包括CPU、内存和磁盘存储资源。</li><li>健康检查：Kubelet可以执行容器健康检查，并根据检查结果决定是否需要重启容器。</li><li>与容器运行时的通信：Kubelet与容器运行时（如Docker、containerd等）通信，以管理容器的生命周期。</li><li>秘密和配置管理：Kubelet负责将秘密、配置映射等挂载到Pod的容器中，以便应用程序可以访问这些配置。</li><li>服务发现和负载均衡：尽管Kubelet本身不直接处理服务发现，但它通过设置网络规则和环境变量来支持容器内的服务发现机制。</li></ul><h2 id=kubelet-架构>kubelet 架构
<a class=header-anchor href=#kubelet-%e6%9e%b6%e6%9e%84></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/images/52795638-fd1a-4286-bfc7-170869122330.png alt></p><p>kubelet 的架构由 N 多的组件组成，下面简单介绍下比较重要的几个：</p><ul><li>Sync Loop: 这是Kubelet活动的核心，负责同步Pod的状态。同步循环会定期从API服务器获取PodSpecs，并确保容器的当前状态与这些规格相匹配。</li><li>PodConfig: 负责将各个配置源转换成 PodSpecs，可以选择的配置源包括：Kube-apiserver、本地文件、HTTP。</li><li>PLEG(Pod Lifecycle Event Generator)： 负责监测和缓存Pod生命周期事件，如创建、启动或停止容器，然后将这些事件通知 Sync Loop。</li><li>PodWorkers: 负责管理 Pod 的生命周期事件处理。当 Pod 生命周期事件 PLEG 检测到新的事件时，PodWorkers 会被调用来处理这些事件，包括启动新的 Pod、更新现有的 Pod、或者停止和清理不再需要的 Pod。</li><li>PodManager: 存储 Pod 的期望状态，kubelet 服务的不同渠道的 Pod。</li><li>ContainerRuntime: 顾名思义，容器运行时。与遵循 CRI 规范的高级容器运行时进行交互。</li><li>StatsProvider: 提供节点和容器的统计信息，有 cAdvisor 和 CRI 两种实现。</li><li>ProbeManager: 负责执行容器的健康检查，包括 Liveness，Startup 和 Readiness 检查。</li><li>VolumeManager: 负责管理 Pod 的卷，包括挂载和卸载卷。</li><li>ImageManager: 负责管理镜像，包括拉取、删除、镜像 GC 等。</li><li>DeviceManager: 负责管理设备，包括 GPU、RDMA 等。</li><li>PluginManager: PluginManager 运行一组异步循环，根据此节点确定哪些插件需要注册/取消注册并执行。如 CSI 驱动和设备管理器插件（Device Plugin）。</li><li>CertificateManager: 处理证书轮换。</li><li>OOMWatcher: 从系统日志中获取容器的 OOM 日志，将其封装成事件并记录。</li></ul><h2 id=流程>流程
<a class=header-anchor href=#%e6%b5%81%e7%a8%8b></a></h2><p>首先在 <code>cmd/kubelet</code> 中使用传入命令行参数的方式初始化配置，然后创建 <code>pkg/kubelet</code> 中的 Bootstrap inferface, kubelet struct 实现了这个接口， 然后调用 <code>Run</code> 方法启动 kubelet。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>startKubelet</span>(<span style=color:#a6e22e>k</span> <span style=color:#a6e22e>kubelet</span>.<span style=color:#a6e22e>Bootstrap</span>, <span style=color:#a6e22e>podCfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>PodConfig</span>, <span style=color:#a6e22e>kubeCfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>kubeletconfiginternal</span>.<span style=color:#a6e22e>KubeletConfiguration</span>, <span style=color:#a6e22e>kubeDeps</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>kubelet</span>.<span style=color:#a6e22e>Dependencies</span>, <span style=color:#a6e22e>enableServer</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// start the kubelet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>podCfg</span>.<span style=color:#a6e22e>Updates</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// start the kubelet server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>enableServer</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#a6e22e>kubeCfg</span>, <span style=color:#a6e22e>kubeDeps</span>.<span style=color:#a6e22e>TLSOptions</span>, <span style=color:#a6e22e>kubeDeps</span>.<span style=color:#a6e22e>Auth</span>, <span style=color:#a6e22e>kubeDeps</span>.<span style=color:#a6e22e>TracerProvider</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kubeCfg</span>.<span style=color:#a6e22e>ReadOnlyPort</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>ListenAndServeReadOnly</span>(<span style=color:#a6e22e>netutils</span>.<span style=color:#a6e22e>ParseIPSloppy</span>(<span style=color:#a6e22e>kubeCfg</span>.<span style=color:#a6e22e>Address</span>), uint(<span style=color:#a6e22e>kubeCfg</span>.<span style=color:#a6e22e>ReadOnlyPort</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>ListenAndServePodResources</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=bootstrap>Bootstrap
<a class=header-anchor href=#bootstrap></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Bootstrap is a bootstrapping interface for kubelet, targets the initialization protocol
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Bootstrap</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetConfiguration</span>() <span style=color:#a6e22e>kubeletconfiginternal</span>.<span style=color:#a6e22e>KubeletConfiguration</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>BirthCry</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>StartGarbageCollection</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#a6e22e>kubeCfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>kubeletconfiginternal</span>.<span style=color:#a6e22e>KubeletConfiguration</span>, <span style=color:#a6e22e>tlsOptions</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>TLSOptions</span>, <span style=color:#a6e22e>auth</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>AuthInterface</span>, <span style=color:#a6e22e>tp</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>TracerProvider</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListenAndServeReadOnly</span>(<span style=color:#a6e22e>address</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IP</span>, <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>uint</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ListenAndServePodResources</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Run</span>(<span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RunOnce</span>(<span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>) ([]<span style=color:#a6e22e>RunPodResult</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Kubelet</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>方法：</p><ul><li>GetConfiguration: 获取 kubelet 的配置</li><li>BirthCry: 打印 kubelet 启动信息</li><li>StartGarbageCollection: 启动垃圾回收</li><li>ListenAndServe: 启动 kubelet 服务</li><li>ListenAndServeReadOnly: 启动只读服务</li><li>ListenAndServePodResources: 启动 pod 资源服务</li><li>Run: 启动 kubelet 的同步循环</li><li>RunOnce: 启动一次同步循环</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>StartGarbageCollection</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>loggedContainerGCFailure</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>containerGC</span>.<span style=color:#a6e22e>GarbageCollect</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Container garbage collection failed&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>recorder</span>.<span style=color:#a6e22e>Eventf</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeRef</span>, <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>EventTypeWarning</span>, <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>ContainerGCFailed</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>loggedContainerGCFailure</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>vLevel</span> <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Level</span> = <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>loggedContainerGCFailure</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>vLevel</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>loggedContainerGCFailure</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#a6e22e>vLevel</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Container garbage collection succeeded&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}, <span style=color:#a6e22e>ContainerGCPeriod</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// when the high threshold is set to 100, stub the image GC manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>kubeletConfiguration</span>.<span style=color:#a6e22e>ImageGCHighThresholdPercent</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>100</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;ImageGCHighThresholdPercent is set 100, Disable image GC&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>prevImageGCFailed</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>imageManager</span>.<span style=color:#a6e22e>GarbageCollect</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevImageGCFailed</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Image garbage collection failed multiple times in a row&#34;</span>)
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Only create an event for repeated failures
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>recorder</span>.<span style=color:#a6e22e>Eventf</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeRef</span>, <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>EventTypeWarning</span>, <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>ImageGCFailed</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Image garbage collection failed once. Stats initialization may not have completed yet&#34;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>prevImageGCFailed</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>vLevel</span> <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Level</span> = <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevImageGCFailed</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>vLevel</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>prevImageGCFailed</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#a6e22e>vLevel</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Image garbage collection succeeded&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}, <span style=color:#a6e22e>ImageGCPeriod</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>大致的流程为使用 <code>containerGC</code> 启动容器垃圾回收，当ImageGCHighThresholdPercent 为100时，不启动镜像垃圾回收，否则使用 <code>imageManager</code> 启动镜像垃圾回收。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75715e>// RunOnce polls from one configuration update and run the associated pods.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>RunOnce</span>(<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>) ([]<span style=color:#a6e22e>RunPodResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Setup filesystem directories.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>setupDataDirs</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If the container logs directory does not exist, create it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stat</span>(<span style=color:#a6e22e>ContainerLogsDir</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>MkdirAll</span>(<span style=color:#a6e22e>ContainerLogsDir</span>, <span style=color:#ae81ff>0755</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to create directory&#34;</span>, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#a6e22e>ContainerLogsDir</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>u</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>updates</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Processing manifest with pods&#34;</span>, <span style=color:#e6db74>&#34;numPods&#34;</span>, len(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runOnce</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>, <span style=color:#a6e22e>runOnceRetryDelay</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Finished processing pods&#34;</span>, <span style=color:#e6db74>&#34;numPods&#34;</span>, len(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>runOnceManifestDelay</span>):
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;no pod manifest update after %v&#34;</span>, <span style=color:#a6e22e>runOnceManifestDelay</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// runOnce runs a given set of pods and returns their status.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>runOnce</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#a6e22e>retryDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) (<span style=color:#a6e22e>results</span> []<span style=color:#a6e22e>RunPodResult</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>RunPodResult</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>admitted</span> <span style=color:#f92672>:=</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pods</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Check if we can admit the pod.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>canAdmitPod</span>(<span style=color:#a6e22e>admitted</span>, <span style=color:#a6e22e>pod</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>rejectPod</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>results</span> = append(<span style=color:#a6e22e>results</span>, <span style=color:#a6e22e>RunPodResult</span>{<span style=color:#a6e22e>pod</span>, <span style=color:#66d9ef>nil</span>})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>admitted</span> = append(<span style=color:#a6e22e>admitted</span>, <span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runPod</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>retryDelay</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>RunPodResult</span>{<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>err</span>}
</span></span><span style=display:flex><span>		}(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Waiting for pods&#34;</span>, <span style=color:#e6db74>&#34;numPods&#34;</span>, len(<span style=color:#a6e22e>admitted</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failedPods</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>admitted</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>results</span> = append(<span style=color:#a6e22e>results</span>, <span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>failedContainerName</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>getFailedContainers</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Unable to get failed containers&#39; names for pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Pod</span>), <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Unable to start pod because container failed&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Pod</span>), <span style=color:#e6db74>&#34;containerName&#34;</span>, <span style=color:#a6e22e>failedContainerName</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>failedPods</span> = append(<span style=color:#a6e22e>failedPods</span>, <span style=color:#a6e22e>format</span>.<span style=color:#a6e22e>Pod</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Pod</span>))
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Started pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Pod</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>failedPods</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>results</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error running pods: %v&#34;</span>, <span style=color:#a6e22e>failedPods</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Pods started&#34;</span>, <span style=color:#e6db74>&#34;numPods&#34;</span>, len(<span style=color:#a6e22e>pods</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>results</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>大致作用为从 <code>updates</code> 中获取 PodUpdate，然后调用 <code>runOnce</code> 方法，该方法会调用 <code>runPod</code> 方法启动 Pod。</p><h3 id=run>Run
<a class=header-anchor href=#run></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>logServer</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>FileServer</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Dir</span>(<span style=color:#a6e22e>nodeLogDir</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>utilfeature</span>.<span style=color:#a6e22e>DefaultFeatureGate</span>.<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>features</span>.<span style=color:#a6e22e>NodeLogQuery</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>kubeletConfiguration</span>.<span style=color:#a6e22e>EnableSystemLogQuery</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>logServer</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StripPrefix</span>(<span style=color:#e6db74>&#34;/logs/&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nlq</span>, <span style=color:#a6e22e>errs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newNodeLogQuery</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Query</span>()); len(<span style=color:#a6e22e>errs</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>errs</span>.<span style=color:#a6e22e>ToAggregate</span>().<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nlq</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;path not allowed in query mode&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusNotAcceptable</span>)
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nlq</span>.<span style=color:#a6e22e>validate</span>(); len(<span style=color:#a6e22e>errs</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>errs</span>.<span style=color:#a6e22e>ToAggregate</span>().<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusNotAcceptable</span>)
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#75715e>// Validation ensures that the request does not query services and files at the same time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nlq</span>.<span style=color:#a6e22e>Services</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>journal</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#75715e>// Validation ensures that the request does not explicitly query multiple files at the same time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nlq</span>.<span style=color:#a6e22e>Files</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>						<span style=color:#75715e>// Account for the \ being used on Windows clients
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>						<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span> = <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>ToSlash</span>(<span style=color:#a6e22e>nlq</span>.<span style=color:#a6e22e>Files</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Fall back in case the caller is directly trying to query a file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// Example: kubectl get --raw /api/v1/nodes/$name/proxy/logs/foo.log
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>			}))
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>logServer</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StripPrefix</span>(<span style=color:#e6db74>&#34;/logs/&#34;</span>, <span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>kubeClient</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;No API server defined - no node status update will be sent&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start the cloud provider sync manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cloudResourceSyncManager</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cloudResourceSyncManager</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>initializeModules</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>recorder</span>.<span style=color:#a6e22e>Eventf</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeRef</span>, <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>EventTypeWarning</span>, <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>KubeletSetupFailed</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to initialize internal modules&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start volume manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>volumeManager</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>sourcesReady</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>kubeClient</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Start two go-routines to update the status.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// The first will report to the apiserver every nodeStatusUpdateFrequency and is aimed to provide regular status intervals,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// while the second is used to provide a more timely status update during initialization and runs an one-shot update to the apiserver
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// once the node becomes ready, then exits afterwards.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Introduce some small jittering to ensure that over time the requests won&#39;t start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// accumulating at approximately the same time from the set of nodes due to priority and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// fairness effect.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>JitterUntil</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncNodeStatus</span>, <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeStatusUpdateFrequency</span>, <span style=color:#ae81ff>0.04</span>, <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>fastStatusUpdateOnce</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// start syncing lease
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeLeaseController</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>updateRuntimeUp</span>, <span style=color:#ae81ff>5</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Set up iptables util rules
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>makeIPTablesUtilChains</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>initNetworkUtil</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start component sync loops.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>statusManager</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start syncing RuntimeClasses if enabled.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeClassManager</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeClassManager</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start the pod lifecycle event generator.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start eventedPLEG only if EventedPLEG feature gate is enabled.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>utilfeature</span>.<span style=color:#a6e22e>DefaultFeatureGate</span>.<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>features</span>.<span style=color:#a6e22e>EventedPLEG</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>eventedPleg</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoop</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>updates</span>, <span style=color:#a6e22e>kl</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码的流程为：</p><ol><li>检查是否需要创建日志服务器 如果需要则创建</li><li>启动云提供商同步管理器</li><li>初始化模块，如果出错则打印日志并退出</li><li>启动卷管理器</li><li>启动两个 goroutine 来更新状态，一个是定时更新，一个是在初始化时更新</li><li>启动同步租约的goroutine</li><li>定期更新RuntimeUp状态的goroutine</li><li>设置iptables规则</li><li>启动组件同步循环</li><li>如果启用了RuntimeClasses，则启动RuntimeClasses同步循环</li><li>启动Pod Lifecycle Event Generator</li><li>如果启用了EventedPLEG特性，则启动EventedPLEG</li><li>启动 syncloop</li></ol><h3 id=syncloop>syncLoop
<a class=header-anchor href=#syncloop></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75715e>// syncLoop is the main loop for processing changes. It watches for changes from
</span></span></span><span style=display:flex><span><span style=color:#75715e>// three channels (file, apiserver, and http) and creates a union of them. For
</span></span></span><span style=display:flex><span><span style=color:#75715e>// any new change seen, will run a sync against desired state and running state. If
</span></span></span><span style=display:flex><span><span style=color:#75715e>// no changes are seen to the configuration, will synchronize the last known desired
</span></span></span><span style=display:flex><span><span style=color:#75715e>// state every sync-frequency seconds. Never returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>syncLoop</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>, <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>SyncHandler</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Starting kubelet main sync loop&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The syncTicker wakes up kubelet to checks if there are any pod workers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// that need to be sync&#39;d. A one-second period is sufficient because the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// sync interval is defaulted to 10s.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>syncTicker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>syncTicker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>housekeepingTicker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>housekeepingPeriod</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>housekeepingTicker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>plegCh</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>Watch</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>base</span>   = <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>max</span>    = <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>factor</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>duration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Responsible for checking limits in resolv.conf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// The limits do not have anything to do with individual pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Since this is called in syncLoop, we don&#39;t need to call it anywhere else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>dnsConfigurer</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>dnsConfigurer</span>.<span style=color:#a6e22e>ResolverConfig</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>dnsConfigurer</span>.<span style=color:#a6e22e>CheckLimitsForResolvConf</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeState</span>.<span style=color:#a6e22e>runtimeErrors</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Skipping pod synchronization&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>// exponential backoff
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>duration</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>duration</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Min</span>(float64(<span style=color:#a6e22e>max</span>), <span style=color:#a6e22e>factor</span><span style=color:#f92672>*</span>float64(<span style=color:#a6e22e>duration</span>)))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// reset backoff if we have a success
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>duration</span> = <span style=color:#a6e22e>base</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoopMonitor</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoopIteration</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>updates</span>, <span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>syncTicker</span>.<span style=color:#a6e22e>C</span>, <span style=color:#a6e22e>housekeepingTicker</span>.<span style=color:#a6e22e>C</span>, <span style=color:#a6e22e>plegCh</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoopMonitor</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码流程为：</p><ol><li>从 pleg 获取 update 事件 他是一个 channel</li><li>进入循环 如果 runtimeState 有错误 sleep 一会儿然后跳过</li><li>执行 syncLoopIteration</li></ol><h4 id=syncloopiteration>syncLoopIteration
<a class=header-anchor href=#syncloopiteration></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>syncLoopIteration</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>configCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>, <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>SyncHandler</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>syncCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>housekeepingCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>plegCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>PodLifecycleEvent</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>open</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>configCh</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Update from a config source; dispatch it to the right handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// callback.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>open</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Update channel is closed, exiting the sync loop&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Op</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>ADD</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop ADD&#34;</span>, <span style=color:#e6db74>&#34;source&#34;</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Source</span>, <span style=color:#e6db74>&#34;pods&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObjSlice</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>))
</span></span><span style=display:flex><span>			<span style=color:#75715e>// After restarting, kubelet will get all existing pods through
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// ADD as if they are new pods. These pods will then go through the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// admission process and *may* be rejected. This can be resolved
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// once we have checkpointing.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodAdditions</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>UPDATE</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop UPDATE&#34;</span>, <span style=color:#e6db74>&#34;source&#34;</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Source</span>, <span style=color:#e6db74>&#34;pods&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObjSlice</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodUpdates</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>REMOVE</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop REMOVE&#34;</span>, <span style=color:#e6db74>&#34;source&#34;</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Source</span>, <span style=color:#e6db74>&#34;pods&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObjSlice</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodRemoves</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>RECONCILE</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop RECONCILE&#34;</span>, <span style=color:#e6db74>&#34;source&#34;</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Source</span>, <span style=color:#e6db74>&#34;pods&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObjSlice</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodReconcile</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>DELETE</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop DELETE&#34;</span>, <span style=color:#e6db74>&#34;source&#34;</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Source</span>, <span style=color:#e6db74>&#34;pods&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObjSlice</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>))
</span></span><span style=display:flex><span>			<span style=color:#75715e>// DELETE is treated as a UPDATE because of graceful deletion.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodUpdates</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Pods</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SET</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// TODO: Do we want to support this?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Kubelet does not support snapshot update&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Invalid operation type received&#34;</span>, <span style=color:#e6db74>&#34;operation&#34;</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Op</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>sourcesReady</span>.<span style=color:#a6e22e>AddSource</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Source</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>plegCh</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isSyncPodWorthy</span>(<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// PLEG event for a pod; sync it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodByUID</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>ID</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (PLEG): event for pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>pod</span>), <span style=color:#e6db74>&#34;event&#34;</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodSyncs</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{<span style=color:#a6e22e>pod</span>})
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// If the pod no longer exists, ignore the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (PLEG): pod does not exist, ignore irrelevant event&#34;</span>, <span style=color:#e6db74>&#34;event&#34;</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>ContainerDied</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>containerID</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Data</span>.(<span style=color:#66d9ef>string</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cleanUpContainersInPod</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#a6e22e>containerID</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>syncCh</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Sync pods waiting for sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>podsToSync</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>getPodsToSync</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>podsToSync</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (SYNC) pods&#34;</span>, <span style=color:#e6db74>&#34;total&#34;</span>, len(<span style=color:#a6e22e>podsToSync</span>), <span style=color:#e6db74>&#34;pods&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObjSlice</span>(<span style=color:#a6e22e>podsToSync</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodSyncs</span>(<span style=color:#a6e22e>podsToSync</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>livenessManager</span>.<span style=color:#a6e22e>Updates</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Result</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>proberesults</span>.<span style=color:#a6e22e>Failure</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>handleProbeSync</span>(<span style=color:#a6e22e>kl</span>, <span style=color:#a6e22e>update</span>, <span style=color:#a6e22e>handler</span>, <span style=color:#e6db74>&#34;liveness&#34;</span>, <span style=color:#e6db74>&#34;unhealthy&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>readinessManager</span>.<span style=color:#a6e22e>Updates</span>():
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ready</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Result</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>proberesults</span>.<span style=color:#a6e22e>Success</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>statusManager</span>.<span style=color:#a6e22e>SetContainerReadiness</span>(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>PodUID</span>, <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>ContainerID</span>, <span style=color:#a6e22e>ready</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ready</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>status</span> = <span style=color:#e6db74>&#34;ready&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>handleProbeSync</span>(<span style=color:#a6e22e>kl</span>, <span style=color:#a6e22e>update</span>, <span style=color:#a6e22e>handler</span>, <span style=color:#e6db74>&#34;readiness&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>startupManager</span>.<span style=color:#a6e22e>Updates</span>():
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>started</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Result</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>proberesults</span>.<span style=color:#a6e22e>Success</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>statusManager</span>.<span style=color:#a6e22e>SetContainerStartup</span>(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>PodUID</span>, <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>ContainerID</span>, <span style=color:#a6e22e>started</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>started</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>status</span> = <span style=color:#e6db74>&#34;started&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>handleProbeSync</span>(<span style=color:#a6e22e>kl</span>, <span style=color:#a6e22e>update</span>, <span style=color:#a6e22e>handler</span>, <span style=color:#e6db74>&#34;startup&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>housekeepingCh</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>sourcesReady</span>.<span style=color:#a6e22e>AllReady</span>() {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// If the sources aren&#39;t ready or volume manager has not yet synced the states,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// skip housekeeping, as we may accidentally delete pods from unready sources.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (housekeeping, skipped): sources aren&#39;t ready yet&#34;</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (housekeeping)&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodCleanups</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed cleaning pods&#34;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>duration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>start</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>duration</span> &gt; <span style=color:#a6e22e>housekeepingWarningDuration</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;housekeeping took too long&#34;</span>), <span style=color:#e6db74>&#34;Housekeeping took longer than expected&#34;</span>, <span style=color:#e6db74>&#34;expected&#34;</span>, <span style=color:#a6e22e>housekeepingWarningDuration</span>, <span style=color:#e6db74>&#34;actual&#34;</span>, <span style=color:#a6e22e>duration</span>.<span style=color:#a6e22e>Round</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>))
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (housekeeping) end&#34;</span>, <span style=color:#e6db74>&#34;duration&#34;</span>, <span style=color:#a6e22e>duration</span>.<span style=color:#a6e22e>Round</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>首先解释一下这个函数的参数：</p><ul><li>configCh: 将配置更改的 Pod 分派给适当的处理程序回调函数</li><li>plegCh: 更新运行时缓存；同步 Pod</li><li>syncCh: 同步所有等待同步的 Pod</li><li>housekeepingCh: 触发 Pod 的清理</li><li>health manager: 同步失败的 Pod 或其中一个或多个容器的健康检查失败的 Pod</li></ul><p>代码流程为：</p><ul><li>如果 updates channel 有消息 则使用 handler 调用对应方法做处理</li><li>如果 plegCh 有消息 则使用 handler 的 HandlePodSyncs 做同步</li><li>如果 syncCh 有消息 代表到了同步时间 做同步操作</li><li>如果是 三种 probe 的更新 则使用 handleProbeSync 做同步</li><li>如果 housekeepingCh 有消息 则使用 handler 的 HandlePodCleanups 做清理</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleProbeSync</span>(<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>, <span style=color:#a6e22e>update</span> <span style=color:#a6e22e>proberesults</span>.<span style=color:#a6e22e>Update</span>, <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>SyncHandler</span>, <span style=color:#a6e22e>probe</span>, <span style=color:#a6e22e>status</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// We should not use the pod from manager, because it is never updated after initialization.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodByUID</span>(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>PodUID</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// If the pod no longer exists, ignore the update.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (probe): ignore irrelevant update&#34;</span>, <span style=color:#e6db74>&#34;probe&#34;</span>, <span style=color:#a6e22e>probe</span>, <span style=color:#e6db74>&#34;status&#34;</span>, <span style=color:#a6e22e>status</span>, <span style=color:#e6db74>&#34;update&#34;</span>, <span style=color:#a6e22e>update</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (probe)&#34;</span>, <span style=color:#e6db74>&#34;probe&#34;</span>, <span style=color:#a6e22e>probe</span>, <span style=color:#e6db74>&#34;status&#34;</span>, <span style=color:#a6e22e>status</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>pod</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodSyncs</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{<span style=color:#a6e22e>pod</span>})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>handleProbeSync也是使用 handler 的 HandlePodSyncs 做同步</p><h3 id=handle-synchandler>handle (SyncHandler)
<a class=header-anchor href=#handle-synchandler></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75715e>// SyncHandler is an interface implemented by Kubelet, for testability
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SyncHandler</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HandlePodAdditions</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HandlePodUpdates</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HandlePodRemoves</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HandlePodReconcile</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HandlePodSyncs</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HandlePodCleanups</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也是 kubelet struct 实现了这个接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75715e>// HandlePodAdditions is the callback in SyncHandler for pods being added from
</span></span></span><span style=display:flex><span><span style=color:#75715e>// a config source.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>HandlePodAdditions</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>sliceutils</span>.<span style=color:#a6e22e>PodsByCreationTime</span>(<span style=color:#a6e22e>pods</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>utilfeature</span>.<span style=color:#a6e22e>DefaultFeatureGate</span>.<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>features</span>.<span style=color:#a6e22e>InPlacePodVerticalScaling</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podResizeMutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podResizeMutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pods</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>existingPods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPods</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>AddPod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>mirrorPod</span>, <span style=color:#a6e22e>wasMirror</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodAndMirrorPod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wasMirror</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Unable to find pod for mirror pod, skipping&#34;</span>, <span style=color:#e6db74>&#34;mirrorPod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>mirrorPod</span>), <span style=color:#e6db74>&#34;mirrorPodUID&#34;</span>, <span style=color:#a6e22e>mirrorPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>MirrorPod</span>:  <span style=color:#a6e22e>mirrorPod</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodUpdate</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>StartTime</span>:  <span style=color:#a6e22e>start</span>,
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>IsPodTerminationRequested</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>UID</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// We failed pods that we rejected, so activePods include all admitted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// pods that are alive.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>activePods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>filterOutInactivePods</span>(<span style=color:#a6e22e>existingPods</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>utilfeature</span>.<span style=color:#a6e22e>DefaultFeatureGate</span>.<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>features</span>.<span style=color:#a6e22e>InPlacePodVerticalScaling</span>) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// To handle kubelet restarts, test pod admissibility using AllocatedResources values
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// (for cpu &amp; memory) from checkpoint store. If found, that is the source of truth.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>podCopy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>DeepCopy</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>updateContainerResourceAllocation</span>(<span style=color:#a6e22e>podCopy</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Check if we can admit the pod; if not, reject it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>canAdmitPod</span>(<span style=color:#a6e22e>activePods</span>, <span style=color:#a6e22e>podCopy</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>rejectPod</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#75715e>// For new pod, checkpoint the resource values at which the Pod has been admitted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>statusManager</span>.<span style=color:#a6e22e>SetPodAllocation</span>(<span style=color:#a6e22e>podCopy</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#75715e>//TODO(vinaykul,InPlacePodVerticalScaling): Can we recover from this in some way? Investigate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;SetPodAllocation failed&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>pod</span>))
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Check if we can admit the pod; if not, reject it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>canAdmitPod</span>(<span style=color:#a6e22e>activePods</span>, <span style=color:#a6e22e>pod</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>rejectPod</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>MirrorPod</span>:  <span style=color:#a6e22e>mirrorPod</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodCreate</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>StartTime</span>:  <span style=color:#a6e22e>start</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>HandlePodUpdates</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pods</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>mirrorPod</span>, <span style=color:#a6e22e>wasMirror</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodAndMirrorPod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wasMirror</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Unable to find pod for mirror pod, skipping&#34;</span>, <span style=color:#e6db74>&#34;mirrorPod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>mirrorPod</span>), <span style=color:#e6db74>&#34;mirrorPodUID&#34;</span>, <span style=color:#a6e22e>mirrorPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>MirrorPod</span>:  <span style=color:#a6e22e>mirrorPod</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodUpdate</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>StartTime</span>:  <span style=color:#a6e22e>start</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>HandlePodRemoves</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pods</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>RemovePod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>mirrorPod</span>, <span style=color:#a6e22e>wasMirror</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodAndMirrorPod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wasMirror</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Unable to find pod for mirror pod, skipping&#34;</span>, <span style=color:#e6db74>&#34;mirrorPod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>mirrorPod</span>), <span style=color:#e6db74>&#34;mirrorPodUID&#34;</span>, <span style=color:#a6e22e>mirrorPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>MirrorPod</span>:  <span style=color:#a6e22e>mirrorPod</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodUpdate</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>StartTime</span>:  <span style=color:#a6e22e>start</span>,
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Deletion is allowed to fail because the periodic cleanup routine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// will trigger deletion again.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>deletePod</span>(<span style=color:#a6e22e>pod</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Failed to delete pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>pod</span>), <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>HandlePodReconcile</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pods</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Update the pod in pod manager, status manager will do periodically reconcile according
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// to the pod manager.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>mirrorPod</span>, <span style=color:#a6e22e>wasMirror</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodAndMirrorPod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wasMirror</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Unable to find pod for mirror pod, skipping&#34;</span>, <span style=color:#e6db74>&#34;mirrorPod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>mirrorPod</span>), <span style=color:#e6db74>&#34;mirrorPodUID&#34;</span>, <span style=color:#a6e22e>mirrorPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Static pods should be reconciled the same way as regular pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// TODO: reconcile being calculated in the config manager is questionable, and avoiding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// extra syncs may no longer be necessary. Reevaluate whether Reconcile and Sync can be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// merged (after resolving the next two TODOs).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Reconcile Pod &#34;Ready&#34; condition if necessary. Trigger sync pod for reconciliation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// TODO: this should be unnecessary today - determine what is the cause for this to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// be different than Sync, or if there is a better place for it. For instance, we have
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// needsReconcile in kubelet/config, here, and in status_manager.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>NeedToReconcilePodReadiness</span>(<span style=color:#a6e22e>pod</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>MirrorPod</span>:  <span style=color:#a6e22e>mirrorPod</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodSync</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>StartTime</span>:  <span style=color:#a6e22e>start</span>,
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// After an evicted pod is synced, all dead containers in the pod can be removed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// TODO: this is questionable - status read is async and during eviction we already
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// expect to not have some container info. The pod worker knows whether a pod has
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// been evicted, so if this is about minimizing the time to react to an eviction we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// can do better. If it&#39;s about preserving pod status info we can also do better.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>eviction</span>.<span style=color:#a6e22e>PodIsEvicted</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Status</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>podStatus</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podCache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>UID</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>containerDeletor</span>.<span style=color:#a6e22e>deleteContainersInPod</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>podStatus</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>HandlePodSyncs</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pods</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>mirrorPod</span>, <span style=color:#a6e22e>wasMirror</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodAndMirrorPod</span>(<span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wasMirror</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Unable to find pod for mirror pod, skipping&#34;</span>, <span style=color:#e6db74>&#34;mirrorPod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>mirrorPod</span>), <span style=color:#e6db74>&#34;mirrorPodUID&#34;</span>, <span style=color:#a6e22e>mirrorPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Syncing a mirror pod is a programmer error since the intent of sync is to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// batch notify all pending work. We should make it impossible to double sync,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// but for now log a programmer error to prevent accidental introduction.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Programmer error, HandlePodSyncs does not expect to receive mirror pods&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>UID</span>, <span style=color:#e6db74>&#34;mirrorPodUID&#34;</span>, <span style=color:#a6e22e>mirrorPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>MirrorPod</span>:  <span style=color:#a6e22e>mirrorPod</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodSync</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>StartTime</span>:  <span style=color:#a6e22e>start</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>HandlePodCleanups</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The kubelet lacks checkpointing, so we need to introspect the set of pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// in the cgroup tree prior to inspecting the set of pods in our pod manager.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// this ensures our view of the cgroup tree does not mistakenly observe pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// that are added after the fact...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cgroupPods</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#a6e22e>cm</span>.<span style=color:#a6e22e>CgroupName</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span>        <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cgroupsPerQOS</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pcm</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>containerManager</span>.<span style=color:#a6e22e>NewPodContainerManager</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cgroupPods</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>pcm</span>.<span style=color:#a6e22e>GetAllPodsFromCgroups</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get list of pods that still exist on cgroup mounts: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>allPods</span>, <span style=color:#a6e22e>mirrorPods</span>, <span style=color:#a6e22e>orphanedMirrorPodFullnames</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodsAndMirrorPods</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Pod phase progresses monotonically. Once a pod has reached a final state,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// it should never leave regardless of the restart policy. The statuses
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// of such pods should not be changed, and there is no need to sync them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// TODO: the logic here does not handle two cases:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   1. If the containers were removed immediately after they died, kubelet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//      may fail to generate correct statuses, let alone filtering correctly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   2. If kubelet restarted before writing the terminated status for a pod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//      to the apiserver, it could still restart the terminated pod (even
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//      though the pod was not considered terminated by the apiserver).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// These two conditions could be alleviated by checkpointing kubelet.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stop the workers for terminated pods not in the config source
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up pod workers for terminated pods&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>workingPods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>SyncKnownPods</span>(<span style=color:#a6e22e>allPods</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Reconcile: At this point the pod workers have been pruned to the set of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// desired pods. Pods that must be restarted due to UID reuse, or leftover
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// pods from previous runs, are not known to the pod worker.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>allPodsByUID</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allPods</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>allPodsByUID</span>[<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>UID</span>] = <span style=color:#a6e22e>pod</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Identify the set of pods that have workers, which should be all pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// from config that are not terminated, as well as any terminating pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// that have already been removed from config. Pods that are terminating
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// will be added to possiblyRunningPods, to prevent overly aggressive
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// cleanup of pod cgroups.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stringIfTrue</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runningPods</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#a6e22e>sets</span>.<span style=color:#a6e22e>Empty</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>possiblyRunningPods</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#a6e22e>sets</span>.<span style=color:#a6e22e>Empty</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>sync</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>workingPods</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>State</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SyncPod</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>runningPods</span>[<span style=color:#a6e22e>uid</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>possiblyRunningPods</span>[<span style=color:#a6e22e>uid</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>TerminatingPod</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>possiblyRunningPods</span>[<span style=color:#a6e22e>uid</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Retrieve the list of running containers from the runtime to perform cleanup.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// We need the latest state to avoid delaying restarts of static pods that reuse
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// a UID.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeCache</span>.<span style=color:#a6e22e>ForceUpdateIfOlder</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Error listing containers&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runningRuntimePods</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeCache</span>.<span style=color:#a6e22e>GetPods</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Error listing containers&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stop probing pods that are not running
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up probes for terminated pods&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>probeManager</span>.<span style=color:#a6e22e>CleanupPods</span>(<span style=color:#a6e22e>possiblyRunningPods</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Remove orphaned pod statuses not in the total list of known config pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up orphaned pod statuses&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>removeOrphanedPodStatuses</span>(<span style=color:#a6e22e>allPods</span>, <span style=color:#a6e22e>mirrorPods</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Remove orphaned pod user namespace allocations (if any).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up orphaned pod user namespace allocations&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>usernsManager</span>.<span style=color:#a6e22e>CleanupOrphanedPodUsernsAllocations</span>(<span style=color:#a6e22e>allPods</span>, <span style=color:#a6e22e>runningRuntimePods</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed cleaning up orphaned pod user namespaces allocations&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Remove orphaned volumes from pods that are known not to have any
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// containers. Note that we pass all pods (including terminated pods) to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// the function, so that we don&#39;t remove volumes associated with terminated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// but not yet deleted pods.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// TODO: this method could more aggressively cleanup terminated pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// in the future (volumes, mount dirs, logs, and containers could all be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// better separated)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up orphaned pod directories&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cleanupOrphanedPodDirs</span>(<span style=color:#a6e22e>allPods</span>, <span style=color:#a6e22e>runningRuntimePods</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// We want all cleanup tasks to be run even if one of them failed. So
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// we just log an error here and continue other cleanup tasks.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// This also applies to the other clean up tasks.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed cleaning up orphaned pod directories&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Remove any orphaned mirror pods (mirror pods are tracked by name via the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// pod worker)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up orphaned mirror pods&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>podFullname</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>orphanedMirrorPodFullnames</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>IsPodForMirrorPodTerminatingByFullName</span>(<span style=color:#a6e22e>podFullname</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>mirrorPodClient</span>.<span style=color:#a6e22e>DeleteMirrorPod</span>(<span style=color:#a6e22e>podFullname</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Encountered error when deleting mirror pod&#34;</span>, <span style=color:#e6db74>&#34;podName&#34;</span>, <span style=color:#a6e22e>podFullname</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Deleted mirror pod&#34;</span>, <span style=color:#e6db74>&#34;podName&#34;</span>, <span style=color:#a6e22e>podFullname</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// After pruning pod workers for terminated pods get the list of active pods for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// metrics and to determine restarts.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>activePods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>filterOutInactivePods</span>(<span style=color:#a6e22e>allPods</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>allRegularPods</span>, <span style=color:#a6e22e>allStaticPods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>splitPodsByStatic</span>(<span style=color:#a6e22e>allPods</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>activeRegularPods</span>, <span style=color:#a6e22e>activeStaticPods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>splitPodsByStatic</span>(<span style=color:#a6e22e>activePods</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>DesiredPodCount</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;&#34;</span>).<span style=color:#a6e22e>Set</span>(float64(len(<span style=color:#a6e22e>allRegularPods</span>)))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>DesiredPodCount</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;true&#34;</span>).<span style=color:#a6e22e>Set</span>(float64(len(<span style=color:#a6e22e>allStaticPods</span>)))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ActivePodCount</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;&#34;</span>).<span style=color:#a6e22e>Set</span>(float64(len(<span style=color:#a6e22e>activeRegularPods</span>)))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ActivePodCount</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;true&#34;</span>).<span style=color:#a6e22e>Set</span>(float64(len(<span style=color:#a6e22e>activeStaticPods</span>)))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>MirrorPodCount</span>.<span style=color:#a6e22e>Set</span>(float64(len(<span style=color:#a6e22e>mirrorPods</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// At this point, the pod worker is aware of which pods are not desired (SyncKnownPods).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// We now look through the set of active pods for those that the pod worker is not aware of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// and deliver an update. The most common reason a pod is not known is because the pod was
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// deleted and recreated with the same UID while the pod worker was driving its lifecycle (very
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// very rare for API pods, common for static pods with fixed UIDs). Containers that may still
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// be running from a previous execution must be reconciled by the pod worker&#39;s sync method.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// We must use active pods because that is the set of admitted pods (podManager includes pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// that will never be run, and statusManager tracks already rejected pods).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>restartCount</span>, <span style=color:#a6e22e>restartCountStatic</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>desiredPod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>activePods</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>knownPod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workingPods</span>[<span style=color:#a6e22e>desiredPod</span>.<span style=color:#a6e22e>UID</span>]; <span style=color:#a6e22e>knownPod</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Pod will be restarted because it is in the desired set and not known to the pod workers (likely due to UID reuse)&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>desiredPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>isStatic</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>IsStaticPod</span>(<span style=color:#a6e22e>desiredPod</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>mirrorPod</span>, <span style=color:#a6e22e>wasMirror</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodAndMirrorPod</span>(<span style=color:#a6e22e>desiredPod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>wasMirror</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Programmer error, restartable pod was a mirror pod but activePods should never contain a mirror pod&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>desiredPod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodCreate</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>MirrorPod</span>:  <span style=color:#a6e22e>mirrorPod</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// the desired pod is now known as well
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>workingPods</span>[<span style=color:#a6e22e>desiredPod</span>.<span style=color:#a6e22e>UID</span>] = <span style=color:#a6e22e>PodWorkerSync</span>{<span style=color:#a6e22e>State</span>: <span style=color:#a6e22e>SyncPod</span>, <span style=color:#a6e22e>HasConfig</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Static</span>: <span style=color:#a6e22e>isStatic</span>}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isStatic</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// restartable static pods are the normal case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>restartCountStatic</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// almost certainly means shenanigans, as API pods should never have the same UID after being deleted and recreated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// unless there is a major API violation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>restartCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RestartedPodTotal</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;true&#34;</span>).<span style=color:#a6e22e>Add</span>(float64(<span style=color:#a6e22e>restartCountStatic</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RestartedPodTotal</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;&#34;</span>).<span style=color:#a6e22e>Add</span>(float64(<span style=color:#a6e22e>restartCount</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Complete termination of deleted pods that are not runtime pods (don&#39;t have
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// running containers), are terminal, and are not known to pod workers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// An example is pods rejected during kubelet admission that have never
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// started before (i.e. does not have an orphaned pod).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Adding the pods with SyncPodKill to pod workers allows to proceed with
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// force-deletion of such pods, yet preventing re-entry of the routine in the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// next invocation of HandlePodCleanups.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>filterTerminalPodsToDelete</span>(<span style=color:#a6e22e>allPods</span>, <span style=color:#a6e22e>runningRuntimePods</span>, <span style=color:#a6e22e>workingPods</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Handling termination and deletion of the pod to pod workers&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>pod</span>), <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>UpdateType</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodKill</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Pod</span>:        <span style=color:#a6e22e>pod</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Finally, terminate any pods that are observed in the runtime but not present in the list of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// known running pods from config. If we do terminate running runtime pods that will happen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// asynchronously in the background and those will be processed in the next invocation of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// HandlePodCleanups.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>orphanCount</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>runningPod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>runningRuntimePods</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// If there are orphaned pod resources in CRI that are unknown to the pod worker, terminate them
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// now. Since housekeeping is exclusive to other pod worker updates, we know that no pods have
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// been added to the pod worker in the meantime. Note that pods that are not visible in the runtime
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// but which were previously known are terminated by SyncKnownPods().
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>knownPod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workingPods</span>[<span style=color:#a6e22e>runningPod</span>.<span style=color:#a6e22e>ID</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>knownPod</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>one</span> <span style=color:#f92672>:=</span> int64(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>killPodOptions</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>KillPodOptions</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>PodTerminationGracePeriodSecondsOverride</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>one</span>,
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up containers for orphaned pod we had not seen before&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>runningPod</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#e6db74>&#34;killPodOptions&#34;</span>, <span style=color:#a6e22e>killPodOptions</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podWorkers</span>.<span style=color:#a6e22e>UpdatePod</span>(<span style=color:#a6e22e>UpdatePodOptions</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>UpdateType</span>:     <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SyncPodKill</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>RunningPod</span>:     <span style=color:#a6e22e>runningPod</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>KillPodOptions</span>: <span style=color:#a6e22e>killPodOptions</span>,
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// the running pod is now known as well
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>workingPods</span>[<span style=color:#a6e22e>runningPod</span>.<span style=color:#a6e22e>ID</span>] = <span style=color:#a6e22e>PodWorkerSync</span>{<span style=color:#a6e22e>State</span>: <span style=color:#a6e22e>TerminatingPod</span>, <span style=color:#a6e22e>Orphan</span>: <span style=color:#66d9ef>true</span>}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>orphanCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>OrphanedRuntimePodTotal</span>.<span style=color:#a6e22e>Add</span>(float64(<span style=color:#a6e22e>orphanCount</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Now that we have recorded any terminating pods, and added new pods that should be running,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// record a summary here. Not all possible combinations of PodWorkerSync values are valid.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>counts</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>PodWorkerSync</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sync</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>workingPods</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>counts</span>[<span style=color:#a6e22e>sync</span>]<span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>validSync</span>, <span style=color:#a6e22e>configState</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>PodWorkerSync</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		{<span style=color:#a6e22e>HasConfig</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Static</span>: <span style=color:#66d9ef>true</span>}:                <span style=color:#e6db74>&#34;desired&#34;</span>,
</span></span><span style=display:flex><span>		{<span style=color:#a6e22e>HasConfig</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Static</span>: <span style=color:#66d9ef>false</span>}:               <span style=color:#e6db74>&#34;desired&#34;</span>,
</span></span><span style=display:flex><span>		{<span style=color:#a6e22e>Orphan</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>HasConfig</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Static</span>: <span style=color:#66d9ef>true</span>}:  <span style=color:#e6db74>&#34;orphan&#34;</span>,
</span></span><span style=display:flex><span>		{<span style=color:#a6e22e>Orphan</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>HasConfig</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Static</span>: <span style=color:#66d9ef>false</span>}: <span style=color:#e6db74>&#34;orphan&#34;</span>,
</span></span><span style=display:flex><span>		{<span style=color:#a6e22e>Orphan</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>HasConfig</span>: <span style=color:#66d9ef>false</span>}:               <span style=color:#e6db74>&#34;runtime_only&#34;</span>,
</span></span><span style=display:flex><span>	} {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> []<span style=color:#a6e22e>PodWorkerState</span>{<span style=color:#a6e22e>SyncPod</span>, <span style=color:#a6e22e>TerminatingPod</span>, <span style=color:#a6e22e>TerminatedPod</span>} {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>validSync</span>.<span style=color:#a6e22e>State</span> = <span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>counts</span>[<span style=color:#a6e22e>validSync</span>]
</span></span><span style=display:flex><span>			delete(<span style=color:#a6e22e>counts</span>, <span style=color:#a6e22e>validSync</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>staticString</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stringIfTrue</span>(<span style=color:#a6e22e>validSync</span>.<span style=color:#a6e22e>Static</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>validSync</span>.<span style=color:#a6e22e>HasConfig</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>staticString</span> = <span style=color:#e6db74>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>WorkingPodCount</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>configState</span>, <span style=color:#a6e22e>staticString</span>).<span style=color:#a6e22e>Set</span>(float64(<span style=color:#a6e22e>count</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>counts</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// in case a combination is lost
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Programmer error, did not report a kubelet_working_pods metric for a value returned by SyncKnownPods&#34;</span>, <span style=color:#e6db74>&#34;counts&#34;</span>, <span style=color:#a6e22e>counts</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Remove any cgroups in the hierarchy for pods that are definitely no longer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// running (not in the container runtime).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cgroupsPerQOS</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pcm</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>containerManager</span>.<span style=color:#a6e22e>NewPodContainerManager</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>3</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Clean up orphaned pod cgroups&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cleanupOrphanedPodCgroups</span>(<span style=color:#a6e22e>pcm</span>, <span style=color:#a6e22e>cgroupPods</span>, <span style=color:#a6e22e>possiblyRunningPods</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Cleanup any backoff entries.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>backOff</span>.<span style=color:#a6e22e>GC</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到这些函数基本都是把pod交给 podWorkers 去处理</p><h2 id=podconfig>podconfig
<a class=header-anchor href=#podconfig></a></h2><p>上文中的 updates channel 是从 podconfig 中获取的 那就来看看 podconfig 是怎么工作的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SourcesReady</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// AddSource adds the specified source to the set of sources managed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>AddSource</span>(<span style=color:#a6e22e>source</span> <span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// AllReady returns true if the currently configured sources have all been seen.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>AllReady</span>() <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// sourcesImpl implements SourcesReady.  It is thread-safe.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>sourcesImpl</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// lock protects access to sources seen.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// set of sources seen.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sourcesSeen</span> <span style=color:#a6e22e>sets</span>.<span style=color:#a6e22e>String</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// sourcesReady is a function that evaluates if the sources are ready.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sourcesReadyFn</span> <span style=color:#a6e22e>SourcesReadyFn</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里定义了接口 接口提中可以存储多个 source 那么有什么 source 呢</p><h3 id=kube-apiserver>kube-apiserver
<a class=header-anchor href=#kube-apiserver></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewSourceApiserver</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>clientset</span>.<span style=color:#a6e22e>Interface</span>, <span style=color:#a6e22e>nodeName</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NodeName</span>, <span style=color:#a6e22e>nodeHasSynced</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>updates</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>NewListWatchFromClient</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>CoreV1</span>().<span style=color:#a6e22e>RESTClient</span>(), <span style=color:#e6db74>&#34;pods&#34;</span>, <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>NamespaceAll</span>, <span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>OneTermEqualSelector</span>(<span style=color:#e6db74>&#34;spec.nodeName&#34;</span>, string(<span style=color:#a6e22e>nodeName</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The Reflector responsible for watching pods at the apiserver should be run only after
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// the node sync with the apiserver has completed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Waiting for node sync before watching apiserver pods&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nodeHasSynced</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;node sync completed&#34;</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>WaitForAPIServerSyncPeriod</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;node sync has not completed yet&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Watching apiserver&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>newSourceApiserverFromLW</span>(<span style=color:#a6e22e>lw</span>, <span style=color:#a6e22e>updates</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// newSourceApiserverFromLW holds creates a config source that watches and pulls from the apiserver.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newSourceApiserverFromLW</span>(<span style=color:#a6e22e>lw</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>ListerWatcher</span>, <span style=color:#a6e22e>updates</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>send</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>objs</span> []<span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>objs</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pods</span> = append(<span style=color:#a6e22e>pods</span>, <span style=color:#a6e22e>o</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>{<span style=color:#a6e22e>Pods</span>: <span style=color:#a6e22e>pods</span>, <span style=color:#a6e22e>Op</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SET</span>, <span style=color:#a6e22e>Source</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>ApiserverSource</span>}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>NewReflector</span>(<span style=color:#a6e22e>lw</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{}, <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>NewUndeltaStore</span>(<span style=color:#a6e22e>send</span>, <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>MetaNamespaceKeyFunc</span>), <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到代码简单 就是 watrch apiserver 的 pod 然后把 pods 传给 updates channel</p><h3 id=file>file
<a class=header-anchor href=#file></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sourceFile</span>) <span style=color:#a6e22e>doWatch</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stat</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IsNotExist</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Emit an update with an empty PodList to allow FileSource to be marked as seen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>{<span style=color:#a6e22e>Pods</span>: []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{}, <span style=color:#a6e22e>Op</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SET</span>, <span style=color:#a6e22e>Source</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>FileSource</span>}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>retryableError</span>{<span style=color:#e6db74>&#34;path does not exist, ignoring&#34;</span>}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>NewWatcher</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unable to create inotify: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unable to create inotify for path %q: %v&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>event</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Events</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>produceWatchEvent</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>event</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error while processing inotify event (%+v): %v&#34;</span>, <span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> = <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Errors</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error while watching %q: %v&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sourceFile</span>) <span style=color:#a6e22e>produceWatchEvent</span>(<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Event</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Ignore file start with dots
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Base</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Name</span>), <span style=color:#e6db74>&#34;.&#34;</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Ignored pod manifest, because it starts with dots&#34;</span>, <span style=color:#e6db74>&#34;eventName&#34;</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>eventType</span> <span style=color:#a6e22e>podEventType</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Op</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Create</span>) &gt; <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eventType</span> = <span style=color:#a6e22e>podAdd</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Op</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Write</span>) &gt; <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eventType</span> = <span style=color:#a6e22e>podModify</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Op</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Chmod</span>) &gt; <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eventType</span> = <span style=color:#a6e22e>podModify</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Op</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Remove</span>) &gt; <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eventType</span> = <span style=color:#a6e22e>podDelete</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Op</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Rename</span>) &gt; <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eventType</span> = <span style=color:#a6e22e>podDelete</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Ignore rest events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>watchEvents</span> <span style=color:#f92672>&lt;-</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>watchEvent</span>{<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>eventType</span>}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sourceFile</span>) <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>listTicker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>period</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Read path immediately to speed up startup.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>listConfig</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Unable to read config path&#34;</span>, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>listTicker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>listConfig</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Unable to read config path&#34;</span>, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>watchEvents</span>:
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>consumeWatchEvent</span>(<span style=color:#a6e22e>e</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Unable to process watch event&#34;</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>startWatch</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上面是 file source 的代码 也是 watch 文件变化 然后把变化的 pod 传给 updates channel
这个主要的作用就是 kubeadm 等部署 k8s 集群 使用文件拉起 kube-apiserver etcd kube-controller-manager kube-scheduler 等组件</p><h3 id=http>http
<a class=header-anchor href=#http></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sourceURL</span>) <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>extractFromURL</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Don&#39;t log this multiple times per minute. The first few entries should be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// enough to get the point across.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>failureLogs</span> &lt; <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Failed to read pods from URL&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>failureLogs</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Failed to read pods from URL. Dropping verbosity of this message to V(4)&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Failed to read pods from URL&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>failureLogs</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>failureLogs</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Successfully read pods from URL&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>failureLogs</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sourceURL</span>) <span style=color:#a6e22e>applyDefaults</span>(<span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Pod</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>applyDefaults</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>url</span>, <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>nodeName</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sourceURL</span>) <span style=color:#a6e22e>extractFromURL</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>url</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>header</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>utilio</span>.<span style=color:#a6e22e>ReadAtMost</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#a6e22e>maxConfigLength</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;%v: %v&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Status</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>data</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Emit an update with an empty PodList to allow HTTPSource to be marked as seen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>{<span style=color:#a6e22e>Pods</span>: []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{}, <span style=color:#a6e22e>Op</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SET</span>, <span style=color:#a6e22e>Source</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>HTTPSource</span>}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;zero-length data received from %v&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Short circuit if the data has not changed since the last time it was read.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>data</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>data</span> = <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// First try as it is a single pod.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>parsed</span>, <span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>singlePodErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tryDecodeSinglePod</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>applyDefaults</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parsed</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>singlePodErr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// It parsed but could not be used.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>singlePodErr</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>{<span style=color:#a6e22e>Pods</span>: []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{<span style=color:#a6e22e>pod</span>}, <span style=color:#a6e22e>Op</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SET</span>, <span style=color:#a6e22e>Source</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>HTTPSource</span>}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// That didn&#39;t work, so try a list of pods.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>parsed</span>, <span style=color:#a6e22e>podList</span>, <span style=color:#a6e22e>multiPodErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tryDecodePodList</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>applyDefaults</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parsed</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>multiPodErr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// It parsed but could not be used.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>multiPodErr</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pods</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>podList</span>.<span style=color:#a6e22e>Items</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>podList</span>.<span style=color:#a6e22e>Items</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pods</span> = append(<span style=color:#a6e22e>pods</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>podList</span>.<span style=color:#a6e22e>Items</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>{<span style=color:#a6e22e>Pods</span>: <span style=color:#a6e22e>pods</span>, <span style=color:#a6e22e>Op</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>SET</span>, <span style=color:#a6e22e>Source</span>: <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>HTTPSource</span>}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;%v: received &#39;%v&#39;, but couldn&#39;t parse as &#34;</span><span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;single (%v) or multiple pods (%v)&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>url</span>, string(<span style=color:#a6e22e>data</span>), <span style=color:#a6e22e>singlePodErr</span>, <span style=color:#a6e22e>multiPodErr</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>http source 是 kubelet 本身开启 http 服务 通过调用 kubelet 的 http 接口来管理 pod 这个主要的作用是 给那些不想部署集群 只想使用 kubelet 的需求提供的</p><h2 id=pleg>PLEG
<a class=header-anchor href=#pleg></a></h2><p>PLEG（Pod Lifecycle Event Generator）是 Kubernetes 中的一个关键组件，它负责监视和处理 Pod 的生命周期事件。PLEG 运行在每个节点上，并与 kubelet 组件紧密配合工作。</p><p>PLEG 的主要功能包括：</p><ol><li>监控容器状态：PLEG 监控每个节点上正在运行的容器的状态，并根据其状态变化生成相应的事件。</li><li>生成事件：当容器的状态发生变化时，PLEG 会生成相应的事件，例如容器的创建、启动、停止、退出等事件。</li><li>同步状态：PLEG 通过与 kubelet 进行交互，将容器的状态信息同步给 kubelet，使 kubelet 能够了解容器的当前状态。</li><li>故障处理：PLEG 检测容器的状态变化，并在发现容器失败或异常时生成相应的事件，以便 kubelet 采取适当的故障处理措施。</li></ol><p>PLEG 的设计目标是提供高效可靠的容器生命周期事件处理。它使用操作系统的文件系统事件和容器运行时的状态查询机制来监视容器的状态变化，从而及时地生成相应的事件。这些事件对于监控、日志记录、故障排除和自动恢复等方面非常重要。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PodLifecycleEventGenerator</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Watch</span>() <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Healthy</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UpdateCache</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>) (<span style=color:#66d9ef>error</span>, <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>kubelet 中实现了两种 PLEG，分别是：</p><ul><li>通用 PLEG：用于处理普通容器的生命周期事件。使用轮询机制监控容器的状态变化，因此可能会有一定的延迟。而且耗费资源较多，不适合大规模部署。</li><li>Event PLEG：用于处理事件容器的生命周期事件。使用事件机制监控容器的状态变化，因此响应速度较快。但是，他需要 container runtime 支持事件机制。</li></ul><h3 id=genericpleg>GenericPLEG
<a class=header-anchor href=#genericpleg></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>Watch</span>() <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>eventChannel</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>runningMu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>runningMu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>isRunning</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>isRunning</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>stopCh</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Relist</span>, <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>relistDuration</span>.<span style=color:#a6e22e>RelistPeriod</span>, <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>stopCh</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>Relist</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>relistLock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>relistLock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;GenericPLEG: Relisting&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastRelistTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>getRelistTime</span>(); !<span style=color:#a6e22e>lastRelistTime</span>.<span style=color:#a6e22e>IsZero</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>PLEGRelistInterval</span>.<span style=color:#a6e22e>Observe</span>(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>SinceInSeconds</span>(<span style=color:#a6e22e>lastRelistTime</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>PLEGRelistDuration</span>.<span style=color:#a6e22e>Observe</span>(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>SinceInSeconds</span>(<span style=color:#a6e22e>timestamp</span>))
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Get all the pods.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>podList</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>GetPods</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;GenericPLEG: Unable to retrieve pods&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>updateRelistTime</span>(<span style=color:#a6e22e>timestamp</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pods</span>(<span style=color:#a6e22e>podList</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// update running pod and container count
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>updateRunningPodAndContainerMetrics</span>(<span style=color:#a6e22e>pods</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>setCurrent</span>(<span style=color:#a6e22e>pods</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Compare the old and the current pods, and generate events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>eventsByPodID</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>oldPod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getOld</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getCurrent</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Get all containers in the old and the new pod.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>allContainers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getContainersFromPods</span>(<span style=color:#a6e22e>oldPod</span>, <span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allContainers</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>events</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>computeEvents</span>(<span style=color:#a6e22e>oldPod</span>, <span style=color:#a6e22e>pod</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>updateEvents</span>(<span style=color:#a6e22e>eventsByPodID</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>needsReinspection</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>needsReinspection</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If there are events associated with a pod, we should update the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// podCache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>events</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>eventsByPodID</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getCurrent</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// updateCache() will inspect the pod and update the cache. If an
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// error occurs during the inspection, we want PLEG to retry again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// in the next relist. To achieve this, we do not update the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// associated podRecord of the pod, so that the change will be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// detect again in the next relist.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// TODO: If many pods changed during the same relist period,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// inspecting the pod and getting the PodStatus to update the cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// serially may take a while. We should be aware of this and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// parallelize if needed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>updated</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>updateCache</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>pid</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Rely on updateCache calling GetPodStatus to log the actual error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;PLEG: Ignoring events for pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KRef</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// make sure we try to reinspect the pod during the next relisting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>needsReinspection</span>[<span style=color:#a6e22e>pid</span>] = <span style=color:#a6e22e>pod</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// this pod was in the list to reinspect and we did so because it had events, so remove it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// from the list (we don&#39;t want the reinspection code below to inspect it a second time in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// this relist execution)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				delete(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span>, <span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>utilfeature</span>.<span style=color:#a6e22e>DefaultFeatureGate</span>.<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>features</span>.<span style=color:#a6e22e>EventedPLEG</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>updated</span> {
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Update the internal storage and send out the events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Map from containerId to exit code; used as a temporary cache for lookup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>containerExitCode</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Filter out events that are not reliable and no other components use yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>ContainerChanged</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>eventChannel</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>]:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>PLEGDiscardEvents</span>.<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Event channel is full, discard this relist() cycle event&#34;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Log exit code of containers when they finished in a particular event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>ContainerDied</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Fill up containerExitCode map for ContainerDied event when first time appeared
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>containerExitCode</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cache</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// Get updated podStatus
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>containerStatus</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ContainerStatuses</span> {
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>containerExitCode</span>[<span style=color:#a6e22e>containerStatus</span>.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>ID</span>] = <span style=color:#a6e22e>containerStatus</span>.<span style=color:#a6e22e>ExitCode</span>
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>containerID</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Data</span>.(<span style=color:#66d9ef>string</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>exitCode</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>containerExitCode</span>[<span style=color:#a6e22e>containerID</span>]; <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Generic (PLEG): container finished&#34;</span>, <span style=color:#e6db74>&#34;podID&#34;</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#e6db74>&#34;containerID&#34;</span>, <span style=color:#a6e22e>containerID</span>, <span style=color:#e6db74>&#34;exitCode&#34;</span>, <span style=color:#a6e22e>exitCode</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// reinspect any pods that failed inspection during the previous relist
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;GenericPLEG: Reinspecting pods that previously failed inspection&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>updateCache</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>pid</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// Rely on updateCache calling GetPodStatus to log the actual error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;PLEG: pod failed reinspection&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KRef</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>needsReinspection</span>[<span style=color:#a6e22e>pid</span>] = <span style=color:#a6e22e>pod</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Update the cache timestamp.  This needs to happen *after*
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// all pods have been properly updated in the cache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>UpdateTime</span>(<span style=color:#a6e22e>timestamp</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// make sure we retain the list of pods that need reinspecting the next time relist is called
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span> = <span style=color:#a6e22e>needsReinspection</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到 GenericPLEG 会定时从 runtime 获取 pods 然后和缓存中的旧的 pod 进行对比 然后生成事件发送给 eventChannel</p><h3 id=eventpleg>EventPLEG
<a class=header-anchor href=#eventpleg></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EventedPLEG</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>runningMu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>runningMu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isEventedPLEGInUse</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>setEventedPLEGUsage</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>stopCh</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>stopCacheUpdateCh</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>watchEventsChannel</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>stopCh</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>updateGlobalCache</span>, <span style=color:#a6e22e>globalCacheUpdatePeriod</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>stopCacheUpdateCh</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EventedPLEG</span>) <span style=color:#a6e22e>watchEventsChannel</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>containerEventsResponseCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runtimeapi</span>.<span style=color:#a6e22e>ContainerEventResponse</span>, cap(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>eventChannel</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> close(<span style=color:#a6e22e>containerEventsResponseCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Get the container events from the runtime.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>numAttempts</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>numAttempts</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>eventedPlegMaxStreamRetries</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isEventedPLEGInUse</span>() {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// Fall back to Generic PLEG relisting since Evented PLEG is not working.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Fall back to Generic PLEG relisting since Evented PLEG is not working&#34;</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>genericPleg</span>.<span style=color:#a6e22e>Stop</span>()       <span style=color:#75715e>// Stop the existing Generic PLEG which runs with longer relisting period when Evented PLEG is in use.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Update</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>relistDuration</span>) <span style=color:#75715e>// Update the relisting period to the default value for the Generic PLEG.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>genericPleg</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>runtimeService</span>.<span style=color:#a6e22e>GetContainerEvents</span>(<span style=color:#a6e22e>containerEventsResponseCh</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>EventedPLEGConnErr</span>.<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>numAttempts</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Relist</span>() <span style=color:#75715e>// Force a relist to get the latest container and pods running metric.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Evented PLEG: Failed to get container events, retrying: &#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isEventedPLEGInUse</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>processCRIEvents</span>(<span style=color:#a6e22e>containerEventsResponseCh</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 转换 runtimeapi.ContainerEventResponse 为 PodLifecycleEvent
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EventedPLEG</span>) <span style=color:#a6e22e>processCRIEvents</span>(<span style=color:#a6e22e>containerEventsResponseCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runtimeapi</span>.<span style=color:#a6e22e>ContainerEventResponse</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>event</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>containerEventsResponseCh</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Ignore the event if PodSandboxStatus is nil.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// This might happen under some race condition where the podSandbox has
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// been deleted, and therefore container runtime couldn&#39;t find the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// podSandbox for the container when generating the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// It is safe to ignore because
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// a) a event would have been received for the sandbox deletion,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// b) in worst case, a relist will eventually sync the pod status.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// TODO(#114371): Figure out a way to handle this case instead of ignoring.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>PodSandboxStatus</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>PodSandboxStatus</span>.<span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Evented PLEG: received ContainerEventResponse with nil PodSandboxStatus or PodSandboxStatus.Metadata&#34;</span>, <span style=color:#e6db74>&#34;containerEventResponse&#34;</span>, <span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>podID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>PodSandboxStatus</span>.<span style=color:#a6e22e>Metadata</span>.<span style=color:#a6e22e>Uid</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>shouldSendPLEGEvent</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>GeneratePodStatus</span>(<span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// nolint:logcheck // Not using the result of klog.V inside the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// if branch is okay, we just use it to determine whether the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// additional &#34;podStatus&#34; key and its value should be added.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>6</span>).<span style=color:#a6e22e>Enabled</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Evented PLEG: error generating pod status from the received event&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>podID</span>, <span style=color:#e6db74>&#34;podStatus&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Evented PLEG: error generating pod status from the received event&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>podID</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>klogV</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>6</span>); <span style=color:#a6e22e>klogV</span>.<span style=color:#a6e22e>Enabled</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klogV</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Evented PLEG: Generated pod status from the received event&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>podID</span>, <span style=color:#e6db74>&#34;podStatus&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Evented PLEG: Generated pod status from the received event&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>podID</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Preserve the pod IP across cache updates if the new IP is empty.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// When a pod is torn down, kubelet may race with PLEG and retrieve
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// a pod status after network teardown, but the kubernetes API expects
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// the completed pod&#39;s IP to be available after the pod is dead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>IPs</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>getPodIPs</span>(<span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>updateRunningPodMetric</span>(<span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>updateRunningContainerMetric</span>(<span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>updateLatencyMetric</span>(<span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>ContainerEventType</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>runtimeapi</span>.<span style=color:#a6e22e>ContainerEventType_CONTAINER_DELETED_EVENT</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sandbox</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>SandboxStatuses</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sandbox</span>.<span style=color:#a6e22e>Id</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>ContainerId</span> {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// When the CONTAINER_DELETED_EVENT is received by the kubelet,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// the runtime has indicated that the container has been removed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// by the runtime and hence, it must be removed from the cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// of kubelet too.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>podID</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>shouldSendPLEGEvent</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Unix</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>GetCreatedAt</span>(), <span style=color:#ae81ff>0</span>)) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>shouldSendPLEGEvent</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>shouldSendPLEGEvent</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>processCRIEvent</span>(<span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>从代码中可以看到 EventPLEG 可以从 runtime 获取容器事件。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/kubelet>kubelet
</a><a href=/tags/kubernetes>kubernetes
</a><a href=/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>源码分析
</a><a href=/tags/golang>golang</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
kubelet 原理分析</li><li class=post-copyright-author><strong>本文作者： </strong>daemon365</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/ title="kubelet 原理分析">https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/cloud/kubernetes_storage_process/ rel=next title="kubernetes 存储流程"><i class="fa fa-chevron-left"></i> kubernetes 存储流程</a></div><div class="post-nav-prev post-nav-item"><a href=/post/cloud/kubernetes_cni_container_network_inferface/ rel=prev title="kubernetes CNI(Container Network Inferface)">kubernetes CNI(Container Network Inferface)
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>daemon365</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.139.3 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://daemon365.dev/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://daemon365.dev/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"JmAHxEAUVgyS8B1c","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":false,"enable":false,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"daemon365/blog","theme":"preferred-color-scheme"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://daemon365.dev/3rd"}},"version":"4.6.3"}</script><script type=text/javascript src=/js/main.min.412b2d7d9cead6dbf9b4df1d9dcc9b5b7818e8e434f664050b4498e888bb3009.js defer></script></body></html>