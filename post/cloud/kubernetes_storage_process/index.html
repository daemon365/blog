<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.138.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.ico><meta itemprop=name content="kubernetes 存储流程"><meta itemprop=description content="Don't let yourself stop."><meta name=description content="Don't let yourself stop."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://daemon365.dev/imgs/daemon365.png"><meta itemprop=keywords content="csi,kubernetes"><meta property="og:type" content="article"><meta property="og:title" content="kubernetes 存储流程"><meta property="og:description" content="Don't let yourself stop."><meta property="og:image" content="/imgs/daemon365.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://daemon365.dev/post/cloud/kubernetes_storage_process/"><meta property="og:site_name" content="Daemon"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="daemon365"><meta property="article:published_time" content="2024-05-03 00:00:00 +0800 +0800"><meta property="article:modified_time" content="2024-05-03 00:00:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.3617ff82394b233ac557ab6bc7e098de56307034954005671d085539d7bd0873.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"kubernetes_storage_process","permalink":"https://daemon365.dev/post/cloud/kubernetes_storage_process/","title":"kubernetes 存储流程","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JmAHxEAUVgyS8B1c",ck:"JmAHxEAUVgyS8B1c",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>kubernetes 存储流程 - Daemon</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Daemon</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Don't let yourself stop.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives
<span class=badge>93</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>Commonweal</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#pv-与-pvc>PV 与 PVC</a><ul><li><a href=#静态创建存储卷>静态创建存储卷</a></li><li><a href=#pvc-pv-绑定流程>pvc pv 绑定流程</a></li><li><a href=#kubelet-绑定>kubelet 绑定</a></li></ul></li><li><a href=#storageclass>StorageClass</a><ul><li><a href=#动态创建存储卷>动态创建存储卷</a></li><li><a href=#storageclass-创建-pv-流程>StorageClass 创建 pv 流程</a></li></ul></li><li><a href=#kubernetes-external-provisioner>kubernetes external provisioner</a></li><li><a href=#csi-流程>CSI 流程</a><ul><li><a href=#provisioner>Provisioner</a></li><li><a href=#attacher>Attacher</a></li><li><a href=#snapshotter>Snapshotter</a></li><li><a href=#csi-node>csi-node</a></li><li><a href=#csi-node-driver-registrar>csi-node-driver-registrar</a></li><li><a href=#csi-livenessprobe>csi-livenessprobe</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=daemon365 src=/imgs/img-lazy-loading.gif data-src=/imgs/daemon365.png><p class=site-author-name itemprop=name>daemon365</p><div class=site-description itemprop=description>Don't let yourself stop.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>93</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/daemon365 title="Github → https://github.com/daemon365" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev title=https://go-kratos.dev target=_blank>kratos</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://daemon365.dev/post/cloud/kubernetes_storage_process/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/daemon365.png"><meta itemprop=name content="daemon365"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="daemon365"><meta itemprop=description content="Don't let yourself stop."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="kubernetes 存储流程"><meta itemprop=description content="PV 与 PVC

PVC (PersistentVolumeClaim)，命名空间（namespace）级别的资源，由 用户 or StatefulSet 控制器（根据VolumeClaimTemplate） 创建。PVC 类似于 Pod，Pod 消耗 Node 资源，PVC 消耗 PV 资源。Pod 可以请求特定级别的资源（CPU 和内存），而 PVC 可以请求特定存储卷的大小及访问模式（Access Mode
PV（PersistentVolume）是集群中的一块存储资源，可以是 NFS、iSCSI、Ceph、GlusterFS 等存储卷，PV 由集群管理员创建，然后由开发者使用 PVC 来申请 PV，PVC 是对 PV 的申请，类似于 Pod 对 Node 的申请。"></span><header class=post-header><h1 class=post-title itemprop="name headline">kubernetes 存储流程</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-05-03 00:00:00 +0800 +0800" itemprop="dateCreated datePublished" datetime="2024-05-03 00:00:00 +0800 +0800">2024-05-03
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cloud itemprop=url rel=index><span itemprop=name>cloud</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>2884</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>6分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/cloud/kubernetes_storage_process/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><h2 id=pv-与-pvc>PV 与 PVC
<a class=header-anchor href=#pv-%e4%b8%8e-pvc></a></h2><p>PVC (PersistentVolumeClaim)，命名空间（namespace）级别的资源，由 用户 or StatefulSet 控制器（根据VolumeClaimTemplate） 创建。PVC 类似于 Pod，Pod 消耗 Node 资源，PVC 消耗 PV 资源。Pod 可以请求特定级别的资源（CPU 和内存），而 PVC 可以请求特定存储卷的大小及访问模式（Access Mode
PV（PersistentVolume）是集群中的一块存储资源，可以是 NFS、iSCSI、Ceph、GlusterFS 等存储卷，PV 由集群管理员创建，然后由开发者使用 PVC 来申请 PV，PVC 是对 PV 的申请，类似于 Pod 对 Node 的申请。</p><h3 id=静态创建存储卷>静态创建存储卷
<a class=header-anchor href=#%e9%9d%99%e6%80%81%e5%88%9b%e5%bb%ba%e5%ad%98%e5%82%a8%e5%8d%b7></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/images/e1e2ee82-b5ea-4edb-a587-b1d5860f81d9.png alt></p><p>也就是我们手动创建一个pv和pvc，然后将pv和pvc绑定，然后pod使用pvc，这样就可以使用pv了。</p><p>创建一个 nfs 的 pv 以及 对应的 pvc</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-pv</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>capacity</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>persistentVolumeReclaimPolicy</span>: <span style=color:#ae81ff>Delete</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nfs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.203.110</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/data/nfs</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-pvc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
</span></span></code></pre></div><p>查看 pvc</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-BASH data-lang=BASH><span style=display:flex><span>$ kubectl get pvc
</span></span><span style=display:flex><span>NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span></span><span style=display:flex><span>nfs-pvc   Bound    nfs-pv   10Gi       RWO                           101s
</span></span></code></pre></div><p>创建一个 pod 使用 pvc</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test-nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ubuntu:22.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/bin/sh</span>
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>c</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sleep 10000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-volume</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-volume</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>nfs-pvc</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>❯ kubectl exec -it test-nfs -- cat /data/nfs
</span></span><span style=display:flex><span>192.168.203.110:/data/nfs
</span></span></code></pre></div><h3 id=pvc-pv-绑定流程>pvc pv 绑定流程
<a class=header-anchor href=#pvc-pv-%e7%bb%91%e5%ae%9a%e6%b5%81%e7%a8%8b></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ctrl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PersistentVolumeController</span>) <span style=color:#a6e22e>syncUnboundClaim</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>claim</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolumeClaim</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>VolumeName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 是不是延迟绑定 也就是 VolumeBindingMode 为 WaitForFirstConsumer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>delayBinding</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>storagehelpers</span>.<span style=color:#a6e22e>IsDelayBindingMode</span>(<span style=color:#a6e22e>claim</span>, <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>classLister</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过 pvc 找到最合适的 pv
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>volume</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>volumes</span>.<span style=color:#a6e22e>findBestMatchForClaim</span>(<span style=color:#a6e22e>claim</span>, <span style=color:#a6e22e>delayBinding</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Synchronizing unbound PersistentVolumeClaim, Error finding PV for claim&#34;</span>, <span style=color:#e6db74>&#34;PVC&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>claim</span>), <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error finding PV for claim %q: %w&#34;</span>, <span style=color:#a6e22e>claimToClaimKey</span>(<span style=color:#a6e22e>claim</span>), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>volume</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>//// No PV found for this claim
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		} <span style=color:#66d9ef>else</span> <span style=color:#75715e>/* pv != nil */</span> {
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>claimKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>claimToClaimKey</span>(<span style=color:#a6e22e>claim</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Synchronizing unbound PersistentVolumeClaim, volume found&#34;</span>, <span style=color:#e6db74>&#34;PVC&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>claim</span>), <span style=color:#e6db74>&#34;volumeName&#34;</span>, <span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;volumeStatus&#34;</span>, <span style=color:#a6e22e>getVolumeStatusForLogging</span>(<span style=color:#a6e22e>volume</span>))
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 绑定 pv 和 pvc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 这里会处理 pvc 的 spec.volumeName status 和 pv 的 status
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>volume</span>, <span style=color:#a6e22e>claim</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#75715e>/* pvc.Spec.VolumeName != nil */</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>      ......
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 选择
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FindMatchingVolume</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>claim</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolumeClaim</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>volumes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolume</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Node</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>excludedVolumes</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolume</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>delayBinding</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolume</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>smallestVolume</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolume</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>smallestVolumeQty</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>Quantity</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>requestedQty</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Requests</span>[<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceName</span>(<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceStorage</span>)]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>requestedClass</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetPersistentVolumeClaimClass</span>(<span style=color:#a6e22e>claim</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>selector</span> <span style=color:#a6e22e>labels</span>.<span style=color:#a6e22e>Selector</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Selector</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>internalSelector</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>LabelSelectorAsSelector</span>(<span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Selector</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error creating internal label selector for claim: %v: %v&#34;</span>, <span style=color:#a6e22e>claimToClaimKey</span>(<span style=color:#a6e22e>claim</span>), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>selector</span> = <span style=color:#a6e22e>internalSelector</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Go through all available volumes with two goals:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// - find a volume that is either pre-bound by user or dynamically
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   provisioned for this claim. Because of this we need to loop through
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   all volumes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// - find the smallest matching one if there is no volume pre-bound to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   the claim.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>volume</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>volumes</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>excludedVolumes</span>[<span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>Name</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Skip volumes in the excluded list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>ClaimRef</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>IsVolumeBoundToClaim</span>(<span style=color:#a6e22e>volume</span>, <span style=color:#a6e22e>claim</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>volumeQty</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Capacity</span>[<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceStorage</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>volumeQty</span>.<span style=color:#a6e22e>Cmp</span>(<span style=color:#a6e22e>requestedQty</span>) &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// filter out mismatching volumeModes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>CheckVolumeModeMismatches</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>Spec</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>Spec</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// check if PV&#39;s DeletionTimeStamp is set, if so, skip this volume.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>ObjectMeta</span>.<span style=color:#a6e22e>DeletionTimestamp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>nodeAffinityValid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>node</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Scheduler path, check that the PV NodeAffinity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// is satisfied by the node
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// CheckNodeAffinity is the most expensive call in this loop.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// We should check cheaper conditions first or consider optimizing this function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CheckNodeAffinity</span>(<span style=color:#a6e22e>volume</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Labels</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>nodeAffinityValid</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>IsVolumeBoundToClaim</span>(<span style=color:#a6e22e>volume</span>, <span style=color:#a6e22e>claim</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// If PV node affinity is invalid, return no match.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// This means the prebound PV (and therefore PVC)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// is not suitable for this node.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>nodeAffinityValid</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>volume</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>node</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>delayBinding</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// PV controller does not bind this claim.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// Scheduler will handle binding unbound volumes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// Scheduler path will have node != nil
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// filter out:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// - volumes in non-available phase
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// - volumes whose labels don&#39;t match the claim&#39;s selector, if specified
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// - volumes in Class that is not requested
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// - volumes whose NodeAffinity does not match the node
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>Phase</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>VolumeAvailable</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// We ignore volumes in non-available phase, because volumes that
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// satisfies matching criteria will be updated to available, binding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// them now has high chance of encountering unnecessary failures
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// due to API conflicts.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>selector</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Matches</span>(<span style=color:#a6e22e>labels</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>Labels</span>)) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>GetPersistentVolumeClass</span>(<span style=color:#a6e22e>volume</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>requestedClass</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>nodeAffinityValid</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>node</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Scheduler path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// Check that the access modes match
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>CheckAccessModes</span>(<span style=color:#a6e22e>claim</span>, <span style=color:#a6e22e>volume</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>smallestVolume</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>smallestVolumeQty</span>.<span style=color:#a6e22e>Cmp</span>(<span style=color:#a6e22e>volumeQty</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>smallestVolume</span> = <span style=color:#a6e22e>volume</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>smallestVolumeQty</span> = <span style=color:#a6e22e>volumeQty</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>smallestVolume</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Found a matching volume
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>smallestVolume</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=kubelet-绑定>kubelet 绑定
<a class=header-anchor href=#kubelet-%e7%bb%91%e5%ae%9a></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>MkdirAll</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#ae81ff>0750</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>source</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%s&#34;</span>, <span style=color:#a6e22e>nfsMounter</span>.<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>nfsMounter</span>.<span style=color:#a6e22e>exportPath</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>options</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nfsMounter</span>.<span style=color:#a6e22e>readOnly</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>options</span> = append(<span style=color:#a6e22e>options</span>, <span style=color:#e6db74>&#34;ro&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>mountOptions</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>JoinMountOptions</span>(<span style=color:#a6e22e>nfsMounter</span>.<span style=color:#a6e22e>mountOptions</span>, <span style=color:#a6e22e>options</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nfsMounter</span>.<span style=color:#a6e22e>mounter</span>.<span style=color:#a6e22e>MountSensitiveWithoutSystemd</span>(<span style=color:#a6e22e>source</span>, <span style=color:#a6e22e>dir</span>, <span style=color:#e6db74>&#34;nfs&#34;</span>, <span style=color:#a6e22e>mountOptions</span>, <span style=color:#66d9ef>nil</span>)
</span></span></code></pre></div><p>kubelet 就会在调用 <code>sudo mount -t nfs ...</code> 命令把 nfs 绑定到主机上 绑定的目录大概为 <code>/var/lib/kubelet/pods/[POD-ID]/volumes/</code></p><h2 id=storageclass>StorageClass
<a class=header-anchor href=#storageclass></a></h2><p>StorageClass 是 Kubernetes 中用来定义存储卷的类型的资源对象，StorageClass 用来定义存储卷的类型，比如 NFS、iSCSI、Ceph、GlusterFS 等存储卷。StorageClass 是集群级别的资源，由集群管理员创建，用户可以使用 StorageClass 来动态创建 PV。</p><h3 id=动态创建存储卷>动态创建存储卷
<a class=header-anchor href=#%e5%8a%a8%e6%80%81%e5%88%9b%e5%bb%ba%e5%ad%98%e5%82%a8%e5%8d%b7></a></h3><p>动态创建存储卷相比静态创建存储卷，少了集群管理员的干预，流程如下图所示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/7cc8ddd7-1c7d-430d-9332-d7da9d4a2752.png alt></p><p>创建一个 StorageClass pvc pod</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>storage.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StorageClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>local-storage</span>
</span></span><span style=display:flex><span><span style=color:#f92672>provisioner</span>: <span style=color:#ae81ff>rancher.io/local-path</span>
</span></span><span style=display:flex><span><span style=color:#f92672>reclaimPolicy</span>: <span style=color:#ae81ff>Delete</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumeBindingMode</span>: <span style=color:#ae81ff>WaitForFirstConsumer</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-local-pvc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>128Mi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>local-storage</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ubuntu:22.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/bin/sh</span>
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>c</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sleep 10000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-local-pvc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-local-pvc</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>my-local-pvc</span>
</span></span></code></pre></div><p>查看 pv</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>❯ kubectl get pv
</span></span><span style=display:flex><span>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                  STORAGECLASS    REASON   AGE
</span></span><span style=display:flex><span>pvc-9d257d8a-29a8-4abf-a1e2-c7e4953fc0ca   128Mi      RWO            Delete           Bound    default/my-local-pvc   local-storage            85s
</span></span></code></pre></div><h3 id=storageclass-创建-pv-流程>StorageClass 创建 pv 流程
<a class=header-anchor href=#storageclass-%e5%88%9b%e5%bb%ba-pv-%e6%b5%81%e7%a8%8b></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 还是 syncUnboundClaim 中
</span></span></span><span style=display:flex><span><span style=color:#75715e>// volume 为空，说明没有找到合适的 pv 那么去检查 如果 pvc 的 storageClassName 不为空，那么就会去找到对应的 storageClass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>volume</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>delayBinding</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>storagehelpers</span>.<span style=color:#a6e22e>IsDelayBindingProvisioning</span>(<span style=color:#a6e22e>claim</span>):
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>storagehelpers</span>.<span style=color:#a6e22e>GetPersistentVolumeClaimClass</span>(<span style=color:#a6e22e>claim</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span>:
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 如果 pvc 的 storageClassName 不为空，那么就会去找到对应的 storageClass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>provisionClaim</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>claim</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ctrl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PersistentVolumeController</span>) <span style=color:#a6e22e>provisionClaim</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>claim</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolumeClaim</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>plugin</span>, <span style=color:#a6e22e>storageClass</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>findProvisionablePlugin</span>(<span style=color:#a6e22e>claim</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>scheduleOperation</span>(<span style=color:#a6e22e>logger</span>, <span style=color:#a6e22e>opName</span>, <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>plugin</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 如果是外部的 provisioner 这里我们就安装了 rancher.io/local-path 这个插件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// 所以这里会调用 provisionClaimOperationExternal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>provisionClaimOperationExternal</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>claim</span>, <span style=color:#a6e22e>storageClass</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 内部的 provisioner 直接处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>provisionClaimOperation</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>claim</span>, <span style=color:#a6e22e>plugin</span>, <span style=color:#a6e22e>storageClass</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果是外部的 provisioner 会在 pvc 的 annotations 加入 volume.beta.kubernetes.io/storage-provisioner: rancher.io/local-path 和 volume.kubernetes.io/storage-provisioner: rancher.io/local-path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ctrl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PersistentVolumeController</span>) <span style=color:#a6e22e>setClaimProvisioner</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>claim</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolumeClaim</span>, <span style=color:#a6e22e>provisionerName</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolumeClaim</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>Annotations</span>[<span style=color:#a6e22e>storagehelpers</span>.<span style=color:#a6e22e>AnnStorageProvisioner</span>]; <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>provisionerName</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// annotation is already set, nothing to do
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>claim</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The volume from method args can be pointing to watcher cache. We must not
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// modify these, therefore create a copy.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>claimClone</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>DeepCopy</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// TODO: remove the beta storage provisioner anno after the deprecation period
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>SetMetaDataAnnotation</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>claimClone</span>.<span style=color:#a6e22e>ObjectMeta</span>, <span style=color:#a6e22e>storagehelpers</span>.<span style=color:#a6e22e>AnnBetaStorageProvisioner</span>, <span style=color:#a6e22e>provisionerName</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>SetMetaDataAnnotation</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>claimClone</span>.<span style=color:#a6e22e>ObjectMeta</span>, <span style=color:#a6e22e>storagehelpers</span>.<span style=color:#a6e22e>AnnStorageProvisioner</span>, <span style=color:#a6e22e>provisionerName</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>updateMigrationAnnotations</span>(<span style=color:#a6e22e>logger</span>, <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>csiMigratedPluginManager</span>, <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>translator</span>, <span style=color:#a6e22e>claimClone</span>.<span style=color:#a6e22e>Annotations</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newClaim</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>kubeClient</span>.<span style=color:#a6e22e>CoreV1</span>().<span style=color:#a6e22e>PersistentVolumeClaims</span>(<span style=color:#a6e22e>claim</span>.<span style=color:#a6e22e>Namespace</span>).<span style=color:#a6e22e>Update</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>claimClone</span>, <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>UpdateOptions</span>{})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newClaim</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>storeClaimUpdate</span>(<span style=color:#a6e22e>logger</span>, <span style=color:#a6e22e>newClaim</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newClaim</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newClaim</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=kubernetes-external-provisioner>kubernetes external provisioner
<a class=header-anchor href=#kubernetes-external-provisioner></a></h2><p>kubernetes external provisioner 是一个独立的进程，用来动态创建 PV，它通过监听 StorageClass 的事件，当 StorageClass 的 ReclaimPolicy 为 Retain 时，会创建 PV。</p><p>在这里我新建一个 关于 nfs 的 external provisioner</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/golang/glog&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>v1</span> <span style=color:#e6db74>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metav1</span> <span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sigs.k8s.io/sig-storage-lib-external-provisioner/v10/controller&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provisionerName</span> = <span style=color:#e6db74>&#34;provisioner.test.com/nfs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>Provisioner</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nfsProvisioner</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>nfsProvisioner</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>Interface</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nfsProvisioner</span>) <span style=color:#a6e22e>Provision</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>options</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>ProvisionOptions</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolume</span>, <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>ProvisioningState</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>PVC</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Selector</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>ProvisioningFinished</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;claim Selector is not supported&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>glog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;nfs provisioner: VolumeOptions %v&#34;</span>, <span style=color:#a6e22e>options</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolume</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ObjectMeta</span>: <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>ObjectMeta</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>PVName</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Spec</span>: <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolumeSpec</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>PersistentVolumeReclaimPolicy</span>: <span style=color:#f92672>*</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>StorageClass</span>.<span style=color:#a6e22e>ReclaimPolicy</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>AccessModes</span>:                   <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>PVC</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>AccessModes</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>MountOptions</span>:                  <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>StorageClass</span>.<span style=color:#a6e22e>MountOptions</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Capacity</span>: <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceList</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceName</span>(<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceStorage</span>): <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>PVC</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Requests</span>[<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceName</span>(<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceStorage</span>)],
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>PersistentVolumeSource</span>: <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolumeSource</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>NFS</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>NFSVolumeSource</span>{
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Server</span>:   <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>StorageClass</span>.<span style=color:#a6e22e>Parameters</span>[<span style=color:#e6db74>&#34;server&#34;</span>],
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Path</span>:     <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>StorageClass</span>.<span style=color:#a6e22e>Parameters</span>[<span style=color:#e6db74>&#34;path&#34;</span>],
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ReadOnly</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>StorageClass</span>.<span style=color:#a6e22e>Parameters</span>[<span style=color:#e6db74>&#34;readOnly&#34;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>				},
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pv</span>, <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>ProvisioningFinished</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nfsProvisioner</span>) <span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>volume</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PersistentVolume</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 因为是 nfs 没有产生实际的资源，所以这里不需要删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 如果在 provisioner 中创建了资源，那么这里需要删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 一般是调用 csi 创建/删除资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>BuildConfigFromFlags</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>homedir</span>.<span style=color:#a6e22e>HomeDir</span>(), <span style=color:#e6db74>&#34;.kube&#34;</span>, <span style=color:#e6db74>&#34;config&#34;</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>glog</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Failed to create kubeconfig: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>clientset</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>NewForConfig</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>glog</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Failed to create client: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>clientNFSProvisioner</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nfsProvisioner</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>client</span>: <span style=color:#a6e22e>clientset</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>NewProvisionController</span>(<span style=color:#a6e22e>l</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>clientset</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>provisionerName</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>clientNFSProvisioner</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>LeaderElection</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>glog</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Starting provision controller&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建一个 nfs 的 storageClass</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>storage.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StorageClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>provisioner</span>: <span style=color:#ae81ff>provisioner.test.com/nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>reclaimPolicy</span>: <span style=color:#ae81ff>Delete</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumeBindingMode</span>: <span style=color:#ae81ff>Immediate</span>
</span></span><span style=display:flex><span><span style=color:#f92672>parameters</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span>: <span style=color:#e6db74>&#34;192.168.203.110&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/data/nfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>readOnly</span>: <span style=color:#e6db74>&#34;false&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>my-nfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>1Gi</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test-nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ubuntu:22.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/bin/sh</span>
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>c</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sleep 10000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>❯ kubectl exec -it test-nfs -- cat /data/nfs
</span></span><span style=display:flex><span>192.168.203.110:/data/nfs
</span></span></code></pre></div><h2 id=csi-流程>CSI 流程
<a class=header-anchor href=#csi-%e6%b5%81%e7%a8%8b></a></h2><p>持久化存储流程图如下：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/d0dd40b9-6ce3-40bc-a048-0b3f1653d952.jpg alt></p><h3 id=provisioner>Provisioner
<a class=header-anchor href=#provisioner></a></h3><p>当部署 csi-controller 时 ，会启动一个伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/external-provisioner</code> 这个项目是一个 csi 的 provisioner
它会监控属于自己的pvc，当有新的pvc创建时，会调用 csi 的 createVolume 方法，创建一个 volume，然后创建一个 pv。当 pvc 删除时，会调用 csi 的 deleteVolume 方法，然后删除 volume 和 pv。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/8556b88f-a2a3-447a-a2ac-e0ed179e3b24.png alt></p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/06af3f24-bdbc-44be-a08a-36f1da8ab8c5.png alt></p><h3 id=attacher>Attacher
<a class=header-anchor href=#attacher></a></h3><p>external-attacher 也是 csi-controller 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/external-attacher</code> 这个项目是一个 csi 的 attacher, 它会监控 AttachDetachController 资源，当有新的资源创建时，会调用 csi 的 controllerPublishVolume 方法，挂载 volume 到 node 上。当资源删除时，会调用 csi 的 controllerUnpublishVolume 方法，卸载 volume。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/d4f2c430-8b28-43e6-b150-960db81b6bf7.png alt></p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/2486b91a-6a5a-476a-8795-a69305dd6011.png alt></p><h3 id=snapshotter>Snapshotter
<a class=header-anchor href=#snapshotter></a></h3><p>external-snapshotter 也是 csi-controller 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/external-snapshotter</code> 这个项目是一个 csi 的 snapshotter, 它会监控 VolumeSnapshot 资源，当有新的资源创建时，会调用 csi 的 createSnapshot 方法，创建一个快照。当资源删除时，会调用 csi 的 deleteSnapshot 方法，删除快照。</p><h3 id=csi-node>csi-node
<a class=header-anchor href=#csi-node></a></h3><p>csi-node 是一个 kubelet 的插件，所以它需要每个节点上都运行，当 pod 创建时，并且 VolumeAttachment 的 .spec.Attached 时，kubelet 会调用 csi 的 NodeStageVolume 函数，之后插件（csiAttacher）调用内部 in-tree CSI 插件（csiMountMgr）的 SetUp 函数，该函数内部会调用 csi 的 NodePublishVolume 函数，挂载 volume 到 pod 上。当 pod 删除时，kubelet 观察到包含 CSI 存储卷的 Pod 被删除，于是调用内部 in-tree CSI 插件（csiMountMgr）的 TearDown 函数，该函数内部会通过 unix domain socket 调用外部 CSI 插件的 NodeUnpublishVolume 函数。kubelet 调用内部 in-tree CSI 插件（csiAttacher）的 UnmountDevice 函数，该函数内部会通过 unix domain socket 调用外部 CSI 插件的 NodeUnstageVolume 函数。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/d6bd8e82-8227-4e1e-9764-c66a34572398.png alt></p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/b8a8b74d-4c97-4dcd-a097-20b59561b107.png alt></p><h3 id=csi-node-driver-registrar>csi-node-driver-registrar
<a class=header-anchor href=#csi-node-driver-registrar></a></h3><p>这个是 csi-node 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/node-driver-registrar</code>,
它的主要作用是向 kubelet 注册 csi 插件，kubelet 会调用 csi 插件的 Probe 方法，如果返回成功，kubelet 会调用 csi 插件的 NodeGetInfo 方法，获取节点信息。</p><h3 id=csi-livenessprobe>csi-livenessprobe
<a class=header-anchor href=#csi-livenessprobe></a></h3><p>这个是 csi-node 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/livenessprobe</code>, 它的主要作用是给 kubernetes 的 livenessprobe 提供一个接口，用来检查 csi 插件是否正常运行。它在 <code>/healthz</code> 时，会调用 csi 的 Probe 方法，如果返回成功，返回 200，否则返回 500。</p><h2 id=reference>Reference
<a class=header-anchor href=#reference></a></h2><ul><li><a href=https://developer.aliyun.com/article/754434 title=https://developer.aliyun.com/article/754434 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://developer.aliyun.com/article/754434
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://developer.aliyun.com/article/783464 title=https://developer.aliyun.com/article/783464 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://developer.aliyun.com/article/783464
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/csi>csi
</a><a href=/tags/kubernetes>kubernetes</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
kubernetes 存储流程</li><li class=post-copyright-author><strong>本文作者： </strong>daemon365</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://daemon365.dev/post/cloud/kubernetes_storage_process/ title="kubernetes 存储流程">https://daemon365.dev/post/cloud/kubernetes_storage_process/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/cloud/kube_proxy_traffic_flow_mode/ rel=next title="kube-proxy 流量流转方式"><i class="fa fa-chevron-left"></i> kube-proxy 流量流转方式</a></div><div class="post-nav-prev post-nav-item"><a href=/post/cloud/analysis_of_kubelet_principles/ rel=prev title="kubelet 原理分析">kubelet 原理分析
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>daemon365</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.138.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://daemon365.dev/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://daemon365.dev/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"JmAHxEAUVgyS8B1c","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":false,"enable":false,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"daemon365/blog","theme":"preferred-color-scheme"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://daemon365.dev/3rd"}},"version":"4.6.3"}</script><script type=text/javascript src=/js/main.min.67947911eede6b08b61e6da911bd723abeb33e549e5f17c600657105589e5d18.js defer></script></body></html>