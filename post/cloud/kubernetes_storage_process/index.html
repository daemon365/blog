<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>kubernetes 存储流程 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="PV 与 PVC
PVC (PersistentVolumeClaim)，命名空间（namespace）级别的资源，由 用户 or StatefulSet 控制器（根据VolumeClaimTemplate） 创建。PVC 类似于 Pod，Pod 消耗 Node 资源，PVC 消耗 PV 资源。Pod 可以请 …"><meta name=keywords content="csi,kubernetes"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/cloud/kubernetes_storage_process/"><meta property="og:title" content="kubernetes 存储流程 - Daemon365"><meta property="og:description" content="PV 与 PVC
PVC (PersistentVolumeClaim)，命名空间（namespace）级别的资源，由 用户 or StatefulSet 控制器（根据VolumeClaimTemplate） 创建。PVC 类似于 Pod，Pod 消耗 Node 资源，PVC 消耗 PV 资源。Pod 可以请 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2024-05-03T00:00:00+08:00"><meta property="article:modified_time" content="2024-05-03T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="cloud"><meta property="article:tag" content="csi"><meta property="article:tag" content="kubernetes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/cloud/kubernetes_storage_process/"><meta name=twitter:title content="kubernetes 存储流程 - Daemon365"><meta name=twitter:description content="PV 与 PVC
PVC (PersistentVolumeClaim)，命名空间（namespace）级别的资源，由 用户 or StatefulSet 控制器（根据VolumeClaimTemplate） 创建。PVC 类似于 Pod，Pod 消耗 Node 资源，PVC 消耗 PV 资源。Pod 可以请 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/cloud/kubernetes_storage_process/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kubernetes 存储流程","description":"\u003ch2 id=\u0022pv-与-pvc\u0022\u003ePV 与 PVC\u003c\/h2\u003e\n\u003cp\u003ePVC (PersistentVolumeClaim)，命名空间（namespace）级别的资源，由 用户 or StatefulSet 控制器（根据VolumeClaimTemplate） 创建。PVC 类似于 Pod，Pod 消耗 Node 资源，PVC 消耗 PV 资源。Pod 可以请 …\u003c\/p\u003e","datePublished":"2024-05-03T00:00:00\u002b08:00","dateModified":"2024-05-03T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/cloud\/kubernetes_storage_process\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
首页</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
关于</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
归档</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
分类</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
标签</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
搜索</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>kubernetes 存储流程</h1><div class=post-meta><time datetime=2024-05-03><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2024-05-03
</time><a href=/categories/cloud class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
cloud
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
8 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
1689 words</span></div><div class=post-tags><a href=/tags/csi class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
csi
</a><a href=/tags/kubernetes class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
kubernetes</a></div></header><div class=post-body><h2 id=pv-与-pvc>PV 与 PVC</h2><p>PVC (PersistentVolumeClaim)，命名空间（namespace）级别的资源，由 用户 or StatefulSet 控制器（根据VolumeClaimTemplate） 创建。PVC 类似于 Pod，Pod 消耗 Node 资源，PVC 消耗 PV 资源。Pod 可以请求特定级别的资源（CPU 和内存），而 PVC 可以请求特定存储卷的大小及访问模式（Access Mode
PV（PersistentVolume）是集群中的一块存储资源，可以是 NFS、iSCSI、Ceph、GlusterFS 等存储卷，PV 由集群管理员创建，然后由开发者使用 PVC 来申请 PV，PVC 是对 PV 的申请，类似于 Pod 对 Node 的申请。</p><h3 id=静态创建存储卷>静态创建存储卷</h3><p><img src=/images/e1e2ee82-b5ea-4edb-a587-b1d5860f81d9.png alt></p><p>也就是我们手动创建一个pv和pvc，然后将pv和pvc绑定，然后pod使用pvc，这样就可以使用pv了。</p><p>创建一个 nfs 的 pv 以及 对应的 pvc</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>nfs-pv</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>capacity</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span><span style=color:#111>:</span> <span style=color:#ae81ff>10Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>persistentVolumeReclaimPolicy</span><span style=color:#111>:</span> <span style=color:#ae81ff>Delete</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nfs</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span><span style=color:#111>:</span> <span style=color:#ae81ff>192.168.203.110</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span><span style=color:#111>:</span> <span style=color:#ae81ff>/data/nfs</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>nfs-pvc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span><span style=color:#111>:</span> <span style=color:#ae81ff>10Gi</span>
</span></span></code></pre></div><p>查看 pvc</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>$ kubectl get pvc
</span></span><span style=display:flex><span>NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span></span><span style=display:flex><span>nfs-pvc   Bound    nfs-pv   10Gi       RWO                           101s
</span></span></code></pre></div><p>创建一个 pod 使用 pvc</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>test-nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>image</span><span style=color:#111>:</span> <span style=color:#ae81ff>ubuntu:22.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/bin/sh</span>
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>c</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sleep 10000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumeMounts</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span><span style=color:#111>:</span> <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>nfs-volume</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>nfs-volume</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>persistentVolumeClaim</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>claimName</span><span style=color:#111>:</span> <span style=color:#ae81ff>nfs-pvc</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ kubectl <span style=color:#111>exec</span> -it test-nfs -- cat /data/nfs
</span></span><span style=display:flex><span>192.168.203.110:/data/nfs
</span></span></code></pre></div><h3 id=pvc-pv-绑定流程>pvc pv 绑定流程</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ctrl</span> <span style=color:#f92672>*</span><span style=color:#75af00>PersistentVolumeController</span><span style=color:#111>)</span> <span style=color:#75af00>syncUnboundClaim</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span> <span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolumeClaim</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>logger</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>klog</span><span style=color:#111>.</span><span style=color:#75af00>FromContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>VolumeName</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 是不是延迟绑定 也就是 VolumeBindingMode 为 WaitForFirstConsumer</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>delayBinding</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>storagehelpers</span><span style=color:#111>.</span><span style=color:#75af00>IsDelayBindingMode</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>,</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>classLister</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过 pvc 找到最合适的 pv</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>volume</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>volumes</span><span style=color:#111>.</span><span style=color:#75af00>findBestMatchForClaim</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>,</span> <span style=color:#75af00>delayBinding</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>logger</span><span style=color:#111>.</span><span style=color:#75af00>V</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>).</span><span style=color:#75af00>Info</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Synchronizing unbound PersistentVolumeClaim, Error finding PV for claim&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;PVC&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>klog</span><span style=color:#111>.</span><span style=color:#75af00>KObj</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>),</span> <span style=color:#d88200>&#34;err&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;error finding PV for claim %q: %w&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>claimToClaimKey</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>),</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>volume</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>//// No PV found for this claim</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#75715e>/* pv != nil */</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>			<span style=color:#75af00>claimKey</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>claimToClaimKey</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>logger</span><span style=color:#111>.</span><span style=color:#75af00>V</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>).</span><span style=color:#75af00>Info</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Synchronizing unbound PersistentVolumeClaim, volume found&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;PVC&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>klog</span><span style=color:#111>.</span><span style=color:#75af00>KObj</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>),</span> <span style=color:#d88200>&#34;volumeName&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;volumeStatus&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>getVolumeStatusForLogging</span><span style=color:#111>(</span><span style=color:#75af00>volume</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 绑定 pv 和 pvc</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 这里会处理 pvc 的 spec.volumeName status 和 pv 的 status</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>bind</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>volume</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#75715e>/* pvc.Spec.VolumeName != nil */</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>      ......
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 选择</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>FindMatchingVolume</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>claim</span> <span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolumeClaim</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>volumes</span> <span style=color:#111>[]</span><span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolume</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>node</span> <span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>Node</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>excludedVolumes</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#00a8c8>string</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolume</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>delayBinding</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolume</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>smallestVolume</span> <span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolume</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>smallestVolumeQty</span> <span style=color:#75af00>resource</span><span style=color:#111>.</span><span style=color:#75af00>Quantity</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>requestedQty</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>Resources</span><span style=color:#111>.</span><span style=color:#75af00>Requests</span><span style=color:#111>[</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceName</span><span style=color:#111>(</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceStorage</span><span style=color:#111>)]</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>requestedClass</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>GetPersistentVolumeClaimClass</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>selector</span> <span style=color:#75af00>labels</span><span style=color:#111>.</span><span style=color:#75af00>Selector</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>Selector</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>internalSelector</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>metav1</span><span style=color:#111>.</span><span style=color:#75af00>LabelSelectorAsSelector</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>Selector</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;error creating internal label selector for claim: %v: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>claimToClaimKey</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>),</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>selector</span> <span style=color:#111>=</span> <span style=color:#75af00>internalSelector</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Go through all available volumes with two goals:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// - find a volume that is either pre-bound by user or dynamically</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//   provisioned for this claim. Because of this we need to loop through</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//   all volumes.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// - find the smallest matching one if there is no volume pre-bound to</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//   the claim.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>volume</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>volumes</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>excludedVolumes</span><span style=color:#111>[</span><span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>];</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Skip volumes in the excluded list</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>ClaimRef</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>IsVolumeBoundToClaim</span><span style=color:#111>(</span><span style=color:#75af00>volume</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>volumeQty</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>Capacity</span><span style=color:#111>[</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceStorage</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>volumeQty</span><span style=color:#111>.</span><span style=color:#75af00>Cmp</span><span style=color:#111>(</span><span style=color:#75af00>requestedQty</span><span style=color:#111>)</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// filter out mismatching volumeModes</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>CheckVolumeModeMismatches</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// check if PV&#39;s DeletionTimeStamp is set, if so, skip this volume.</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>ObjectMeta</span><span style=color:#111>.</span><span style=color:#75af00>DeletionTimestamp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>nodeAffinityValid</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>node</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Scheduler path, check that the PV NodeAffinity</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// is satisfied by the node</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// CheckNodeAffinity is the most expensive call in this loop.</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// We should check cheaper conditions first or consider optimizing this function.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>CheckNodeAffinity</span><span style=color:#111>(</span><span style=color:#75af00>volume</span><span style=color:#111>,</span> <span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>Labels</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>nodeAffinityValid</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>IsVolumeBoundToClaim</span><span style=color:#111>(</span><span style=color:#75af00>volume</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// If PV node affinity is invalid, return no match.</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// This means the prebound PV (and therefore PVC)</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// is not suitable for this node.</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>nodeAffinityValid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>volume</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>node</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>delayBinding</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// PV controller does not bind this claim.</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Scheduler will handle binding unbound volumes</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Scheduler path will have node != nil</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// filter out:</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// - volumes in non-available phase</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// - volumes whose labels don&#39;t match the claim&#39;s selector, if specified</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// - volumes in Class that is not requested</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// - volumes whose NodeAffinity does not match the node</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>Status</span><span style=color:#111>.</span><span style=color:#75af00>Phase</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>VolumeAvailable</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// We ignore volumes in non-available phase, because volumes that</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// satisfies matching criteria will be updated to available, binding</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// them now has high chance of encountering unnecessary failures</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// due to API conflicts.</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#75af00>selector</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>selector</span><span style=color:#111>.</span><span style=color:#75af00>Matches</span><span style=color:#111>(</span><span style=color:#75af00>labels</span><span style=color:#111>.</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#75af00>volume</span><span style=color:#111>.</span><span style=color:#75af00>Labels</span><span style=color:#111>))</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>GetPersistentVolumeClass</span><span style=color:#111>(</span><span style=color:#75af00>volume</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>requestedClass</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>nodeAffinityValid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>node</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Scheduler path</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Check that the access modes match</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>CheckAccessModes</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>,</span> <span style=color:#75af00>volume</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>smallestVolume</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>||</span> <span style=color:#75af00>smallestVolumeQty</span><span style=color:#111>.</span><span style=color:#75af00>Cmp</span><span style=color:#111>(</span><span style=color:#75af00>volumeQty</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>smallestVolume</span> <span style=color:#111>=</span> <span style=color:#75af00>volume</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>smallestVolumeQty</span> <span style=color:#111>=</span> <span style=color:#75af00>volumeQty</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>smallestVolume</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Found a matching volume</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>smallestVolume</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=kubelet-绑定>kubelet 绑定</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>MkdirAll</span><span style=color:#111>(</span><span style=color:#75af00>dir</span><span style=color:#111>,</span> <span style=color:#ae81ff>0750</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>source</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s:%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>nfsMounter</span><span style=color:#111>.</span><span style=color:#75af00>server</span><span style=color:#111>,</span> <span style=color:#75af00>nfsMounter</span><span style=color:#111>.</span><span style=color:#75af00>exportPath</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>options</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>nfsMounter</span><span style=color:#111>.</span><span style=color:#75af00>readOnly</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>options</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>options</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;ro&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>mountOptions</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>util</span><span style=color:#111>.</span><span style=color:#75af00>JoinMountOptions</span><span style=color:#111>(</span><span style=color:#75af00>nfsMounter</span><span style=color:#111>.</span><span style=color:#75af00>mountOptions</span><span style=color:#111>,</span> <span style=color:#75af00>options</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>nfsMounter</span><span style=color:#111>.</span><span style=color:#75af00>mounter</span><span style=color:#111>.</span><span style=color:#75af00>MountSensitiveWithoutSystemd</span><span style=color:#111>(</span><span style=color:#75af00>source</span><span style=color:#111>,</span> <span style=color:#75af00>dir</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;nfs&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>mountOptions</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>kubelet 就会在调用 <code>sudo mount -t nfs ...</code> 命令把 nfs 绑定到主机上 绑定的目录大概为 <code>/var/lib/kubelet/pods/[POD-ID]/volumes/</code></p><h2 id=storageclass>StorageClass</h2><p>StorageClass 是 Kubernetes 中用来定义存储卷的类型的资源对象，StorageClass 用来定义存储卷的类型，比如 NFS、iSCSI、Ceph、GlusterFS 等存储卷。StorageClass 是集群级别的资源，由集群管理员创建，用户可以使用 StorageClass 来动态创建 PV。</p><h3 id=动态创建存储卷>动态创建存储卷</h3><p>动态创建存储卷相比静态创建存储卷，少了集群管理员的干预，流程如下图所示：</p><p><img src=/images/7cc8ddd7-1c7d-430d-9332-d7da9d4a2752.png alt></p><p>创建一个 StorageClass pvc pod</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>storage.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>StorageClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>local-storage</span>
</span></span><span style=display:flex><span><span style=color:#f92672>provisioner</span><span style=color:#111>:</span> <span style=color:#ae81ff>rancher.io/local-path</span>
</span></span><span style=display:flex><span><span style=color:#f92672>reclaimPolicy</span><span style=color:#111>:</span> <span style=color:#ae81ff>Delete</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumeBindingMode</span><span style=color:#111>:</span> <span style=color:#ae81ff>WaitForFirstConsumer</span>
</span></span><span style=display:flex><span><span style=color:#111>---</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-local-pvc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span><span style=color:#111>:</span> <span style=color:#ae81ff>128Mi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span><span style=color:#111>:</span> <span style=color:#ae81ff>local-storage</span>
</span></span><span style=display:flex><span><span style=color:#111>---</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>image</span><span style=color:#111>:</span> <span style=color:#ae81ff>ubuntu:22.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/bin/sh</span>
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>c</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sleep 10000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumeMounts</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span><span style=color:#111>:</span> <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-local-pvc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-local-pvc</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>persistentVolumeClaim</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>claimName</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-local-pvc</span>
</span></span></code></pre></div><p>查看 pv</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ kubectl get pv
</span></span><span style=display:flex><span>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                  STORAGECLASS    REASON   AGE
</span></span><span style=display:flex><span>pvc-9d257d8a-29a8-4abf-a1e2-c7e4953fc0ca   128Mi      RWO            Delete           Bound    default/my-local-pvc   local-storage            85s
</span></span></code></pre></div><h3 id=storageclass-创建-pv-流程>StorageClass 创建 pv 流程</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 还是 syncUnboundClaim 中</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// volume 为空，说明没有找到合适的 pv 那么去检查 如果 pvc 的 storageClassName 不为空，那么就会去找到对应的 storageClass</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>volume</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>switch</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>case</span> <span style=color:#75af00>delayBinding</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>storagehelpers</span><span style=color:#111>.</span><span style=color:#75af00>IsDelayBindingProvisioning</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>case</span> <span style=color:#75af00>storagehelpers</span><span style=color:#111>.</span><span style=color:#75af00>GetPersistentVolumeClaimClass</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 如果 pvc 的 storageClassName 不为空，那么就会去找到对应的 storageClass</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>provisionClaim</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>default</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ctrl</span> <span style=color:#f92672>*</span><span style=color:#75af00>PersistentVolumeController</span><span style=color:#111>)</span> <span style=color:#75af00>provisionClaim</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span> <span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolumeClaim</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>plugin</span><span style=color:#111>,</span> <span style=color:#75af00>storageClass</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>findProvisionablePlugin</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>scheduleOperation</span><span style=color:#111>(</span><span style=color:#75af00>logger</span><span style=color:#111>,</span> <span style=color:#75af00>opName</span><span style=color:#111>,</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>var</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>plugin</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 如果是外部的 provisioner 这里我们就安装了 rancher.io/local-path 这个插件</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 所以这里会调用 provisionClaimOperationExternal</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>provisionClaimOperationExternal</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span><span style=color:#111>,</span> <span style=color:#75af00>storageClass</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 内部的 provisioner 直接处理</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>provisionClaimOperation</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span><span style=color:#111>,</span> <span style=color:#75af00>plugin</span><span style=color:#111>,</span> <span style=color:#75af00>storageClass</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果是外部的 provisioner 会在 pvc 的 annotations 加入 volume.beta.kubernetes.io/storage-provisioner: rancher.io/local-path 和 volume.kubernetes.io/storage-provisioner: rancher.io/local-path</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ctrl</span> <span style=color:#f92672>*</span><span style=color:#75af00>PersistentVolumeController</span><span style=color:#111>)</span> <span style=color:#75af00>setClaimProvisioner</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>claim</span> <span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolumeClaim</span><span style=color:#111>,</span> <span style=color:#75af00>provisionerName</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolumeClaim</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>val</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>Annotations</span><span style=color:#111>[</span><span style=color:#75af00>storagehelpers</span><span style=color:#111>.</span><span style=color:#75af00>AnnStorageProvisioner</span><span style=color:#111>];</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>val</span> <span style=color:#f92672>==</span> <span style=color:#75af00>provisionerName</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// annotation is already set, nothing to do</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>claim</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The volume from method args can be pointing to watcher cache. We must not</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// modify these, therefore create a copy.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>claimClone</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>DeepCopy</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// TODO: remove the beta storage provisioner anno after the deprecation period</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>logger</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>klog</span><span style=color:#111>.</span><span style=color:#75af00>FromContext</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>metav1</span><span style=color:#111>.</span><span style=color:#75af00>SetMetaDataAnnotation</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>claimClone</span><span style=color:#111>.</span><span style=color:#75af00>ObjectMeta</span><span style=color:#111>,</span> <span style=color:#75af00>storagehelpers</span><span style=color:#111>.</span><span style=color:#75af00>AnnBetaStorageProvisioner</span><span style=color:#111>,</span> <span style=color:#75af00>provisionerName</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>metav1</span><span style=color:#111>.</span><span style=color:#75af00>SetMetaDataAnnotation</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>claimClone</span><span style=color:#111>.</span><span style=color:#75af00>ObjectMeta</span><span style=color:#111>,</span> <span style=color:#75af00>storagehelpers</span><span style=color:#111>.</span><span style=color:#75af00>AnnStorageProvisioner</span><span style=color:#111>,</span> <span style=color:#75af00>provisionerName</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>updateMigrationAnnotations</span><span style=color:#111>(</span><span style=color:#75af00>logger</span><span style=color:#111>,</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>csiMigratedPluginManager</span><span style=color:#111>,</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>translator</span><span style=color:#111>,</span> <span style=color:#75af00>claimClone</span><span style=color:#111>.</span><span style=color:#75af00>Annotations</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>newClaim</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>kubeClient</span><span style=color:#111>.</span><span style=color:#75af00>CoreV1</span><span style=color:#111>().</span><span style=color:#75af00>PersistentVolumeClaims</span><span style=color:#111>(</span><span style=color:#75af00>claim</span><span style=color:#111>.</span><span style=color:#75af00>Namespace</span><span style=color:#111>).</span><span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>claimClone</span><span style=color:#111>,</span> <span style=color:#75af00>metav1</span><span style=color:#111>.</span><span style=color:#75af00>UpdateOptions</span><span style=color:#111>{})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>newClaim</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ctrl</span><span style=color:#111>.</span><span style=color:#75af00>storeClaimUpdate</span><span style=color:#111>(</span><span style=color:#75af00>logger</span><span style=color:#111>,</span> <span style=color:#75af00>newClaim</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>newClaim</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>newClaim</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=kubernetes-external-provisioner>kubernetes external provisioner</h2><p>kubernetes external provisioner 是一个独立的进程，用来动态创建 PV，它通过监听 StorageClass 的事件，当 StorageClass 的 ReclaimPolicy 为 Retain 时，会创建 PV。</p><p>在这里我新建一个 关于 nfs 的 external provisioner</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/golang/glog&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>v1</span> <span style=color:#d88200>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>metav1</span> <span style=color:#d88200>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;sigs.k8s.io/sig-storage-lib-external-provisioner/v10/controller&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>provisionerName</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;provisioner.test.com/nfs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>_</span> <span style=color:#75af00>controller</span><span style=color:#111>.</span><span style=color:#75af00>Provisioner</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>nfsProvisioner</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>nfsProvisioner</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>client</span> <span style=color:#75af00>kubernetes</span><span style=color:#111>.</span><span style=color:#75af00>Interface</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>nfsProvisioner</span><span style=color:#111>)</span> <span style=color:#75af00>Provision</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>options</span> <span style=color:#75af00>controller</span><span style=color:#111>.</span><span style=color:#75af00>ProvisionOptions</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolume</span><span style=color:#111>,</span> <span style=color:#75af00>controller</span><span style=color:#111>.</span><span style=color:#75af00>ProvisioningState</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>PVC</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>Selector</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>controller</span><span style=color:#111>.</span><span style=color:#75af00>ProvisioningFinished</span><span style=color:#111>,</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;claim Selector is not supported&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>glog</span><span style=color:#111>.</span><span style=color:#75af00>V</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>).</span><span style=color:#75af00>Infof</span><span style=color:#111>(</span><span style=color:#d88200>&#34;nfs provisioner: VolumeOptions %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>options</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolume</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ObjectMeta</span><span style=color:#111>:</span> <span style=color:#75af00>metav1</span><span style=color:#111>.</span><span style=color:#75af00>ObjectMeta</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Name</span><span style=color:#111>:</span> <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>PVName</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#111>},</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Spec</span><span style=color:#111>:</span> <span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolumeSpec</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>PersistentVolumeReclaimPolicy</span><span style=color:#111>:</span> <span style=color:#f92672>*</span><span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>StorageClass</span><span style=color:#111>.</span><span style=color:#75af00>ReclaimPolicy</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>AccessModes</span><span style=color:#111>:</span>                   <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>PVC</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>AccessModes</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>MountOptions</span><span style=color:#111>:</span>                  <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>StorageClass</span><span style=color:#111>.</span><span style=color:#75af00>MountOptions</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Capacity</span><span style=color:#111>:</span> <span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceList</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceName</span><span style=color:#111>(</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceStorage</span><span style=color:#111>):</span> <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>PVC</span><span style=color:#111>.</span><span style=color:#75af00>Spec</span><span style=color:#111>.</span><span style=color:#75af00>Resources</span><span style=color:#111>.</span><span style=color:#75af00>Requests</span><span style=color:#111>[</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceName</span><span style=color:#111>(</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>ResourceStorage</span><span style=color:#111>)],</span>
</span></span><span style=display:flex><span>			<span style=color:#111>},</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>PersistentVolumeSource</span><span style=color:#111>:</span> <span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolumeSource</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>NFS</span><span style=color:#111>:</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>NFSVolumeSource</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>Server</span><span style=color:#111>:</span>   <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>StorageClass</span><span style=color:#111>.</span><span style=color:#75af00>Parameters</span><span style=color:#111>[</span><span style=color:#d88200>&#34;server&#34;</span><span style=color:#111>],</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>Path</span><span style=color:#111>:</span>     <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>StorageClass</span><span style=color:#111>.</span><span style=color:#75af00>Parameters</span><span style=color:#111>[</span><span style=color:#d88200>&#34;path&#34;</span><span style=color:#111>],</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>ReadOnly</span><span style=color:#111>:</span> <span style=color:#75af00>options</span><span style=color:#111>.</span><span style=color:#75af00>StorageClass</span><span style=color:#111>.</span><span style=color:#75af00>Parameters</span><span style=color:#111>[</span><span style=color:#d88200>&#34;readOnly&#34;</span><span style=color:#111>]</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;true&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>				<span style=color:#111>},</span>
</span></span><span style=display:flex><span>			<span style=color:#111>},</span>
</span></span><span style=display:flex><span>		<span style=color:#111>},</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>pv</span><span style=color:#111>,</span> <span style=color:#75af00>controller</span><span style=color:#111>.</span><span style=color:#75af00>ProvisioningFinished</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>nfsProvisioner</span><span style=color:#111>)</span> <span style=color:#75af00>Delete</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>volume</span> <span style=color:#f92672>*</span><span style=color:#75af00>v1</span><span style=color:#111>.</span><span style=color:#75af00>PersistentVolume</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 因为是 nfs 没有产生实际的资源，所以这里不需要删除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果在 provisioner 中创建了资源，那么这里需要删除</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 一般是调用 csi 创建/删除资源</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>l</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>FromContext</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Background</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>config</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>clientcmd</span><span style=color:#111>.</span><span style=color:#75af00>BuildConfigFromFlags</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>filepath</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#75af00>homedir</span><span style=color:#111>.</span><span style=color:#75af00>HomeDir</span><span style=color:#111>(),</span> <span style=color:#d88200>&#34;.kube&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;config&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>glog</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Failed to create kubeconfig: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>clientset</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>kubernetes</span><span style=color:#111>.</span><span style=color:#75af00>NewForConfig</span><span style=color:#111>(</span><span style=color:#75af00>config</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>glog</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Failed to create client: %v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>clientNFSProvisioner</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>nfsProvisioner</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>client</span><span style=color:#111>:</span> <span style=color:#75af00>clientset</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pc</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>controller</span><span style=color:#111>.</span><span style=color:#75af00>NewProvisionController</span><span style=color:#111>(</span><span style=color:#75af00>l</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>clientset</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>provisionerName</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>clientNFSProvisioner</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>controller</span><span style=color:#111>.</span><span style=color:#75af00>LeaderElection</span><span style=color:#111>(</span><span style=color:#00a8c8>true</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>glog</span><span style=color:#111>.</span><span style=color:#75af00>Info</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Starting provision controller&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pc</span><span style=color:#111>.</span><span style=color:#75af00>Run</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Background</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>创建一个 nfs 的 storageClass</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>storage.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>StorageClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>provisioner</span><span style=color:#111>:</span> <span style=color:#ae81ff>provisioner.test.com/nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>reclaimPolicy</span><span style=color:#111>:</span> <span style=color:#ae81ff>Delete</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumeBindingMode</span><span style=color:#111>:</span> <span style=color:#ae81ff>Immediate</span>
</span></span><span style=display:flex><span><span style=color:#f92672>parameters</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;192.168.203.110&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>path</span><span style=color:#111>:</span> <span style=color:#ae81ff>/data/nfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>readOnly</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;false&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-nfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span><span style=color:#111>:</span> <span style=color:#ae81ff>1Gi</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span><span style=color:#111>:</span> <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span><span style=color:#111>:</span> <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>test-nfs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>image</span><span style=color:#111>:</span> <span style=color:#ae81ff>ubuntu:22.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/bin/sh</span>
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>c</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sleep 10000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumeMounts</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span><span style=color:#111>:</span> <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>persistentVolumeClaim</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>claimName</span><span style=color:#111>:</span> <span style=color:#ae81ff>my-nfs-pvc</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ kubectl <span style=color:#111>exec</span> -it test-nfs -- cat /data/nfs
</span></span><span style=display:flex><span>192.168.203.110:/data/nfs
</span></span></code></pre></div><h2 id=csi-流程>CSI 流程</h2><p>持久化存储流程图如下：</p><p><img src=/images/d0dd40b9-6ce3-40bc-a048-0b3f1653d952.jpg alt></p><h3 id=provisioner>Provisioner</h3><p>当部署 csi-controller 时 ，会启动一个伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/external-provisioner</code> 这个项目是一个 csi 的 provisioner
它会监控属于自己的pvc，当有新的pvc创建时，会调用 csi 的 createVolume 方法，创建一个 volume，然后创建一个 pv。当 pvc 删除时，会调用 csi 的 deleteVolume 方法，然后删除 volume 和 pv。</p><p><img src=/images/8556b88f-a2a3-447a-a2ac-e0ed179e3b24.png alt></p><p><img src=/images/06af3f24-bdbc-44be-a08a-36f1da8ab8c5.png alt></p><h3 id=attacher>Attacher</h3><p>external-attacher 也是 csi-controller 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/external-attacher</code> 这个项目是一个 csi 的 attacher, 它会监控 AttachDetachController 资源，当有新的资源创建时，会调用 csi 的 controllerPublishVolume 方法，挂载 volume 到 node 上。当资源删除时，会调用 csi 的 controllerUnpublishVolume 方法，卸载 volume。</p><p><img src=/images/d4f2c430-8b28-43e6-b150-960db81b6bf7.png alt></p><p><img src=/images/2486b91a-6a5a-476a-8795-a69305dd6011.png alt></p><h3 id=snapshotter>Snapshotter</h3><p>external-snapshotter 也是 csi-controller 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/external-snapshotter</code> 这个项目是一个 csi 的 snapshotter, 它会监控 VolumeSnapshot 资源，当有新的资源创建时，会调用 csi 的 createSnapshot 方法，创建一个快照。当资源删除时，会调用 csi 的 deleteSnapshot 方法，删除快照。</p><h3 id=csi-node>csi-node</h3><p>csi-node 是一个 kubelet 的插件，所以它需要每个节点上都运行，当 pod 创建时，并且 VolumeAttachment 的 .spec.Attached 时，kubelet 会调用 csi 的 NodeStageVolume 函数，之后插件（csiAttacher）调用内部 in-tree CSI 插件（csiMountMgr）的 SetUp 函数，该函数内部会调用 csi 的 NodePublishVolume 函数，挂载 volume 到 pod 上。当 pod 删除时，kubelet 观察到包含 CSI 存储卷的 Pod 被删除，于是调用内部 in-tree CSI 插件（csiMountMgr）的 TearDown 函数，该函数内部会通过 unix domain socket 调用外部 CSI 插件的 NodeUnpublishVolume 函数。kubelet 调用内部 in-tree CSI 插件（csiAttacher）的 UnmountDevice 函数，该函数内部会通过 unix domain socket 调用外部 CSI 插件的 NodeUnstageVolume 函数。</p><p><img src=/images/d6bd8e82-8227-4e1e-9764-c66a34572398.png alt></p><p><img src=/images/b8a8b74d-4c97-4dcd-a097-20b59561b107.png alt></p><h3 id=csi-node-driver-registrar>csi-node-driver-registrar</h3><p>这个是 csi-node 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/node-driver-registrar</code>,
它的主要作用是向 kubelet 注册 csi 插件，kubelet 会调用 csi 插件的 Probe 方法，如果返回成功，kubelet 会调用 csi 插件的 NodeGetInfo 方法，获取节点信息。</p><h3 id=csi-livenessprobe>csi-livenessprobe</h3><p>这个是 csi-node 的伴生容器，项目地址为 <code>https://github.com/kubernetes-csi/livenessprobe</code>, 它的主要作用是给 kubernetes 的 livenessprobe 提供一个接口，用来检查 csi 插件是否正常运行。它在 <code>/healthz</code> 时，会调用 csi 的 Probe 方法，如果返回成功，返回 200，否则返回 500。</p><h2 id=reference>Reference</h2><ul><li><a href=https://developer.aliyun.com/article/754434>https://developer.aliyun.com/article/754434</a></li><li><a href=https://developer.aliyun.com/article/783464>https://developer.aliyun.com/article/783464</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> kubernetes 存储流程</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/cloud/kubernetes_storage_process/>https://daemon365.dev/post/cloud/kubernetes_storage_process/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/cloud/analysis_of_kubelet_principles/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>kubelet 原理分析</span></div></a><a href=/post/cloud/kube_proxy_traffic_flow_mode/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>kube-proxy 流量流转方式</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#pv-与-pvc>PV 与 PVC</a><ul><li><a href=#静态创建存储卷>静态创建存储卷</a></li><li><a href=#pvc-pv-绑定流程>pvc pv 绑定流程</a></li><li><a href=#kubelet-绑定>kubelet 绑定</a></li></ul></li><li><a href=#storageclass>StorageClass</a><ul><li><a href=#动态创建存储卷>动态创建存储卷</a></li><li><a href=#storageclass-创建-pv-流程>StorageClass 创建 pv 流程</a></li></ul></li><li><a href=#kubernetes-external-provisioner>kubernetes external provisioner</a></li><li><a href=#csi-流程>CSI 流程</a><ul><li><a href=#provisioner>Provisioner</a></li><li><a href=#attacher>Attacher</a></li><li><a href=#snapshotter>Snapshotter</a></li><li><a href=#csi-node>csi-node</a></li><li><a href=#csi-node-driver-registrar>csi-node-driver-registrar</a></li><li><a href=#csi-livenessprobe>csi-livenessprobe</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2026 daemon365</p><p class=powered-by>由 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 和 <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a> 驱动</p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder=搜索文章... autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>输入 2 个或更多字符开始搜索</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>