<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>etcd watch 实现原理 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="介绍
在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。
etcdctl watch /test
# 当 /test 的值发生变化时，会输出如下信息 …"><meta name=keywords content="boltdb,etcd,golang,数据库,kubernetes"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/"><meta property="og:title" content="etcd watch 实现原理 - Daemon365"><meta property="og:description" content="介绍
在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。
etcdctl watch /test
# 当 /test 的值发生变化时，会输出如下信息 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2024-06-10T14:16:00+08:00"><meta property="article:modified_time" content="2024-06-10T14:16:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="cloud"><meta property="article:tag" content="boltdb"><meta property="article:tag" content="etcd"><meta property="article:tag" content="golang"><meta property="article:tag" content="数据库"><meta property="article:tag" content="kubernetes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/"><meta name=twitter:title content="etcd watch 实现原理 - Daemon365"><meta name=twitter:description content="介绍
在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。
etcdctl watch /test
# 当 /test 的值发生变化时，会输出如下信息 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"etcd watch 实现原理","description":"\u003ch2 id=\u0022介绍\u0022\u003e介绍\u003c\/h2\u003e\n\u003cp\u003e在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。\u003c\/p\u003e\n\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-BASH\u0022 data-lang=\u0022BASH\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eetcdctl watch \/test\n\u003c\/span\u003e\u003c\/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# 当 \/test 的值发生变化时，会输出如下信息 …\u003c\/span\u003e\u003c\/span\u003e\u003c\/span\u003e\u003c\/span\u003e\u003c\/span\u003e\u003c\/code\u003e\u003c\/pre\u003e\u003c\/div\u003e","datePublished":"2024-06-10T14:16:00\u002b08:00","dateModified":"2024-06-10T14:16:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/cloud\/etcd_watch_implementation_principle\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
Archives</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
Search</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>etcd watch 实现原理</h1><div class=post-meta><time datetime=2024-06-10><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2024-06-10
</time><a href=/categories/cloud class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
cloud
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
13 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
2637 words</span></div><div class=post-tags><a href=/tags/boltdb class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
boltdb
</a><a href=/tags/etcd class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
etcd
</a><a href=/tags/golang class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
golang
</a><a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93 class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
数据库
</a><a href=/tags/kubernetes class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
kubernetes</a></div></header><div class=post-body><h2 id=介绍>介绍</h2><p>在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span>etcdctl watch /test
</span></span><span style=display:flex><span><span style=color:#75715e># 当 /test 的值发生变化时，会输出如下信息</span>
</span></span><span style=display:flex><span>PUT
</span></span><span style=display:flex><span>/test
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>PUT
</span></span><span style=display:flex><span>/test
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span>DELETE
</span></span><span style=display:flex><span>/test
</span></span></code></pre></div><h2 id=watch-的-api>watch 的 api</h2><p>etcd watch api 是由 grpc stream 实现的，客户端通过 grpc stream 发送 watch 请求，etcd 会将 key 的变化通过 stream 返回给客户端。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#00a8c8>rpc</span> <span style=color:#111>Watch</span><span style=color:#111>(</span><span style=color:#111>stream</span> <span style=color:#111>WatchRequest</span><span style=color:#111>)</span> <span style=color:#00a8c8>returns</span> <span style=color:#111>(</span><span style=color:#111>stream</span> <span style=color:#111>WatchResponse</span><span style=color:#111>)</span> <span style=color:#111>{</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#00a8c8>option</span> <span style=color:#111>(</span><span style=color:#111>google.api.http</span><span style=color:#111>)</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#111>post</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#34;/v3/watch&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#111>body</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#34;*&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#111>};</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=api-实现>api 实现</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchServer</span><span style=color:#111>)</span> <span style=color:#75af00>Watch</span><span style=color:#111>(</span><span style=color:#75af00>stream</span> <span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>Watch_WatchServer</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sws</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>serverWatchStream</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lg</span><span style=color:#111>:</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>clusterID</span><span style=color:#111>:</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>clusterID</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>memberID</span><span style=color:#111>:</span>  <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>memberID</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>maxRequestBytes</span><span style=color:#111>:</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>maxRequestBytes</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sg</span><span style=color:#111>:</span>        <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>sg</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>watchable</span><span style=color:#111>:</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchable</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ag</span><span style=color:#111>:</span>        <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>ag</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gRPCStream</span><span style=color:#111>:</span>  <span style=color:#75af00>stream</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>watchStream</span><span style=color:#111>:</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchable</span><span style=color:#111>.</span><span style=color:#75af00>NewWatchStream</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// chan for sending control response like watcher created and canceled.</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ctrlStream</span><span style=color:#111>:</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#f92672>*</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>,</span> <span style=color:#75af00>ctrlStreamBufLen</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>progress</span><span style=color:#111>:</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span><span style=color:#00a8c8>bool</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>prevKV</span><span style=color:#111>:</span>   <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span><span style=color:#00a8c8>bool</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fragment</span><span style=color:#111>:</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span><span style=color:#00a8c8>bool</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>closec</span><span style=color:#111>:</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}),</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>wg</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启一个 goroutine 处理新的 event 然后发送给客户端</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>sendLoop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>wg</span><span style=color:#111>.</span><span style=color:#75af00>Done</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>errc</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启一个 goroutine 处理客户端发送的 watch 请求</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>rerr</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>recvLoop</span><span style=color:#111>();</span> <span style=color:#75af00>rerr</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>isClientCtxErr</span><span style=color:#111>(</span><span style=color:#75af00>stream</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>().</span><span style=color:#75af00>Err</span><span style=color:#111>(),</span> <span style=color:#75af00>rerr</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to receive watch request from gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>rerr</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Warn</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to receive watch request from gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>rerr</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>streamFailures</span><span style=color:#111>.</span><span style=color:#75af00>WithLabelValues</span><span style=color:#111>(</span><span style=color:#d88200>&#34;receive&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;watch&#34;</span><span style=color:#111>).</span><span style=color:#75af00>Inc</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>errc</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>rerr</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 处理结束</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>errc</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Canceled</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>rpctypes</span><span style=color:#111>.</span><span style=color:#75af00>ErrGRPCWatchCanceled</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>close</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>ctrlStream</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>stream</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>().</span><span style=color:#75af00>Done</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>stream</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>().</span><span style=color:#75af00>Err</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Canceled</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>rpctypes</span><span style=color:#111>.</span><span style=color:#75af00>ErrGRPCWatchCanceled</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#111>close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>这里 主要的逻辑是开启两个 goroutine，一个用于处理客户端发送的 watch 请求，另一个用于处理新的 event 然后发送给客户端。</p><h3 id=sendloop>sendLoop</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>sws</span> <span style=color:#f92672>*</span><span style=color:#75af00>serverWatchStream</span><span style=color:#111>)</span> <span style=color:#75af00>sendLoop</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// watch ids that are currently active</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ids</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span><span style=color:#00a8c8>struct</span><span style=color:#111>{})</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// watch responses pending on a watch id creation message</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pending</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>][]</span><span style=color:#f92672>*</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>interval</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>GetProgressReportInterval</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>progressTicker</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>NewTicker</span><span style=color:#111>(</span><span style=color:#75af00>interval</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>progressTicker</span><span style=color:#111>.</span><span style=color:#75af00>Stop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 清空chan ，清理待处理 event</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>ws</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>Chan</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>ReportEventReceived</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>wrs</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>pending</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>ws</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>wrs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>ReportEventReceived</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#75af00>wresp</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>Chan</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 从 watchStream.Chan() 中获取 event</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 然后发送给客户端 </span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>evs</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>Events</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>events</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>([]</span><span style=color:#f92672>*</span><span style=color:#75af00>mvccpb</span><span style=color:#111>.</span><span style=color:#75af00>Event</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>evs</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>needPrevKV</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>prevKV</span><span style=color:#111>[</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>evs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>events</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>evs</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>needPrevKV</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>IsCreateEvent</span><span style=color:#111>(</span><span style=color:#75af00>evs</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>])</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>opt</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>RangeOptions</span><span style=color:#111>{</span><span style=color:#75af00>Rev</span><span style=color:#111>:</span> <span style=color:#75af00>evs</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Kv</span><span style=color:#111>.</span><span style=color:#75af00>ModRevision</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>r</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchable</span><span style=color:#111>.</span><span style=color:#75af00>Range</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>TODO</span><span style=color:#111>(),</span> <span style=color:#75af00>evs</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>Kv</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>opt</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>KVs</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>						<span style=color:#75af00>events</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>PrevKv</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>KVs</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>					<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>canceled</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>CompactRevision</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>wr</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>Header</span><span style=color:#111>:</span>          <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>newResponseHeader</span><span style=color:#111>(</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>Revision</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>WatchId</span><span style=color:#111>:</span>         <span style=color:#111>int64</span><span style=color:#111>(</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>Events</span><span style=color:#111>:</span>          <span style=color:#75af00>events</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>CompactRevision</span><span style=color:#111>:</span> <span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>CompactRevision</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>Canceled</span><span style=color:#111>:</span>        <span style=color:#75af00>canceled</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Progress notifications can have WatchID -1</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// if they announce on behalf of multiple watchers</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>clientv3</span><span style=color:#111>.</span><span style=color:#75af00>InvalidWatchID</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>okID</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ids</span><span style=color:#111>[</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>];</span> <span style=color:#111>!</span><span style=color:#75af00>okID</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>// buffer if id not yet announced</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>wrs</span> <span style=color:#f92672>:=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>pending</span><span style=color:#111>[</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>],</span> <span style=color:#75af00>wr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>pending</span><span style=color:#111>[</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>wrs</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>ReportEventReceived</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>evs</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>fragmented</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>fragment</span><span style=color:#111>[</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>var</span> <span style=color:#75af00>serr</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// gofail: var beforeSendWatchResponse struct{}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>fragmented</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>serr</span> <span style=color:#111>=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Send</span><span style=color:#111>(</span><span style=color:#75af00>wr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>serr</span> <span style=color:#111>=</span> <span style=color:#75af00>sendFragments</span><span style=color:#111>(</span><span style=color:#75af00>wr</span><span style=color:#111>,</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>maxRequestBytes</span><span style=color:#111>,</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Send</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>serr</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>isClientCtxErr</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>().</span><span style=color:#75af00>Err</span><span style=color:#111>(),</span> <span style=color:#75af00>serr</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to send watch response to gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>serr</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Warn</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to send watch response to gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>serr</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>streamFailures</span><span style=color:#111>.</span><span style=color:#75af00>WithLabelValues</span><span style=color:#111>(</span><span style=color:#d88200>&#34;send&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;watch&#34;</span><span style=color:#111>).</span><span style=color:#75af00>Inc</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>evs</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>progress</span><span style=color:#111>[</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// elide next progress update if sent a key update</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>progress</span><span style=color:#111>[</span><span style=color:#75af00>wresp</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#75af00>c</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>ctrlStream</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理客户端发送的 watch 请求</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Send</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>isClientCtxErr</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>().</span><span style=color:#75af00>Err</span><span style=color:#111>(),</span> <span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to send watch control response to gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Warn</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to send watch control response to gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>streamFailures</span><span style=color:#111>.</span><span style=color:#75af00>WithLabelValues</span><span style=color:#111>(</span><span style=color:#d88200>&#34;send&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;watch&#34;</span><span style=color:#111>).</span><span style=color:#75af00>Inc</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// track id creation</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>wid</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>WatchId</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>verify</span><span style=color:#111>.</span><span style=color:#75af00>Assert</span><span style=color:#111>(!(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Canceled</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Created</span><span style=color:#111>)</span> <span style=color:#f92672>||</span> <span style=color:#75af00>wid</span> <span style=color:#f92672>==</span> <span style=color:#75af00>clientv3</span><span style=color:#111>.</span><span style=color:#75af00>InvalidWatchID</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;unexpected watchId: %d, wanted: %d, since both &#39;Canceled&#39; and &#39;Created&#39; are true&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>wid</span><span style=color:#111>,</span> <span style=color:#75af00>clientv3</span><span style=color:#111>.</span><span style=color:#75af00>InvalidWatchID</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Canceled</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>wid</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>clientv3</span><span style=color:#111>.</span><span style=color:#75af00>InvalidWatchID</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>ids</span><span style=color:#111>,</span> <span style=color:#75af00>wid</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Created</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// flush buffered events</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>ids</span><span style=color:#111>[</span><span style=color:#75af00>wid</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}{}</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>pending</span><span style=color:#111>[</span><span style=color:#75af00>wid</span><span style=color:#111>]</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>ReportEventReceived</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Send</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>						<span style=color:#00a8c8>if</span> <span style=color:#75af00>isClientCtxErr</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>().</span><span style=color:#75af00>Err</span><span style=color:#111>(),</span> <span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>							<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to send pending watch response to gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>						<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>							<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Warn</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to send pending watch response to gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>							<span style=color:#75af00>streamFailures</span><span style=color:#111>.</span><span style=color:#75af00>WithLabelValues</span><span style=color:#111>(</span><span style=color:#d88200>&#34;send&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;watch&#34;</span><span style=color:#111>).</span><span style=color:#75af00>Inc</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>						<span style=color:#111>}</span>
</span></span><span style=display:flex><span>						<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>					<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>pending</span><span style=color:#111>,</span> <span style=color:#75af00>wid</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>progressTicker</span><span style=color:#111>.</span><span style=color:#75af00>C</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>progress</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>RequestProgress</span><span style=color:#111>(</span><span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>progress</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>closec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>这里使用了 for select 循环：</p><ol><li>从 watchStream.Chan() 中获取 event 然后发送给客户端。</li><li>处理客户端发送的 watch 请求。</li><li>dispatch progress 事件。</li><li>处理结束。</li></ol><h3 id=recvloop>recvLoop</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>sws</span> <span style=color:#f92672>*</span><span style=color:#75af00>serverWatchStream</span><span style=color:#111>)</span> <span style=color:#75af00>recvLoop</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>gRPCStream</span><span style=color:#111>.</span><span style=color:#75af00>Recv</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>EOF</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>switch</span> <span style=color:#75af00>uv</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>RequestUnion</span><span style=color:#111>.(</span><span style=color:#00a8c8>type</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>*</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchRequest_CreateRequest</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>uv</span><span style=color:#111>.</span><span style=color:#75af00>CreateRequest</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>creq</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>uv</span><span style=color:#111>.</span><span style=color:#75af00>CreateRequest</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// \x00 is the smallest key</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>Key</span> <span style=color:#111>=</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>{</span><span style=color:#ae81ff>0</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>RangeEnd</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// force nil since watchstream.Watch distinguishes</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// between nil and []byte{} for single key / &gt;=</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>RangeEnd</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>RangeEnd</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>RangeEnd</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// support  &gt;= key queries</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>RangeEnd</span> <span style=color:#111>=</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>isWatchPermitted</span><span style=color:#111>(</span><span style=color:#75af00>creq</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>var</span> <span style=color:#75af00>cancelReason</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>switch</span> <span style=color:#75af00>err</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#75af00>auth</span><span style=color:#111>.</span><span style=color:#75af00>ErrInvalidAuthToken</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>cancelReason</span> <span style=color:#111>=</span> <span style=color:#75af00>rpctypes</span><span style=color:#111>.</span><span style=color:#75af00>ErrGRPCInvalidAuthToken</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#75af00>auth</span><span style=color:#111>.</span><span style=color:#75af00>ErrAuthOldRevision</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>cancelReason</span> <span style=color:#111>=</span> <span style=color:#75af00>rpctypes</span><span style=color:#111>.</span><span style=color:#75af00>ErrGRPCAuthOldRevision</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#75af00>auth</span><span style=color:#111>.</span><span style=color:#75af00>ErrUserEmpty</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>cancelReason</span> <span style=color:#111>=</span> <span style=color:#75af00>rpctypes</span><span style=color:#111>.</span><span style=color:#75af00>ErrGRPCUserEmpty</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>default</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>auth</span><span style=color:#111>.</span><span style=color:#75af00>ErrPermissionDenied</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>						<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#d88200>&#34;unexpected error code&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>					<span style=color:#111>}</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>cancelReason</span> <span style=color:#111>=</span> <span style=color:#75af00>rpctypes</span><span style=color:#111>.</span><span style=color:#75af00>ErrGRPCPermissionDenied</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>wr</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>Header</span><span style=color:#111>:</span>       <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>newResponseHeader</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>Rev</span><span style=color:#111>()),</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>WatchId</span><span style=color:#111>:</span>      <span style=color:#75af00>clientv3</span><span style=color:#111>.</span><span style=color:#75af00>InvalidWatchID</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>Canceled</span><span style=color:#111>:</span>     <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>Created</span><span style=color:#111>:</span>      <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>CancelReason</span><span style=color:#111>:</span> <span style=color:#75af00>cancelReason</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>ctrlStream</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>wr</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>closec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>filters</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>FiltersFromRequest</span><span style=color:#111>(</span><span style=color:#75af00>creq</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>wsrev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>Rev</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>rev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>StartRevision</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>rev</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>rev</span> <span style=color:#111>=</span> <span style=color:#75af00>wsrev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>Watch</span><span style=color:#111>(</span><span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>(</span><span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>WatchId</span><span style=color:#111>),</span> <span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>,</span> <span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>RangeEnd</span><span style=color:#111>,</span> <span style=color:#75af00>rev</span><span style=color:#111>,</span> <span style=color:#75af00>filters</span><span style=color:#f92672>...</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>ProgressNotify</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>progress</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>PrevKv</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>prevKV</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>creq</span><span style=color:#111>.</span><span style=color:#75af00>Fragment</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>fragment</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>id</span> <span style=color:#111>=</span> <span style=color:#75af00>clientv3</span><span style=color:#111>.</span><span style=color:#75af00>InvalidWatchID</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>wr</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>Header</span><span style=color:#111>:</span>   <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>newResponseHeader</span><span style=color:#111>(</span><span style=color:#75af00>wsrev</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>WatchId</span><span style=color:#111>:</span>  <span style=color:#111>int64</span><span style=color:#111>(</span><span style=color:#75af00>id</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>Created</span><span style=color:#111>:</span>  <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>Canceled</span><span style=color:#111>:</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>CancelReason</span> <span style=color:#111>=</span> <span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>case</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>ctrlStream</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>wr</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>closec</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>*</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchRequest_CancelRequest</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>uv</span><span style=color:#111>.</span><span style=color:#75af00>CancelRequest</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>id</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>uv</span><span style=color:#111>.</span><span style=color:#75af00>CancelRequest</span><span style=color:#111>.</span><span style=color:#75af00>WatchId</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>Cancel</span><span style=color:#111>(</span><span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>(</span><span style=color:#75af00>id</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>ctrlStream</span> <span style=color:#f92672>&lt;-</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>						<span style=color:#75af00>Header</span><span style=color:#111>:</span>   <span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>newResponseHeader</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>Rev</span><span style=color:#111>()),</span>
</span></span><span style=display:flex><span>						<span style=color:#75af00>WatchId</span><span style=color:#111>:</span>  <span style=color:#75af00>id</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>						<span style=color:#75af00>Canceled</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>					<span style=color:#111>}</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>					<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>progress</span><span style=color:#111>,</span> <span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>(</span><span style=color:#75af00>id</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>					<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>prevKV</span><span style=color:#111>,</span> <span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>(</span><span style=color:#75af00>id</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>					<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>fragment</span><span style=color:#111>,</span> <span style=color:#75af00>mvcc</span><span style=color:#111>.</span><span style=color:#75af00>WatchID</span><span style=color:#111>(</span><span style=color:#75af00>id</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>*</span><span style=color:#75af00>pb</span><span style=color:#111>.</span><span style=color:#75af00>WatchRequest_ProgressRequest</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>uv</span><span style=color:#111>.</span><span style=color:#75af00>ProgressRequest</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>watchStream</span><span style=color:#111>.</span><span style=color:#75af00>RequestProgressAll</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>default</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// we probably should not shutdown the entire stream when</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// receive an invalid command.</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// so just do nothing instead.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sws</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>.</span><span style=color:#75af00>Sugar</span><span style=color:#111>().</span><span style=color:#75af00>Infof</span><span style=color:#111>(</span><span style=color:#d88200>&#34;invalid watch request type %T received in gRPC stream&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>uv</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>这里主要处理客户端发送的 watch 请求，然后发送给 ctrlStream。sendLoop 会从 ctrlStream 中获取 event 然后发送给客户端。</p><h2 id=watchstream>WatchStream</h2><p>这个 inferface 才是处理 watch 的主要逻辑</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// WatchStream 是一个接口，定义了一个流式处理watch请求的机制</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>WatchStream</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Watch 创建一个观察者。观察者会监听在给定的键或范围 [key, end) 上发生的事件或已发生的事件。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 整个事件历史都可以被观察到，除非被压缩。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果 &#34;startRev&#34; &lt;= 0，watch 将观察在当前修订版本之后的事件。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 返回的 &#34;id&#34; 是这个观察者的ID。它作为 WatchID 出现在通过 stream 通道发送到创建的观察者的事件中。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 当 WatchID 不等于 AutoWatchID 时，使用指定的 WatchID，否则返回自动生成的 WatchID。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Watch</span><span style=color:#111>(</span><span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>end</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>startRev</span> <span style=color:#00a8c8>int64</span><span style=color:#111>,</span> <span style=color:#75af00>fcs</span> <span style=color:#f92672>...</span><span style=color:#75af00>FilterFunc</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>WatchID</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Chan 返回一个通道。所有的watch响应将被发送到这个返回的通道。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Chan</span><span style=color:#111>()</span> <span style=color:#f92672>&lt;-</span><span style=color:#00a8c8>chan</span> <span style=color:#75af00>WatchResponse</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RequestProgress 请求给定ID的观察者的进度。响应只有在观察者当前同步时才会被发送。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 响应将通过与此流关联的 WatchResponse 通道发送，以确保正确的顺序。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 响应不包含事件。响应中的修订版本是观察者自同步以来的进度。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>RequestProgress</span><span style=color:#111>(</span><span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RequestProgressAll 请求所有共享此流的观察者的进度通知。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果所有观察者都已同步，将向此流的任意观察者发送带有watch ID -1的进度通知，并返回 true。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>RequestProgressAll</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Cancel 通过给定ID取消观察者。如果观察者不存在，将返回错误。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Cancel</span><span style=color:#111>(</span><span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Close 关闭通道并释放所有相关资源。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Rev 返回流上观察到的KV的当前修订版本。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Rev</span><span style=color:#111>()</span> <span style=color:#00a8c8>int64</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WatchResponse 表示一个watch操作的响应。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>WatchResponse</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WatchID 是发送此响应的观察者的ID。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>WatchID</span> <span style=color:#75af00>WatchID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Events 包含所有需要发送的事件。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Events</span> <span style=color:#111>[]</span><span style=color:#75af00>mvccpb</span><span style=color:#111>.</span><span style=color:#75af00>Event</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Revision 是创建watch响应时KV的修订版本。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 对于正常响应，修订版本应该与Events中最后一个修改的修订版本相同。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 对于延迟响应的未同步观察者，修订版本大于Events中最后一个修改的修订版本。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Revision</span> <span style=color:#00a8c8>int64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// CompactRevision 在观察者由于压缩而被取消时设置。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>CompactRevision</span> <span style=color:#00a8c8>int64</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 实现了 WatchStream</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// watchStream 包含共享一个流通道发送被观察事件和其他控制事件的观察者集合。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>watchStream</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 可观察对象（例如KV存储）</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>watchable</span> <span style=color:#75af00>watchable</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 用于发送watch响应的通道</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span>        <span style=color:#00a8c8>chan</span> <span style=color:#75af00>WatchResponse</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 互斥锁，保护以下字段</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>mu</span> <span style=color:#75af00>sync</span><span style=color:#111>.</span><span style=color:#75af00>Mutex</span> 
</span></span><span style=display:flex><span>	<span style=color:#75715e>// nextID 是为此流中下一个新观察者预分配的ID</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>nextID</span>   <span style=color:#75af00>WatchID</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标志流是否已关闭</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>closed</span>   <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 取消函数的映射，用于取消特定的观察者</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cancels</span>  <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span><span style=color:#75af00>cancelFunc</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 观察者的映射，根据观察者ID索引</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>watchers</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#75af00>watcher</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Watch 在流中创建一个新的观察者并返回其 WatchID。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchStream</span><span style=color:#111>)</span> <span style=color:#75af00>Watch</span><span style=color:#111>(</span><span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>,</span> <span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>end</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>startRev</span> <span style=color:#00a8c8>int64</span><span style=color:#111>,</span> <span style=color:#75af00>fcs</span> <span style=color:#f92672>...</span><span style=color:#75af00>FilterFunc</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>WatchID</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 防止键 &gt;= 结束键（按字典顺序）的错误范围</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 带有 &#39;WithFromKey&#39; 的watch请求具有空字节范围结束</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>end</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Compare</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>end</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#75af00>ErrEmptyWatcherRange</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果流已关闭，返回错误</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>closed</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#75af00>ErrEmptyWatcherRange</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 自动生成 WatchID</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>id</span> <span style=color:#f92672>==</span> <span style=color:#75af00>clientv3</span><span style=color:#111>.</span><span style=color:#75af00>AutoWatchID</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>[</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>nextID</span><span style=color:#111>]</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>nextID</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>id</span> <span style=color:#111>=</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>nextID</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>nextID</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>];</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#75af00>ErrWatcherDuplicateID</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建新的观察者</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchable</span><span style=color:#111>.</span><span style=color:#75af00>watch</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>end</span><span style=color:#111>,</span> <span style=color:#75af00>startRev</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>fcs</span><span style=color:#f92672>...</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 保存取消函数和观察者</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>cancels</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>w</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Chan 返回用于接收watch响应的通道。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchStream</span><span style=color:#111>)</span> <span style=color:#75af00>Chan</span><span style=color:#111>()</span> <span style=color:#f92672>&lt;-</span><span style=color:#00a8c8>chan</span> <span style=color:#75af00>WatchResponse</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>ch</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Cancel 取消具有给定ID的观察者。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchStream</span><span style=color:#111>)</span> <span style=color:#75af00>Cancel</span><span style=color:#111>(</span><span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cancel</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>cancels</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>w</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ok</span> <span style=color:#111>=</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>closed</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果观察者不存在或流已关闭，返回错误</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>ErrWatcherNotExist</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cancel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在取消之前不删除观察者，以确保 Close() 调用时等待取消</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>ww</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>];</span> <span style=color:#75af00>ww</span> <span style=color:#f92672>==</span> <span style=color:#75af00>w</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>cancels</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Close 关闭通道并释放所有相关资源。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchStream</span><span style=color:#111>)</span> <span style=color:#75af00>Close</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 取消所有观察者</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>cancels</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>cancel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标记流已关闭并关闭通道</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>closed</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>	<span style=color:#111>close</span><span style=color:#111>(</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>ch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>watchStreamGauge</span><span style=color:#111>.</span><span style=color:#75af00>Dec</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Rev 返回流上观察到的KV的当前修订版本。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchStream</span><span style=color:#111>)</span> <span style=color:#75af00>Rev</span><span style=color:#111>()</span> <span style=color:#00a8c8>int64</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchable</span><span style=color:#111>.</span><span style=color:#75af00>rev</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RequestProgress 请求给定ID的观察者的进度。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchStream</span><span style=color:#111>)</span> <span style=color:#75af00>RequestProgress</span><span style=color:#111>(</span><span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>[</span><span style=color:#75af00>id</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果观察者不存在，直接返回</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 请求进度</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchable</span><span style=color:#111>.</span><span style=color:#75af00>progress</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RequestProgressAll 请求所有观察者的进度通知。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>ws</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchStream</span><span style=color:#111>)</span> <span style=color:#75af00>RequestProgressAll</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchable</span><span style=color:#111>.</span><span style=color:#75af00>progressAll</span><span style=color:#111>(</span><span style=color:#75af00>ws</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><ol><li>Watch 方法：创建一个新的观察者，如果指定的范围不正确或观察者ID重复，则返回错误。否则，创建观察者并保存取消函数和观察者实例。</li><li>Chan 方法：返回用于接收watch响应的通道。</li><li>Cancel 方法：取消给定ID的观察者，删除相关的取消函数和观察者实例。</li><li>Close 方法：关闭所有观察者并释放资源。</li><li>Rev 方法：返回当前观察到的KV修订版本。</li><li>RequestProgress 方法：请求特定观察者的进度。</li><li>RequestProgressAll 方法：请求所有观察者的进度通知。</li></ol><p>可以可到 当调用 Watch 的时候 每个 watchId 都会调用 <code>watchable.watch</code> 并把自己 ch 放入进去</p><h2 id=watchable>watchable</h2><p><img src=/images/ad802824-86e0-42a7-b84d-d2dfe2076620.png alt></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// watchable 接口定义了可观察对象的行为</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>watchable</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// watch 创建一个新的观察者，用于监听指定键或范围[startRev, end)上的事件。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回观察者指针和取消函数。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>watch</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>end</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>startRev</span> <span style=color:#00a8c8>int64</span><span style=color:#111>,</span> <span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>,</span> <span style=color:#75af00>ch</span> <span style=color:#00a8c8>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#75af00>WatchResponse</span><span style=color:#111>,</span> <span style=color:#75af00>fcs</span> <span style=color:#f92672>...</span><span style=color:#75af00>FilterFunc</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>watcher</span><span style=color:#111>,</span> <span style=color:#75af00>cancelFunc</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// progress 通知特定观察者当前的进度。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>progress</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#f92672>*</span><span style=color:#75af00>watcher</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// progressAll 通知所有观察者当前的进度。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果所有观察者都已同步，则返回 true。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>progressAll</span><span style=color:#111>(</span><span style=color:#75af00>watchers</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#75af00>WatchID</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#75af00>watcher</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// rev 返回当前观察到的修订版本。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>rev</span><span style=color:#111>()</span> <span style=color:#00a8c8>int64</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// watchableStore 是一个实现了 watchable 接口的结构体，代表一个可观察的存储</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>watchableStore</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// store 是一个指向基础存储的指针</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span><span style=color:#75af00>store</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mu 保护观察者组和批次。为了避免死锁，在锁定 store.mu 之前不应锁定 mu。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>mu</span> <span style=color:#75af00>sync</span><span style=color:#111>.</span><span style=color:#75af00>RWMutex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// victims 是在 watch 通道上被阻塞的观察者批次</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>victims</span> <span style=color:#111>[]</span><span style=color:#75af00>watcherBatch</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>victimc</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// unsynced 包含所有需要同步已经发生的事件的未同步观察者</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>unsynced</span> <span style=color:#75af00>watcherGroup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// synced 包含所有与存储进度同步的观察者</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 映射的键是观察者监听的键</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>synced</span> <span style=color:#75af00>watcherGroup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// stopc 是一个用于停止操作的通道</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>stopc</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wg 用于等待所有 goroutine 完成</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>wg</span> <span style=color:#75af00>sync</span><span style=color:#111>.</span><span style=color:#75af00>WaitGroup</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchableStore</span><span style=color:#111>)</span> <span style=color:#75af00>watch</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>,</span> <span style=color:#75af00>end</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>startRev</span> <span style=color:#00a8c8>int64</span><span style=color:#111>,</span> <span style=color:#75af00>id</span> <span style=color:#75af00>WatchID</span><span style=color:#111>,</span> <span style=color:#75af00>ch</span> <span style=color:#00a8c8>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#75af00>WatchResponse</span><span style=color:#111>,</span> <span style=color:#75af00>fcs</span> <span style=color:#f92672>...</span><span style=color:#75af00>FilterFunc</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>watcher</span><span style=color:#111>,</span> <span style=color:#75af00>cancelFunc</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建一个新的观察者</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>wa</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>watcher</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>key</span><span style=color:#111>:</span>    <span style=color:#75af00>key</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>end</span><span style=color:#111>:</span>    <span style=color:#75af00>end</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>minRev</span><span style=color:#111>:</span> <span style=color:#75af00>startRev</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>id</span><span style=color:#111>:</span>     <span style=color:#75af00>id</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ch</span><span style=color:#111>:</span>     <span style=color:#75af00>ch</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fcs</span><span style=color:#111>:</span>    <span style=color:#75af00>fcs</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定 watchableStore 的互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定 store 的读写锁用于获取当前修订版本</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>revMu</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断观察者是否与当前存储修订版本同步</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>synced</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>startRev</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>currentRev</span> <span style=color:#f92672>||</span> <span style=color:#75af00>startRev</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>synced</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果同步，设置最小修订版本为当前修订版本的下一个版本</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>wa</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>currentRev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>startRev</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>wa</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>wa</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#111>=</span> <span style=color:#75af00>startRev</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将观察者添加到同步观察者组中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>synced</span><span style=color:#111>.</span><span style=color:#75af00>add</span><span style=color:#111>(</span><span style=color:#75af00>wa</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果未同步，增加慢速观察者计数器</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>slowWatcherGauge</span><span style=color:#111>.</span><span style=color:#75af00>Inc</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将观察者添加到未同步观察者组中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#75af00>add</span><span style=color:#111>(</span><span style=color:#75af00>wa</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 解锁 store 的读写锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>revMu</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 解锁 watchableStore 的互斥锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 增加观察者计数器</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>watcherGauge</span><span style=color:#111>.</span><span style=color:#75af00>Inc</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 返回观察者和取消函数</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>wa</span><span style=color:#111>,</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>cancelWatcher</span><span style=color:#111>(</span><span style=color:#75af00>wa</span><span style=color:#111>)</span> <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=newwatchablestore>newWatchableStore</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>newWatchableStore</span><span style=color:#111>(</span><span style=color:#75af00>lg</span> <span style=color:#f92672>*</span><span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>Logger</span><span style=color:#111>,</span> <span style=color:#75af00>b</span> <span style=color:#75af00>backend</span><span style=color:#111>.</span><span style=color:#75af00>Backend</span><span style=color:#111>,</span> <span style=color:#75af00>le</span> <span style=color:#75af00>lease</span><span style=color:#111>.</span><span style=color:#75af00>Lessor</span><span style=color:#111>,</span> <span style=color:#75af00>cfg</span> <span style=color:#75af00>StoreConfig</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchableStore</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>lg</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lg</span> <span style=color:#111>=</span> <span style=color:#75af00>zap</span><span style=color:#111>.</span><span style=color:#75af00>NewNop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>watchableStore</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>store</span><span style=color:#111>:</span>    <span style=color:#75af00>NewStore</span><span style=color:#111>(</span><span style=color:#75af00>lg</span><span style=color:#111>,</span> <span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>le</span><span style=color:#111>,</span> <span style=color:#75af00>cfg</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>victimc</span><span style=color:#111>:</span>  <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{},</span> <span style=color:#ae81ff>1</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unsynced</span><span style=color:#111>:</span> <span style=color:#75af00>newWatcherGroup</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>synced</span><span style=color:#111>:</span>   <span style=color:#75af00>newWatcherGroup</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stopc</span><span style=color:#111>:</span>    <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}),</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>ReadView</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>readView</span><span style=color:#111>{</span><span style=color:#75af00>s</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>WriteView</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>writeView</span><span style=color:#111>{</span><span style=color:#75af00>s</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>le</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// use this store as the deleter so revokes trigger watch events</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>le</span><span style=color:#111>.</span><span style=color:#75af00>SetRangeDeleter</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#75af00>lease</span><span style=color:#111>.</span><span style=color:#75af00>TxnDelete</span> <span style=color:#111>{</span> <span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>traceutil</span><span style=color:#111>.</span><span style=color:#75af00>TODO</span><span style=color:#111>())</span> <span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>wg</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>syncWatchersLoop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>syncVictimsLoop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=syncwatchersloop>syncWatchersLoop</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// syncWatchersLoop 每100毫秒同步一次unsynced集合中的观察者。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchableStore</span><span style=color:#111>)</span> <span style=color:#75af00>syncWatchersLoop</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>wg</span><span style=color:#111>.</span><span style=color:#75af00>Done</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置等待时间为100毫秒</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>waitDuration</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>delayTicker</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>NewTicker</span><span style=color:#111>(</span><span style=color:#75af00>waitDuration</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>delayTicker</span><span style=color:#111>.</span><span style=color:#75af00>Stop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 锁定以获取未同步观察者的数量</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>st</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Now</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lastUnsyncedWatchers</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#75af00>size</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unsyncedWatchers</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果有未同步观察者，同步这些观察者</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>lastUnsyncedWatchers</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>unsyncedWatchers</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>syncWatchers</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>syncDuration</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Since</span><span style=color:#111>(</span><span style=color:#75af00>st</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 重置定时器</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>delayTicker</span><span style=color:#111>.</span><span style=color:#75af00>Reset</span><span style=color:#111>(</span><span style=color:#75af00>waitDuration</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检查是否有更多待处理的工作</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>unsyncedWatchers</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>lastUnsyncedWatchers</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>unsyncedWatchers</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 公平对待其他存储操作，通过延长时间来避免占用太多资源</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>delayTicker</span><span style=color:#111>.</span><span style=color:#75af00>Reset</span><span style=color:#111>(</span><span style=color:#75af00>syncDuration</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 等待定时器或停止信号</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>delayTicker</span><span style=color:#111>.</span><span style=color:#75af00>C</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>stopc</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// syncWatchers 通过以下步骤同步未同步的观察者：</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  1. 从未同步观察者组中选择一组观察者</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  2. 迭代该组以获取最小修订版本并移除压缩的观察者</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  3. 使用最小修订版本获取所有键值对，并将这些事件发送给观察者</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  4. 从未同步组中移除已同步的观察者，并移动到同步组中</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchableStore</span><span style=color:#111>)</span> <span style=color:#75af00>syncWatchers</span><span style=color:#111>()</span> <span style=color:#00a8c8>int</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果没有未同步观察者，返回0</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#75af00>size</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定存储的读写锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>revMu</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>revMu</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 为了从未同步观察者中找到键值对，我们需要找到最小修订版本</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>curRev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>currentRev</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>compactionRev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>compactMainRev</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 选择一组观察者</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>wg</span><span style=color:#111>,</span> <span style=color:#75af00>minRev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#75af00>choose</span><span style=color:#111>(</span><span style=color:#75af00>maxWatchersPerSync</span><span style=color:#111>,</span> <span style=color:#75af00>curRev</span><span style=color:#111>,</span> <span style=color:#75af00>compactionRev</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>minBytes</span><span style=color:#111>,</span> <span style=color:#75af00>maxBytes</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>NewRevBytes</span><span style=color:#111>(),</span> <span style=color:#75af00>NewRevBytes</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>minBytes</span> <span style=color:#111>=</span> <span style=color:#75af00>RevToBytes</span><span style=color:#111>(</span><span style=color:#75af00>Revision</span><span style=color:#111>{</span><span style=color:#75af00>Main</span><span style=color:#111>:</span> <span style=color:#75af00>minRev</span><span style=color:#111>},</span> <span style=color:#75af00>minBytes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>maxBytes</span> <span style=color:#111>=</span> <span style=color:#75af00>RevToBytes</span><span style=color:#111>(</span><span style=color:#75af00>Revision</span><span style=color:#111>{</span><span style=color:#75af00>Main</span><span style=color:#111>:</span> <span style=color:#75af00>curRev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#111>},</span> <span style=color:#75af00>maxBytes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// UnsafeRange 返回键和值。在boltdb中，键是修订版本，值是实际的键值对。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>tx</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>ReadTx</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>revs</span><span style=color:#111>,</span> <span style=color:#75af00>vs</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>UnsafeRange</span><span style=color:#111>(</span><span style=color:#75af00>schema</span><span style=color:#111>.</span><span style=color:#75af00>Key</span><span style=color:#111>,</span> <span style=color:#75af00>minBytes</span><span style=color:#111>,</span> <span style=color:#75af00>maxBytes</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>evs</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>kvsToEvents</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>lg</span><span style=color:#111>,</span> <span style=color:#75af00>wg</span><span style=color:#111>,</span> <span style=color:#75af00>revs</span><span style=color:#111>,</span> <span style=color:#75af00>vs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 必须在kvsToEvents之后解锁，因为vs（来自boltdb内存）不是深拷贝。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 我们只能在Unmarshal之后解锁，这将进行深拷贝。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 否则我们将在boltdb重新mmap期间触发SIGSEGV。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建一个新的观察者批次</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>victims</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#75af00>watcherBatch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>wb</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>newWatcherBatch</span><span style=color:#111>(</span><span style=color:#75af00>wg</span><span style=color:#111>,</span> <span style=color:#75af00>evs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>w</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>wg</span><span style=color:#111>.</span><span style=color:#75af00>watchers</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>compactionRev</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 跳过因压缩而无法发送响应的观察者</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#111>=</span> <span style=color:#75af00>curRev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>eb</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>wb</span><span style=color:#111>[</span><span style=color:#75af00>w</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 将未通知的观察者移至同步</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>synced</span><span style=color:#111>.</span><span style=color:#75af00>add</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>moreRev</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#111>=</span> <span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>moreRev</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 发送响应</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>{</span><span style=color:#75af00>WatchID</span><span style=color:#111>:</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>Events</span><span style=color:#111>:</span> <span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>evs</span><span style=color:#111>,</span> <span style=color:#75af00>Revision</span><span style=color:#111>:</span> <span style=color:#75af00>curRev</span><span style=color:#111>})</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pendingEventsGauge</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>evs</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>victim</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 处理受害者观察者</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>victim</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>victims</span><span style=color:#111>[</span><span style=color:#75af00>w</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>eb</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>moreRev</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 保持未同步状态；还有更多要读取</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>synced</span><span style=color:#111>.</span><span style=color:#75af00>add</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>addVictim</span><span style=color:#111>(</span><span style=color:#75af00>victims</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新慢速观察者计数器</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>vsz</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>victims</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>vsz</span> <span style=color:#f92672>+=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>slowWatcherGauge</span><span style=color:#111>.</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#75af00>size</span><span style=color:#111>()</span> <span style=color:#f92672>+</span> <span style=color:#75af00>vsz</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#75af00>size</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=watcher--send>watcher & send</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>watcher</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the watcher key</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// end indicates the end of the range to watch.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If end is set, the watcher is on a range.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>end</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// victim is set when ch is blocked and undergoing victim processing</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>victim</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// compacted is set when the watcher is removed because of compaction</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>compacted</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// restore is true when the watcher is being restored from leader snapshot</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// which means that this watcher has just been moved from &#34;synced&#34; to &#34;unsynced&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// watcher group, possibly with a future revision when it was first added</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// to the synced watcher</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// &#34;unsynced&#34; watcher revision must always be &lt;= current revision,</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// except when the watcher were to be moved from &#34;synced&#34; watcher group</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>restore</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// minRev is the minimum revision update the watcher will accept</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>minRev</span> <span style=color:#00a8c8>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>id</span>     <span style=color:#75af00>WatchID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fcs</span> <span style=color:#111>[]</span><span style=color:#75af00>FilterFunc</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// a chan to send out the watch response.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The chan might be shared with other watchers.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span> <span style=color:#00a8c8>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#75af00>WatchResponse</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#f92672>*</span><span style=color:#75af00>watcher</span><span style=color:#111>)</span> <span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>wr</span> <span style=color:#75af00>WatchResponse</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>progressEvent</span> <span style=color:#f92672>:=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>fcs</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ne</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>([]</span><span style=color:#75af00>mvccpb</span><span style=color:#111>.</span><span style=color:#75af00>Event</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>Events</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>filtered</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>filter</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>fcs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>filter</span><span style=color:#111>(</span><span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>])</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>filtered</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>filtered</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>ne</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>ne</span><span style=color:#111>,</span> <span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>Events</span> <span style=color:#111>=</span> <span style=color:#75af00>ne</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// if all events are filtered out, we should send nothing.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>progressEvent</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>wr</span><span style=color:#111>.</span><span style=color:#75af00>Events</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>wr</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>default</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=syncvictimsloop>syncVictimsLoop</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// syncVictimsLoop 尝试将预先计算的观察者响应写入被阻塞的观察者通道</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchableStore</span><span style=color:#111>)</span> <span style=color:#75af00>syncVictimsLoop</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>wg</span><span style=color:#111>.</span><span style=color:#75af00>Done</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 尝试更新所有受害者观察者</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>moveVictims</span><span style=color:#111>()</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 持续更新，直到所有受害者观察者都处理完毕</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检查是否有受害者观察者</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>isEmpty</span> <span style=color:#f92672>:=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>victims</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>var</span> <span style=color:#75af00>tickc</span> <span style=color:#f92672>&lt;-</span><span style=color:#00a8c8>chan</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Time</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>isEmpty</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>tickc</span> <span style=color:#111>=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>After</span><span style=color:#111>(</span><span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 等待10毫秒或收到新的受害者通知或停止信号</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>tickc</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>victimc</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>stopc</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// moveVictims 尝试使用已存在的事件数据更新观察者</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>watchableStore</span><span style=color:#111>)</span> <span style=color:#75af00>moveVictims</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>moved</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>victims</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>victims</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>victims</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>newVictim</span> <span style=color:#75af00>watcherBatch</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>wb</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>victims</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 再次尝试发送响应</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>eb</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>wb</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 观察者已观察到存储，直到但不包括 w.minRev</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>rev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>WatchResponse</span><span style=color:#111>{</span><span style=color:#75af00>WatchID</span><span style=color:#111>:</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>Events</span><span style=color:#111>:</span> <span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>evs</span><span style=color:#111>,</span> <span style=color:#75af00>Revision</span><span style=color:#111>:</span> <span style=color:#75af00>rev</span><span style=color:#111>})</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>pendingEventsGauge</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>evs</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#75af00>newVictim</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>newVictim</span> <span style=color:#111>=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#75af00>watcherBatch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>newVictim</span><span style=color:#111>[</span><span style=color:#75af00>w</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>eb</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>moved</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将完成的受害者观察者分配到未同步/同步组</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>revMu</span><span style=color:#111>.</span><span style=color:#75af00>RLock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>curRev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>currentRev</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>eb</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>wb</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>newVictim</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>newVictim</span><span style=color:#111>[</span><span style=color:#75af00>w</span><span style=color:#111>]</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 无法发送watch响应，仍然是受害者</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>victim</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>moreRev</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#111>=</span> <span style=color:#75af00>eb</span><span style=color:#111>.</span><span style=color:#75af00>moreRev</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>minRev</span> <span style=color:#f92672>&lt;=</span> <span style=color:#75af00>curRev</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>unsynced</span><span style=color:#111>.</span><span style=color:#75af00>add</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>slowWatcherGauge</span><span style=color:#111>.</span><span style=color:#75af00>Dec</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>synced</span><span style=color:#111>.</span><span style=color:#75af00>add</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>store</span><span style=color:#111>.</span><span style=color:#75af00>revMu</span><span style=color:#111>.</span><span style=color:#75af00>RUnlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果仍然有未处理的受害者，重新添加到受害者列表中</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>newVictim</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>victims</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>victims</span><span style=color:#111>,</span> <span style=color:#75af00>newVictim</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>mu</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>moved</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://blog.csdn.net/qq_24433609/article/details/120653747>https://blog.csdn.net/qq_24433609/article/details/120653747</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> etcd watch 实现原理</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/>https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/cloud/etcd_mvcc_storage_structure_and_process/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>etcd MVCC 存储结构及流程</span></div></a><a href=/post/cloud/boltdb_principles/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>boltdb 原理</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#watch-的-api>watch 的 api</a></li><li><a href=#api-实现>api 实现</a><ul><li><a href=#sendloop>sendLoop</a></li><li><a href=#recvloop>recvLoop</a></li></ul></li><li><a href=#watchstream>WatchStream</a></li><li><a href=#watchable>watchable</a><ul><li><a href=#newwatchablestore>newWatchableStore</a></li><li><a href=#syncwatchersloop>syncWatchersLoop</a><ul><li><a href=#watcher--send>watcher & send</a></li></ul></li><li><a href=#syncvictimsloop>syncVictimsLoop</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2025 daemon365</p><p class=powered-by>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a></p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder="Search articles..." autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>Enter 2 or more characters to start searching</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>