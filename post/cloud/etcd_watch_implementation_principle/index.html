<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.136.5"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.ico><meta itemprop=name content="etcd watch 实现原理"><meta itemprop=description content="Don't let yourself stop."><meta name=description content="Don't let yourself stop."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://daemon365.dev/imgs/daemon365.png"><meta itemprop=keywords content="boltdb,etcd,golang,数据库,kubernetes"><meta property="og:type" content="article"><meta property="og:title" content="etcd watch 实现原理"><meta property="og:description" content="Don't let yourself stop."><meta property="og:image" content="/imgs/daemon365.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/"><meta property="og:site_name" content="Daemon"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="daemon365"><meta property="article:published_time" content="2024-06-10 14:16:00 +0800 +0800"><meta property="article:modified_time" content="2024-06-10 14:16:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.d676189b0ac4b63b254e222668b8bedd7d6ba28666e76077ff3b7e23522b4a6d.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"etcd_watch_implementation_principle","permalink":"https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/","title":"etcd watch 实现原理","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JmAHxEAUVgyS8B1c",ck:"JmAHxEAUVgyS8B1c",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>etcd watch 实现原理 - Daemon</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Daemon</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Don't let yourself stop.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives
<span class=badge>93</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>Commonweal</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#watch-的-api>watch 的 api</a></li><li><a href=#api-实现>api 实现</a><ul><li><a href=#sendloop>sendLoop</a></li><li><a href=#recvloop>recvLoop</a></li></ul></li><li><a href=#watchstream>WatchStream</a></li><li><a href=#watchable>watchable</a><ul><li><a href=#newwatchablestore>newWatchableStore</a></li><li><a href=#syncwatchersloop>syncWatchersLoop</a><ul><li><a href=#watcher--send>watcher & send</a></li></ul></li><li><a href=#syncvictimsloop>syncVictimsLoop</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=daemon365 src=/imgs/img-lazy-loading.gif data-src=/imgs/daemon365.png><p class=site-author-name itemprop=name>daemon365</p><div class=site-description itemprop=description>Don't let yourself stop.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>93</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>1</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/daemon365 title="Github → https://github.com/daemon365" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev title=https://go-kratos.dev target=_blank>kratos</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/daemon365.png"><meta itemprop=name content="daemon365"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="daemon365"><meta itemprop=description content="Don't let yourself stop."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="etcd watch 实现原理"><meta itemprop=description content="介绍

在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。"></span><header class=post-header><h1 class=post-title itemprop="name headline">etcd watch 实现原理</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-06-10 14:16:00 +0800 +0800" itemprop="dateCreated datePublished" datetime="2024-06-10 14:16:00 +0800 +0800">2024-06-10</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>5056</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>11分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/cloud/etcd_watch_implementation_principle/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=介绍>介绍
<a class=header-anchor href=#%e4%bb%8b%e7%bb%8d></a></h2><p>在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-BASH data-lang=BASH><span style=display:flex><span>etcdctl watch /test
</span></span><span style=display:flex><span><span style=color:#75715e># 当 /test 的值发生变化时，会输出如下信息</span>
</span></span><span style=display:flex><span>PUT
</span></span><span style=display:flex><span>/test
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>PUT
</span></span><span style=display:flex><span>/test
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span>DELETE
</span></span><span style=display:flex><span>/test
</span></span></code></pre></div><h2 id=watch-的-api>watch 的 api
<a class=header-anchor href=#watch-%e7%9a%84-api></a></h2><p>etcd watch api 是由 grpc stream 实现的，客户端通过 grpc stream 发送 watch 请求，etcd 会将 key 的变化通过 stream 返回给客户端。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>rpc</span> Watch(stream WatchRequest) <span style=color:#66d9ef>returns</span> (stream WatchResponse) {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#66d9ef>option</span> (google.api.http) <span style=color:#f92672>=</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        post<span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/v3/watch&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        body<span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;*&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    };<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=api-实现>api 实现
<a class=header-anchor href=#api-%e5%ae%9e%e7%8e%b0></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchServer</span>) <span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>stream</span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>Watch_WatchServer</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sws</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>serverWatchStream</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lg</span>: <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>lg</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>clusterID</span>: <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>clusterID</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>memberID</span>:  <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>memberID</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>maxRequestBytes</span>: <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>maxRequestBytes</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>:        <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>sg</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>watchable</span>: <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchable</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ag</span>:        <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>ag</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gRPCStream</span>:  <span style=color:#a6e22e>stream</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>watchStream</span>: <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchable</span>.<span style=color:#a6e22e>NewWatchStream</span>(),
</span></span><span style=display:flex><span>		<span style=color:#75715e>// chan for sending control response like watcher created and canceled.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>ctrlStream</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchResponse</span>, <span style=color:#a6e22e>ctrlStreamBufLen</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>progress</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>]<span style=color:#66d9ef>bool</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prevKV</span>:   make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>]<span style=color:#66d9ef>bool</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fragment</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>]<span style=color:#66d9ef>bool</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>closec</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启一个 goroutine 处理新的 event 然后发送给客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>sendLoop</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>errc</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启一个 goroutine 处理客户端发送的 watch 请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rerr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>recvLoop</span>(); <span style=color:#a6e22e>rerr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isClientCtxErr</span>(<span style=color:#a6e22e>stream</span>.<span style=color:#a6e22e>Context</span>().<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>rerr</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;failed to receive watch request from gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>rerr</span>))
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;failed to receive watch request from gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>rerr</span>))
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>streamFailures</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;receive&#34;</span>, <span style=color:#e6db74>&#34;watch&#34;</span>).<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>errc</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rerr</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 处理结束
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> = <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errc</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Canceled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>rpctypes</span>.<span style=color:#a6e22e>ErrGRPCWatchCanceled</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		close(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>ctrlStream</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>stream</span>.<span style=color:#a6e22e>Context</span>().<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>stream</span>.<span style=color:#a6e22e>Context</span>().<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Canceled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>rpctypes</span>.<span style=color:#a6e22e>ErrGRPCWatchCanceled</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sws</span>.close()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里 主要的逻辑是开启两个 goroutine，一个用于处理客户端发送的 watch 请求，另一个用于处理新的 event 然后发送给客户端。</p><h3 id=sendloop>sendLoop
<a class=header-anchor href=#sendloop></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverWatchStream</span>) <span style=color:#a6e22e>sendLoop</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// watch ids that are currently active
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ids</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>]<span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>	<span style=color:#75715e>// watch responses pending on a watch id creation message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pending</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchResponse</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>interval</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetProgressReportInterval</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>progressTicker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>interval</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>progressTicker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 清空chan ，清理待处理 event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>ws</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>Chan</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>ReportEventReceived</span>(len(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>Events</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>wrs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pending</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ws</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>wrs</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>ReportEventReceived</span>(len(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>Events</span>))
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>wresp</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>Chan</span>():
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 从 watchStream.Chan() 中获取 event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// 然后发送给客户端 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>evs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>Events</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>events</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>mvccpb</span>.<span style=color:#a6e22e>Event</span>, len(<span style=color:#a6e22e>evs</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>needPrevKV</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>prevKV</span>[<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>]
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>evs</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>evs</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>needPrevKV</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>IsCreateEvent</span>(<span style=color:#a6e22e>evs</span>[<span style=color:#a6e22e>i</span>]) {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>RangeOptions</span>{<span style=color:#a6e22e>Rev</span>: <span style=color:#a6e22e>evs</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Kv</span>.<span style=color:#a6e22e>ModRevision</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchable</span>.<span style=color:#a6e22e>Range</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#a6e22e>evs</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Kv</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>opt</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>KVs</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>PrevKv</span> = <span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>KVs</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>canceled</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>CompactRevision</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wr</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchResponse</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Header</span>:          <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>newResponseHeader</span>(<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>Revision</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>WatchId</span>:         int64(<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Events</span>:          <span style=color:#a6e22e>events</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>CompactRevision</span>: <span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>CompactRevision</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Canceled</span>:        <span style=color:#a6e22e>canceled</span>,
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Progress notifications can have WatchID -1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// if they announce on behalf of multiple watchers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>InvalidWatchID</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>okID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ids</span>[<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>]; !<span style=color:#a6e22e>okID</span> {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// buffer if id not yet announced
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>wrs</span> <span style=color:#f92672>:=</span> append(<span style=color:#a6e22e>pending</span>[<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>], <span style=color:#a6e22e>wr</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>pending</span>[<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>] = <span style=color:#a6e22e>wrs</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>ReportEventReceived</span>(len(<span style=color:#a6e22e>evs</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fragmented</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>fragment</span>[<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>]
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>serr</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// gofail: var beforeSendWatchResponse struct{}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>fragmented</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>serr</span> = <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>wr</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>serr</span> = <span style=color:#a6e22e>sendFragments</span>(<span style=color:#a6e22e>wr</span>, <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>maxRequestBytes</span>, <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Send</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>serr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isClientCtxErr</span>(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Context</span>().<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>serr</span>) {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;failed to send watch response to gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>serr</span>))
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;failed to send watch response to gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>serr</span>))
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>streamFailures</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;send&#34;</span>, <span style=color:#e6db74>&#34;watch&#34;</span>).<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>evs</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>progress</span>[<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>] {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// elide next progress update if sent a key update
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>progress</span>[<span style=color:#a6e22e>wresp</span>.<span style=color:#a6e22e>WatchID</span>] = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>ctrlStream</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理客户端发送的 watch 请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>c</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isClientCtxErr</span>(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Context</span>().<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;failed to send watch control response to gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;failed to send watch control response to gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>streamFailures</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;send&#34;</span>, <span style=color:#e6db74>&#34;watch&#34;</span>).<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// track id creation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>wid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>WatchId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>verify</span>.<span style=color:#a6e22e>Assert</span>(!(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Canceled</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Created</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>wid</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>InvalidWatchID</span>, <span style=color:#e6db74>&#34;unexpected watchId: %d, wanted: %d, since both &#39;Canceled&#39; and &#39;Created&#39; are true&#34;</span>, <span style=color:#a6e22e>wid</span>, <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>InvalidWatchID</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Canceled</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>wid</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>InvalidWatchID</span> {
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>ids</span>, <span style=color:#a6e22e>wid</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Created</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// flush buffered events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>ids</span>[<span style=color:#a6e22e>wid</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pending</span>[<span style=color:#a6e22e>wid</span>] {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>ReportEventReceived</span>(len(<span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Events</span>))
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>v</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isClientCtxErr</span>(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Context</span>().<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;failed to send pending watch response to gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>						} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;failed to send pending watch response to gRPC stream&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>streamFailures</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;send&#34;</span>, <span style=color:#e6db74>&#34;watch&#34;</span>).<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>pending</span>, <span style=color:#a6e22e>wid</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>progressTicker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>progress</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>RequestProgress</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>progress</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>closec</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里使用了 for select 循环：</p><ol><li>从 watchStream.Chan() 中获取 event 然后发送给客户端。</li><li>处理客户端发送的 watch 请求。</li><li>dispatch progress 事件。</li><li>处理结束。</li></ol><h3 id=recvloop>recvLoop
<a class=header-anchor href=#recvloop></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverWatchStream</span>) <span style=color:#a6e22e>recvLoop</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>gRPCStream</span>.<span style=color:#a6e22e>Recv</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>uv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>RequestUnion</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchRequest_CreateRequest</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>uv</span>.<span style=color:#a6e22e>CreateRequest</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>creq</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>uv</span>.<span style=color:#a6e22e>CreateRequest</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>Key</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// \x00 is the smallest key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>Key</span> = []<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>0</span>}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>RangeEnd</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// force nil since watchstream.Watch distinguishes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// between nil and []byte{} for single key / &gt;=
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>RangeEnd</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>RangeEnd</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>RangeEnd</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// support  &gt;= key queries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>RangeEnd</span> = []<span style=color:#66d9ef>byte</span>{}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>isWatchPermitted</span>(<span style=color:#a6e22e>creq</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cancelReason</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>err</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>ErrInvalidAuthToken</span>:
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>cancelReason</span> = <span style=color:#a6e22e>rpctypes</span>.<span style=color:#a6e22e>ErrGRPCInvalidAuthToken</span>.<span style=color:#a6e22e>Error</span>()
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>ErrAuthOldRevision</span>:
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>cancelReason</span> = <span style=color:#a6e22e>rpctypes</span>.<span style=color:#a6e22e>ErrGRPCAuthOldRevision</span>.<span style=color:#a6e22e>Error</span>()
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>ErrUserEmpty</span>:
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>cancelReason</span> = <span style=color:#a6e22e>rpctypes</span>.<span style=color:#a6e22e>ErrGRPCUserEmpty</span>.<span style=color:#a6e22e>Error</span>()
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>ErrPermissionDenied</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;unexpected error code&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>cancelReason</span> = <span style=color:#a6e22e>rpctypes</span>.<span style=color:#a6e22e>ErrGRPCPermissionDenied</span>.<span style=color:#a6e22e>Error</span>()
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>wr</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchResponse</span>{
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Header</span>:       <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>newResponseHeader</span>(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>Rev</span>()),
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>WatchId</span>:      <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>InvalidWatchID</span>,
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Canceled</span>:     <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Created</span>:      <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>CancelReason</span>: <span style=color:#a6e22e>cancelReason</span>,
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>ctrlStream</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>wr</span>:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>closec</span>:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filters</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FiltersFromRequest</span>(<span style=color:#a6e22e>creq</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wsrev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>Rev</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>rev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>StartRevision</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rev</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>rev</span> = <span style=color:#a6e22e>wsrev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>(<span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>WatchId</span>), <span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>RangeEnd</span>, <span style=color:#a6e22e>rev</span>, <span style=color:#a6e22e>filters</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>ProgressNotify</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>progress</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>PrevKv</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>prevKV</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>creq</span>.<span style=color:#a6e22e>Fragment</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>fragment</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>InvalidWatchID</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wr</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchResponse</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Header</span>:   <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>newResponseHeader</span>(<span style=color:#a6e22e>wsrev</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>WatchId</span>:  int64(<span style=color:#a6e22e>id</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Created</span>:  <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Canceled</span>: <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>CancelReason</span> = <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>ctrlStream</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>wr</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>closec</span>:
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchRequest_CancelRequest</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>uv</span>.<span style=color:#a6e22e>CancelRequest</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>id</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>uv</span>.<span style=color:#a6e22e>CancelRequest</span>.<span style=color:#a6e22e>WatchId</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>Cancel</span>(<span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>(<span style=color:#a6e22e>id</span>))
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>ctrlStream</span> <span style=color:#f92672>&lt;-</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchResponse</span>{
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>Header</span>:   <span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>newResponseHeader</span>(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>Rev</span>()),
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>WatchId</span>:  <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>Canceled</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>					delete(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>progress</span>, <span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>(<span style=color:#a6e22e>id</span>))
</span></span><span style=display:flex><span>					delete(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>prevKV</span>, <span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>(<span style=color:#a6e22e>id</span>))
</span></span><span style=display:flex><span>					delete(<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>fragment</span>, <span style=color:#a6e22e>mvcc</span>.<span style=color:#a6e22e>WatchID</span>(<span style=color:#a6e22e>id</span>))
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>WatchRequest_ProgressRequest</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>uv</span>.<span style=color:#a6e22e>ProgressRequest</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>watchStream</span>.<span style=color:#a6e22e>RequestProgressAll</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// we probably should not shutdown the entire stream when
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// receive an invalid command.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// so just do nothing instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>sws</span>.<span style=color:#a6e22e>lg</span>.<span style=color:#a6e22e>Sugar</span>().<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;invalid watch request type %T received in gRPC stream&#34;</span>, <span style=color:#a6e22e>uv</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里主要处理客户端发送的 watch 请求，然后发送给 ctrlStream。sendLoop 会从 ctrlStream 中获取 event 然后发送给客户端。</p><h2 id=watchstream>WatchStream
<a class=header-anchor href=#watchstream></a></h2><p>这个 inferface 才是处理 watch 的主要逻辑</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// WatchStream 是一个接口，定义了一个流式处理watch请求的机制
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WatchStream</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Watch 创建一个观察者。观察者会监听在给定的键或范围 [key, end) 上发生的事件或已发生的事件。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 整个事件历史都可以被观察到，除非被压缩。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 如果 &#34;startRev&#34; &lt;= 0，watch 将观察在当前修订版本之后的事件。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 返回的 &#34;id&#34; 是这个观察者的ID。它作为 WatchID 出现在通过 stream 通道发送到创建的观察者的事件中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 当 WatchID 不等于 AutoWatchID 时，使用指定的 WatchID，否则返回自动生成的 WatchID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>end</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>startRev</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>fcs</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>FilterFunc</span>) (<span style=color:#a6e22e>WatchID</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Chan 返回一个通道。所有的watch响应将被发送到这个返回的通道。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Chan</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>WatchResponse</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RequestProgress 请求给定ID的观察者的进度。响应只有在观察者当前同步时才会被发送。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 响应将通过与此流关联的 WatchResponse 通道发送，以确保正确的顺序。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 响应不包含事件。响应中的修订版本是观察者自同步以来的进度。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>RequestProgress</span>(<span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RequestProgressAll 请求所有共享此流的观察者的进度通知。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 如果所有观察者都已同步，将向此流的任意观察者发送带有watch ID -1的进度通知，并返回 true。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>RequestProgressAll</span>() <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Cancel 通过给定ID取消观察者。如果观察者不存在，将返回错误。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Cancel</span>(<span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Close 关闭通道并释放所有相关资源。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Rev 返回流上观察到的KV的当前修订版本。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Rev</span>() <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WatchResponse 表示一个watch操作的响应。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WatchResponse</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WatchID 是发送此响应的观察者的ID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>WatchID</span> <span style=color:#a6e22e>WatchID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Events 包含所有需要发送的事件。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Events</span> []<span style=color:#a6e22e>mvccpb</span>.<span style=color:#a6e22e>Event</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Revision 是创建watch响应时KV的修订版本。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 对于正常响应，修订版本应该与Events中最后一个修改的修订版本相同。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 对于延迟响应的未同步观察者，修订版本大于Events中最后一个修改的修订版本。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Revision</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// CompactRevision 在观察者由于压缩而被取消时设置。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CompactRevision</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 实现了 WatchStream
</span></span></span><span style=display:flex><span><span style=color:#75715e>// watchStream 包含共享一个流通道发送被观察事件和其他控制事件的观察者集合。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>watchStream</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 可观察对象（例如KV存储）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>watchable</span> <span style=color:#a6e22e>watchable</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 用于发送watch响应的通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ch</span>        <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>WatchResponse</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 互斥锁，保护以下字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mu</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span> 
</span></span><span style=display:flex><span>	<span style=color:#75715e>// nextID 是为此流中下一个新观察者预分配的ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>nextID</span>   <span style=color:#a6e22e>WatchID</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标志流是否已关闭
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>closed</span>   <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 取消函数的映射，用于取消特定的观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>cancels</span>  <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>WatchID</span>]<span style=color:#a6e22e>cancelFunc</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 观察者的映射，根据观察者ID索引
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>watchers</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>WatchID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>watcher</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Watch 在流中创建一个新的观察者并返回其 WatchID。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchStream</span>) <span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>end</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>startRev</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>fcs</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>FilterFunc</span>) (<span style=color:#a6e22e>WatchID</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 防止键 &gt;= 结束键（按字典顺序）的错误范围
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 带有 &#39;WithFromKey&#39; 的watch请求具有空字节范围结束
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>end</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>end</span>) <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>ErrEmptyWatcherRange</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果流已关闭，返回错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>closed</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>ErrEmptyWatcherRange</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 自动生成 WatchID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>AutoWatchID</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>nextID</span>] <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>nextID</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>nextID</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>nextID</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>id</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>ErrWatcherDuplicateID</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建新的观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchable</span>.<span style=color:#a6e22e>watch</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>end</span>, <span style=color:#a6e22e>startRev</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>fcs</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 保存取消函数和观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>cancels</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#a6e22e>w</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>id</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Chan 返回用于接收watch响应的通道。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchStream</span>) <span style=color:#a6e22e>Chan</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>WatchResponse</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Cancel 取消具有给定ID的观察者。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchStream</span>) <span style=color:#a6e22e>Cancel</span>(<span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cancel</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>cancels</span>[<span style=color:#a6e22e>id</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>id</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ok</span> = <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>closed</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果观察者不存在或流已关闭，返回错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrWatcherNotExist</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在取消之前不删除观察者，以确保 Close() 调用时等待取消
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ww</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>id</span>]; <span style=color:#a6e22e>ww</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>w</span> {
</span></span><span style=display:flex><span>		delete(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>cancels</span>, <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>		delete(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>, <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Close 关闭通道并释放所有相关资源。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchStream</span>) <span style=color:#a6e22e>Close</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 取消所有观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>cancels</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标记流已关闭并关闭通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>closed</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	close(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>watchStreamGauge</span>.<span style=color:#a6e22e>Dec</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// Rev 返回流上观察到的KV的当前修订版本。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchStream</span>) <span style=color:#a6e22e>Rev</span>() <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchable</span>.<span style=color:#a6e22e>rev</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// RequestProgress 请求给定ID的观察者的进度。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchStream</span>) <span style=color:#a6e22e>RequestProgress</span>(<span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>id</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果观察者不存在，直接返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 请求进度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchable</span>.<span style=color:#a6e22e>progress</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// RequestProgressAll 请求所有观察者的进度通知。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ws</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchStream</span>) <span style=color:#a6e22e>RequestProgressAll</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchable</span>.<span style=color:#a6e22e>progressAll</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>watchers</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>Watch 方法：创建一个新的观察者，如果指定的范围不正确或观察者ID重复，则返回错误。否则，创建观察者并保存取消函数和观察者实例。</li><li>Chan 方法：返回用于接收watch响应的通道。</li><li>Cancel 方法：取消给定ID的观察者，删除相关的取消函数和观察者实例。</li><li>Close 方法：关闭所有观察者并释放资源。</li><li>Rev 方法：返回当前观察到的KV修订版本。</li><li>RequestProgress 方法：请求特定观察者的进度。</li><li>RequestProgressAll 方法：请求所有观察者的进度通知。</li></ol><p>可以可到 当调用 Watch 的时候 每个 watchId 都会调用 <code>watchable.watch</code> 并把自己 ch 放入进去</p><h2 id=watchable>watchable
<a class=header-anchor href=#watchable></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/images/ad802824-86e0-42a7-b84d-d2dfe2076620.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// watchable 接口定义了可观察对象的行为
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>watchable</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// watch 创建一个新的观察者，用于监听指定键或范围[startRev, end)上的事件。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 返回观察者指针和取消函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>watch</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>end</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>startRev</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>, <span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>WatchResponse</span>, <span style=color:#a6e22e>fcs</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>FilterFunc</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>watcher</span>, <span style=color:#a6e22e>cancelFunc</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// progress 通知特定观察者当前的进度。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>progress</span>(<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watcher</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// progressAll 通知所有观察者当前的进度。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 如果所有观察者都已同步，则返回 true。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>progressAll</span>(<span style=color:#a6e22e>watchers</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>WatchID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>watcher</span>) <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// rev 返回当前观察到的修订版本。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rev</span>() <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// watchableStore 是一个实现了 watchable 接口的结构体，代表一个可观察的存储
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>watchableStore</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// store 是一个指向基础存储的指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>store</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// mu 保护观察者组和批次。为了避免死锁，在锁定 store.mu 之前不应锁定 mu。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mu</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// victims 是在 watch 通道上被阻塞的观察者批次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>victims</span> []<span style=color:#a6e22e>watcherBatch</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>victimc</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// unsynced 包含所有需要同步已经发生的事件的未同步观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>unsynced</span> <span style=color:#a6e22e>watcherGroup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// synced 包含所有与存储进度同步的观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 映射的键是观察者监听的键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>synced</span> <span style=color:#a6e22e>watcherGroup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// stopc 是一个用于停止操作的通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>stopc</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wg 用于等待所有 goroutine 完成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchableStore</span>) <span style=color:#a6e22e>watch</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>end</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>startRev</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>id</span> <span style=color:#a6e22e>WatchID</span>, <span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>WatchResponse</span>, <span style=color:#a6e22e>fcs</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>FilterFunc</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>watcher</span>, <span style=color:#a6e22e>cancelFunc</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建一个新的观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>wa</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>watcher</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>key</span>:    <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>end</span>:    <span style=color:#a6e22e>end</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>minRev</span>: <span style=color:#a6e22e>startRev</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>id</span>:     <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ch</span>:     <span style=color:#a6e22e>ch</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fcs</span>:    <span style=color:#a6e22e>fcs</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定 watchableStore 的互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定 store 的读写锁用于获取当前修订版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>revMu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断观察者是否与当前存储修订版本同步
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>synced</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>startRev</span> &gt; <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>currentRev</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>startRev</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>synced</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果同步，设置最小修订版本为当前修订版本的下一个版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>wa</span>.<span style=color:#a6e22e>minRev</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>currentRev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>startRev</span> &gt; <span style=color:#a6e22e>wa</span>.<span style=color:#a6e22e>minRev</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wa</span>.<span style=color:#a6e22e>minRev</span> = <span style=color:#a6e22e>startRev</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将观察者添加到同步观察者组中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>synced</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>wa</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果未同步，增加慢速观察者计数器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>slowWatcherGauge</span>.<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将观察者添加到未同步观察者组中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>wa</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 解锁 store 的读写锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>revMu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 解锁 watchableStore 的互斥锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 增加观察者计数器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>watcherGauge</span>.<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 返回观察者和取消函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>wa</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>cancelWatcher</span>(<span style=color:#a6e22e>wa</span>) }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=newwatchablestore>newWatchableStore
<a class=header-anchor href=#newwatchablestore></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newWatchableStore</span>(<span style=color:#a6e22e>lg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Logger</span>, <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>backend</span>.<span style=color:#a6e22e>Backend</span>, <span style=color:#a6e22e>le</span> <span style=color:#a6e22e>lease</span>.<span style=color:#a6e22e>Lessor</span>, <span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>StoreConfig</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>watchableStore</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lg</span> = <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>NewNop</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>watchableStore</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>store</span>:    <span style=color:#a6e22e>NewStore</span>(<span style=color:#a6e22e>lg</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>le</span>, <span style=color:#a6e22e>cfg</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>victimc</span>:  make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unsynced</span>: <span style=color:#a6e22e>newWatcherGroup</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>synced</span>:   <span style=color:#a6e22e>newWatcherGroup</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>stopc</span>:    make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>ReadView</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>readView</span>{<span style=color:#a6e22e>s</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>WriteView</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>writeView</span>{<span style=color:#a6e22e>s</span>}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>le</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// use this store as the deleter so revokes trigger watch events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>le</span>.<span style=color:#a6e22e>SetRangeDeleter</span>(<span style=color:#66d9ef>func</span>() <span style=color:#a6e22e>lease</span>.<span style=color:#a6e22e>TxnDelete</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>traceutil</span>.<span style=color:#a6e22e>TODO</span>()) })
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>syncWatchersLoop</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>syncVictimsLoop</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=syncwatchersloop>syncWatchersLoop
<a class=header-anchor href=#syncwatchersloop></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// syncWatchersLoop 每100毫秒同步一次unsynced集合中的观察者。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchableStore</span>) <span style=color:#a6e22e>syncWatchersLoop</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置等待时间为100毫秒
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>waitDuration</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>delayTicker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>waitDuration</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>delayTicker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 锁定以获取未同步观察者的数量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>st</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lastUnsyncedWatchers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.<span style=color:#a6e22e>size</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unsyncedWatchers</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果有未同步观察者，同步这些观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastUnsyncedWatchers</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unsyncedWatchers</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>syncWatchers</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>syncDuration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>st</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 重置定时器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>delayTicker</span>.<span style=color:#a6e22e>Reset</span>(<span style=color:#a6e22e>waitDuration</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检查是否有更多待处理的工作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>unsyncedWatchers</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>lastUnsyncedWatchers</span> &gt; <span style=color:#a6e22e>unsyncedWatchers</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 公平对待其他存储操作，通过延长时间来避免占用太多资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>delayTicker</span>.<span style=color:#a6e22e>Reset</span>(<span style=color:#a6e22e>syncDuration</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 等待定时器或停止信号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>delayTicker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>stopc</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// syncWatchers 通过以下步骤同步未同步的观察者：
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  1. 从未同步观察者组中选择一组观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  2. 迭代该组以获取最小修订版本并移除压缩的观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  3. 使用最小修订版本获取所有键值对，并将这些事件发送给观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  4. 从未同步组中移除已同步的观察者，并移动到同步组中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchableStore</span>) <span style=color:#a6e22e>syncWatchers</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果没有未同步观察者，返回0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 锁定存储的读写锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>revMu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>revMu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 为了从未同步观察者中找到键值对，我们需要找到最小修订版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>curRev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>currentRev</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>compactionRev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>compactMainRev</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 选择一组观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>minRev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.<span style=color:#a6e22e>choose</span>(<span style=color:#a6e22e>maxWatchersPerSync</span>, <span style=color:#a6e22e>curRev</span>, <span style=color:#a6e22e>compactionRev</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>minBytes</span>, <span style=color:#a6e22e>maxBytes</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRevBytes</span>(), <span style=color:#a6e22e>NewRevBytes</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>minBytes</span> = <span style=color:#a6e22e>RevToBytes</span>(<span style=color:#a6e22e>Revision</span>{<span style=color:#a6e22e>Main</span>: <span style=color:#a6e22e>minRev</span>}, <span style=color:#a6e22e>minBytes</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>maxBytes</span> = <span style=color:#a6e22e>RevToBytes</span>(<span style=color:#a6e22e>Revision</span>{<span style=color:#a6e22e>Main</span>: <span style=color:#a6e22e>curRev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>}, <span style=color:#a6e22e>maxBytes</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// UnsafeRange 返回键和值。在boltdb中，键是修订版本，值是实际的键值对。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ReadTx</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>revs</span>, <span style=color:#a6e22e>vs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>UnsafeRange</span>(<span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>minBytes</span>, <span style=color:#a6e22e>maxBytes</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>evs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kvsToEvents</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>lg</span>, <span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>revs</span>, <span style=color:#a6e22e>vs</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 必须在kvsToEvents之后解锁，因为vs（来自boltdb内存）不是深拷贝。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 我们只能在Unmarshal之后解锁，这将进行深拷贝。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 否则我们将在boltdb重新mmap期间触发SIGSEGV。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建一个新的观察者批次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>victims</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>watcherBatch</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newWatcherBatch</span>(<span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>evs</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>watchers</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>minRev</span> &lt; <span style=color:#a6e22e>compactionRev</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 跳过因压缩而无法发送响应的观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>minRev</span> = <span style=color:#a6e22e>curRev</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eb</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>wb</span>[<span style=color:#a6e22e>w</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 将未通知的观察者移至同步
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>synced</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.delete(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>moreRev</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>minRev</span> = <span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>moreRev</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 发送响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>WatchResponse</span>{<span style=color:#a6e22e>WatchID</span>: <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>Events</span>: <span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>evs</span>, <span style=color:#a6e22e>Revision</span>: <span style=color:#a6e22e>curRev</span>}) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pendingEventsGauge</span>.<span style=color:#a6e22e>Add</span>(float64(len(<span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>evs</span>)))
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>victim</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 处理受害者观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>victim</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>victims</span>[<span style=color:#a6e22e>w</span>] = <span style=color:#a6e22e>eb</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>moreRev</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 保持未同步状态；还有更多要读取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>synced</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.delete(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>addVictim</span>(<span style=color:#a6e22e>victims</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 更新慢速观察者计数器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>vsz</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>victims</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vsz</span> <span style=color:#f92672>+=</span> len(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slowWatcherGauge</span>.<span style=color:#a6e22e>Set</span>(float64(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>vsz</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.<span style=color:#a6e22e>size</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=watcher--send>watcher & send
<a class=header-anchor href=#watcher--send></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>watcher</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the watcher key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// end indicates the end of the range to watch.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// If end is set, the watcher is on a range.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>end</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// victim is set when ch is blocked and undergoing victim processing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>victim</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// compacted is set when the watcher is removed because of compaction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>compacted</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// restore is true when the watcher is being restored from leader snapshot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// which means that this watcher has just been moved from &#34;synced&#34; to &#34;unsynced&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// watcher group, possibly with a future revision when it was first added
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// to the synced watcher
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// &#34;unsynced&#34; watcher revision must always be &lt;= current revision,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// except when the watcher were to be moved from &#34;synced&#34; watcher group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>restore</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// minRev is the minimum revision update the watcher will accept
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>minRev</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>id</span>     <span style=color:#a6e22e>WatchID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fcs</span> []<span style=color:#a6e22e>FilterFunc</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// a chan to send out the watch response.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// The chan might be shared with other watchers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>WatchResponse</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watcher</span>) <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>wr</span> <span style=color:#a6e22e>WatchResponse</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>progressEvent</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Events</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>fcs</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ne</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>mvccpb</span>.<span style=color:#a6e22e>Event</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Events</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Events</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filtered</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>filter</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>fcs</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Events</span>[<span style=color:#a6e22e>i</span>]) {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>filtered</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>filtered</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ne</span> = append(<span style=color:#a6e22e>ne</span>, <span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Events</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Events</span> = <span style=color:#a6e22e>ne</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// if all events are filtered out, we should send nothing.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>progressEvent</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Events</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>wr</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=syncvictimsloop>syncVictimsLoop
<a class=header-anchor href=#syncvictimsloop></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// syncVictimsLoop 尝试将预先计算的观察者响应写入被阻塞的观察者通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchableStore</span>) <span style=color:#a6e22e>syncVictimsLoop</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 尝试更新所有受害者观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>moveVictims</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 持续更新，直到所有受害者观察者都处理完毕
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检查是否有受害者观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>isEmpty</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>victims</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tickc</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isEmpty</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>tickc</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 等待10毫秒或收到新的受害者通知或停止信号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>tickc</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>victimc</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>stopc</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// moveVictims 尝试使用已存在的事件数据更新观察者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>watchableStore</span>) <span style=color:#a6e22e>moveVictims</span>() (<span style=color:#a6e22e>moved</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>victims</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>victims</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>victims</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>newVictim</span> <span style=color:#a6e22e>watcherBatch</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>wb</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>victims</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 再次尝试发送响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>eb</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>wb</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 观察者已观察到存储，直到但不包括 w.minRev
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>rev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>minRev</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>WatchResponse</span>{<span style=color:#a6e22e>WatchID</span>: <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>Events</span>: <span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>evs</span>, <span style=color:#a6e22e>Revision</span>: <span style=color:#a6e22e>rev</span>}) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>pendingEventsGauge</span>.<span style=color:#a6e22e>Add</span>(float64(len(<span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>evs</span>)))
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newVictim</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>newVictim</span> = make(<span style=color:#a6e22e>watcherBatch</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>newVictim</span>[<span style=color:#a6e22e>w</span>] = <span style=color:#a6e22e>eb</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>moved</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将完成的受害者观察者分配到未同步/同步组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>revMu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>curRev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>currentRev</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>eb</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>wb</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newVictim</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>newVictim</span>[<span style=color:#a6e22e>w</span>] <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 无法发送watch响应，仍然是受害者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>victim</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>moreRev</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>minRev</span> = <span style=color:#a6e22e>eb</span>.<span style=color:#a6e22e>moreRev</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>minRev</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>curRev</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>unsynced</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>slowWatcherGauge</span>.<span style=color:#a6e22e>Dec</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>synced</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>revMu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果仍然有未处理的受害者，重新添加到受害者列表中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>newVictim</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>victims</span> = append(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>victims</span>, <span style=color:#a6e22e>newVictim</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>moved</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=reference>Reference
<a class=header-anchor href=#reference></a></h2><ul><li><a href=https://blog.csdn.net/qq_24433609/article/details/120653747 title=https://blog.csdn.net/qq_24433609/article/details/120653747 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/qq_24433609/article/details/120653747
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/boltdb>boltdb
</a><a href=/tags/etcd>etcd
</a><a href=/tags/golang>golang
</a><a href=/tags/%e6%95%b0%e6%8d%ae%e5%ba%93>数据库
</a><a href=/tags/kubernetes>kubernetes</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
etcd watch 实现原理</li><li class=post-copyright-author><strong>本文作者： </strong>daemon365</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/ title="etcd watch 实现原理">https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/cloud/boltdb_principles/ rel=next title="boltdb 原理"><i class="fa fa-chevron-left"></i> boltdb 原理</a></div><div class="post-nav-prev post-nav-item"><a href=/post/cloud/etcd_mvcc_storage_structure_and_process/ rel=prev title="etcd MVCC 存储结构及流程">etcd MVCC 存储结构及流程
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>daemon365</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.136.5 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://daemon365.dev/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://daemon365.dev/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"JmAHxEAUVgyS8B1c","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"daemon365/blog","theme":"preferred-color-scheme"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://daemon365.dev/3rd"}},"version":"4.6.3"}</script><script type=text/javascript src=/js/main.min.44e8f3a116669418a0551fcbff81fe26c85707505ea0b87a42f2d4116994b442.js defer></script></body></html>