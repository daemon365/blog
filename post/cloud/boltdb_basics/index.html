<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>boltdb 介绍 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="介绍
BoltDB 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：

键/值存储: BoltDB 为应用程序提供了简单的键/值存储接口。
事务: BoltDB 支持完整的 ACID 事务。
嵌入式: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同 …"><meta name=keywords content="boltdb,etcd,golang,数据库,kubernetes"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/cloud/boltdb_basics/"><meta property="og:title" content="boltdb 介绍 - Daemon365"><meta property="og:description" content="介绍
BoltDB 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：

键/值存储: BoltDB 为应用程序提供了简单的键/值存储接口。
事务: BoltDB 支持完整的 ACID 事务。
嵌入式: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2024-05-08T20:56:00+08:00"><meta property="article:modified_time" content="2024-05-08T20:56:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="cloud"><meta property="article:tag" content="boltdb"><meta property="article:tag" content="etcd"><meta property="article:tag" content="golang"><meta property="article:tag" content="数据库"><meta property="article:tag" content="kubernetes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/cloud/boltdb_basics/"><meta name=twitter:title content="boltdb 介绍 - Daemon365"><meta name=twitter:description content="介绍
BoltDB 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：

键/值存储: BoltDB 为应用程序提供了简单的键/值存储接口。
事务: BoltDB 支持完整的 ACID 事务。
嵌入式: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/cloud/boltdb_basics/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"boltdb 介绍","description":"\u003ch2 id=\u0022介绍\u0022\u003e介绍\u003c\/h2\u003e\n\u003cp\u003e\u003ccode\u003eBoltDB\u003c\/code\u003e 是一个用 Go 语言编写的嵌入式键\/值数据库。以下是关于 BoltDB 的一些基本介绍：\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e键\/值存储\u003c\/strong\u003e: BoltDB 为应用程序提供了简单的键\/值存储接口。\u003c\/li\u003e\n\u003cli\u003e\u003cstrong\u003e事务\u003c\/strong\u003e: BoltDB 支持完整的 ACID 事务。\u003c\/li\u003e\n\u003cli\u003e\u003cstrong\u003e嵌入式\u003c\/strong\u003e: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同 …\u003c\/li\u003e\u003c\/ul\u003e","datePublished":"2024-05-08T20:56:00\u002b08:00","dateModified":"2024-05-08T20:56:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/cloud\/boltdb_basics\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
首页</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
关于</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
归档</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
分类</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
标签</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
搜索</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>boltdb 介绍</h1><div class=post-meta><time datetime=2024-05-08><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2024-05-08
</time><a href=/categories/cloud class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
cloud
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
5 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
1013 words</span></div><div class=post-tags><a href=/tags/boltdb class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
boltdb
</a><a href=/tags/etcd class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
etcd
</a><a href=/tags/golang class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
golang
</a><a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93 class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
数据库
</a><a href=/tags/kubernetes class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
kubernetes</a></div></header><div class=post-body><h2 id=介绍>介绍</h2><p><code>BoltDB</code> 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：</p><ul><li><strong>键/值存储</strong>: BoltDB 为应用程序提供了简单的键/值存储接口。</li><li><strong>事务</strong>: BoltDB 支持完整的 ACID 事务。</li><li><strong>嵌入式</strong>: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同，BoltDB 不运行在单独的服务器进程中。它作为一个库被直接嵌入到你的应用程序中。</li><li><strong>单文件存储</strong>: 所有的数据都存储在一个文件中，这使得备份和迁移变得简单。</li><li><strong>高效的二进制存储</strong>: 数据在磁盘上使用 B+ 树结构存储，这为随机读取提供了高性能。</li><li><strong>前缀扫描</strong>: 可以很容易地按键的前缀进行扫描，这使得它适用于范围查询。</li><li><strong>没有外部依赖</strong>: BoltDB 不依赖于任何外部系统或库。</li><li><strong>线程安全</strong>: BoltDB 是线程安全的，可以在多个 goroutines 中并发地使用。</li></ul><p>BoltDB 特别适用于需要一个轻量级、高性能、易于部署和维护的数据库解决方案的场景。</p><p>虽然 BoltDB 非常有用，但它也有其局限性。例如，它不支持分布式存储，也不适用于需要多节点复制或分片的场景。但对于许多应用程序，它提供了一个简单且高性能的存储解决方案。</p><p><strong>源码地址：</strong></p><p><a href=https://github.com/boltdb/bolt>https://github.com/boltdb/bolt</a> 这个项目已经不维护了, <a href=https://etcd.io/>etcd</a> 官方维护了一个 fork 库，api 是互通的: <a href=https://github.com/etcd-io/bbolt>https://github.com/etcd-io/bbolt</a></p><h2 id=谁在使用>谁在使用</h2><p><a href=https://github.com/etcd-io/etcd>etcd</a>、<a href=https://github.com/pingcap/tidb>tidb</a>、<a href=https://github.com/influxdata/influxdb>influxdb</a>、<a href=https://github.com/hashicorp/consul>consul</a> &mldr;&mldr;</p><h2 id=架构图>架构图</h2><p><img src=/images/6f10d17d-ca52-4fd0-a600-e92a9fc99d36.png alt=boltdb></p><h2 id=引入>引入</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go get go.etcd.io/bbolt 
</span></span></code></pre></div><h2 id=使用>使用</h2><h3 id=open--a-database>open a database</h3><p>Bolt 中的顶级对象是 DB。它在你的硬盘上表示为一个单独的文件，并代表了你数据的一个一致性快照。</p><p>要打开你的数据库，只需使用 <code>bolt.Open()</code> 函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>bolt</span> <span style=color:#d88200>&#34;go.etcd.io/bbolt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;my.db&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>0600</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatal</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>请注意，Bolt 在数据文件上获得一个文件锁，因此多个进程不能同时打开同一个数据库。打开一个已经打开的 Bolt 数据库会导致它挂起，直到另一个进程关闭它。为了防止无限期的等待，你可以向 <code>Open()</code> 函数传递一个超时选项：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;my.db&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>0600</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Options</span><span style=color:#111>{</span><span style=color:#75af00>Timeout</span><span style=color:#111>:</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>})</span>
</span></span></code></pre></div><h3 id=transactions>Transactions</h3><p>Bolt一次只允许一个读写 transactions ，但允许您一次进行多个只读 transactions 。每一个 transactions 在开始时都能看到数据的一致视图。</p><p>单独的 transactions 和从它们创建的所有对象（例如桶、键）都不是线程安全的。要在多个goroutines中处理数据，您必须为每一个goroutine启动一个 transactions ，或使用锁来确保一次只有一个goroutine访问一个 transactions 。从数据库创建 transactions 是线程安全的。</p><p>transactions 不应相互依赖，并且通常不应在同一goroutine中同时打开。这可能会导致死锁，因为读写 transactions 需要定期重新映射数据文件，但在任何只读 transactions 打开时都不能这样做。即使是嵌套的只读 transactions 也可能导致死锁，因为子 transactions 可能阻止父 transactions 释放其资源。</p><h4 id=read-write-transactions>Read-write transactions</h4><p>要开始一个读写 transactions ，可以使用DB.Update()函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>在闭包中，您可以看到数据库的一致视图。通过在最后返回nil来提交 transactions 。您还可以通过返回错误在任何时候回滚 transactions 。所有的数据库操作都允许在一个读写 transactions 中进行。</p><p>始终检查返回错误，因为它会报告任何可能导致您的 transactions 未完成的磁盘故障。如果您在闭包内返回错误，它将被传递。</p><h4 id=read-only-transactions>Read-only transactions</h4><p>要开始一个只读 transactions ，您可以使用DB.View()函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>在这个闭包内，您也可以看到数据库的一致视图，但在只读 transactions 中不允许进行变动操作。在一个只读 transactions 中，您只能检索桶、检索值和复制数据库。</p><h4 id=batch-read-write-transactions>Batch read-write transactions</h4><p>每个DB.Update()都会等待磁盘提交写入。这种开销可以通过使用DB.Batch()函数结合多个更新来最小化：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Batch</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>并发的Batch调用会被机会性地组合成更大的 transactions 。只有当有多个goroutines调用它时，Batch才是有用的。</p><p>权衡之处在于，Batch在 transactions 的部分失败时可以多次调用给定的函数。该函数必须是幂等的，且只有在成功从DB.Batch()返回后，副作用才会生效。</p><p>例如：不要从函数内部显示消息，而是在封闭范围内设置变量：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>id</span> <span style=color:#00a8c8>uint64</span>
</span></span><span style=display:flex><span><span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Batch</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在桶中查找最后一个键，解码为bigendian uint64，增加</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 一个，编码回[]byte，并添加新键。</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>id</span> <span style=color:#111>=</span> <span style=color:#75af00>newValue</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Allocated ID %d&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span></code></pre></div><h4 id=managing-transactions-manually>Managing transactions manually</h4><p>DB.View()和DB.Update()函数是DB.Begin()函数的包装。这些助手函数将启动 transactions 、执行函数，然后在返回错误时安全地关闭您的 transactions 。这是使用Bolt transactions 的推荐方法。</p><p>然而，有时您可能希望手动开始和结束您的 transactions 。您可以直接使用DB.Begin()函数，但请确保关闭 transactions 。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 开始一个可写的 transactions 。</span>
</span></span><span style=display:flex><span><span style=color:#75af00>tx</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Begin</span><span style=color:#111>(</span><span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>defer</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Rollback</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用 transactions ...</span>
</span></span><span style=display:flex><span><span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>CreateBucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 提交 transactions 并检查错误。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Commit</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>DB.Begin()的第一个参数是一个布尔值，表示 transactions 是否应该是可写的。</p><h3 id=using-buckets>Using buckets</h3><p>桶是数据库中的键/值对集合。一个桶中的所有键都必须是唯一的。您可以使用Tx.CreateBucket()函数创建一个桶：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>CreateBucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;create bucket: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>您可以使用Tx.Bucket()函数检索现有的桶：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;bucket does not exist&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>您还可以使用Tx.CreateBucketIfNotExists()函数只在桶不存在时创建一个桶。打开数据库后，为所有的顶级桶调用此函数是一种常见的模式，这样您可以保证它们存在于未来的 transactions 中。</p><p>要删除一个桶，只需调用Tx.DeleteBucket()函数。</p><h3 id=using-keyvalue-pairs>Using key/value pairs</h3><p>要将键/值对保存到存储桶，使用<code>Bucket.Put()</code>函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Put</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;answer&#34;</span><span style=color:#111>),</span> <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;42&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>这会在<code>MyBucket</code>存储桶中将"answer"键的值设置为"42"。要检索此值，我们可以使用<code>Bucket.Get()</code>函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>v</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;answer&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;The answer is: %s\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p><code>Get()</code>函数不返回错误，因为其操作保证可以工作（除非有某种系统故障）。如果键存在，它将返回其字节切片值。如果不存在，则返回nil。重要的是要注意，您可以将零长度的值设置为一个键，这与键不存在是不同的。</p><p>使用<code>Bucket.Delete()</code>函数从存储桶中删除键：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Delete</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;answer&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>这将从<code>MyBucket</code>存储桶中删除答案键。</p><p>请注意，从<code>Get()</code>返回的值只在事务打开时有效。如果您需要在事务外部使用值，则必须使用<code>copy()</code>将其复制到另一个字节切片。</p><h3 id=autoincrementing-integer-for-the-bucket>Autoincrementing integer for the bucket</h3><p>通过使用<code>NextSequence()</code>函数，您可以让Bolt确定一个序列，该序列可以用作键/值对的唯一标识符。请参阅下面的示例。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75715e>// CreateUser saves u to the store. The new user ID is set on u once the data is persisted.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>Store</span><span style=color:#111>)</span> <span style=color:#75af00>CreateUser</span><span style=color:#111>(</span><span style=color:#75af00>u</span> <span style=color:#f92672>*</span><span style=color:#75af00>User</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Update</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Retrieve the users bucket.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// This should be created when the DB is first opened.</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;users&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Generate ID for the user.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// This returns an error only if the Tx is closed or not writeable.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// That can&#39;t happen in an Update() call so I ignore the error check.</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>NextSequence</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>u</span><span style=color:#111>.</span><span style=color:#75af00>ID</span> <span style=color:#111>=</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Marshal user data into bytes.</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>buf</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>u</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Persist bytes to users bucket.</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Put</span><span style=color:#111>(</span><span style=color:#75af00>itob</span><span style=color:#111>(</span><span style=color:#75af00>u</span><span style=color:#111>.</span><span style=color:#75af00>ID</span><span style=color:#111>),</span> <span style=color:#75af00>buf</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// itob returns an 8-byte big endian representation of v.</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>itob</span><span style=color:#111>(</span><span style=color:#75af00>v</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>([]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>binary</span><span style=color:#111>.</span><span style=color:#75af00>BigEndian</span><span style=color:#111>.</span><span style=color:#75af00>PutUint64</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#111>uint64</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>b</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>User</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ID</span> <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=iterating-over-keys>Iterating over keys</h3><p>Bolt在存储桶内按字节排序存储其键。这使得对这些键进行顺序迭代非常快。要迭代键，我们将使用一个Cursor：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Assume bucket exists and has keys</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>Cursor</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>First</span><span style=color:#111>();</span> <span style=color:#75af00>k</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span><span style=color:#111>;</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Next</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;key=%s, value=%s\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>游标允许您移动到键列表中的特定点，并一次向前或向后移动一个键。</p><p>以下函数在游标上可用：</p><ul><li><code>First()</code> 移动到第一个键。</li><li><code>Last()</code> 移动到最后一个键。</li><li><code>Seek()</code> 移动到特定键。</li><li><code>Next()</code> 移动到下一个键。</li><li><code>Prev()</code> 移动到上一个键。 每个函数都有一个返回签名（key []byte, value []byte）。当您迭代到游标的末尾时，<code>Next()</code>将返回一个nil键。您必须使用<code>First()</code>、<code>Last()</code>或<code>Seek()</code>移动到某个位置，然后再调用<code>Next()</code>或<code>Prev()</code>。如果您没有移动到某个位置，那么这些函数将返回一个nil键。</li></ul><p>在迭代过程中，如果键不是nil，但值是nil，那么意味着键引用的是一个存储桶而不是一个值。使用<code>Bucket.Bucket()</code>来访问子存储桶。</p><h4 id=prefix-scans>Prefix scans</h4><p>要迭代键前缀，您可以结合使用<code>Seek()</code>和<code>bytes.HasPrefix()</code>：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Assume bucket exists and has keys</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>)).</span><span style=color:#75af00>Cursor</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>prefix</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;1234&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Seek</span><span style=color:#111>(</span><span style=color:#75af00>prefix</span><span style=color:#111>);</span> <span style=color:#75af00>k</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>HasPrefix</span><span style=color:#111>(</span><span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>prefix</span><span style=color:#111>);</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Next</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;key=%s, value=%s\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><h4 id=range-scans>Range scans</h4><p>另一个常见的用例是扫描范围，例如时间范围。如果您使用可排序的时间编码，例如RFC3339，那么您可以像这样查询特定的日期范围：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Assume our events bucket exists and has RFC3339 encoded time keys.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Events&#34;</span><span style=color:#111>)).</span><span style=color:#75af00>Cursor</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Our time range spans the 90&#39;s decade.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>min</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;1990-01-01T00:00:00Z&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>max</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;2000-01-01T00:00:00Z&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Iterate over the 90&#39;s.</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Seek</span><span style=color:#111>(</span><span style=color:#75af00>min</span><span style=color:#111>);</span> <span style=color:#75af00>k</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Compare</span><span style=color:#111>(</span><span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>max</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Next</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>请注意，虽然RFC3339是可排序的，但Golang的RFC3339Nano实现不使用小数点后固定数量的数字，因此不可排序。</p><h4 id=foreach>ForEach()</h4><p>如果您知道要在存储桶中迭代所有键，也可以使用<code>ForEach()</code>函数：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Assume bucket exists and has keys</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MyBucket&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>ForEach</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;key=%s, value=%s\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>请注意，ForEach()中的键和值仅在事务打开时有效。如果您需要在事务之外使用键或值，您必须使用copy()将其复制到另一个字节切片。</p><h3 id=nested-buckets>Nested buckets</h3><p>以下是给定文档的中文翻译：</p><p>请注意，ForEach()中的键和值仅在事务打开时有效。如果您需要在事务之外使用键或值，您必须使用copy()将其复制到另一个字节切片。</p><p><strong>嵌套的桶</strong> 您还可以在键中存储一个桶，以创建嵌套的桶。该API与DB对象上的桶管理API相同：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>)</span> <span style=color:#75af00>CreateBucket</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>)</span> <span style=color:#75af00>CreateBucketIfNotExists</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>Bucket</span><span style=color:#111>)</span> <span style=color:#75af00>DeleteBucket</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#111>[]</span><span style=color:#00a8c8>byte</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span>
</span></span></code></pre></div><p>假设您有一个多租户应用程序，其中根级别的桶是帐户桶。在此桶内是一系列自身为桶的帐户。在这个序列桶里，你可以拥有许多与账户自身相关的桶（如用户、笔记等），将信息隔离到逻辑分组中。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// createUser 在给定账户中创建一个新用户。</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>createUser</span><span style=color:#111>(</span><span style=color:#75af00>accountID</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>u</span> <span style=color:#f92672>*</span><span style=color:#75af00>User</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开始事务。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>tx</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Begin</span><span style=color:#111>(</span><span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>defer</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Rollback</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检索帐户的根桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 假设在设置帐户时已经创建了此桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>root</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Bucket</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>strconv</span><span style=color:#111>.</span><span style=color:#75af00>FormatUint</span><span style=color:#111>(</span><span style=color:#75af00>accountID</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置用户桶。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>bkt</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>root</span><span style=color:#111>.</span><span style=color:#75af00>CreateBucketIfNotExists</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;USERS&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 为新用户生成ID。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>userID</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bkt</span><span style=color:#111>.</span><span style=color:#75af00>NextSequence</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>u</span><span style=color:#111>.</span><span style=color:#75af00>ID</span> <span style=color:#111>=</span> <span style=color:#75af00>userID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 序列化并保存编码的用户。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>buf</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>u</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bkt</span><span style=color:#111>.</span><span style=color:#75af00>Put</span><span style=color:#111>([]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>strconv</span><span style=color:#111>.</span><span style=color:#75af00>FormatUint</span><span style=color:#111>(</span><span style=color:#75af00>u</span><span style=color:#111>.</span><span style=color:#75af00>ID</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>)),</span> <span style=color:#75af00>buf</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提交事务。</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Commit</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=数据库备份>数据库备份</h3><p>Bolt是一个单一的文件，所以备份很容易。您可以使用Tx.WriteTo()函数将数据库的一致视图写入一个写入器。如果您从只读事务中调用此函数，它将执行一个热备份，并且不会阻止您的其他数据库读取和写入。</p><p>默认情况下，它将使用一个常规的文件句柄，该句柄将利用操作系统的页面缓存。请查看Tx文档，了解有关优化大于RAM数据集的信息。</p><p>一个常见的用例是通过HTTP进行备份，这样您就可以使用像cURL这样的工具进行数据库备份：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>BackupHandleFunc</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ResponseWriter</span><span style=color:#111>,</span> <span style=color:#75af00>req</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>View</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>tx</span> <span style=color:#f92672>*</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Tx</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Header</span><span style=color:#111>().</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Content-Type&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;application/octet-stream&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Header</span><span style=color:#111>().</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Content-Disposition&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>`attachment; filename=&#34;my.db&#34;`</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Header</span><span style=color:#111>().</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Content-Length&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>strconv</span><span style=color:#111>.</span><span style=color:#75af00>Itoa</span><span style=color:#111>(</span><span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>Size</span><span style=color:#111>())))</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>tx</span><span style=color:#111>.</span><span style=color:#75af00>WriteTo</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>(),</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>StatusInternalServerError</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>然后你可以使用这个命令备份：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#75af00>curl</span> <span style=color:#75af00>http</span><span style=color:#111>:</span><span style=color:#75715e>//localhost/backup &gt; my.db</span>
</span></span></code></pre></div><p>或者您可以打开您的浏览器访问http://localhost/backup，它将自动下载。</p><p>如果您想备份到另一个文件，您可以使用Tx.CopyFile()辅助函数。</p><p><strong>统计信息</strong> 数据库保持对其执行的许多内部操作的持续计数，这样您可以更好地了解正在发生的事情。通过在两个时间点获取这些统计的快照，我们可以看到在这个时间范围内执行了哪些操作。</p><p>例如，我们可以启动一个goroutine，每10秒记录一次统计信息：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>go</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取初始统计。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>prev</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Stats</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 等待10秒。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取当前统计并对其进行差异处理。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>stats</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>Stats</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>diff</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>stats</span><span style=color:#111>.</span><span style=color:#75af00>Sub</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>prev</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将统计信息编码为JSON并打印到STDERR。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>NewEncoder</span><span style=color:#111>(</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Stderr</span><span style=color:#111>).</span><span style=color:#75af00>Encode</span><span style=color:#111>(</span><span style=color:#75af00>diff</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 为下一个循环保存统计。</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>prev</span> <span style=color:#111>=</span> <span style=color:#75af00>stats</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}()</span>
</span></span></code></pre></div><p>将这些统计信息管道到像statsd这样的服务进行监控，或者提供一个HTTP端点来执行固定长度的样本，也很有用。</p><h3 id=只读模式>只读模式</h3><p>有时创建一个共享的、只读的Bolt数据库是很有用的。要做到这一点，打开数据库时设置Options.ReadOnly标志。只读模式使用共享锁，允许多个进程从数据库中读取，但它会阻止任何进程以读写模式打开数据库。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>db</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;my.db&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>0600</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>bolt</span><span style=color:#111>.</span><span style=color:#75af00>Options</span><span style=color:#111>{</span><span style=color:#75af00>ReadOnly</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatal</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>希望这可以帮助您理解给定的文档！如果您有任何问题或需要进一步的澄清，请告诉我。</p><h2 id=referance>referance</h2><ul><li><a href=https://github.com/etcd-io/bbolt>https://github.com/etcd-io/bbolt</a></li><li><a href=https://zhuanlan.zhihu.com/p/377572049>https://zhuanlan.zhihu.com/p/377572049</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> boltdb 介绍</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/cloud/boltdb_basics/>https://daemon365.dev/post/cloud/boltdb_basics/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/cloud/kube_proxy_traffic_flow_mode/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>kube-proxy 流量流转方式</span></div></a><a href=/post/cloud/the_relationship_between_docker_containerd_runc_containerd_shim_and_other_components/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>docker containerd runc containerd-shim等组件的关系</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#谁在使用>谁在使用</a></li><li><a href=#架构图>架构图</a></li><li><a href=#引入>引入</a></li><li><a href=#使用>使用</a><ul><li><a href=#open--a-database>open a database</a></li><li><a href=#transactions>Transactions</a><ul><li><a href=#read-write-transactions>Read-write transactions</a></li><li><a href=#read-only-transactions>Read-only transactions</a></li><li><a href=#batch-read-write-transactions>Batch read-write transactions</a></li><li><a href=#managing-transactions-manually>Managing transactions manually</a></li></ul></li><li><a href=#using-buckets>Using buckets</a></li><li><a href=#using-keyvalue-pairs>Using key/value pairs</a></li><li><a href=#autoincrementing-integer-for-the-bucket>Autoincrementing integer for the bucket</a></li><li><a href=#iterating-over-keys>Iterating over keys</a><ul><li><a href=#prefix-scans>Prefix scans</a></li><li><a href=#range-scans>Range scans</a></li><li><a href=#foreach>ForEach()</a></li></ul></li><li><a href=#nested-buckets>Nested buckets</a></li><li><a href=#数据库备份>数据库备份</a></li><li><a href=#只读模式>只读模式</a></li></ul></li><li><a href=#referance>referance</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2026 daemon365</p><p class=powered-by>由 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 和 <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a> 驱动</p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder=搜索文章... autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>输入 2 个或更多字符开始搜索</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>