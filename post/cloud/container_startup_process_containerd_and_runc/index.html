<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>容器启动流程（containerd 和 runc） - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="启动流程
containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续 …"><meta name=keywords content="docker,containerd,runc,containerd-shim,kubernetes,源码分析"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/"><meta property="og:title" content="容器启动流程（containerd 和 runc） - Daemon365"><meta property="og:description" content="启动流程
containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2023-12-07T00:00:00+08:00"><meta property="article:modified_time" content="2023-12-07T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="cloud"><meta property="article:tag" content="docker"><meta property="article:tag" content="containerd"><meta property="article:tag" content="runc"><meta property="article:tag" content="containerd-shim"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="源码分析"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/"><meta name=twitter:title content="容器启动流程（containerd 和 runc） - Daemon365"><meta name=twitter:description content="启动流程
containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"容器启动流程（containerd 和 runc）","description":"\u003ch2 id=\u0022启动流程\u0022\u003e启动流程\u003c\/h2\u003e\n\u003cp\u003econtainerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。\nkubelet 通过 cri 调用 containerd 和这些不一样，后续 …\u003c\/p\u003e","datePublished":"2023-12-07T00:00:00\u002b08:00","dateModified":"2023-12-07T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/cloud\/container_startup_process_containerd_and_runc\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
Archives</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
Search</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>容器启动流程（containerd 和 runc）</h1><div class=post-meta><time datetime=2023-12-07><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2023-12-07
</time><a href=/categories/cloud class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
cloud
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
8 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
1669 words</span></div><div class=post-tags><a href=/tags/docker class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
docker
</a><a href=/tags/containerd class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
containerd
</a><a href=/tags/runc class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
runc
</a><a href=/tags/containerd-shim class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
containerd-shim
</a><a href=/tags/kubernetes class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
kubernetes
</a><a href=/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90 class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
源码分析</a></div></header><div class=post-body><h2 id=启动流程>启动流程</h2><p>containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续我会介绍到。</p><p>containerd 创建容器流程如下：</p><ol><li>接收到 api 请求，通过调用 containerd-shim-runc-v2 调用 runc 创建容器，主要是做解压文件和准备环境的工作。</li><li>接收到 api 请求，创建一个 task，task 是一个容器的抽象，包含了容器的所有信息，比如容器的 id、容器的状态、容器的配置等等。</li><li>containerd 启动一个 containerd-shim-runc-v2 进程。</li><li>containerd-shim-runc-v2 进程 在启动一个 containerd-shim-runc-v2 进程，然后第一个 containerd-shim-runc-v2 进程退出。</li><li>containerd 通过 IPC 通信，让第二个 containerd-shim-runc-v2 启动容器。</li><li>containerd-shim-runc-v2 进程通过调用 runc start 启动容器。</li><li>runc 会调用 runc init 启动容器的 init 进程。</li><li>runc init 进程会调用 <code>unix.Exec</code> 的方式，替换自己的进程，启动容器的第一个进程。这个进程既是容器的启动命令，也是容器的 pid 1 进程。完成之后，runc create 进程退出。</li></ol><p>这样 containerd-shim-runc-v2 的父进程就是 init 进程（1），而 init 进程的父进程是 containerd-shim-runc-v2 进程，这样就形成了一个进程树。</p><p>我通过 docker 启动一个容器，示例一下：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker run -d --rm -it docker.m.daocloud.io/ubuntu:22.10 sleep <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>❯ ps -ef<span style=color:#111>|</span>grep <span style=color:#d88200>&#34;sleep 3000&#34;</span>
</span></span><span style=display:flex><span>root       <span style=color:#ae81ff>15042</span>   <span style=color:#ae81ff>15021</span>  <span style=color:#ae81ff>0</span> 22:02 pts/0    00:00:00 sleep <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>❯ ps -ef<span style=color:#111>|</span>grep <span style=color:#d88200>&#34;15021&#34;</span>
</span></span><span style=display:flex><span>root       <span style=color:#ae81ff>15021</span>       <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span> 22:02 ?        00:00:00 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 4346ca602cd85d35b0a4a81762be6142bc6a2222f859f4af47563992efc3c59c -address /run/containerd/containerd.sock
</span></span><span style=display:flex><span>root       <span style=color:#ae81ff>15042</span>   <span style=color:#ae81ff>15021</span>  <span style=color:#ae81ff>0</span> 22:02 pts/0    00:00:00 sleep <span style=color:#ae81ff>3000</span>
</span></span></code></pre></div><p>可以看到我们的结论是正确的。</p><h3 id=疑问解答>疑问解答</h3><p><strong>1.为什么要创建两个 containerd-shim 不嫌麻烦吗？</strong></p><p>因为 第一个 containerd-shim 会在创建完第二个 containerd-shim 后退出，而作为第一个进程子进程的第二个 containerd-shim 会成为孤儿进程，这样就会被 init 进程接管，而和 containerd 本身脱离了关系。</p><p><strong>2.为什么要想法设法把 containerd-shim 挂在 init 进程下面，而不是 containerd？</strong></p><p>为了保证稳定性和独立性。这样做可以确保即使 containerd 崩溃或重启，由 containerd-shim 管理的容器进程仍然可以继续运行，不受影响。此外，这种设计还有助于更好地管理资源和防止资源泄露。</p><p><strong>3.为什么 runc start 进程退出了 runc init 进程（用户进程）没有变成 init 的子进程 而是containerd-shim的子进程？</strong></p><p>因为 containerd-shim 做了 unix 的 <code>PR_SET_CHILD_SUBREAPER</code> 调用, 这个系统调用大概作用为 当这个进程的子子孙孙进程变成孤儿进程的时候，这个进程会接管这个孤儿进程，而不是 init 进程接管。</p><h2 id=架构图>架构图</h2><p><img src=/images/1a309094-015a-4bcf-b371-134a5a275089.png alt></p><h2 id=代码分析>代码分析</h2><h3 id=containerd-api-注册-代码分析>containerd api 注册 代码分析</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>register</span> <span style=color:#111>=</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sync</span><span style=color:#111>.</span><span style=color:#75af00>RWMutex</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>r</span> <span style=color:#75af00>plugin</span><span style=color:#111>.</span><span style=color:#75af00>Registry</span>
</span></span><span style=display:flex><span><span style=color:#111>}{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Registry</span> <span style=color:#111>[]</span><span style=color:#f92672>*</span><span style=color:#75af00>Registration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Registration</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Type of the plugin</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Type</span> <span style=color:#75af00>Type</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ID of the plugin</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ID</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Config specific to the plugin</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Config</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Requires is a list of plugins that the registered plugin requires to be available</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Requires</span> <span style=color:#111>[]</span><span style=color:#75af00>Type</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// InitFn is called when initializing a plugin. The registration and</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// context are passed in. The init function may modify the registration to</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// add exports, capabilities and platform support declarations.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>InitFn</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>InitContext</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>interface</span><span style=color:#111>{},</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ConfigMigration allows a plugin to migrate configurations from an older</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// version to handle plugin renames or moving of features from one plugin</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// to another in a later version.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The configuration map is keyed off the plugin name and the value</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// is the configuration for that objects, with the structure defined</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// for the plugin. No validation is done on the value before performing</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the migration.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ConfigMigration</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#00a8c8>map</span><span style=color:#111>[</span><span style=color:#00a8c8>string</span><span style=color:#111>]</span><span style=color:#00a8c8>interface</span><span style=color:#111>{})</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>通过 init 把接口注册进去 比如 task api 注册</p><p>代码位置 ： <code>services/tasks/local.go</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>init</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>registry</span><span style=color:#111>.</span><span style=color:#75af00>Register</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>plugin</span><span style=color:#111>.</span><span style=color:#75af00>Registration</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Type</span><span style=color:#111>:</span>     <span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>ServicePlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ID</span><span style=color:#111>:</span>       <span style=color:#75af00>services</span><span style=color:#111>.</span><span style=color:#75af00>TasksService</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Requires</span><span style=color:#111>:</span> <span style=color:#75af00>tasksServiceRequires</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Config</span><span style=color:#111>:</span>   <span style=color:#f92672>&amp;</span><span style=color:#75af00>Config</span><span style=color:#111>{},</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>InitFn</span><span style=color:#111>:</span>   <span style=color:#75af00>initFunc</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>timeout</span><span style=color:#111>.</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#75af00>stateTimeout</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>initFunc</span><span style=color:#111>(</span><span style=color:#75af00>ic</span> <span style=color:#f92672>*</span><span style=color:#75af00>plugin</span><span style=color:#111>.</span><span style=color:#75af00>InitContext</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>interface</span><span style=color:#111>{},</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>config</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>Config</span><span style=color:#111>.(</span><span style=color:#f92672>*</span><span style=color:#75af00>Config</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>v2r</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>GetByID</span><span style=color:#111>(</span><span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>RuntimePluginV2</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;task&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>m</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>GetSingle</span><span style=color:#111>(</span><span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>MetadataPlugin</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ep</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>GetSingle</span><span style=color:#111>(</span><span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>EventPlugin</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>monitor</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>GetSingle</span><span style=color:#111>(</span><span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>TaskMonitorPlugin</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>Is</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#75af00>plugin</span><span style=color:#111>.</span><span style=color:#75af00>ErrPluginNotFound</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>monitor</span> <span style=color:#111>=</span> <span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>NewNoopMonitor</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>db</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>m</span><span style=color:#111>.(</span><span style=color:#f92672>*</span><span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>DB</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>l</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>local</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>containers</span><span style=color:#111>:</span> <span style=color:#75af00>metadata</span><span style=color:#111>.</span><span style=color:#75af00>NewContainerStore</span><span style=color:#111>(</span><span style=color:#75af00>db</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>store</span><span style=color:#111>:</span>      <span style=color:#75af00>db</span><span style=color:#111>.</span><span style=color:#75af00>ContentStore</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>publisher</span><span style=color:#111>:</span>  <span style=color:#75af00>ep</span><span style=color:#111>.(</span><span style=color:#75af00>events</span><span style=color:#111>.</span><span style=color:#75af00>Publisher</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>monitor</span><span style=color:#111>:</span>    <span style=color:#75af00>monitor</span><span style=color:#111>.(</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>TaskMonitor</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>v2Runtime</span><span style=color:#111>:</span>  <span style=color:#75af00>v2r</span><span style=color:#111>.(</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>PlatformRuntime</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>v2Tasks</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>l</span><span style=color:#111>.</span><span style=color:#75af00>v2Runtime</span><span style=color:#111>.</span><span style=color:#75af00>Tasks</span><span style=color:#111>(</span><span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>t</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>v2Tasks</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>l</span><span style=color:#111>.</span><span style=color:#75af00>monitor</span><span style=color:#111>.</span><span style=color:#75af00>Monitor</span><span style=color:#111>(</span><span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>blockio</span><span style=color:#111>.</span><span style=color:#75af00>SetConfig</span><span style=color:#111>(</span><span style=color:#75af00>config</span><span style=color:#111>.</span><span style=color:#75af00>BlockIOConfigFile</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>G</span><span style=color:#111>(</span><span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>).</span><span style=color:#75af00>WithError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>).</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;blockio initialization failed&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>rdt</span><span style=color:#111>.</span><span style=color:#75af00>SetConfig</span><span style=color:#111>(</span><span style=color:#75af00>config</span><span style=color:#111>.</span><span style=color:#75af00>RdtConfigFile</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>G</span><span style=color:#111>(</span><span style=color:#75af00>ic</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>).</span><span style=color:#75af00>WithError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>).</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;RDT initialization failed&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>l</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>然后在 containerd 启动的时候 注册api</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#75af00>loaded</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>registry</span><span style=color:#111>.</span><span style=color:#75af00>Graph</span><span style=color:#111>(</span><span style=color:#75af00>filter</span><span style=color:#111>(</span><span style=color:#75af00>config</span><span style=color:#111>.</span><span style=color:#75af00>DisabledPlugins</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>p</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>loaded</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>result</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Init</span><span style=color:#111>(</span><span style=color:#75af00>initContext</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>initialized</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#75af00>result</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;could not add plugin result to plugin set: %w&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>instance</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>Instance</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#111>delete</span><span style=color:#111>(</span><span style=color:#75af00>required</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// check for grpc services that should be registered with the server</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>src</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>instance</span><span style=color:#111>.(</span><span style=color:#75af00>grpcService</span><span style=color:#111>);</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>grpcServices</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>grpcServices</span><span style=color:#111>,</span> <span style=color:#75af00>src</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>src</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>instance</span><span style=color:#111>.(</span><span style=color:#75af00>ttrpcService</span><span style=color:#111>);</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ttrpcServices</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>ttrpcServices</span><span style=color:#111>,</span> <span style=color:#75af00>src</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>service</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>instance</span><span style=color:#111>.(</span><span style=color:#75af00>tcpService</span><span style=color:#111>);</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>tcpServices</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>tcpServices</span><span style=color:#111>,</span> <span style=color:#75af00>service</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>plugins</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>plugins</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// register services after all plugins have been initialized</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>service</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>grpcServices</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>service</span><span style=color:#111>.</span><span style=color:#75af00>Register</span><span style=color:#111>(</span><span style=color:#75af00>grpcServer</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>service</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>ttrpcServices</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>service</span><span style=color:#111>.</span><span style=color:#75af00>RegisterTTRPC</span><span style=color:#111>(</span><span style=color:#75af00>ttrpcServer</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>service</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>tcpServices</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>service</span><span style=color:#111>.</span><span style=color:#75af00>RegisterTCP</span><span style=color:#111>(</span><span style=color:#75af00>tcpServer</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=create-task>create task</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>l</span> <span style=color:#f92672>*</span><span style=color:#75af00>local</span><span style=color:#111>)</span> <span style=color:#75af00>Create</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>api</span><span style=color:#111>.</span><span style=color:#75af00>CreateTaskRequest</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>...</span><span style=color:#75af00>grpc</span><span style=color:#111>.</span><span style=color:#75af00>CallOption</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>api</span><span style=color:#111>.</span><span style=color:#75af00>CreateTaskResponse</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>rtime</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>l</span><span style=color:#111>.</span><span style=color:#75af00>v2Runtime</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>rtime</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>ContainerID</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>errdefs</span><span style=color:#111>.</span><span style=color:#75af00>IsNotFound</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errdefs</span><span style=color:#111>.</span><span style=color:#75af00>ToGRPC</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>errdefs</span><span style=color:#111>.</span><span style=color:#75af00>ToGRPC</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;task %s: %w&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>ContainerID</span><span style=color:#111>,</span> <span style=color:#75af00>errdefs</span><span style=color:#111>.</span><span style=color:#75af00>ErrAlreadyExists</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>rtime</span><span style=color:#111>.</span><span style=color:#75af00>Create</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>ContainerID</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>m</span> <span style=color:#f92672>*</span><span style=color:#75af00>TaskManager</span><span style=color:#111>)</span> <span style=color:#75af00>Create</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>taskID</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span> <span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>CreateOpts</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>Task</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 启动第一个 containerd-shim-runc-v2 进程</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>shimTask</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>newShimTask</span><span style=color:#111>(</span><span style=color:#75af00>shim</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 给第二个 containerd-shim-runc-v2 进程传递参数</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>shimTask</span><span style=color:#111>.</span><span style=color:#75af00>Create</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>t</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=cri-代码>cri 代码</h3><p>cri 和 task 和上述的是一样的， 通过 register 注册 api.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>init</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>registry</span><span style=color:#111>.</span><span style=color:#75af00>Register</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>plugin</span><span style=color:#111>.</span><span style=color:#75af00>Registration</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Type</span><span style=color:#111>:</span> <span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>GRPCPlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ID</span><span style=color:#111>:</span>   <span style=color:#d88200>&#34;cri&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Requires</span><span style=color:#111>:</span> <span style=color:#111>[]</span><span style=color:#75af00>plugin</span><span style=color:#111>.</span><span style=color:#75af00>Type</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>CRIImagePlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>InternalPlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>SandboxControllerPlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>NRIApiPlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>EventPlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>ServicePlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>LeasePlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>plugins</span><span style=color:#111>.</span><span style=color:#75af00>SandboxStorePlugin</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#111>},</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>InitFn</span><span style=color:#111>:</span> <span style=color:#75af00>initCRIService</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>startContainer 接口</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>in</span> <span style=color:#f92672>*</span><span style=color:#75af00>instrumentedService</span><span style=color:#111>)</span> <span style=color:#75af00>StartContainer</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>StartContainerRequest</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>_</span> <span style=color:#f92672>*</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>StartContainerResponse</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>in</span><span style=color:#111>.</span><span style=color:#75af00>checkInitialized</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>G</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>).</span><span style=color:#75af00>Infof</span><span style=color:#111>(</span><span style=color:#d88200>&#34;StartContainer for %q&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>GetContainerId</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>G</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>).</span><span style=color:#75af00>WithError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>).</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;StartContainer for %q failed&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>GetContainerId</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>G</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>).</span><span style=color:#75af00>Infof</span><span style=color:#111>(</span><span style=color:#d88200>&#34;StartContainer for %q returns successfully&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>GetContainerId</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>res</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>in</span><span style=color:#111>.</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>StartContainer</span><span style=color:#111>(</span><span style=color:#75af00>ctrdutil</span><span style=color:#111>.</span><span style=color:#75af00>WithNamespace</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>),</span> <span style=color:#75af00>r</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>res</span><span style=color:#111>,</span> <span style=color:#75af00>errdefs</span><span style=color:#111>.</span><span style=color:#75af00>ToGRPC</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>criService</span><span style=color:#111>)</span> <span style=color:#75af00>StartContainer</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>StartContainerRequest</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>retRes</span> <span style=color:#f92672>*</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>StartContainerResponse</span><span style=color:#111>,</span> <span style=color:#75af00>retErr</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#75af00>task</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>container</span><span style=color:#111>.</span><span style=color:#75af00>NewTask</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>ioCreation</span><span style=color:#111>,</span> <span style=color:#75af00>taskOpts</span><span style=color:#f92672>...</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>container</span><span style=color:#111>)</span> <span style=color:#75af00>NewTask</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>ioCreate</span> <span style=color:#75af00>cio</span><span style=color:#111>.</span><span style=color:#75af00>Creator</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span> <span style=color:#f92672>...</span><span style=color:#75af00>NewTaskOpts</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>_</span> <span style=color:#75af00>Task</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 通过 unix socket 的方式调用上述的 create task 接口</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>response</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>client</span><span style=color:#111>.</span><span style=color:#75af00>TaskService</span><span style=color:#111>().</span><span style=color:#75af00>Create</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>request</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=containerd-shim>containerd-shim</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>run</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>manager</span> <span style=color:#75af00>Manager</span><span style=color:#111>,</span> <span style=color:#75af00>config</span> <span style=color:#75af00>Config</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Handle explicit actions</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>switch</span> <span style=color:#75af00>action</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#d88200>&#34;delete&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#d88200>&#34;start&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是 start 参数的话启动一个 containerd-shim-runc-v2 进程</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>opts</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>StartOpts</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Address</span><span style=color:#111>:</span>      <span style=color:#75af00>addressFlag</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>TTRPCAddress</span><span style=color:#111>:</span> <span style=color:#75af00>ttrpcAddress</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Debug</span><span style=color:#111>:</span>        <span style=color:#75af00>debugFlag</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>params</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>manager</span><span style=color:#111>.</span><span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>opts</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>data</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>params</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;failed to marshal bootstrap params to json: %w&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Stdout</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>data</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// manager.Start 中创建的 command 指定三个参数 Namespace 容器 id 和 containerd socket 文件的地址</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>newCommand</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>,</span> <span style=color:#75af00>containerdAddress</span><span style=color:#111>,</span> <span style=color:#75af00>containerdTTRPCAddress</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>debug</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>exec</span><span style=color:#111>.</span><span style=color:#75af00>Cmd</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ns</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>namespaces</span><span style=color:#111>.</span><span style=color:#75af00>NamespaceRequired</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>self</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Executable</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cwd</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Getwd</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>args</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;-namespace&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>ns</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;-id&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;-address&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>containerdAddress</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>debug</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>args</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>args</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;-debug&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>exec</span><span style=color:#111>.</span><span style=color:#75af00>Command</span><span style=color:#111>(</span><span style=color:#75af00>self</span><span style=color:#111>,</span> <span style=color:#75af00>args</span><span style=color:#f92672>...</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>Dir</span> <span style=color:#111>=</span> <span style=color:#75af00>cwd</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>Env</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Environ</span><span style=color:#111>(),</span> <span style=color:#d88200>&#34;GOMAXPROCS=4&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>SysProcAttr</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>syscall</span><span style=color:#111>.</span><span style=color:#75af00>SysProcAttr</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Setpgid</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>cmd</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>第二个 containerd-shim 也会开启一些api服务 ，比如启动容器</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GO data-lang=GO><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>service</span><span style=color:#111>)</span> <span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>taskAPI</span><span style=color:#111>.</span><span style=color:#75af00>StartRequest</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>taskAPI</span><span style=color:#111>.</span><span style=color:#75af00>StartResponse</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>container</span><span style=color:#111>.</span><span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Container</span><span style=color:#111>)</span> <span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>task</span><span style=color:#111>.</span><span style=color:#75af00>StartRequest</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>process</span><span style=color:#111>.</span><span style=color:#75af00>Process</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>ExecID</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// command 及调用 runc 启动 runc create 的进程</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>Runc</span><span style=color:#111>)</span> <span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>context</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span> <span style=color:#75af00>id</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>runOrError</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>command</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;start&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>id</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=runc>runc</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>runner</span><span style=color:#111>)</span> <span style=color:#75af00>run</span><span style=color:#111>(</span><span style=color:#75af00>config</span> <span style=color:#f92672>*</span><span style=color:#75af00>specs</span><span style=color:#111>.</span><span style=color:#75af00>Process</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>switch</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>action</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>CT_ACT_CREATE</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>container</span><span style=color:#111>.</span><span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>process</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>CT_ACT_RESTORE</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>container</span><span style=color:#111>.</span><span style=color:#75af00>Restore</span><span style=color:#111>(</span><span style=color:#75af00>process</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>criuOpts</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>CT_ACT_RUN</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>container</span><span style=color:#111>.</span><span style=color:#75af00>Run</span><span style=color:#111>(</span><span style=color:#75af00>process</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>default</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Unknown action&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Container</span><span style=color:#111>)</span> <span style=color:#75af00>Start</span><span style=color:#111>(</span><span style=color:#75af00>process</span> <span style=color:#f92672>*</span><span style=color:#75af00>Process</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>Lock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>Unlock</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>config</span><span style=color:#111>.</span><span style=color:#75af00>Cgroups</span><span style=color:#111>.</span><span style=color:#75af00>Resources</span><span style=color:#111>.</span><span style=color:#75af00>SkipDevices</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;can&#39;t start container with SkipDevices set&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>process</span><span style=color:#111>.</span><span style=color:#75af00>Init</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>createExecFifo</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>start</span><span style=color:#111>(</span><span style=color:#75af00>process</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>process</span><span style=color:#111>.</span><span style=color:#75af00>Init</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>deleteExecFifo</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 调用 runc init 进程 /proc/self/exe 是自己的二进制文件</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>Container</span><span style=color:#111>)</span> <span style=color:#75af00>newParentProcess</span><span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>Process</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#75af00>parentProcess</span><span style=color:#111>,</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>comm</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>newProcessComm</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Make sure we use a new safe copy of /proc/self/exe or the runc-dmz</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// binary each time this is called, to make sure that if a container</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// manages to overwrite the file it cannot affect other containers on the</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// system. For runc, this code will only ever be called once, but</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// libcontainer users might call this more than once.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>closeClonedExes</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>exePath</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// only one of dmzExe or safeExe are used at a time</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>dmzExe</span><span style=color:#111>,</span> <span style=color:#75af00>safeExe</span> <span style=color:#f92672>*</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>File</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>dmz</span><span style=color:#111>.</span><span style=color:#75af00>IsSelfExeCloned</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// /proc/self/exe is already a cloned binary -- no need to do anything</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>logrus</span><span style=color:#111>.</span><span style=color:#75af00>Debug</span><span style=color:#111>(</span><span style=color:#d88200>&#34;skipping binary cloning -- /proc/self/exe is already cloned!&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>exePath</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/proc/self/exe&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>exec</span><span style=color:#111>.</span><span style=color:#75af00>Command</span><span style=color:#111>(</span><span style=color:#75af00>exePath</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;init&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>Stdin</span> <span style=color:#111>=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Stdin</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>Stdout</span> <span style=color:#111>=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Stdout</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>Stderr</span> <span style=color:#111>=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>Stderr</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>Dir</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>config</span><span style=color:#111>.</span><span style=color:#75af00>Rootfs</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>SysProcAttr</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>cmd</span><span style=color:#111>.</span><span style=color:#75af00>SysProcAttr</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>unix</span><span style=color:#111>.</span><span style=color:#75af00>SysProcAttr</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>runc init</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>init</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;init&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// This is the golang entry point for runc init, executed</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// before main() but after libcontainer/nsenter&#39;s nsexec().</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>libcontainer</span><span style=color:#111>.</span><span style=color:#75af00>Init</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// libcontainer.Init() 中调用的</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>startInitialization</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>retErr</span> <span style=color:#00a8c8>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>containerInit</span><span style=color:#111>(</span><span style=color:#75af00>it</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>config</span><span style=color:#111>,</span> <span style=color:#75af00>syncPipe</span><span style=color:#111>,</span> <span style=color:#75af00>consoleSocket</span><span style=color:#111>,</span> <span style=color:#75af00>pidfdSocket</span><span style=color:#111>,</span> <span style=color:#75af00>fifofd</span><span style=color:#111>,</span> <span style=color:#75af00>logFD</span><span style=color:#111>,</span> <span style=color:#75af00>dmzExe</span><span style=color:#111>,</span> <span style=color:#75af00>mountFds</span><span style=color:#111>{</span><span style=color:#75af00>sourceFds</span><span style=color:#111>:</span> <span style=color:#75af00>mountSrcFds</span><span style=color:#111>,</span> <span style=color:#75af00>idmapFds</span><span style=color:#111>:</span> <span style=color:#75af00>idmapFds</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// linuxSetnsInit 是 exec 的时候调用的 在启动的容器执行命令</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// initStandard 是启动容器</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>containerInit</span><span style=color:#111>(</span><span style=color:#75af00>t</span> <span style=color:#75af00>initType</span><span style=color:#111>,</span> <span style=color:#75af00>config</span> <span style=color:#f92672>*</span><span style=color:#75af00>initConfig</span><span style=color:#111>,</span> <span style=color:#75af00>pipe</span> <span style=color:#f92672>*</span><span style=color:#75af00>syncSocket</span><span style=color:#111>,</span> <span style=color:#75af00>consoleSocket</span><span style=color:#111>,</span> <span style=color:#75af00>pidfdSocket</span> <span style=color:#f92672>*</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>File</span><span style=color:#111>,</span> <span style=color:#75af00>fifoFd</span><span style=color:#111>,</span> <span style=color:#75af00>logFd</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>dmzExe</span> <span style=color:#f92672>*</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>File</span><span style=color:#111>,</span> <span style=color:#75af00>mountFds</span> <span style=color:#75af00>mountFds</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>populateProcessEnvironment</span><span style=color:#111>(</span><span style=color:#75af00>config</span><span style=color:#111>.</span><span style=color:#75af00>Env</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>err</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>switch</span> <span style=color:#75af00>t</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>initSetns</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// mount and idmap fds must be nil in this case. We don&#39;t mount while doing runc exec.</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>mountFds</span><span style=color:#111>.</span><span style=color:#75af00>sourceFds</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>||</span> <span style=color:#75af00>mountFds</span><span style=color:#111>.</span><span style=color:#75af00>idmapFds</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>errors</span><span style=color:#111>.</span><span style=color:#75af00>New</span><span style=color:#111>(</span><span style=color:#d88200>&#34;mount and idmap fds must be nil; can&#39;t mount from exec&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>linuxSetnsInit</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pipe</span><span style=color:#111>:</span>          <span style=color:#75af00>pipe</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>consoleSocket</span><span style=color:#111>:</span> <span style=color:#75af00>consoleSocket</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pidfdSocket</span><span style=color:#111>:</span>   <span style=color:#75af00>pidfdSocket</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>config</span><span style=color:#111>:</span>        <span style=color:#75af00>config</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>logFd</span><span style=color:#111>:</span>         <span style=color:#75af00>logFd</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>dmzExe</span><span style=color:#111>:</span>        <span style=color:#75af00>dmzExe</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>i</span><span style=color:#111>.</span><span style=color:#75af00>Init</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>initStandard</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>linuxStandardInit</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pipe</span><span style=color:#111>:</span>          <span style=color:#75af00>pipe</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>consoleSocket</span><span style=color:#111>:</span> <span style=color:#75af00>consoleSocket</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pidfdSocket</span><span style=color:#111>:</span>   <span style=color:#75af00>pidfdSocket</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>parentPid</span><span style=color:#111>:</span>     <span style=color:#75af00>unix</span><span style=color:#111>.</span><span style=color:#75af00>Getppid</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>config</span><span style=color:#111>:</span>        <span style=color:#75af00>config</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>fifoFd</span><span style=color:#111>:</span>        <span style=color:#75af00>fifoFd</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>logFd</span><span style=color:#111>:</span>         <span style=color:#75af00>logFd</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>dmzExe</span><span style=color:#111>:</span>        <span style=color:#75af00>dmzExe</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mountFds</span><span style=color:#111>:</span>      <span style=color:#75af00>mountFds</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>i</span><span style=color:#111>.</span><span style=color:#75af00>Init</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Errorf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;unknown init type %q&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>t</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>l</span> <span style=color:#f92672>*</span><span style=color:#75af00>linuxStandardInit</span><span style=color:#111>)</span> <span style=color:#75af00>Init</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>system</span><span style=color:#111>.</span><span style=color:#75af00>Exec</span><span style=color:#111>(</span><span style=color:#75af00>name</span><span style=color:#111>,</span> <span style=color:#75af00>l</span><span style=color:#111>.</span><span style=color:#75af00>config</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>,</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Environ</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 替换进程</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Exec</span><span style=color:#111>(</span><span style=color:#75af00>cmd</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>args</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>env</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>unix</span><span style=color:#111>.</span><span style=color:#75af00>Exec</span><span style=color:#111>(</span><span style=color:#75af00>cmd</span><span style=color:#111>,</span> <span style=color:#75af00>args</span><span style=color:#111>,</span> <span style=color:#75af00>env</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>unix</span><span style=color:#111>.</span><span style=color:#75af00>EINTR</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>PathError</span><span style=color:#111>{</span><span style=color:#75af00>Op</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;exec&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>Path</span><span style=color:#111>:</span> <span style=color:#75af00>cmd</span><span style=color:#111>,</span> <span style=color:#75af00>Err</span><span style=color:#111>:</span> <span style=color:#75af00>err</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> 容器启动流程（containerd 和 runc）</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/>https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/cloud/kubernetes_container_device_interface_cdi/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>kubernetes container device interface (CDI)</span></div></a><a href=/post/cloud/kubernetes_client_go_function_introduction/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>kubernetes client-go功能介绍</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#启动流程>启动流程</a><ul><li><a href=#疑问解答>疑问解答</a></li></ul></li><li><a href=#架构图>架构图</a></li><li><a href=#代码分析>代码分析</a><ul><li><a href=#containerd-api-注册-代码分析>containerd api 注册 代码分析</a></li><li><a href=#create-task>create task</a></li><li><a href=#cri-代码>cri 代码</a></li><li><a href=#containerd-shim>containerd-shim</a></li><li><a href=#runc>runc</a></li></ul></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2025 daemon365</p><p class=powered-by>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a></p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder="Search articles..." autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>Enter 2 or more characters to start searching</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>