<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.136.5"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.ico><meta itemprop=name content="从kratos分析BBR限流源码实现"><meta itemprop=description content="Don't let yourself stop."><meta name=description content="Don't let yourself stop."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://daemon365.dev/imgs/daemon365.png"><meta itemprop=keywords content="go,kratos,BBR,源码分析"><meta property="og:type" content="article"><meta property="og:title" content="从kratos分析BBR限流源码实现"><meta property="og:description" content="Don't let yourself stop."><meta property="og:image" content="/imgs/daemon365.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/"><meta property="og:site_name" content="Daemon"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="daemon365"><meta property="article:published_time" content="2021-09-04 00:00:00 +0800 +0800"><meta property="article:modified_time" content="2021-09-04 00:00:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.d676189b0ac4b63b254e222668b8bedd7d6ba28666e76077ff3b7e23522b4a6d.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos","permalink":"https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/","title":"从kratos分析BBR限流源码实现","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JmAHxEAUVgyS8B1c",ck:"JmAHxEAUVgyS8B1c",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>从kratos分析BBR限流源码实现 - Daemon</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Daemon</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Don't let yourself stop.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives
<span class=badge>93</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>Commonweal</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#什么是自适应限流>什么是自适应限流</a></li><li><a href=#限流规则>限流规则</a><ul><li><a href=#指标介绍>指标介绍</a></li><li><a href=#滑动窗口>滑动窗口</a></li><li><a href=#限流公式>限流公式</a></li></ul></li><li><a href=#源码分析>源码分析</a></li><li><a href=#代码地址>代码地址：</a><ul><li><a href=#bbr-struct>BBR struct</a></li></ul></li><li><a href=#allow接口>Allow接口</a><ul><li><a href=#shoulddrop方法>shouldDrop方法</a></li><li><a href=#流程图>流程图</a></li></ul></li><li><a href=#压测报告>压测报告</a></li><li><a href=#原文地址>原文地址：</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=daemon365 src=/imgs/img-lazy-loading.gif data-src=/imgs/daemon365.png><p class=site-author-name itemprop=name>daemon365</p><div class=site-description itemprop=description>Don't let yourself stop.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>93</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/daemon365 title="Github → https://github.com/daemon365" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev title=https://go-kratos.dev target=_blank>kratos</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/daemon365.png"><meta itemprop=name content="daemon365"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="daemon365"><meta itemprop=description content="Don't let yourself stop."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="从kratos分析BBR限流源码实现"><meta itemprop=description content="什么是自适应限流

自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。"></span><header class=post-header><h1 class=post-title itemprop="name headline">从kratos分析BBR限流源码实现</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2021-09-04 00:00:00 +0800 +0800" itemprop="dateCreated datePublished" datetime="2021-09-04 00:00:00 +0800 +0800">2021-09-04
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/kratos itemprop=url rel=index><span itemprop=name>kratos</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>1775</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>4分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=什么是自适应限流>什么是自适应限流
<a class=header-anchor href=#%e4%bb%80%e4%b9%88%e6%98%af%e8%87%aa%e9%80%82%e5%ba%94%e9%99%90%e6%b5%81></a></h2><p>自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p><p><strong>核心目标：</strong></p><ul><li>自动嗅探负载和 qps，减少人工配置</li><li>削顶，保证超载时系统不被拖垮，并能以高水位 qps 继续运行</li></ul><h2 id=限流规则>限流规则
<a class=header-anchor href=#%e9%99%90%e6%b5%81%e8%a7%84%e5%88%99></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/images/fdc8a49d-6a85-4ad6-b266-994260aa8350.png alt></p><p><strong>计算吞吐量：利特尔法则 <code>L = λ * W</code></strong></p><p>如上图所示，如果我们开一个小店，平均每分钟进店 2 个客人(λ)，每位客人从等待到完成交易需要 4 分钟(W)，那我们店里能承载的客人数量就是 2 * 4 = 8 个人</p><p>同理，我们可以将 <code>λ</code> 当做 QPS， <code>W</code> 呢是每个请求需要花费的时间，那我们的系统的吞吐就是 <code>L = λ * W</code> ，所以我们可以使用利特尔法则来计算系统的吞吐量。</p><h3 id=指标介绍>指标介绍
<a class=header-anchor href=#%e6%8c%87%e6%a0%87%e4%bb%8b%e7%bb%8d></a></h3><table><thead><tr><th>指标名称</th><th>指标含义</th></tr></thead><tbody><tr><td>cpu</td><td>最近 1s 的 CPU 使用率均值，使用滑动平均计算，采样周期是 250ms</td></tr><tr><td>inflight</td><td>当前处理中正在处理的请求数量</td></tr><tr><td>pass</td><td>请求处理成功的量</td></tr><tr><td>rt</td><td>请求成功的响应耗时</td></tr></tbody></table><h3 id=滑动窗口>滑动窗口
<a class=header-anchor href=#%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3></a></h3><p>在自适应限流保护中，采集到的指标的时效性非常强，系统只需要采集最近一小段时间内的 qps、rt 即可，对于较老的数据，会自动丢弃。为了实现这个效果，kratos 使用了滑动窗口来保存采样数据。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/d3cc3465-12f9-4400-bc50-8a7af654570c.png alt></p><p>如上图，展示了一个具有两个桶（bucket）的滑动窗口（rolling window）。整个滑动窗口用来保存最近 1s 的采样数据，每个小的桶用来保存 500ms 的采样数据。 当时间流动之后，过期的桶会自动被新桶的数据覆盖掉，在图中，在 1000-1500ms 时，bucket 1 的数据因为过期而被丢弃，之后 bucket 3 的数据填到了窗口的头部。</p><h3 id=限流公式>限流公式
<a class=header-anchor href=#%e9%99%90%e6%b5%81%e5%85%ac%e5%bc%8f></a></h3><p>判断是否丢弃当前请求的算法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cpu</span> &gt; <span style=color:#ae81ff>800</span> <span style=color:#a6e22e>AND</span> (<span style=color:#a6e22e>Now</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>PrevDrop</span>) &lt; <span style=color:#ae81ff>1</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>AND</span> (<span style=color:#a6e22e>MaxPass</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>MinRt</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>windows</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>) &lt; <span style=color:#a6e22e>InFlight</span>
</span></span></code></pre></div><p>MaxPass 表示最近 5s 内，单个采样窗口中最大的请求数。 MinRt 表示最近 5s 内，单个采样窗口中最小的响应时间。 windows 表示一秒内采样窗口的数量，默认配置中是 5s 50 个采样，那么 windows 的值为 10。</p><h2 id=源码分析>源码分析
<a class=header-anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90></a></h2><h2 id=代码地址>代码地址：
<a class=header-anchor href=#%e4%bb%a3%e7%a0%81%e5%9c%b0%e5%9d%80></a></h2><ul><li><a href=https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr title=https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr
<i class="fa fa-external-link-alt"></i></a></li></ul><h3 id=bbr-struct>BBR struct
<a class=header-anchor href=#bbr-struct></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>BBR</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cpu</span>             <span style=color:#a6e22e>cpuGetter</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>passStat</span>        <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>RollingCounter</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rtStat</span>          <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>RollingCounter</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>inFlight</span>        <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bucketPerSecond</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bucketSize</span>      <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// prevDropTime defines previous start drop since initTime
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>prevDropTime</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>maxPASSCache</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>minRtCache</span>   <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>options</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li><code>cpu</code><ul><li>cpu的指标函数，CPU的使用率， 这里为了减小误差，把数字扩大化，乘以1000，比赛使用率60%，也就是0.6 cpu的值就为600</li></ul></li><li><code>passStat</code><ul><li>请求数的采样数据，使用滑动窗口进行统计</li></ul></li><li><code>rtStat</code><ul><li>响应时间的采样数据，同样使用滑动窗口进行统计</li></ul></li><li><code>inFlight</code><ul><li>当前系统中的请求数，数据得来方法是：中间件原理在处理前+1，处理handle之后不管成功失败都减去1</li></ul></li><li><code>bucketPerSecond</code><ul><li>一个 bucket 的时间</li></ul></li><li><code>bucketSize</code><ul><li>桶的数量</li></ul></li><li><code>prevDropTime</code><ul><li>上次触发限流时间</li></ul></li><li><code>maxPASSCache</code><ul><li>单个采样窗口中最大的请求数的缓存数据</li></ul></li><li><code>minRtCache</code><ul><li>单个采样窗口中最小的响应时间的缓存数据</li></ul></li></ol><h2 id=allow接口>Allow接口
<a class=header-anchor href=#allow%e6%8e%a5%e5%8f%a3></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Allow checks all inbound traffic.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Once overload is detected, it raises limit.ErrLimitExceed error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BBR</span>) <span style=color:#a6e22e>Allow</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>func</span>(), <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>shouldDrop</span>() { <span style=color:#75715e>// shouldDrop 判断是否需要限流，如果true表示拒绝 之后重点讲
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrLimitExceed</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>inFlight</span>, <span style=color:#ae81ff>1</span>) <span style=color:#75715e>// 之前说的，正在处理数+1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>initTime</span>) <span style=color:#75715e>// 现在时间减去程序初始化时间 表示程序开始执行时刻
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() { <span style=color:#75715e>// allow返回函数 在中间件（拦截器）中handle执行完成后调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>rt</span> <span style=color:#f92672>:=</span> int64((<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>initTime</span>) <span style=color:#f92672>-</span> <span style=color:#a6e22e>stime</span>) <span style=color:#f92672>/</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)  <span style=color:#75715e>// 执行完handle的时间减去stime 表示 程序执行的总时间 单位ms
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>rtStat</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>rt</span>) <span style=color:#75715e>// 把处理时间放进采样数据window
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>inFlight</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e>// 正在处理数-1 便是处理完成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>passStat</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>) <span style=color:#75715e>// 成功了，把通过数的采样数据window加1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=shoulddrop方法>shouldDrop方法
<a class=header-anchor href=#shoulddrop%e6%96%b9%e6%b3%95></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BBR</span>) <span style=color:#a6e22e>shouldDrop</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>curTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>initTime</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>cpu</span>() &lt; <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>CPUThreshold</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// current cpu payload below the threshold
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>prevDropTime</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>prevDropTime</span>.<span style=color:#a6e22e>Load</span>().(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevDropTime</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// haven&#39;t start drop,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// accept current request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>curTime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>prevDropTime</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// just start drop one second ago,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// check current inflight count
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>inFlight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>inFlight</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>inFlight</span> &gt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>inFlight</span> &gt; <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>maxInFlight</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>prevDropTime</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// current cpu payload exceeds the threshold
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>inFlight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>inFlight</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>drop</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>inFlight</span> &gt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>inFlight</span> &gt; <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>maxInFlight</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>drop</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prevDrop</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>prevDropTime</span>.<span style=color:#a6e22e>Load</span>().(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevDrop</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// already started drop, return directly
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>drop</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// store start drop time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>prevDropTime</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>curTime</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>drop</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>maxInFlight()方法代表过去的负载</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span>int64(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Floor</span>(float64(<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>maxPASS</span>()<span style=color:#f92672>*</span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>minRT</span>()<span style=color:#f92672>*</span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>bucketPerSecond</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1000.0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5</span>)
</span></span></code></pre></div><p>参考算法：https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</p><ul><li>maxPass * bucketPerSecond / 1000 为每毫秒处理的请求数</li><li>l.minRT() 为 单个采样窗口中最小的响应时间</li><li>T ≈ QPS * Avg(RT)</li><li><code>+ 0.5</code>为向上取整</li></ul><h3 id=流程图>流程图
<a class=header-anchor href=#%e6%b5%81%e7%a8%8b%e5%9b%be></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/images/c13f3623-a858-4322-9695-f1db1a4f85a5.png alt></p><h2 id=压测报告>压测报告
<a class=header-anchor href=#%e5%8e%8b%e6%b5%8b%e6%8a%a5%e5%91%8a></a></h2><p>场景1，请求以每秒增加1个的速度不停上升，压测效果如下：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/fcae1ea8-da01-470a-823d-ab394851b01a.png alt></p><p>左测是没有限流的压测效果，右侧是带限流的压测效果。 可以看到，没有限流的场景里，系统在 700qps 时开始抖动，在 1k qps 时被拖垮，几乎没有新的请求能被放行，然而在使用限流之后，系统请求能够稳定在 600 qps 左右，rt 没有暴增，服务也没有被打垮，可见，限流有效的保护了服务。</p><h2 id=原文地址>原文地址：
<a class=header-anchor href=#%e5%8e%9f%e6%96%87%e5%9c%b0%e5%9d%80></a></h2><ul><li><a href=https://zhaohaiyu.com/posts/microservice/overload/ title=https://zhaohaiyu.com/posts/microservice/overload/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://zhaohaiyu.com/posts/microservice/overload/
<i class="fa fa-external-link-alt"></i></a></li></ul><p>参考文章：</p><ul><li><a href=https://v1.go-kratos.dev/#/ratelimit title=https://v1.go-kratos.dev/#/ratelimit rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://v1.go-kratos.dev/#/ratelimit
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81 title=https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81
<i class="fa fa-external-link-alt"></i></a></li></ul><hr><p><img src=/imgs/img-lazy-loading.gif data-src=/images/f3c8339b-cae8-4cde-9f92-dd68eba61462.png alt></p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/cec35d8f-b7d4-4c38-adb3-1fe46b6c7a1b.gif alt></p></div><footer class=post-footer><div class=post-tags><a href=/tags/go>go
</a><a href=/tags/kratos>kratos
</a><a href=/tags/bbr>BBR
</a><a href=/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>源码分析</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
从kratos分析BBR限流源码实现</li><li class=post-copyright-author><strong>本文作者： </strong>daemon365</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/ title=从kratos分析BBR限流源码实现>https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/kratos/analyzing_the_breaker_fuse_source_code_implementation_from_kratos/ rel=next title=从kratos分析breaker熔断器源码实现><i class="fa fa-chevron-left"></i> 从kratos分析breaker熔断器源码实现</a></div><div class="post-nav-prev post-nav-item"><a href=/post/kratos/the_hitchhikers_guide_to_kratos_1___overview/ rel=prev title="Kratos漫游指南 1 - 概览">Kratos漫游指南 1 - 概览
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>daemon365</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.136.5 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://daemon365.dev/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://daemon365.dev/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"JmAHxEAUVgyS8B1c","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"daemon365/blog","theme":"preferred-color-scheme"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://daemon365.dev/3rd"}},"version":"4.6.3"}</script><script type=text/javascript src=/js/main.min.44e8f3a116669418a0551fcbff81fe26c85707505ea0b87a42f2d4116994b442.js defer></script></body></html>